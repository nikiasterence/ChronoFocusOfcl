<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gridora - Advanced Spreadsheet Application</title>
    <style>
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px var(--accent-color); }
            50% { box-shadow: 0 0 20px var(--accent-color), 0 0 30px var(--accent-color); }
            100% { box-shadow: 0 0 5px var(--accent-color); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f8f9fa;
            --tertiary-bg: #e9ecef;
            --accent-bg: #dee2e6;
            --primary-text: #2d3748;
            --secondary-text: #4a5568;
            --tertiary-text: #718096;
            --border-color: #e2e8f0;
            --accent-color: #4299e1;
            --accent-hover: #3182ce;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px 0 rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --blur: blur(20px);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] {
            --primary-bg: #1a202c;
            --secondary-bg: #2d3748;
            --tertiary-bg: #4a5568;
            --accent-bg: #2d3748;
            --primary-text: #f7fafc;
            --secondary-text: #e2e8f0;
            --tertiary-text: #cbd5e0;
            --border-color: #4a5568;
            --accent-color: #63b3ed;
            --accent-hover: #4299e1;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px 0 rgba(0, 0, 0, 0.3);
            --glass-bg: rgba(26, 32, 44, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        [data-theme="cozy"] {
            --primary-bg: #fdf6e3;
            --secondary-bg: #eee8d5;
            --tertiary-bg: #d3cbbd;
            --accent-bg: #c5bdb0;
            --primary-text: #657b83;
            --secondary-text: #586e75;
            --tertiary-text: #93a1a1;
            --border-color: #d3cbbd;
            --accent-color: #2aa198;
            --accent-hover: #268bd2;
            --glass-bg: rgba(253, 246, 227, 0.7);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        [data-theme="notion"] {
            --primary-bg: #ffffff;
            --secondary-bg: #f7f6f3;
            --tertiary-bg: #f1f0ec;
            --accent-bg: #e9e8e4;
            --primary-text: #37352f;
            --secondary-text: #787774;
            --tertiary-text: #9b9a97;
            --border-color: #e0e0e0;
            --accent-color: #2eaadc;
            --accent-hover: #2298c4;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 16px 0 rgba(0, 0, 0, 0.08);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--primary-text);
            line-height: 1.6;
            overflow: hidden;
            min-height: 100vh;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
        }

        .header {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border-bottom: 1px solid var(--glass-border);
            border-radius: var(--radius);
            margin: 10px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 0 0 10px var(--accent-color);
            animation: float 3s ease-in-out infinite;
        }

        .logo::before {
            content: "üìä";
            font-size: 28px;
        }

        .file-menu {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 10px 16px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--primary-text);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .btn:hover {
            background-color: var(--secondary-bg);
            border-color: var(--accent-color);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(66, 153, 225, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-hover), var(--accent-color));
            border-color: var(--accent-hover);
            box-shadow: 0 0 20px rgba(66, 153, 225, 0.5);
            transform: translateY(-2px);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ai-assistant {
            position: relative;
        }

        .ai-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--success-color));
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
        }

        .ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            animation: glow 2s ease-in-out infinite;
        }

        .ai-panel {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            width: 350px;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 20px;
            display: none;
            z-index: 1000;
        }

        .ai-panel.active {
            display: block;
        }

        .ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .ai-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-text);
        }

        .ai-model-select {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--secondary-bg);
            color: var(--primary-text);
            font-size: 12px;
        }

        .ai-chat {
            height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 10px;
            background-color: var(--secondary-bg);
        }

        .ai-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--secondary-bg);
            color: var(--primary-text);
            font-size: 14px;
            resize: none;
        }

        .toolbar {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            margin: 10px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            box-shadow: var(--shadow);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 10px;
            border-right: 1px solid var(--border-color);
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .formula-bar {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            margin: 10px;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
        }

        .cell-indicator {
            min-width: 60px;
            padding: 6px 10px;
            background-color: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 14px;
            text-align: center;
        }

        .formula-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            background: var(--glass-bg);
            color: var(--primary-text);
            font-size: 14px;
            font-family: 'Monaco', 'Menlo', monospace;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .worksheet-tabs {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            margin: 10px 10px 0 10px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: var(--shadow);
        }

        .tab {
            padding: 12px 20px;
            border-right: 1px solid var(--glass-border);
            cursor: pointer;
            background: transparent;
            color: var(--secondary-text);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
            border-radius: var(--radius-sm);
            margin: 5px;
        }

        .tab:hover {
            background-color: var(--accent-bg);
        }

        .tab.active {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            color: var(--primary-text);
            border-bottom: 2px solid var(--accent-color);
            box-shadow: var(--shadow);
        }

        .add-tab {
            padding: 10px 15px;
            background-color: transparent;
            border: none;
            color: var(--secondary-text);
            cursor: pointer;
            font-size: 18px;
            border-radius: var(--radius-sm);
            margin-left: 5px;
        }

        .add-tab:hover {
            background-color: var(--accent-bg);
        }

        .spreadsheet-container {
            flex: 1;
            overflow: auto;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            margin: 10px;
            position: relative;
            box-shadow: var(--shadow);
        }

        .spreadsheet {
            border-collapse: collapse;
            min-width: 100%;
        }

        .spreadsheet th,
        .spreadsheet td {
            border: 1px solid var(--glass-border);
            padding: 12px;
            text-align: left;
            vertical-align: middle;
            min-width: 100px;
            max-width: 250px;
            height: 30px;
            position: relative;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .spreadsheet th {
            background: rgba(255, 255, 255, 0.2);
            color: var(--secondary-text);
            font-weight: 600;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .spreadsheet th:first-child {
            position: sticky;
            left: 0;
            z-index: 11;
        }

        .spreadsheet td:first-child {
            background: rgba(255, 255, 255, 0.15);
            color: var(--secondary-text);
            font-weight: 600;
            text-align: center;
            position: sticky;
            left: 0;
            z-index: 9;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .spreadsheet td {
            background: var(--glass-bg);
            color: var(--primary-text);
            cursor: cell;
            transition: all 0.2s ease;
        }

        .spreadsheet td:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
            transition: all 0.2s ease;
            z-index: 6;
        }

        .spreadsheet td.selected {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 0 0 2px var(--accent-color);
            z-index: 5;
        }

        .spreadsheet td.editing {
            padding: 0;
        }

        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            padding: 8px;
            background: var(--glass-bg);
            color: var(--primary-text);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border-left: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            transition: right 0.3s ease;
            z-index: 200;
            overflow-y: auto;
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-header {
            padding: 20px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-text);
        }

        .settings-content {
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: 15px;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .theme-option {
            padding: 20px;
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .theme-option:hover {
            border-color: var(--accent-color);
        }

        .theme-option.active {
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .template-card {
            padding: 25px;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .template-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .template-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .template-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: 5px;
        }

        .template-desc {
            font-size: 12px;
            color: var(--secondary-text);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-text);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 5px;
        }

        .close-btn:hover {
            color: var(--primary-text);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-text);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            background: var(--glass-bg);
            color: var(--primary-text);
            font-size: 14px;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .status-bar {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border-top: 1px solid var(--glass-border);
            border-radius: var(--radius);
            margin: 0 10px 10px 10px;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--secondary-text);
            box-shadow: var(--shadow);
        }

        .context-menu {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            padding: 5px 0;
            display: none;
            z-index: 1000;
            min-width: 150px;
        }

        .context-menu.active {
            display: block;
        }

        .context-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            color: var(--primary-text);
            transition: background-color 0.2s ease;
        }

        .context-item:hover {
            background-color: var(--secondary-bg);
        }

        .context-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }
            
            .toolbar {
                padding: 8px 15px;
                gap: 10px;
            }
            
            .toolbar-group {
                padding: 0 8px;
            }
            
            .settings-panel {
                width: 100%;
                right: -100%;
            }
            
            .ai-panel {
                width: 280px;
            }
        }
    </style>
</head>
<body data-theme="notion">
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <div class="logo">Gridora</div>
                <div class="file-menu">
                    <button class="btn" onclick="showNewFileModal()">
                        <span>üìÑ</span> New
                    </button>
                    <button class="btn" onclick="openFile()">
                        <span>üìÅ</span> Open
                    </button>
                    <button class="btn" onclick="saveFile()">
                        <span>üíæ</span> Save
                    </button>
                    <button class="btn" onclick="exportData()">
                        <span>üì§</span> Export
                    </button>
                </div>
            </div>
            <div class="header-right">
                <div class="ai-assistant">
                    <button class="ai-btn" onclick="toggleAI()">
                        <span>ü§ñ</span> Optichain AI
                    </button>
                    <div class="ai-panel" id="aiPanel">
                        <div class="ai-header">
                            <div class="ai-title">Optichain Assistant</div>
                            <select class="ai-model-select" id="aiModel">
                                <option value="5pro">Optichain 5 Pro</option>
                                <option value="ultra">Optichain Ultra</option>
                            </select>
                        </div>
                        <div class="ai-chat" id="aiChat"></div>
                        <textarea class="ai-input" id="aiInput" placeholder="Ask me anything about your data..." rows="3"></textarea>
                        <button class="btn btn-primary" style="margin-top: 10px; width: 100%;" onclick="sendAIMessage()">Send</button>
                    </div>
                </div>
                <button class="btn" onclick="toggleSettings()">
                    <span>‚öôÔ∏è</span> Settings
                </button>
            </div>
        </header>

        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn" onclick="undo()" title="Undo">
                    <span>‚Ü∂</span>
                </button>
                <button class="btn" onclick="redo()" title="Redo">
                    <span>‚Ü∑</span>
                </button>
            </div>
            <div class="toolbar-group">
                <button class="btn" onclick="cut()" title="Cut">
                    <span>‚úÇÔ∏è</span>
                </button>
                <button class="btn" onclick="copy()" title="Copy">
                    <span>üìã</span>
                </button>
                <button class="btn" onclick="paste()" title="Paste">
                    <span>üìÑ</span>
                </button>
            </div>
            <div class="toolbar-group">
                <button class="btn" onclick="formatBold()" title="Bold">
                    <span><b>B</b></span>
                </button>
                <button class="btn" onclick="formatItalic()" title="Italic">
                    <span><i>I</i></span>
                </button>
                <button class="btn" onclick="formatUnderline()" title="Underline">
                    <span><u>U</u></span>
                </button>
            </div>
            <div class="toolbar-group">
                <button class="btn" onclick="insertRow()" title="Insert Row">
                    <span>‚ûï Row</span>
                </button>
                <button class="btn" onclick="insertColumn()" title="Insert Column">
                    <span>‚ûï Col</span>
                </button>
                <button class="btn" onclick="deleteRow()" title="Delete Row">
                    <span>üóëÔ∏è Row</span>
                </button>
                <button class="btn" onclick="deleteColumn()" title="Delete Column">
                    <span>üóëÔ∏è Col</span>
                </button>
            </div>
            <div class="toolbar-group">
                <button class="btn" onclick="sortAsc()" title="Sort Ascending">
                    <span>üîº</span>
                </button>
                <button class="btn" onclick="sortDesc()" title="Sort Descending">
                    <span>üîΩ</span>
                </button>
            </div>
            <div class="toolbar-group">
                <button class="btn" onclick="createChart()" title="Create Chart">
                    <span>üìä</span>
                </button>
                <button class="btn" onclick="applyFunction()" title="Functions">
                    <span>f(x)</span>
                </button>
            </div>
        </div>

        <div class="formula-bar">
            <div class="cell-indicator" id="cellIndicator">A1</div>
            <input type="text" class="formula-input" id="formulaInput" placeholder="Enter formula or value...">
        </div>

        <div class="main-content">
            <div class="worksheet-tabs" id="worksheetTabs">
                <div class="tab active" onclick="switchWorksheet(0)">Sheet1</div>
                <button class="add-tab" onclick="addWorksheet()">+</button>
            </div>

            <div class="spreadsheet-container">
                <table class="spreadsheet" id="spreadsheet">
                    <thead>
                        <tr id="headerRow">
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="spreadsheetBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-left">
                <span id="cellCount">0 cells selected</span>
            </div>
            <div class="status-right">
                <span id="currentTime"></span>
            </div>
        </div>
    </div>

    <div class="context-menu" id="contextMenu">
        <div class="context-item" onclick="cut()">Cut</div>
        <div class="context-item" onclick="copy()">Copy</div>
        <div class="context-item" onclick="paste()">Paste</div>
        <div class="context-divider"></div>
        <div class="context-item" onclick="insertRow()">Insert Row</div>
        <div class="context-item" onclick="insertColumn()">Insert Column</div>
        <div class="context-item" onclick="deleteRow()">Delete Row</div>
        <div class="context-item" onclick="deleteColumn()">Delete Column</div>
        <div class="context-divider"></div>
        <div class="context-item" onclick="formatCells()">Format Cells</div>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <div class="settings-title">Settings</div>
            <button class="close-btn" onclick="toggleSettings()">√ó</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <h3>Appearance</h3>
                <div class="theme-grid">
                    <div class="theme-option active" data-theme="notion" onclick="changeTheme('notion')">
                        <div style="font-weight: 600;">Notion</div>
                        <div style="font-size: 12px; color: var(--secondary-text);">Clean & Professional</div>
                    </div>
                    <div class="theme-option" data-theme="light" onclick="changeTheme('light')">
                        <div style="font-weight: 600;">Light</div>
                        <div style="font-size: 12px; color: var(--secondary-text);">Bright & Simple</div>
                    </div>
                    <div class="theme-option" data-theme="dark" onclick="changeTheme('dark')">
                        <div style="font-weight: 600;">Dark</div>
                        <div style="font-size: 12px; color: var(--secondary-text);">Easy on Eyes</div>
                    </div>
                    <div class="theme-option" data-theme="cozy" onclick="changeTheme('cozy')">
                        <div style="font-weight: 600;">Cozy</div>
                        <div style="font-size: 12px; color: var(--secondary-text);">Warm & Comfortable</div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Templates</h3>
                <div class="template-grid">
                    <div class="template-card" onclick="loadTemplate('budget')">
                        <div class="template-icon">üí∞</div>
                        <div class="template-title">Monthly Budget</div>
                        <div class="template-desc">Track income & expenses</div>
                    </div>
                    <div class="template-card" onclick="loadTemplate('school')">
                        <div class="template-icon">üìö</div>
                        <div class="template-title">School Project</div>
                        <div class="template-desc">Manage assignments & grades</div>
                    </div>
                    <div class="template-card" onclick="loadTemplate('work')">
                        <div class="template-icon">üíº</div>
                        <div class="template-title">Work Budget</div>
                        <div class="template-desc">Project cost tracking</div>
                    </div>
                    <div class="template-card" onclick="loadTemplate('blank')">
                        <div class="template-icon">üìÑ</div>
                        <div class="template-title">Blank Sheet</div>
                        <div class="template-desc">Start from scratch</div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>AI Settings</h3>
                <div class="form-group">
                    <label class="form-label">AI Model</label>
                    <select class="form-input" id="defaultAIModel">
                        <option value="5pro">Optichain 5 Pro (Balanced)</option>
                        <option value="ultra">Optichain Ultra (Advanced)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Auto-suggestions</label>
                    <input type="checkbox" id="autoSuggestions" checked> Enable AI suggestions
                </div>
            </div>

            <div class="settings-section">
                <h3>Calculation Settings</h3>
                <div class="form-group">
                    <label class="form-label">Calculation Mode</label>
                    <select class="form-input" id="calcMode">
                        <option value="auto">Automatic</option>
                        <option value="manual">Manual</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Precision</label>
                    <input type="number" class="form-input" id="precision" value="2" min="0" max="10">
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="newFileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New File</div>
                <button class="close-btn" onclick="closeModal('newFileModal')">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">File Name</label>
                <input type="text" class="form-input" id="newFileName" value="Untitled Spreadsheet">
            </div>
            <div class="form-group">
                <label class="form-label">Template</label>
                <select class="form-input" id="newFileTemplate">
                    <option value="blank">Blank Spreadsheet</option>
                    <option value="budget">Monthly Budget</option>
                    <option value="school">School Project</option>
                    <option value="work">Work Budget</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="closeModal('newFileModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewFile()">Create</button>
            </div>
        </div>
    </div>

    <script>
        class SpreadsheetApp {
            constructor() {
                this.worksheets = [{
                    name: 'Sheet1',
                    data: this.createEmptySheet(100, 26),
                    activeCell: {row: 0, col: 0}
                }];
                this.activeWorksheet = 0;
                this.history = [];
                this.historyIndex = -1;
                this.clipboard = null;
                this.formulas = new Map();
                this.themes = ['light', 'dark', 'cozy', 'notion'];
                this.currentTheme = 'notion';
                
                this.init();
            }

            init() {
                this.createSpreadsheet();
                this.setupEventListeners();
                this.setupKeyboardShortcuts();
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);
            }

            createEmptySheet(rows, cols) {
                const data = [];
                for (let i = 0; i < rows; i++) {
                    const row = [];
                    for (let j = 0; j < cols; j++) {
                        row.push('');
                    }
                    data.push(row);
                }
                return data;
            }

            createSpreadsheet() {
                const headerRow = document.getElementById('headerRow');
                const spreadsheetBody = document.getElementById('spreadsheetBody');
                
                headerRow.innerHTML = '<th></th>';
                for (let i = 0; i < 26; i++) {
                    const th = document.createElement('th');
                    th.textContent = String.fromCharCode(65 + i);
                    headerRow.appendChild(th);
                }

                spreadsheetBody.innerHTML = '';
                for (let i = 0; i < 100; i++) {
                    const tr = document.createElement('tr');
                    const rowHeader = document.createElement('td');
                    rowHeader.textContent = i + 1;
                    tr.appendChild(rowHeader);

                    for (let j = 0; j < 26; j++) {
                        const td = document.createElement('td');
                        td.dataset.row = i;
                        td.dataset.col = j;
                        td.addEventListener('click', (e) => this.selectCell(e));
                        td.addEventListener('dblclick', (e) => this.editCell(e));
                        td.addEventListener('contextmenu', (e) => this.showContextMenu(e));
                        tr.appendChild(td);
                    }
                    spreadsheetBody.appendChild(tr);
                }

                this.renderData();
            }

            renderData() {
                const worksheet = this.worksheets[this.activeWorksheet];
                const cells = document.querySelectorAll('#spreadsheetBody td:not(:first-child)');
                
                cells.forEach(cell => {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    const value = worksheet.data[row][col];
                    cell.textContent = this.formatValue(value);
                });
            }

            formatValue(value) {
                if (typeof value === 'number') {
                    return value.toFixed(2);
                }
                return value || '';
            }

            selectCell(event) {
                const cell = event.target;
                if (cell.tagName !== 'TD' || cell.dataset.col === undefined) return;

                document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                cell.classList.add('selected');

                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const cellAddress = String.fromCharCode(65 + col) + (row + 1);
                
                document.getElementById('cellIndicator').textContent = cellAddress;
                document.getElementById('formulaInput').value = this.worksheets[this.activeWorksheet].data[row][col] || '';
                
                this.worksheets[this.activeWorksheet].activeCell = {row, col};
                this.updateCellCount();
            }

            editCell(event) {
                const cell = event.target;
                if (cell.tagName !== 'TD' || cell.dataset.col === undefined) return;

                cell.classList.add('editing');
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'cell-input';
                input.value = cell.textContent;
                cell.textContent = '';
                cell.appendChild(input);
                input.focus();
                input.select();

                const finishEdit = () => {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    const value = input.value;
                    
                    this.setCellValue(row, col, value);
                    cell.classList.remove('editing');
                    cell.textContent = this.formatValue(value);
                };

                input.addEventListener('blur', finishEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        finishEdit();
                    } else if (e.key === 'Escape') {
                        cell.classList.remove('editing');
                        cell.textContent = this.formatValue(this.worksheets[this.activeWorksheet].data[parseInt(cell.dataset.row)][parseInt(cell.dataset.col)]);
                    }
                });
            }

            setCellValue(row, col, value) {
                this.saveHistory();
                const worksheet = this.worksheets[this.activeWorksheet];
                
                if (value.startsWith('=')) {
                    try {
                        const result = this.evaluateFormula(value.substring(1));
                        worksheet.data[row][col] = result;
                        this.formulas.set(`${row},${col}`, value);
                    } catch (error) {
                        worksheet.data[row][col] = '#ERROR';
                    }
                } else {
                    worksheet.data[row][col] = value;
                    this.formulas.delete(`${row},${col}`);
                }

                this.renderData();
                this.recalculateFormulas();
            }

            evaluateFormula(formula) {
                formula = formula.toUpperCase().trim();
                
                // Handle basic arithmetic operations and cell references
                if (formula.includes('+') || formula.includes('-') || formula.includes('*') || formula.includes('/') || /^[A-Z]\d+$/.test(formula)) {
                    return this.evaluateArithmetic(formula);
                }
                
                // Handle Excel functions
                if (formula.startsWith('SUM(')) {
                    const range = formula.substring(4, formula.length - 1);
                    return this.sumRange(range);
                } else if (formula.startsWith('AVERAGE(')) {
                    const range = formula.substring(8, formula.length - 1);
                    return this.averageRange(range);
                } else if (formula.startsWith('COUNT(')) {
                    const range = formula.substring(6, formula.length - 1);
                    return this.countRange(range);
                } else if (formula.startsWith('MAX(')) {
                    const range = formula.substring(4, formula.length - 1);
                    return this.maxRange(range);
                } else if (formula.startsWith('MIN(')) {
                    const range = formula.substring(4, formula.length - 1);
                    return this.minRange(range);
                } else if (formula.startsWith('COUNTA(')) {
                    const range = formula.substring(8, formula.length - 1);
                    return this.countARange(range);
                } else if (formula.startsWith('ABS(')) {
                    const param = formula.substring(4, formula.length - 1);
                    return Math.abs(this.getCellValue(param));
                } else if (formula.startsWith('SQRT(')) {
                    const param = formula.substring(5, formula.length - 1);
                    const val = this.getCellValue(param);
                    return val < 0 ? '#NUM!' : Math.sqrt(val);
                } else if (formula.startsWith('POWER(')) {
                    const params = this.parseFunctionParams(formula.substring(6));
                    return Math.pow(this.getCellValue(params[0]), this.getCellValue(params[1]));
                } else if (formula.startsWith('MOD(')) {
                    const params = this.parseFunctionParams(formula.substring(4));
                    return this.getCellValue(params[0]) % this.getCellValue(params[1]);
                } else if (formula.startsWith('IF(')) {
                    return this.evaluateIF(formula);
                } else if (formula.startsWith('ROUND(')) {
                    return this.evaluateROUND(formula);
                } else if (formula.startsWith('TRUNC(')) {
                    const params = this.parseFunctionParams(formula.substring(6));
                    const digits = params.length > 1 ? parseInt(params[1]) : 0;
                    const multiplier = Math.pow(10, digits);
                    return Math.trunc(this.getCellValue(params[0]) * multiplier) / multiplier;
                } else if (formula.startsWith('CONCATENATE(')) {
                    const params = this.parseFunctionParams(formula.substring(12));
                    return params.map(param => this.getCellValue(param).toString()).join('');
                }
            }

            evaluateIF(formula) {
                // Simple IF evaluation: IF(condition, true_value, false_value)
                const params = this.parseFunctionParams(formula.substring(3));
                if (params.length !== 3) return '#ERROR';
                
                const condition = this.evaluateCondition(params[0]);
                return condition ? this.getCellValue(params[1]) : this.getCellValue(params[2]);
            }

            evaluateROUND(formula) {
                const params = this.parseFunctionParams(formula.substring(6));
                if (params.length < 1) return '#ERROR';
                
                const value = this.getCellValue(params[0]);
                const digits = params.length > 1 ? parseInt(params[1]) : 0;
                return Math.round(value * Math.pow(10, digits)) / Math.pow(10, digits);
            }

            parseFunctionParams(paramsStr) {
                const params = [];
                let current = '';
                let depth = 0;
                
                for (let i = 0; i < paramsStr.length; i++) {
                    const char = paramsStr[i];
                    if (char === '(') depth++;
                    else if (char === ')') depth--;
                    
                    if (char === ',' && depth === 0) {
                        params.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                if (current) params.push(current.trim());
                return params;
            }

            evaluateCondition(condition) {
                // Simple condition evaluation: A1>10, A1=B1, etc.
                if (condition.includes('=')) {
                    const parts = condition.split('=');
                    return this.getCellValue(parts[0]) === this.getCellValue(parts[1]);
                } else if (condition.includes('>')) {
                    const parts = condition.split('>');
                    return this.getCellValue(parts[0]) > this.getCellValue(parts[1]);
                } else if (condition.includes('<')) {
                    const parts = condition.split('<');
                    return this.getCellValue(parts[0]) < this.getCellValue(parts[1]);
                }
                return false;
            }

            evaluateArithmetic(formula) {
                // Replace cell references with their values
                formula = formula.replace(/[A-Z]\d+/g, (match) => {
                    return this.getCellValue(match);
                });
                
                // Handle division by zero
                if (formula.includes('/')) {
                    const parts = formula.split('/');
                    const divisor = eval(parts[1]);
                    if (divisor === 0) return '#DIV/0!';
                }
                
                try {
                    return eval(formula);
                } catch (error) {
                    return '#ERROR';
                }
            }

            getCellValue(ref) {
                if (!isNaN(parseFloat(ref))) {
                    return parseFloat(ref);
                }
                
                const col = ref.charCodeAt(0) - 65;
                const row = parseInt(ref.substring(1)) - 1;
                
                if (row >= 0 && row < 100 && col >= 0 && col < 26) {
                    const value = this.worksheets[this.activeWorksheet].data[row][col];
                    if (typeof value === 'string' && value.startsWith('=')) {
                        // Recursive evaluation for formula references
                        return this.evaluateFormula(value.substring(1));
                    }
                    return parseFloat(value) || 0;
                }
                return 0;
            }

            divide(ref1, ref2) {
                const val1 = this.getCellValue(ref1);
                const val2 = this.getCellValue(ref2);
                return val2 !== 0 ? val1 / val2 : '#DIV/0!';
            }

            multiply(ref1, ref2) {
                const val1 = this.getCellValue(ref1);
                const val2 = this.getCellValue(ref2);
                return val1 * val2;
            }

            sumRange(range) {
                const values = this.getRangeValues(range);
                return values.reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
            }

            averageRange(range) {
                const values = this.getRangeValues(range);
                const numbers = values.filter(val => !isNaN(parseFloat(val)));
                return numbers.length > 0 ? numbers.reduce((sum, val) => sum + parseFloat(val), 0) / numbers.length : 0;
            }

            countRange(range) {
                const values = this.getRangeValues(range);
                return values.filter(val => val !== '' && val != null).length;
            }

            maxRange(range) {
                const values = this.getRangeValues(range);
                const numbers = values.filter(val => !isNaN(parseFloat(val)));
                return numbers.length > 0 ? Math.max(...numbers.map(Number)) : 0;
            }

            minRange(range) {
                const values = this.getRangeValues(range);
                const numbers = values.filter(val => !isNaN(parseFloat(val)));
                return numbers.length > 0 ? Math.min(...numbers.map(Number)) : 0;
            }

            countARange(range) {
                const values = this.getRangeValues(range);
                return values.filter(val => val !== '' && val != null).length;
            }

            getRangeValues(range) {
                const values = [];
                const [start, end] = range.split(':');
                const startCol = start.charCodeAt(0) - 65;
                const startRow = parseInt(start.substring(1)) - 1;
                const endCol = end ? end.charCodeAt(0) - 65 : startCol;
                const endRow = end ? parseInt(end.substring(1)) - 1 : startRow;

                for (let row = startRow; row <= endRow; row++) {
                    for (let col = startCol; col <= endCol; col++) {
                        if (row >= 0 && row < 100 && col >= 0 && col < 26) {
                            values.push(this.worksheets[this.activeWorksheet].data[row][col]);
                        }
                    }
                }
                return values;
            }

            recalculateFormulas() {
                for (const [key, formula] of this.formulas) {
                    const [row, col] = key.split(',').map(Number);
                    try {
                        const result = this.evaluateFormula(formula.substring(1));
                        this.worksheets[this.activeWorksheet].data[row][col] = result;
                    } catch (error) {
                        this.worksheets[this.activeWorksheet].data[row][col] = '#ERROR';
                    }
                }
                this.renderData();
            }

            setupEventListeners() {
                document.getElementById('formulaInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const cell = this.worksheets[this.activeWorksheet].activeCell;
                        this.setCellValue(cell.row, cell.col, e.target.value);
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.ai-assistant')) {
                        document.getElementById('aiPanel').classList.remove('active');
                    }
                    if (!e.target.closest('.context-menu')) {
                        document.getElementById('contextMenu').classList.remove('active');
                    }
                });
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'z':
                                e.preventDefault();
                                this.undo();
                                break;
                            case 'y':
                                e.preventDefault();
                                this.redo();
                                break;
                            case 'c':
                                e.preventDefault();
                                this.copy();
                                break;
                            case 'v':
                                e.preventDefault();
                                this.paste();
                                break;
                            case 'x':
                                e.preventDefault();
                                this.cut();
                                break;
                            case 's':
                                e.preventDefault();
                                this.saveFile();
                                break;
                            case 'o':
                                e.preventDefault();
                                this.openFile();
                                break;
                        }
                    }
                });
            }

            saveHistory() {
                this.history = this.history.slice(0, this.historyIndex + 1);
                this.history.push(JSON.parse(JSON.stringify(this.worksheets)));
                this.historyIndex++;
            }

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.worksheets = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
                    this.renderData();
                }
            }

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.worksheets = JSON.parse(JSON.stringify(this.history[this.historyIndex]));
                    this.renderData();
                }
            }

            cut() {
                this.copy();
                const cell = this.worksheets[this.activeWorksheet].activeCell;
                this.setCellValue(cell.row, cell.col, '');
            }

            copy() {
                const cell = this.worksheets[this.activeWorksheet].activeCell;
                this.clipboard = this.worksheets[this.activeWorksheet].data[cell.row][cell.col];
            }

            paste() {
                if (this.clipboard !== null) {
                    const cell = this.worksheets[this.activeWorksheet].activeCell;
                    this.setCellValue(cell.row, cell.col, this.clipboard);
                }
            }

            updateCellCount() {
                const selected = document.querySelectorAll('.selected').length;
                document.getElementById('cellCount').textContent = `${selected} cell${selected !== 1 ? 's' : ''} selected`;
            }

            updateTime() {
                const now = new Date();
                document.getElementById('currentTime').textContent = now.toLocaleTimeString();
            }

            showContextMenu(event) {
                event.preventDefault();
                const menu = document.getElementById('contextMenu');
                menu.style.left = event.pageX + 'px';
                menu.style.top = event.pageY + 'px';
                menu.classList.add('active');
            }
        }

        let app;

        function initApp() {
            app = new SpreadsheetApp();
        }

        function toggleAI() {
            const panel = document.getElementById('aiPanel');
            panel.classList.toggle('active');
        }

        function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const chat = document.getElementById('aiChat');
            const message = input.value.trim();
            
            if (message) {
                const userMessage = document.createElement('div');
                userMessage.innerHTML = `<strong>You:</strong> ${message}`;
                chat.appendChild(userMessage);
                
                const aiMessage = document.createElement('div');
                aiMessage.innerHTML = `<strong>Optichain:</strong> I'm analyzing your data and performing calculations...`;
                chat.appendChild(aiMessage);
                
                input.value = '';
                chat.scrollTop = chat.scrollHeight;
                
                setTimeout(() => {
                    const response = `Based on your current data, I can help you with calculations, data analysis, and formula suggestions. Try asking me to calculate sums, averages, or create complex formulas.`;
                    aiMessage.innerHTML = `<strong>Optichain:</strong> ${response}`;
                    chat.scrollTop = chat.scrollHeight;
                }, 1000);
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('active');
        }

        function changeTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-theme="${theme}"]`).classList.add('active');
        }

        function showNewFileModal() {
            document.getElementById('newFileModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function createNewFile() {
            const name = document.getElementById('newFileName').value;
            const template = document.getElementById('newFileTemplate').value;
            
            if (template !== 'blank') {
                loadTemplate(template);
            } else {
                app = new SpreadsheetApp();
            }
            
            closeModal('newFileModal');
        }

        function loadTemplate(templateType) {
            switch (templateType) {
                case 'budget':
                    loadBudgetTemplate();
                    break;
                case 'school':
                    loadSchoolTemplate();
                    break;
                case 'work':
                    loadWorkTemplate();
                    break;
                default:
                    app = new SpreadsheetApp();
            }
        }

        function loadBudgetTemplate() {
            app = new SpreadsheetApp();
            const ws = app.worksheets[0];
            
            ws.data[0][0] = 'Monthly Budget Planner';
            ws.data[2][0] = 'Income:';
            ws.data[3][0] = 'Salary';
            ws.data[4][0] = 'Freelance';
            ws.data[5][0] = 'Other';
            ws.data[6][0] = 'Total Income';
            ws.data[6][1] = '=SUM(B4:B6)';
            
            ws.data[8][0] = 'Expenses:';
            ws.data[9][0] = 'Rent/Mortgage';
            ws.data[10][0] = 'Utilities';
            ws.data[11][0] = 'Groceries';
            ws.data[12][0] = 'Transportation';
            ws.data[13][0] = 'Entertainment';
            ws.data[14][0] = 'Total Expenses';
            ws.data[14][1] = '=SUM(B10:B13)';
            
            ws.data[16][0] = 'Net Savings';
            ws.data[16][1] = '=B7-B15';
            
            app.renderData();
            app.recalculateFormulas();
        }

        function loadSchoolTemplate() {
            app = new SpreadsheetApp();
            const ws = app.worksheets[0];
            
            ws.data[0][0] = 'School Grade Tracker';
            ws.data[2][0] = 'Subject';
            ws.data[2][1] = 'Assignment';
            ws.data[2][2] = 'Grade';
            ws.data[2][3] = 'Weight';
            ws.data[2][4] = 'Weighted Score';
            
            const subjects = ['Math', 'Science', 'English', 'History', 'Art'];
            for (let i = 0; i < subjects.length; i++) {
                ws.data[3 + i][0] = subjects[i];
                ws.data[3 + i][1] = 'Project';
                ws.data[3 + i][2] = Math.floor(Math.random() * 30 + 70);
                ws.data[3 + i][3] = 0.3;
                ws.data[3 + i][4] = `=C${4 + i}*D${4 + i}`;
            }
            
            ws.data[9][0] = 'Average Grade';
            ws.data[9][4] = '=AVERAGE(E4:E8)';
            
            app.renderData();
            app.recalculateFormulas();
        }

        function loadWorkTemplate() {
            app = new SpreadsheetApp();
            const ws = app.worksheets[0];
            
            ws.data[0][0] = 'Project Budget Tracker';
            ws.data[2][0] = 'Category';
            ws.data[2][1] = 'Budgeted';
            ws.data[2][2] = 'Actual';
            ws.data[2][3] = 'Difference';
            ws.data[2][4] = 'Status';
            
            const categories = ['Personnel', 'Equipment', 'Software', 'Marketing', 'Overhead'];
            for (let i = 0; i < categories.length; i++) {
                ws.data[3 + i][0] = categories[i];
                ws.data[3 + i][1] = Math.floor(Math.random() * 10000 + 5000);
                ws.data[3 + i][2] = Math.floor(Math.random() * 10000 + 4000);
                ws.data[3 + i][3] = `=B${4 + i}-C${4 + i}`;
                ws.data[3 + i][4] = `=IF(D${4 + i}>0,"Under Budget","Over Budget")`;
            }
            
            ws.data[9][0] = 'Total';
            ws.data[9][1] = '=SUM(B4:B8)';
            ws.data[9][2] = '=SUM(C4:C8)';
            ws.data[9][3] = '=SUM(D4:D8)';
            
            app.renderData();
            app.recalculateFormulas();
        }

        function undo() {
            if (app) app.undo();
        }

        function redo() {
            if (app) app.redo();
        }

        function cut() {
            if (app) app.cut();
        }

        function copy() {
            if (app) app.copy();
        }

        function paste() {
            if (app) app.paste();
        }

        function formatBold() {
            alert('Bold formatting applied (simulated)');
        }

        function formatItalic() {
            alert('Italic formatting applied (simulated)');
        }

        function formatUnderline() {
            alert('Underline formatting applied (simulated)');
        }

        function insertRow() {
            alert('Insert row functionality (simulated)');
        }

        function insertColumn() {
            alert('Insert column functionality (simulated)');
        }

        function deleteRow() {
            alert('Delete row functionality (simulated)');
        }

        function deleteColumn() {
            alert('Delete column functionality (simulated)');
        }

        function sortAsc() {
            alert('Sort ascending functionality (simulated)');
        }

        function sortDesc() {
            alert('Sort descending functionality (simulated)');
        }

        function createChart() {
            alert('Chart creation functionality (simulated)');
        }

        function applyFunction() {
            const functions = ['SUM', 'AVERAGE', 'COUNT', 'MAX', 'MIN', 'ABS', 'ROUND', 'IF', 'POWER', 'MOD'];
            const func = prompt('Available functions:\n\nSUM, AVERAGE, COUNT, MAX, MIN, ABS, ROUND, IF, POWER, MOD\n\nEnter function name:', 'SUM');
            if (func && functions.includes(func.toUpperCase())) {
                const cell = app.worksheets[app.activeWorksheet].activeCell;
                const row = cell.row;
                const col = cell.col;
                let formula = '';
                
                switch (func.toUpperCase()) {
                    case 'SUM':
                    case 'AVERAGE':
                    case 'COUNT':
                    case 'MAX':
                    case 'MIN':
                        const range = prompt(`Enter range for ${func} (e.g., A1:A10):`, 'A1:A10');
                        if (range) formula = `=${func}(${range})`;
                        break;
                    case 'ABS':
                    case 'ROUND':
                        const cellRef = prompt(`Enter cell reference for ${func} (e.g., A1):`, 'A1');
                        if (cellRef) formula = `=${func}(${cellRef})`;
                        break;
                    case 'IF':
                        const condition = prompt('Enter condition (e.g., A1>10):', 'A1>10');
                        const trueValue = prompt('Enter value if true:', 'True');
                        const falseValue = prompt('Enter value if false:', 'False');
                        if (condition && trueValue && falseValue) {
                            formula = `=IF(${condition},${trueValue},${falseValue})`;
                        }
                        break;
                    case 'POWER':
                        const base = prompt('Enter base cell (e.g., A1):', 'A1');
                        const exponent = prompt('Enter exponent (e.g., 2):', '2');
                        if (base && exponent) formula = `=POWER(${base},${exponent})`;
                        break;
                    case 'MOD':
                        const dividend = prompt('Enter dividend cell (e.g., A1):', 'A1');
                        const divisor = prompt('Enter divisor (e.g., 3):', '3');
                        if (dividend && divisor) formula = `=MOD(${dividend},${divisor})`;
                        break;
                }
                
                if (formula) {
                    app.setCellValue(row, col, formula);
                }
            }
        }

        function saveFile() {
            const data = {
                worksheets: app.worksheets,
                formulas: Array.from(app.formulas.entries())
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gridora-spreadsheet.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function openFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        app.worksheets = data.worksheets;
                        app.formulas = new Map(data.formulas);
                        app.renderData();
                        app.recalculateFormulas();
                    } catch (error) {
                        alert('Error loading file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportData() {
            const worksheet = app.worksheets[app.activeWorksheet];
            let csv = '';
            
            for (let row = 0; row < worksheet.data.length; row++) {
                csv += worksheet.data[row].map(cell => `"${cell}"`).join(',') + '\n';
            }
            
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gridora-export.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function addWorksheet() {
            const tabs = document.getElementById('worksheetTabs');
            const newTab = document.createElement('div');
            newTab.className = 'tab';
            newTab.textContent = `Sheet${tabs.children.length}`;
            newTab.onclick = () => switchWorksheet(tabs.children.length - 1);
            tabs.insertBefore(newTab, tabs.lastElementChild);
            
            app.worksheets.push({
                name: `Sheet${app.worksheets.length + 1}`,
                data: app.createEmptySheet(100, 26),
                activeCell: {row: 0, col: 0}
            });
        }

        function switchWorksheet(index) {
            if (index < app.worksheets.length) {
                app.activeWorksheet = index;
                app.renderData();
                
                document.querySelectorAll('.tab').forEach((tab, i) => {
                    tab.classList.toggle('active', i === index);
                });
            }
        }

        function formatCells() {
            alert('Format cells functionality (simulated)');
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
