
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="Chronofocus.png" type="image/x-icon">
    <title>Focus Timer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* --- Default Cozy Mocha Palette --- */
            --background: #F9F5F0;
            /* Enhanced glass effect with more transparency */
            --surface: rgba(255, 255, 255, 0.65);
            --primary: #8D6E63;
            --primary-rgb: 141, 110, 99;
            --primary-light: #EFEBE9;
            --secondary: #BCAAA4;
            --text-primary: #5D4037;
            --text-secondary: #9E8D86;
            --border-color: rgba(231, 224, 217, 0.7);
            --success: #66BB6A;
            --danger: #EF5350;
            --border-radius: 18px;
            /* Increased default blur for a more "liquid" feel */
            --blur-effect: blur(20px);
            --shadow-color: rgba(93, 64, 55, 0.15);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            
            /* New variables for dark mode */
            --dark-background: #1E1E2E;
            --dark-surface: rgba(30, 30, 46, 0.7);
            --dark-primary: #CBA6F7;
            --dark-primary-rgb: 203, 166, 247;
            --dark-primary-light: rgba(203, 166, 247, 0.15);
            --dark-text-primary: #CDD6F4;
            --dark-text-secondary: #A6ADC8;
            --dark-border-color: rgba(203, 166, 247, 0.2);
            --dark-shadow-color: rgba(0, 0, 0, 0.3);
        }

        /* Dark mode */
        body.dark-mode {
            --background: var(--dark-background);
            --surface: var(--dark-surface);
            --primary: var(--dark-primary);
            --primary-rgb: var(--dark-primary-rgb);
            --primary-light: var(--dark-primary-light);
            --text-primary: var(--dark-text-primary);
            --text-secondary: var(--dark-text-secondary);
            --border-color: var(--dark-border-color);
            --shadow-color: var(--dark-shadow-color);
        }

        /* --- REFINED THEME PALETTES --- */
        body.theme-sage { --background: #F1F5F1; --surface: rgba(255, 255, 255, 0.65); --primary: #799975; --primary-rgb: 121, 153, 117; --primary-light: #E6EEE5; --text-primary: #445742; --text-secondary: #7E8C7D; --border-color: #E3E9E2; --shadow-color: rgba(68, 87, 66, 0.1); }
        body.theme-rose { --background: #FDF4F6; --surface: rgba(255, 255, 255, 0.65); --primary: #D4A6B2; --primary-rgb: 212, 166, 178; --primary-light: #F9EBEF; --text-primary: #85616B; --text-secondary: #A99299; --border-color: #F3E6E9; --shadow-color: rgba(133, 97, 107, 0.1); }
        body.theme-mist { --background: #F0F4F8; --surface: rgba(255, 255, 255, 0.65); --primary: #94AEC3; --primary-rgb: 148, 174, 195; --primary-light: #E9EFF4; --text-primary: #566879; --text-secondary: #93A0AC; --border-color: #E2E8ED; --shadow-color: rgba(86, 104, 121, 0.1); }
        body.theme-sand { --background: #FBF5EA; --surface: rgba(255, 255, 255, 0.65); --primary: #D6BA9A; --primary-rgb: 214, 186, 154; --primary-light: #F8F2E7; --text-primary: #705D47; --text-secondary: #A89782; --border-color: #EEE6D9; --shadow-color: rgba(112, 93, 71, 0.1); }
        body.theme-lavender { --background: #F8F6FC; --surface: rgba(255, 255, 255, 0.65); --primary: #9E8FB2; --primary-rgb: 158, 143, 178; --primary-light: #EFECF5; --text-primary: #5A4E6B; --text-secondary: #8C819D; --border-color: #E8E4F0; --shadow-color: rgba(90, 78, 107, 0.1); }
        body.theme-ocean { --background: #F0F7FC; --surface: rgba(255, 255, 255, 0.65); --primary: #7AB3D0; --primary-rgb: 122, 179, 208; --primary-light: #E5F1F8; --text-primary: #3E6378; --text-secondary: #7A9BAD; --border-color: #DDEBF3; --shadow-color: rgba(62, 99, 120, 0.1); }
        body.theme-citrus { --background: #FEFBF0; --surface: rgba(255, 255, 255, 0.65); --primary: #E3C567; --primary-rgb: 227, 197, 103; --primary-light: #FBF5E1; --text-primary: #756235; --text-secondary: #B09D6C; --border-color: #F5EED9; --shadow-color: rgba(117, 98, 53, 0.1); }
        body.theme-berry { --background: #FDF2F8; --surface: rgba(255, 255, 255, 0.65); --primary: #D6729B; --primary-rgb: 214, 114, 155; --primary-light: #FAE6EF; --text-primary: #7E4059; --text-secondary: #B27D95; --border-color: #F4DAE6; --shadow-color: rgba(126, 64, 89, 0.1); }
        
        /* --- IMPROVED LIQUID GLASS THEMES --- */
        body.theme-glass-emerald { --background: #E8F5E9; --surface: rgba(200, 230, 201, 0.75); --primary: #2E7D32; --primary-rgb: 46, 125, 50; --primary-light: #C8E6C9; --text-primary: #1B5E20; --text-secondary: #4CAF50; --border-color: rgba(46, 125, 50, 0.3); --shadow-color: rgba(46, 125, 50, 0.15); }
        body.theme-glass-sapphire { --background: #E3F2FD; --surface: rgba(187, 222, 251, 0.75); --primary: #1565C0; --primary-rgb: 21, 101, 192; --primary-light: #BBDEFB; --text-primary: #0D47A1; --text-secondary: #42A5F5; --border-color: rgba(21, 101, 192, 0.3); --shadow-color: rgba(21, 101, 192, 0.15); }
        body.theme-glass-ruby { --background: #FFEBEE; --surface: rgba(255, 205, 210, 0.75); --primary: #C62828; --primary-rgb: 198, 40, 40; --primary-light: #FFCDD2; --text-primary: #B71C1C; --text-secondary: #EF5350; --border-color: rgba(198, 40, 40, 0.3); --shadow-color: rgba(198, 40, 40, 0.15); }
        body.theme-glass-amethyst { --background: #F3E5F5; --surface: rgba(225, 190, 231, 0.75); --primary: #6A1B9A; --primary-rgb: 106, 27, 154; --primary-light: #E1BEE7; --text-primary: #4A148C; --text-secondary: #9C27B0; --border-color: rgba(106, 27, 154, 0.3); --shadow-color: rgba(106, 27, 154, 0.15); }
        body.theme-glass-obsidian { --background: #111; --surface: rgba(50, 50, 50, 0.75); --primary: #9E9E9E; --primary-rgb: 158, 158, 158; --primary-light: #424242; --text-primary: #FAFAFA; --text-secondary: #BDBDBD; --border-color: rgba(158, 158, 158, 0.3); --shadow-color: rgba(0,0,0,0.4); }

        /* --- REFINED AURORA THEMES --- */
        @keyframes auroraGradient { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        .aurora-bg { background-size: 400% 400%; animation: auroraGradient 20s ease infinite; }
        
        body.theme-aurora-boreal { --background: #0d1a26; --surface: rgba(22, 34, 48, 0.85); --primary: #50E3C2; --primary-rgb: 80, 227, 194; --primary-light: rgba(80, 227, 194, 0.15); --text-primary: #E0F5FF; --text-secondary: #A0B8D0; --border-color: rgba(80, 227, 194, 0.2); --shadow-color: rgba(0, 0, 0, 0.25); background: linear-gradient(-45deg, #0d1a26, #1a3a52, #3c164f, #1a233b); }
        body.theme-aurora-sunrise { --background: #fff8f0; --surface: rgba(255, 255, 255, 0.9); --primary: #FF7B54; --primary-rgb: 255, 123, 84; --primary-light: #FFF0EB; --text-primary: #6B3E2E; --text-secondary: #A87E70; --border-color: #FCE8E0; --shadow-color: rgba(107, 62, 46, 0.15); background: linear-gradient(-45deg, #FFDAB9, #FFA07A, #FFFFE0, #FFC0CB); }
        body.theme-aurora-twilight { --background: #1e1e2f; --surface: rgba(38, 38, 59, 0.9); --primary: #C792EA; --primary-rgb: 199, 146, 234; --primary-light: rgba(199, 146, 234, 0.15); --text-primary: #E6E0FF; --text-secondary: #9E93B3; --border-color: rgba(199, 146, 234, 0.2); --shadow-color: rgba(0, 0, 0, 0.25); background: linear-gradient(-45deg, #1e1e2f, #3a2e5d, #6a538d, #2f274a); }
        body.theme-aurora-cosmos { --background: #000428; --surface: rgba(10, 15, 52, 0.85); --primary: #00AEEF; --primary-rgb: 0, 174, 239; --primary-light: rgba(0, 174, 239, 0.15); --text-primary: #FFFFFF; --text-secondary: #A3B0E1; --border-color: rgba(0, 174, 239, 0.25); --shadow-color: rgba(0, 0, 0, 0.3); background: linear-gradient(-45deg, #000428, #004e92, #072a4f, #000a3a); }
        body.theme-aurora-nebula { --background: #2a0a4a; --surface: rgba(40, 15, 70, 0.9); --primary: #F050C5; --primary-rgb: 240, 80, 197; --primary-light: rgba(240, 80, 197, 0.15); --text-primary: #F5E8FF; --text-secondary: #B59AC9; --border-color: rgba(240, 80, 197, 0.2); --shadow-color: rgba(0, 0, 0, 0.25); background: linear-gradient(-45deg, #2a0a4a, #da2a9a, #751a75, #411059); }
        body.theme-aurora-forest { --background: #0d2618; --surface: rgba(23, 45, 32, 0.85); --primary: #4CAF50; --primary-rgb: 76, 175, 80; --primary-light: rgba(76, 175, 80, 0.15); --text-primary: #E8F5E9; --text-secondary: #A5D6A7; --border-color: rgba(76, 175, 80, 0.2); --shadow-color: rgba(0, 0, 0, 0.25); background: linear-gradient(-45deg, #0d2618, #1b5e20, #2e7d32, #1b5e20); }
        body.theme-aurora-sunset { --background: #2c0d2c; --surface: rgba(54, 20, 54, 0.85); --primary: #FF8A65; --primary-rgb: 255, 138, 101; --primary-light: rgba(255, 138, 101, 0.15); --text-primary: #FFEBEE; --text-secondary: #E1BEE7; --border-color: rgba(255, 138, 101, 0.2); --shadow-color: rgba(0, 0, 0, 0.25); background: linear-gradient(-45deg, #2c0d2c, #6a1b9a, #ad1457, #8e24aa); }
        body.theme-aurora-midnight { --background: #0a0a1a; --surface: rgba(20, 20, 40, 0.85); --primary: #7986CB; --primary-rgb: 121, 134, 203; --primary-light: rgba(121, 134, 203, 0.15); --text-primary: #E8EAF6; --text-secondary: #C5CAE9; --border-color: rgba(121, 134, 203, 0.2); --shadow-color: rgba(0, 0, 0, 0.25); background: linear-gradient(-45deg, #0a0a1a, #283593, #3949AB, #1A237E); }
        body.theme-aurora-cottoncandy { --background: #fce4ec; --surface: rgba(255, 255, 255, 0.9); --primary: #F8BBD0; --primary-rgb: 248, 187, 208; --primary-light: rgba(248, 187, 208, 0.2); --text-primary: #880E4F; --text-secondary: #AD1457; --border-color: rgba(248, 187, 208, 0.4); --shadow-color: rgba(136, 14, 79, 0.1); background: linear-gradient(-45deg, #fce4ec, #f8bbd0, #f48fb1, #ff80ab); }
        body.theme-aurora-golden { --background: #fffde7; --surface: rgba(255, 253, 231, 0.9); --primary: #FFD54F; --primary-rgb: 255, 213, 79; --primary-light: rgba(255, 213, 79, 0.2); --text-primary: #5D4037; --text-secondary: #8D6E63; --border-color: rgba(255, 213, 79, 0.4); --shadow-color: rgba(93, 64, 55, 0.1); background: linear-gradient(-45deg, #fffde7, #fff9c4, #fff59d, #ffeb3b); }
        
        /* --- NEW THEMES --- */
        body.theme-cyberpunk { --background: #0d0221; --surface: rgba(26, 7, 65, 0.8); --primary: #ff00ff; --primary-rgb: 255, 0, 255; --primary-light: rgba(255, 0, 255, 0.1); --text-primary: #00f0ff; --text-secondary: #a960ff; --border-color: rgba(0, 240, 255, 0.3); --shadow-color: rgba(255, 0, 255, 0.2); background: linear-gradient(45deg, #0d0221, #241452, #0d0221); }
        body.theme-earthy { --background: #EAE7DC; --surface: rgba(255, 255, 255, 0.8); --primary: #8E8D8A; --primary-rgb: 142, 141, 138; --primary-light: #D8C3A5; --text-primary: #E85A4F; --text-secondary: #8E8D8A; --border-color: #E98074; --shadow-color: rgba(142, 141, 138, 0.15); }
        body.theme-minimalist-dark { --background: #121212; --surface: rgba(28, 28, 28, 0.8); --primary: #FFFFFF; --primary-rgb: 255, 255, 255; --primary-light: #333333; --text-primary: #FFFFFF; --text-secondary: #AAAAAA; --border-color: rgba(255, 255, 255, 0.2); --shadow-color: rgba(0, 0, 0, 0.5); }
        body.theme-minimalist-light { --background: #FFFFFF; --surface: rgba(245, 245, 245, 0.8); --primary: #121212; --primary-rgb: 18, 18, 18; --primary-light: #EEEEEE; --text-primary: #121212; --text-secondary: #666666; --border-color: rgba(0, 0, 0, 0.1); --shadow-color: rgba(0, 0, 0, 0.05); }


        body[class*="theme-aurora"] {
            background-size: 400% 400%; animation: auroraGradient 20s ease infinite;
        }

        /* Enhanced glass effect */
        .glass-effect {
            background: var(--surface);
            backdrop-filter: var(--blur-effect);
            -webkit-backdrop-filter: var(--blur-effect);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        /* General Body styles */
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.5s ease, color 0.5s ease;
            overflow-x: hidden;
            background: var(--background);
            padding: 20px;
            box-sizing: border-box;
        }

        .app-container {
            width: 95%;
            max-width: 1200px;
            min-height: 90vh;
            height: auto;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 2;
            transition: opacity 0.5s, transform 0.5s;
        }
        
        /* Apply glass effect directly to the container */
        .app-container {
             background: var(--surface);
            backdrop-filter: var(--blur-effect);
            -webkit-backdrop-filter: var(--blur-effect);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        @media (min-width: 768px) { .app-container { flex-direction: row; height: 90vh; } }
        .app-container.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }

        .icon-sidebar {
            width: 100%;
            padding: 10px;
            display: flex;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
        }
        @media (min-width: 768px) { .icon-sidebar { width: 70px; flex-shrink: 0; border-right: 1px solid var(--border-color); border-bottom: none; padding: 20px 0; flex-direction: column; align-items: center; gap: 15px; } }

        .icon-sidebar button {
            background: rgba(var(--primary-rgb), 0.1);
            border: none;
            color: var(--text-primary);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 5px;
        }
        @media (min-width: 768px) { .icon-sidebar button { margin: 0; } }
        .icon-sidebar button svg { width: 24px; height: 24px; fill: var(--text-primary); }
        .icon-sidebar button:hover { background: rgba(var(--primary-rgb), 0.2); transform: scale(1.1); }
        
        .main-content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        @media (min-width: 768px) { .main-content { padding: 30px; } }
        #calendar-view { display: flex; flex-direction: column; height: 100%; }
        #welcome-view { text-align: center; margin: auto; display: none; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; margin-bottom: 20px; }
        header h1 { font-size: 1.5rem; }
        @media (min-width: 768px) { header h1 { font-size: 2rem; } }
        
        .calendar-nav button { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-primary); transition: transform 0.2s ease; }
        .calendar-nav button:hover { transform: scale(1.2); }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; flex-grow: 1; }
        @media (min-width: 768px) { .calendar-grid { gap: 10px; } }
        
        .calendar-grid div { padding: 8px; border-radius: 12px; cursor: pointer; transition: background-color 0.3s ease; position: relative; min-height: 40px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        @media (min-width: 768px) { .calendar-grid div { padding: 10px; min-height: 60px; font-size: 1rem; } }
        
        .calendar-grid .day-name { font-weight: 600; color: var(--text-secondary); cursor: default; }
        .calendar-grid .calendar-day:not(.day-name):hover { background: var(--primary-light); }
        .calendar-grid .today { background-color: var(--primary-light); color: var(--primary); font-weight: 600; border: 1px solid var(--primary); }
        .calendar-grid .selected { background-color: var(--primary-light); border: 1px solid var(--primary); }
        
        .calendar-grid .has-tasks::after { content: ''; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: var(--primary); border-radius: 50%; }
        .calendar-grid .has-completed-tasks::after { background-color: var(--success); }

        #welcome-view h2 { font-size: 1.8rem; font-weight: 500; margin-bottom: 10px; }
        @media (min-width: 768px) { #welcome-view h2 { font-size: 2.5rem; } }
        #welcome-view p { color: var(--text-secondary); margin-bottom: 20px; }

        .task-sidebar { width: 100%; flex-shrink: 0; background: transparent; padding: 20px; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; overflow-y: auto; }
        @media (min-width: 768px) { .task-sidebar { width: 350px; border-top: none; border-left: 1px solid var(--border-color); } }
        
        .task-card {
             background: var(--surface);
            backdrop-filter: var(--blur-effect);
            -webkit-backdrop-filter: var(--blur-effect);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            border: 1px solid var(--border-color);
            padding: 15px; margin-bottom: 15px; 
        }
        @media (min-width: 768px) { .task-card { padding: 20px; margin-bottom: 20px; } }

        #new-task-form h3 { margin-top: 0; margin-bottom: 15px; color: var(--text-primary); }
        #new-task-form .time-inputs { display: flex; gap: 10px; }
        #new-task-form input, #new-task-form textarea, #new-task-form button, #new-task-form #task-date { 
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid var(--border-color); box-sizing: border-box; background: var(--primary-light); color: var(--text-primary); font-family: 'Poppins', sans-serif; 
        }
        #new-task-form input::placeholder, #new-task-form textarea::placeholder { color: var(--text-secondary); }
        .duration-inputs { display: flex; gap: 10px; }
        .duration-inputs input { flex: 1; }
        .or-divider { text-align: center; margin: 10px 0; color: var(--text-secondary); font-size: 0.9em; }
        #new-task-form button[type="submit"] { background-color: var(--primary); font-size: 16px; cursor: pointer; color: white; transition: var(--transition); font-weight: 500; border: none; }
        #new-task-form button[type="submit"]:hover { filter: brightness(1.1); }

        /* Animation for new tasks */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        #task-list .task-item { display: flex; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); transition: opacity 0.3s ease; animation: slideIn 0.5s ease-out forwards; }
        #task-list .task-item:last-child { border-bottom: none; }
        #task-list .task-item-content { flex-grow: 1; overflow: hidden; }
        #task-list .task-item-icon { margin-right: 15px; font-size: 20px; color: var(--primary); flex-shrink: 0; }
        #task-list .task-item button { background: none; border: none; cursor: pointer; padding: 5px; color: var(--text-primary); font-size: 16px; flex-shrink: 0; }
        #task-list .task-item-meta, #task-list .task-notes { font-size: 0.9em; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #task-list .task-notes { margin-top: 5px; font-size: 0.85em; }
        #task-list .start-focus { font-weight: bold; color: var(--primary); }
        #task-list .task-item.completed { opacity: 0.7; }
        #task-list .task-item.completed .task-item-content { text-decoration: line-through; color: var(--text-secondary); }
        #task-list .task-item.completed .task-item-icon { color: var(--success); }

        .focus-view-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .focus-view-container.visible { display: flex; opacity: 1; }
        .color-fill-bg { position: absolute; top: 0; left: 0; width: 100%; height: 0; z-index: -1; transition: height 1s linear, background-color 0.4s ease; }
        .focus-content { text-align: center; color: #fff; padding: 20px; max-width: 90%; text-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        
        #focus-task-icon { font-size: 2.5em; margin-bottom: 10px; }
        @media (min-width: 768px) { #focus-task-icon { font-size: 3em; } }
        .focus-content h2 { font-size: 2rem; font-weight: 500; margin-bottom: 10px; word-break: break-word; }
        @media (min-width: 768px) { .focus-content h2 { font-size: 3em; } }
        
        #focus-timer { font-size: 3.5rem; margin: 20px 0; font-weight: 300; letter-spacing: 2px; }
        @media (min-width: 768px) { #focus-timer { font-size: 7em; } }
        
        #focus-status-text { font-size: 1.2em; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 20px; min-height: 30px; }
        @media (min-width: 768px) { #focus-status-text { font-size: 1.5em; } }
        
        .focus-controls { display: flex; flex-wrap: wrap; justify-content: center; }
        .focus-controls button { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 12px 20px; margin: 8px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background 0.3s; min-width: 140px; }
        @media (min-width: 768px) { .focus-controls button { padding: 12px 24px; margin: 10px; min-width: 160px; font-size: 18px; } }
        .focus-controls button:hover { background: rgba(255, 255, 255, 0.2); }
        
        .pomodoro-info { margin-top: 20px; font-size: 1rem; }
        @media (min-width: 768px) { .pomodoro-info { font-size: 1.2em; } }
        .pomodoro-session { display: inline-block; background: rgba(255, 255, 255, 0.2); padding: 5px 15px; border-radius: 20px; margin-top: 10px; }

        .pomodoro-button { margin-top: 20px; background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: var(--transition); }
        .pomodoro-button:hover { filter: brightness(1.1); }

        .settings-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; z-index: 1000; width: 90%; max-width: 450px; display: none; }
        .settings-panel {
             background: var(--surface);
            backdrop-filter: var(--blur-effect);
            -webkit-backdrop-filter: var(--blur-effect);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        .settings-panel h3 { margin-top: 0; margin-bottom: 20px; text-align: center; }
        .settings-option { margin-bottom: 15px; }
        .settings-option label { display: block; margin-bottom: 5px; font-weight: 500; }
        .settings-option input[type="range"], .settings-option input[type="time"] { width: 100%; }
        .work-hours-inputs { display: flex; gap: 10px; align-items: center; }
        .settings-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        .settings-buttons button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; }
        #save-settings { background-color: var(--primary); color: white; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); z-index: 999; display: none; }
        
        /* Theme Dashboard */
        .theme-dashboard { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; z-index: 1000; width: 90%; max-width: 600px; display: none; max-height: 80vh; overflow-y: auto; }
        .theme-dashboard {
            background: var(--surface);
            backdrop-filter: var(--blur-effect);
            -webkit-backdrop-filter: var(--blur-effect);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        .theme-dashboard h3 { margin-top: 0; margin-bottom: 20px; text-align: center; }
        .theme-categories { display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .theme-category { padding: 10px 15px; cursor: pointer; transition: var(--transition); }
        .theme-category.active { border-bottom: 2px solid var(--primary); font-weight: 500; }
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; margin-top: 15px; }
        .theme-item { height: 80px; border-radius: 12px; cursor: pointer; transition: var(--transition); position: relative; overflow: hidden; }
        .theme-item:hover { transform: scale(1.05); }
        .theme-item.active { box-shadow: 0 0 0 3px var(--primary); }
        .theme-item .theme-name { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.6); color: white; padding: 5px; font-size: 0.8em; text-align: center; }
        
        /* AI Assistant */
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.4); } 70% { box-shadow: 0 0 0 10px rgba(var(--primary-rgb), 0); } 100% { box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0); } }
        .ai-assistant-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; z-index: 10; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); display: flex; align-items: center; justify-content: center; transition: var(--transition); animation: pulse 2s infinite; }
        .ai-assistant-btn:hover { transform: scale(1.1); animation-play-state: paused; }
        .ai-assistant-btn i { font-size: 24px; }
        
        .ai-assistant-panel { position: fixed; bottom: 90px; right: 20px; width: 350px; max-height: 500px; z-index: 1000; display: none; flex-direction: column; }
        .ai-assistant-panel {
            background: var(--surface);
            backdrop-filter: var(--blur-effect);
            -webkit-backdrop-filter: var(--blur-effect);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        .ai-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .ai-header h4 { margin: 0; }
        .ai-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-primary); }
        .ai-conversation { flex-grow: 1; padding: 15px; overflow-y: auto; max-height: 350px; }
        .ai-message { margin-bottom: 15px; padding: 10px; border-radius: 10px; max-width: 80%; line-break: anywhere; }
        .ai-user { background: var(--primary-light); margin-left: auto; }
        .ai-bot { background: var(--surface); margin-right: auto; }
        .ai-input-area { padding: 15px; border-top: 1px solid var(--border-color); display: flex; }
        .ai-input { flex-grow: 1; padding: 10px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--primary-light); color: var(--text-primary); }
        .ai-send { background: var(--primary); color: white; border: none; border-radius: 20px; padding: 10px 15px; margin-left: 10px; cursor: pointer; }
        
        /* Enhanced UI elements */
        .enhanced-button {
            background: rgba(var(--primary-rgb), 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .enhanced-button:hover {
            background: rgba(var(--primary-rgb), 0.2);
            transform: translateY(-2px);
        }
        
        .stats-card {
            background: var(--surface);
            backdrop-filter: var(--blur-effect);
            -webkit-backdrop-filter: var(--blur-effect);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .stats-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Focus Lock Screen */
        #focus-lock-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none; /* Changed from 'none' to 'flex' in JS */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            padding: 20px;
        }
        #focus-lock-overlay h2 { font-size: 2.5rem; margin-bottom: 15px; }
        #focus-lock-overlay p { font-size: 1.2rem; }

    </style>
</head>
<body>
    <audio id="complete-sound" src="https://actions.google.com/sounds/v1/alarms/notification_bell.ogg" preload="auto"></audio>

    <div class="overlay" id="settings-overlay"></div>

    <!-- NEW Focus Lock Screen -->
    <div id="focus-lock-overlay">
        <div class="focus-lock-content">
            <h2>Time to Rest</h2>
            <p>Come back during your scheduled work hours to focus.</p>
        </div>
    </div>
    
    <!-- AI Assistant Button -->
    <button class="ai-assistant-btn" id="ai-assistant-btn">
        <i class="fas fa-wand-magic-sparkles"></i>
    </button>
    
    <!-- AI Assistant Panel -->
    <div class="ai-assistant-panel" id="ai-assistant-panel">
        <div class="ai-header">
            <h4>AI Focus Assistant</h4>
            <button class="ai-close" id="ai-close">&times;</button>
        </div>
        <div class="ai-conversation" id="ai-conversation">
            <div class="ai-message ai-bot">
                Hello! How can I help you focus today? Try: "Schedule physics study for 45 minutes" or "Add work from 3pm to 4:30pm". You can also ask me to "motivate me" or ask for "help".
            </div>
        </div>
        <div class="ai-input-area">
            <input type="text" class="ai-input" id="ai-input" placeholder="Ask me to create a task...">
            <button class="ai-send" id="ai-send"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="app-container">
        <div class="icon-sidebar">
             <button id="calendar-toggle-btn" title="Toggle Calendar">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 3H21C21.5523 3 22 3.44772 22 4V20C22 20.5523 21.5523 21 21 21H3C2.44772 21 2 20.5523 2 20V4C2 3.44772 2.44772 3 3 3H7V1H9V3H15V1H17V3ZM4 9V19H20V9H4ZM6 11H8V13H6V11ZM11 11H13V13H11V11ZM16 11H18V13H16V11Z"></path></svg>
            </button>
            <button id="pomodoro-mode-btn" title="Pomodoro Technique">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-1-9V7h2v6h-2zm0 4v-2h2v2h-2z"/></svg>
            </button>
            <button id="theme-dashboard-btn" title="Themes">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 22C6.49 22 2 17.51 2 12S6.49 2 12 2s10 4.49 10 10-4.49 10-10 10zm0-18c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8z"/><circle cx="12" cy="12" r="5" fill="currentColor"/></svg>
            </button>
            <button id="settings-btn" title="Settings">
                 <!-- Updated Settings Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M14 6V4h-4v2h4zm-2-5c4.97 0 9 4.03 9 9s-4.03 9-9 9-9-4.03-9-9 4.03-9 9-9zm7 9c0-3.86-3.14-7-7-7s-7 3.14-7 7 3.14 7 7 7 7-3.14 7-7zm-7 5c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/></svg>
            </button>
        </div>
        <div class="main-content">
            <div id="welcome-view">
                <h2>Welcome to Focus Timer</h2>
                <p>Select a task or open the calendar to get started.</p>
                <button class="pomodoro-button" id="pomodoro-btn">Try Pomodoro Technique</button>
                
                <div class="stats-card">
                    <div class="stats-label">Total Focus Time Today</div>
                    <div class="stats-number" id="today-focus-time">0h 0m</div>
                    <div class="stats-label">Tasks Completed</div>
                    <div class="stats-number" id="tasks-completed">0</div>
                </div>
            </div>
            <div id="calendar-view">
                <header>
                    <h1 id="month-year">September 2025</h1>
                    <div class="calendar-nav">
                        <button id="prev-month">&lt;</button>
                        <button id="next-month">&gt;</button>
                    </div>
                </header>
                <div class="calendar-grid"></div>
            </div>
        </div>
        <div class="task-sidebar">
             <div class="task-card">
                 <form id="new-task-form">
                    <h3>New Task</h3>
                     <input type="text" id="task-name" placeholder="What is your focus?" required list="task-suggestions">
                     <datalist id="task-suggestions">
                         <option value="Work on project">
                         <option value="Study for exam">
                         <option value="Read a book">
                         <option value="Exercise">
                         <option value="Meditate">
                         <option value="Coding session">
                         <option value="Writing session">
                         <option value="Language learning">
                         <option value="Research">
                         <option value="Planning">
                         <option value="Physics homework">
                         <option value="Math practice">
                         <option value="Chemistry lab report">
                         <option value="Unwind and relax">
                     </datalist>
                     <input type="date" id="task-date" required>
                      <div class="time-inputs">
                        <input type="time" id="task-start-time" title="Start Time">
                        <input type="time" id="task-end-time" title="End Time">
                      </div>
                      <div class="or-divider">OR</div>
                     <div class="duration-inputs">
                         <input type="number" id="task-hours" placeholder="Hours" min="0" max="12">
                         <input type="number" id="task-minutes" placeholder="Minutes" min="0" max="59">
                     </div>
                     <textarea id="task-notes" placeholder="Notes..."></textarea>
                     <button type="submit">Create Task</button>
                 </form>
             </div>
             <div id="task-list" class="task-card"></div>
        </div>
    </div>

    <div class="focus-view-container" id="focus-view">
        <div class="color-fill-bg" id="color-fill-bg"></div>
        <div class="focus-content" id="focus-content">
            <div id="focus-task-icon"></div>
            <h2 id="focus-task-name"></h2>
            <div id="focus-timer">00:00:00</div>
            <p id="focus-status-text">Remaining</p>
            <div class="pomodoro-info" id="pomodoro-info" style="display: none;">
                <div>Session: <span id="current-pomodoro">1</span> of 4</div>
                <div class="pomodoro-session" id="pomodoro-session-type">Focus Time</div>
            </div>
            <div class="focus-controls">
                <button id="pause-resume-btn">Pause</button>
                <button id="complete-btn">✓ Mark Complete</button>
                <button id="exit-focus-btn">Exit Focus</button>
            </div>
        </div>
    </div>

    <div class="settings-panel" id="settings-panel">
        <h3>Settings</h3>
        <div class="settings-option">
            <label for="blur-intensity">Blur Intensity</label>
            <input type="range" id="blur-intensity" min="0" max="40" step="1" value="20">
            <span id="blur-value">20px</span>
        </div>
        <div class="settings-option">
            <label for="auto-delete">Auto-delete completed tasks after</label>
            <select id="auto-delete">
                <option value="0">Never</option>
                <option value="1">1 day</option>
                <option value="3">3 days</option>
                <option value="7">1 week</option>
                <option value="30">1 month</option>
            </select>
        </div>
        <hr>
        <h4>Pomodoro</h4>
        <div class="settings-option">
            <label for="pomodoro-duration">Pomodoro Duration (minutes)</label>
            <input type="number" id="pomodoro-duration" min="5" max="60" value="25">
        </div>
        <div class="settings-option">
            <label for="break-duration">Short Break (minutes)</label>
            <input type="number" id="break-duration" min="1" max="30" value="5">
        </div>
         <div class="settings-option">
            <label for="long-break-duration">Long Break (minutes)</label>
            <input type="number" id="long-break-duration" min="5" max="60" value="15">
        </div>
        <hr>
        <h4>Work Hours</h4>
        <div class="settings-option">
             <label><input type="checkbox" id="work-hours-enabled"> Enforce work hours</label>
        </div>
        <div class="settings-option" id="work-hours-inputs" style="display: none;">
             <label for="work-hours-start">From</label>
             <input type="time" id="work-hours-start">
             <label for="work-hours-end">To</label>
             <input type="time" id="work-hours-end">
         </div>
        <div class="settings-buttons">
            <button id="cancel-settings">Cancel</button>
            <button id="save-settings">Save</button>
        </div>
    </div>
    
    <!-- Theme Dashboard -->
    <div class="theme-dashboard" id="theme-dashboard">
        <h3>Choose a Theme</h3>
        <div class="theme-categories">
            <div class="theme-category active" data-category="all">All</div>
            <div class="theme-category" data-category="light">Light</div>
            <div class="theme-category" data-category="dark">Dark</div>
            <div class="theme-category" data-category="glass">Glass</div>
            <div class="theme-category" data-category="aurora">Aurora</div>
        </div>
        <div class="theme-grid" id="theme-grid">
            <!-- Themes will be populated by JavaScript -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element Selection ---
            const appContainer = document.querySelector('.app-container');
            const calendarView = document.getElementById('calendar-view');
            const welcomeView = document.getElementById('welcome-view');
            const calendarToggleBtn = document.getElementById('calendar-toggle-btn');
            const pomodoroModeBtn = document.getElementById('pomodoro-mode-btn');
            const themeDashboardBtn = document.getElementById('theme-dashboard-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const pomodoroBtn = document.getElementById('pomodoro-btn');
            const monthYearEl = document.getElementById('month-year');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const calendarGrid = document.querySelector('.calendar-grid');
            const taskForm = document.getElementById('new-task-form');
            const taskNameInput = document.getElementById('task-name');
            const taskDateInput = document.getElementById('task-date');
            const taskStartTimeInput = document.getElementById('task-start-time');
            const taskEndTimeInput = document.getElementById('task-end-time');
            const taskHoursInput = document.getElementById('task-hours');
            const taskMinutesInput = document.getElementById('task-minutes');
            const taskNotesInput = document.getElementById('task-notes');
            const taskListEl = document.getElementById('task-list');
            const focusView = document.getElementById('focus-view');
            const colorFillBg = document.getElementById('color-fill-bg');
            const focusTaskIconEl = document.getElementById('focus-task-icon');
            const focusTaskNameEl = document.getElementById('focus-task-name');
            const focusTimerEl = document.getElementById('focus-timer');
            const focusStatusTextEl = document.getElementById('focus-status-text');
            const pauseResumeBtn = document.getElementById('pause-resume-btn');
            const completeBtn = document.getElementById('complete-btn');
            const exitFocusBtn = document.getElementById('exit-focus-btn');
            const pomodoroInfo = document.getElementById('pomodoro-info');
            const currentPomodoroEl = document.getElementById('current-pomodoro');
            const pomodoroSessionTypeEl = document.getElementById('pomodoro-session-type');
            const settingsPanel = document.getElementById('settings-panel');
            const settingsOverlay = document.getElementById('settings-overlay');
            const blurIntensityInput = document.getElementById('blur-intensity');
            const blurValueDisplay = document.getElementById('blur-value');
            const autoDeleteSelect = document.getElementById('auto-delete');
            const pomodoroDurationInput = document.getElementById('pomodoro-duration');
            const breakDurationInput = document.getElementById('break-duration');
            const longBreakDurationInput = document.getElementById('long-break-duration');
            const saveSettingsBtn = document.getElementById('save-settings');
            const cancelSettingsBtn = document.getElementById('cancel-settings');
            const themeDashboard = document.getElementById('theme-dashboard');
            const themeGrid = document.getElementById('theme-grid');
            const themeCategories = document.querySelectorAll('.theme-category');
            const aiAssistantBtn = document.getElementById('ai-assistant-btn');
            const aiAssistantPanel = document.getElementById('ai-assistant-panel');
            const aiCloseBtn = document.getElementById('ai-close');
            const aiConversation = document.getElementById('ai-conversation');
            const aiInput = document.getElementById('ai-input');
            const aiSendBtn = document.getElementById('ai-send');
            const todayFocusTimeEl = document.getElementById('today-focus-time');
            const tasksCompletedEl = document.getElementById('tasks-completed');
            const completeSound = document.getElementById('complete-sound');
            const focusLockOverlay = document.getElementById('focus-lock-overlay');
            const workHoursEnabled = document.getElementById('work-hours-enabled');
            const workHoursInputs = document.getElementById('work-hours-inputs');
            const workHoursStart = document.getElementById('work-hours-start');
            const workHoursEnd = document.getElementById('work-hours-end');
            
            // --- ALL THEMES ---
            const ALL_THEMES = [
                {name: 'Cozy Mocha', value: 'default', category: 'light', color: '#8D6E63'},
                {name: 'Sage', value: 'theme-sage', category: 'light', color: '#799975'},
                {name: 'Rose', value: 'theme-rose', category: 'light', color: '#D4A6B2'},
                {name: 'Mist', value: 'theme-mist', category: 'light', color: '#94AEC3'},
                {name: 'Sand', value: 'theme-sand', category: 'light', color: '#D6BA9A'},
                {name: 'Lavender', value: 'theme-lavender', category: 'light', color: '#9E8FB2'},
                {name: 'Ocean', value: 'theme-ocean', category: 'light', color: '#7AB3D0'},
                {name: 'Citrus', value: 'theme-citrus', category: 'light', color: '#E3C567'},
                {name: 'Berry', value: 'theme-berry', category: 'light', color: '#D6729B'},
                {name: 'Minimalist Light', value: 'theme-minimalist-light', category: 'light', color: '#f5f5f5'},
                {name: 'Dark Mode', value: 'dark-mode', category: 'dark', color: '#1E1E2E'},
                {name: 'Cyberpunk', value: 'theme-cyberpunk', category: 'dark', color: 'linear-gradient(45deg, #0d0221, #241452, #0d0221)'},
                {name: 'Earthy', value: 'theme-earthy', category: 'light', color: '#D8C3A5'},
                {name: 'Minimalist Dark', value: 'theme-minimalist-dark', category: 'dark', color: '#121212'},
                {name: 'Emerald Glass', value: 'theme-glass-emerald', category: 'glass', color: 'rgba(46, 125, 50, 0.8)'},
                {name: 'Sapphire Glass', value: 'theme-glass-sapphire', category: 'glass', color: 'rgba(21, 101, 192, 0.8)'},
                {name: 'Ruby Glass', value: 'theme-glass-ruby', category: 'glass', color: 'rgba(198, 40, 40, 0.8)'},
                {name: 'Amethyst Glass', value: 'theme-glass-amethyst', category: 'glass', color: 'rgba(106, 27, 154, 0.8)'},
                {name: 'Obsidian Glass', value: 'theme-glass-obsidian', category: 'glass', color: 'rgba(50, 50, 50, 0.8)'},
                {name: 'Aurora Boreal', value: 'theme-aurora-boreal', category: 'aurora', color: 'linear-gradient(-45deg, #0d1a26, #1a3a52, #3c164f, #1a233b)'},
                {name: 'Aurora Twilight', value: 'theme-aurora-twilight', category: 'aurora', color: 'linear-gradient(-45deg, #1e1e2f, #3a2e5d, #6a538d, #2f274a)'},
                {name: 'Aurora Cosmos', value: 'theme-aurora-cosmos', category: 'aurora', color: 'linear-gradient(-45deg, #000428, #004e92, #072a4f, #000a3a)'},
                {name: 'Aurora Nebula', value: 'theme-aurora-nebula', category: 'aurora', color: 'linear-gradient(-45deg, #2a0a4a, #da2a9a, #751a75, #411059)'},
                {name: 'Aurora Forest', value: 'theme-aurora-forest', category: 'aurora', color: 'linear-gradient(-45deg, #0d2618, #1b5e20, #2e7d32, #1b5e20)'},
                {name: 'Aurora Sunset', value: 'theme-aurora-sunset', category: 'aurora', color: 'linear-gradient(-45deg, #2c0d2c, #6a1b9a, #ad1457, #8e24aa)'},
                {name: 'Aurora Midnight', value: 'theme-aurora-midnight', category: 'aurora', color: 'linear-gradient(-45deg, #0a0a1a, #283593, #3949AB, #1A237E)'},
                {name: 'Aurora Sunrise', value: 'theme-aurora-sunrise', category: 'aurora', color: 'linear-gradient(-45deg, #FFDAB9, #FFA07A, #FFFFE0, #FFC0CB)'},
                {name: 'Cotton Candy', value: 'theme-aurora-cottoncandy', category: 'aurora', color: 'linear-gradient(-45deg, #fce4ec, #f8bbd0, #f48fb1, #ff80ab)'},
                {name: 'Golden Hour', value: 'theme-aurora-golden', category: 'aurora', color: 'linear-gradient(-45deg, #fffde7, #fff9c4, #fff59d, #ffeb3b)'},
            ];

            // --- State Management ---
            let currentDate = new Date();
            let tasks = [];
            let timerInterval;
            let timeRemaining;
            let isPaused = false;
            let currentTaskName = '';
            let totalDuration;
            let currentTaskID = null;
            let isPomodoroMode = false;
            let pomodoroCount = 0;
            let isBreakTime = false;
            let selectedCalendarDate = null;
            let blurIntensity = 20;
            let pomodoroDuration = 25;
            let breakDuration = 5;
            let longBreakDuration = 15;
            let todayFocusTime = 0;
            let todayTasksCompleted = 0;
            let workHoursCheckInterval;
            
            // --- Helper Functions ---
            /**
             * Safely formats a Date object to a YYYY-MM-DD string in local time.
             * @param {Date} date The date to format.
             * @returns {string} The formatted date string.
             */
            const toYYYYMMDD = (date) => {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };
            
            // --- Theme Management ---
            const applyTheme = (theme) => {
                document.body.className = ''; // Clear all classes
                if (theme && theme !== 'default') {
                    document.body.classList.add(theme);
                }
                localStorage.setItem('focusTimerTheme', theme);
                document.querySelectorAll('.theme-item.active').forEach(item => item.classList.remove('active'));
                const activeThemeItem = document.querySelector(`.theme-item[data-theme="${theme}"]`);
                if (activeThemeItem) activeThemeItem.classList.add('active');
            };
            
            const populateThemeDashboard = () => {
                themeGrid.innerHTML = '';
                const currentTheme = localStorage.getItem('focusTimerTheme') || 'default';

                ALL_THEMES.forEach(theme => {
                    const themeItem = document.createElement('div');
                    themeItem.className = 'theme-item';
                    themeItem.dataset.theme = theme.value;
                    themeItem.dataset.category = theme.category;
                    themeItem.style.background = theme.color;
                    
                    const themeName = document.createElement('div');
                    themeName.className = 'theme-name';
                    themeName.textContent = theme.name;
                    themeItem.appendChild(themeName);
                    
                    if (theme.value === currentTheme) themeItem.classList.add('active');
                    
                    themeItem.addEventListener('click', () => applyTheme(theme.value));
                    themeGrid.appendChild(themeItem);
                });
            };
            
            const filterThemes = (category) => {
                document.querySelectorAll('.theme-item').forEach(item => {
                    if (category === 'all' || item.dataset.category === category) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            };

            // --- Task Persistence ---
            const saveTasks = () => localStorage.setItem('focusTimerTasks', JSON.stringify(tasks));
            const loadTasks = () => {
                const storedTasks = localStorage.getItem('focusTimerTasks');
                tasks = storedTasks ? JSON.parse(storedTasks).map(task => ({
                    ...task,
                    id: task.id || Date.now() + Math.random().toString(16).slice(2),
                    completed: task.completed || false,
                    createdAt: task.createdAt || new Date().toISOString() 
                })) : [];
                cleanupOldTasks();
            };

            const cleanupOldTasks = () => {
                const autoDeleteDays = parseInt(localStorage.getItem('autoDeleteDays') || '0');
                if (autoDeleteDays === 0) return;
                
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - autoDeleteDays);
                
                tasks = tasks.filter(task => !task.completed || !task.createdAt || new Date(task.createdAt) > cutoffDate);
                saveTasks();
            };
            
             // --- Sound Effects ---
            const playSound = () => {
                completeSound.currentTime = 0;
                completeSound.play().catch(error => console.log("Audio playback failed:", error));
            };

            // --- Calendar Logic ---
            const toggleCalendar = () => {
                const isVisible = calendarView.style.display !== 'none';
                calendarView.style.display = isVisible ? 'none' : 'flex';
                welcomeView.style.display = isVisible ? 'block' : 'none';
            };

            const renderCalendar = () => {
                calendarGrid.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                monthYearEl.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

                ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
                    const dayEl = document.createElement('div'); dayEl.className = 'day-name'; dayEl.textContent = day; calendarGrid.appendChild(dayEl);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                for (let i = 0; i < firstDayOfMonth; i++) calendarGrid.appendChild(document.createElement('div'));
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const todayStr = toYYYYMMDD(new Date());
                const selectedStr = selectedCalendarDate ? toYYYYMMDD(selectedCalendarDate) : null;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    dayEl.textContent = day;
                    dayEl.classList.add('calendar-day');
                    const dateObj = new Date(year, month, day);
                    const dateStr = toYYYYMMDD(dateObj);
                    
                    if (dateStr === todayStr) dayEl.classList.add('today');
                    if (dateStr === selectedStr) dayEl.classList.add('selected');
                    
                    const tasksForDay = tasks.filter(task => task.date === dateStr);
                    if (tasksForDay.length > 0) {
                        dayEl.classList.add('has-tasks');
                        if (tasksForDay.every(task => task.completed)) dayEl.classList.add('has-completed-tasks');
                    }
                    
                    dayEl.addEventListener('click', () => {
                        document.querySelector('.calendar-day.selected')?.classList.remove('selected');
                        dayEl.classList.add('selected');
                        selectedCalendarDate = dateObj;
                        taskDateInput.value = dateStr;
                        renderTasksForDate(selectedCalendarDate);
                    });
                    calendarGrid.appendChild(dayEl);
                }
            };
            
            const getIconForTask = (taskName) => {
                const name = taskName.toLowerCase();
                if (name.includes('study') || name.includes('exam') || name.includes('learn')) return 'fas fa-brain';
                if (name.includes('work') || name.includes('project') || name.includes('meeting')) return 'fas fa-briefcase';
                if (name.includes('read') || name.includes('book')) return 'fas fa-book';
                if (name.includes('gym') || name.includes('run') || name.includes('exercise')) return 'fas fa-dumbbell';
                if (name.includes('relax') || name.includes('meditate')) return 'fas fa-mug-hot';
                if (name.includes('code') || name.includes('program')) return 'fas fa-code';
                if (name.includes('write')) return 'fas fa-pen';
                if (name.includes('math')) return 'fas fa-calculator';
                if (name.includes('physics')) return 'fas fa-atom';
                if (name.includes('chem')) return 'fas fa-flask';
                if (name.includes('unwind')) return 'fas fa-couch';
                return 'fas fa-star';
            };

            const renderTasksForDate = (date) => {
                const dateStr = toYYYYMMDD(date);
                const tasksForDate = tasks.filter(task => task.date === dateStr).sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));
                taskListEl.innerHTML = `<h3>Tasks for ${date.toLocaleDateString()}</h3>`;
                
                if (tasksForDate.length === 0) {
                    taskListEl.innerHTML += '<p>No tasks. Add one!</p>';
                    return;
                }
                
                tasksForDate.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
                    const timeInfo = task.startTime ? `${task.startTime}${task.endTime ? ' - ' + task.endTime : ''}` : '';
                    const durationInfo = task.duration ? `${Math.floor(task.duration / 60)}h ${task.duration % 60}m` : '';
                    const meta = [timeInfo, durationInfo].filter(Boolean).join(' • ');
                    
                    taskItem.innerHTML = `
                        <div class="task-item-icon"><i class="${task.icon}"></i></div>
                        <div class="task-item-content">
                            <strong>${task.name}</strong>
                             ${meta ? `<p class="task-item-meta">${meta}</p>` : ''}
                             ${task.notes ? `<p class="notes">${task.notes}</p>` : ''}
                        </div>
                        <div>
                           ${!task.completed ? `<button class="start-focus" data-id="${task.id}" title="Start Focus" ${!task.duration ? 'disabled' : ''}><i class="fas fa-play"></i></button>` : ''}
                           <button class="complete-task" data-id="${task.id}" title="${task.completed ? 'Mark Incomplete' : 'Mark Complete'}">${task.completed ? '<i class="fas fa-undo"></i>' : '<i class="fas fa-check"></i>'}</button>
                           <button class="delete-task" data-id="${task.id}" title="Delete Task"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    taskListEl.appendChild(taskItem);
                });
            };

            const formatTime = (seconds) => {
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            };
            
            const handleTimerCompletion = () => {
                 clearInterval(timerInterval);
                 playSound();
                 
                 if (isPomodoroMode) {
                     if (!isBreakTime) {
                        pomodoroCount++;
                        updateStats(pomodoroDuration * 60, 0); // Log focus time
                        
                        if (pomodoroCount >= 4) { // Time for a long break
                            isBreakTime = true;
                            timeRemaining = totalDuration = longBreakDuration * 60;
                            focusStatusTextEl.textContent = `Long Break!`;
                            pomodoroSessionTypeEl.textContent = 'Long Break';
                            pomodoroCount = 0; // Reset for next cycle
                        } else { // Time for a short break
                            isBreakTime = true;
                            timeRemaining = totalDuration = breakDuration * 60;
                            focusStatusTextEl.textContent = `Pomodoro ${pomodoroCount} done. Time for a break!`;
                            pomodoroSessionTypeEl.textContent = 'Short Break';
                        }
                     } else { // Break finished, start next focus
                         isBreakTime = false;
                         timeRemaining = totalDuration = pomodoroDuration * 60;
                         currentPomodoroEl.textContent = pomodoroCount + 1;
                         focusStatusTextEl.textContent = 'Next session starting...';
                         pomodoroSessionTypeEl.textContent = 'Focus Time';
                     }
                     startTimer();
                 } else { // Regular task finished
                    focusStatusTextEl.textContent = `Session for "${currentTaskName}" completed!`;
                    if (currentTaskID) completeTask(currentTaskID, true); // Mark as complete and update stats
                    setTimeout(endFocusSession, 2000); // Wait 2s before exiting
                 }
            }

            const startTimer = () => {
                timerInterval = setInterval(() => {
                    if (isPaused) return;
                    if (timeRemaining <= 0) { handleTimerCompletion(); return; }
                    timeRemaining--;
                    const formattedTime = formatTime(timeRemaining);
                    focusTimerEl.textContent = formattedTime;
                    document.title = `${formattedTime} - ${currentTaskName}`;
                    colorFillBg.style.height = `${((totalDuration - timeRemaining) / totalDuration) * 100}%`;
                }, 1000);
            };

            const startFocusSession = (task, isPomodoro = false) => {
                appContainer.classList.add('hidden');
                
                setTimeout(() => {
                    focusView.classList.add('visible');
                    isPomodoroMode = isPomodoro;
                    
                    if (isPomodoro) {
                        pomodoroCount = 0; 
                        isBreakTime = false; 
                        totalDuration = pomodoroDuration * 60;
                        pomodoroInfo.style.display = 'block'; 
                        currentPomodoroEl.textContent = '1';
                        pomodoroSessionTypeEl.textContent = 'Focus Time';
                        completeBtn.style.display = 'none'; // Cannot "complete" a pomodoro session
                    } else {
                        totalDuration = task.duration * 60; 
                        pomodoroInfo.style.display = 'none';
                        completeBtn.style.display = 'inline-block';
                    }
                    
                    timeRemaining = totalDuration; 
                    currentTaskName = task.name; 
                    currentTaskID = task.id; 
                    isPaused = false;
                    
                    colorFillBg.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                    colorFillBg.style.height = '0%';
                    focusTaskIconEl.innerHTML = `<i class="${task.icon}"></i>`; 
                    focusTaskNameEl.textContent = task.name;
                    focusTimerEl.textContent = formatTime(timeRemaining); 
                    focusStatusTextEl.textContent = 'Remaining';
                    pauseResumeBtn.textContent = 'Pause';
                    
                    if (timerInterval) clearInterval(timerInterval);
                    startTimer();
                }, 500);
            };
            
            const togglePause = () => {
                isPaused = !isPaused; 
                pauseResumeBtn.textContent = isPaused ? 'Resume' : 'Pause';
            };
            
            const completeTask = (taskId, updateFocusTime = false) => {
                 if (!taskId) return;
                 const taskIndex = tasks.findIndex(t => t.id === taskId);
                 if (taskIndex === -1 || tasks[taskIndex].completed) return;
                 
                 tasks[taskIndex].completed = true;
                 
                 const focusTimeToAdd = updateFocusTime ? (tasks[taskIndex].duration * 60) : 0;
                 updateStats(focusTimeToAdd, 1);
                 
                 saveTasks();
            };

            const endFocusSession = () => {
                clearInterval(timerInterval); 
                focusView.classList.remove('visible');
                document.title = 'Focus Timer'; 
                isPomodoroMode = false;

                setTimeout(() => {
                    appContainer.classList.remove('hidden');
                    renderTasksForDate(selectedCalendarDate || new Date());
                    renderCalendar();
                }, 500);
            };

            const showSettings = () => { 
                settingsPanel.style.display = 'block'; 
                settingsOverlay.style.display = 'block';
                blurIntensityInput.value = blurIntensity; 
                blurValueDisplay.textContent = `${blurIntensity}px`;
                autoDeleteSelect.value = localStorage.getItem('autoDeleteDays') || '0';
                pomodoroDurationInput.value = pomodoroDuration;
                breakDurationInput.value = breakDuration;
                longBreakDurationInput.value = longBreakDuration;
                workHoursEnabled.checked = localStorage.getItem('workHoursEnabled') === 'true';
                workHoursStart.value = localStorage.getItem('workHoursStart') || '09:00';
                workHoursEnd.value = localStorage.getItem('workHoursEnd') || '17:00';
                workHoursInputs.style.display = workHoursEnabled.checked ? 'flex' : 'none';
            };
            
            const hideSettings = () => { 
                settingsPanel.style.display = 'none'; 
                settingsOverlay.style.display = 'none'; 
            };
            
            const showThemeDashboard = () => {
                themeDashboard.style.display = 'block';
                settingsOverlay.style.display = 'block';
            };
            
            const hideThemeDashboard = () => {
                themeDashboard.style.display = 'none';
                settingsOverlay.style.display = 'none';
            };

            const saveSettingsToStorage = () => {
                blurIntensity = parseInt(blurIntensityInput.value);
                document.documentElement.style.setProperty('--blur-effect', `blur(${blurIntensity}px)`);
                localStorage.setItem('blurIntensity', blurIntensity);
                
                localStorage.setItem('autoDeleteDays', autoDeleteSelect.value);
                
                pomodoroDuration = parseInt(pomodoroDurationInput.value);
                breakDuration = parseInt(breakDurationInput.value);
                longBreakDuration = parseInt(longBreakDurationInput.value);
                localStorage.setItem('pomodoroDuration', pomodoroDuration);
                localStorage.setItem('breakDuration', breakDuration);
                localStorage.setItem('longBreakDuration', longBreakDuration);

                localStorage.setItem('workHoursEnabled', workHoursEnabled.checked);
                localStorage.setItem('workHoursStart', workHoursStart.value);
                localStorage.setItem('workHoursEnd', workHoursEnd.value);
                checkFocusHours(); // Immediately check after saving
                
                cleanupOldTasks();
                hideSettings();
            };
            
             const checkFocusHours = () => {
                const isEnabled = localStorage.getItem('workHoursEnabled') === 'true';
                if (!isEnabled) {
                    focusLockOverlay.style.display = 'none';
                    return;
                }

                const startTime = localStorage.getItem('workHoursStart');
                const endTime = localStorage.getItem('workHoursEnd');

                if (!startTime || !endTime) {
                    focusLockOverlay.style.display = 'none';
                    return;
                }
                
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
                
                if (currentTime >= startTime && currentTime < endTime) {
                    focusLockOverlay.style.display = 'none'; // Inside work hours, so hide overlay
                } else {
                    focusLockOverlay.style.display = 'flex'; // Outside work hours, show overlay
                }
            };

            const updateStats = (focusSecondsToAdd, tasksCompletedToAdd) => {
                todayFocusTime += focusSecondsToAdd;
                todayTasksCompleted += tasksCompletedToAdd;

                const hours = Math.floor(todayFocusTime / 3600);
                const minutes = Math.floor((todayFocusTime % 3600) / 60);
                todayFocusTimeEl.textContent = `${hours}h ${minutes}m`;
                tasksCompletedEl.textContent = todayTasksCompleted;
                
                localStorage.setItem('todayFocusTime', todayFocusTime);
                localStorage.setItem('todayTasksCompleted', todayTasksCompleted);
                localStorage.setItem('lastStatsUpdate', new Date().toDateString());
            };
            
            const loadStats = () => {
                const lastUpdate = localStorage.getItem('lastStatsUpdate');
                const today = new Date().toDateString();
                
                if (lastUpdate !== today) { // Reset stats for new day
                    todayFocusTime = 0;
                    todayTasksCompleted = 0;
                } else {
                    todayFocusTime = parseInt(localStorage.getItem('todayFocusTime') || '0');
                    todayTasksCompleted = parseInt(localStorage.getItem('todayTasksCompleted') || '0');
                }
                
                updateStats(0, 0); // Initial render
            };
            
            // --- Improved AI Logic ---
             const processAIRequest = (message) => {
                 let userMessage = message.toLowerCase();
                 const today = new Date();

                const motivationalQuotes = ["The secret of getting ahead is getting started.", "The only way to do great work is to love what you do.", "Believe you can and you're halfway there.", "Don't watch the clock; do what it does. Keep going."];
                const productivityTips = ["Try the Pomodoro Technique: 25 minutes of focused work followed by a 5-minute break.", "Use the 2-minute rule: if a task takes less than two minutes, do it now.", "Batch similar tasks together to maintain focus.", "Take regular breaks to rest your mind and body."];

                if (userMessage.includes("plan my day")) {
                    const tasksForToday = tasks.filter(task => task.date === toYYYYMMDD(today) && !task.completed);
                    if(tasksForToday.length === 0) return "You have no upcoming tasks for today! Add some to get started.";
                    
                    let plan = "Here's your plan for today: ";
                    tasksForToday.forEach(t => {
                        plan += `${t.name} ${t.startTime ? 'at ' + t.startTime : 'for ' + t.duration + ' minutes'}. `;
                    });
                    return plan;
                } else if (userMessage.includes("motivate") || userMessage.includes("quote")) {
                     return motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
                } else if (userMessage.includes("tip") || userMessage.includes("advice")) {
                     return productivityTips[Math.floor(Math.random() * productivityTips.length)];
                } else if (userMessage.includes("help") || userMessage.includes("what can you do")) {
                     return "I can create tasks for you! Just tell me the task name and duration (e.g., 'Read for 30 minutes') or a time range ('Work from 2pm to 3pm'). You can also ask me for motivation or a productivity tip.";
                }

                let taskDetails = { name: '', duration: 0, startTime: null, endTime: null, };
                 let foundTime = false;

                const timeRangeRegex = /(?:from\s+)?(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)\s+(?:to|-)\s+(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)/i;
                const singleTimeRegex = /(?:at\s+)?(\d{1,2}(?::\d{2})?\s*(?:am|pm))/i;
                const durationRegex = /(\d+(?:\.\d+)?)\s*(minute|min|hour|hr)s?/i;

                let match = userMessage.match(timeRangeRegex);
                if (match) {
                    const startTimeStr = parseTime(match[1]);
                    const endTimeStr = parseTime(match[2]);
                    if (startTimeStr && endTimeStr) {
                        const start = new Date(`1970-01-01T${startTimeStr}:00`);
                        const end = new Date(`1970-01-01T${endTimeStr}:00`);
                        const durationMins = (end - start) / 60000;
                        if (durationMins > 0) {
                            taskDetails.startTime = startTimeStr;
                            taskDetails.endTime = endTimeStr;
                            taskDetails.duration = durationMins;
                            userMessage = userMessage.replace(match[0], '');
                            foundTime = true;
                        }
                    }
                }

                match = userMessage.match(durationRegex);
                if (!foundTime && match) {
                    let duration = parseFloat(match[1]);
                    if (match[2].startsWith('h')) duration *= 60;
                    taskDetails.duration = duration;
                    userMessage = userMessage.replace(match[0], '');
                    foundTime = true;
                }
                
                match = userMessage.match(singleTimeRegex);
                if(!foundTime && match && taskDetails.duration > 0) {
                    taskDetails.startTime = parseTime(match[1]);
                     userMessage = userMessage.replace(match[0], '');
                }

                taskDetails.name = userMessage.replace(/schedule|create|add|a|an|task|for|me|to|session/g, '').trim();
                taskDetails.name = taskDetails.name.charAt(0).toUpperCase() + taskDetails.name.slice(1);


                if (taskDetails.name && taskDetails.duration > 0) {
                    tasks.push({
                        id: Date.now() + Math.random().toString(16).slice(2),
                        name: taskDetails.name,
                        date: toYYYYMMDD(today),
                        startTime: taskDetails.startTime,
                        endTime: taskDetails.endTime,
                        notes: "Created by AI assistant",
                        duration: taskDetails.duration,
                        icon: getIconForTask(taskDetails.name),
                        completed: false,
                        createdAt: new Date().toISOString()
                    });
                    
                    saveTasks();
                    renderTasksForDate(selectedCalendarDate);
                    renderCalendar();
                    let response = `OK! I've scheduled "${taskDetails.name}" for ${taskDetails.duration} minutes`;
                    if(taskDetails.startTime) response += ` starting at ${taskDetails.startTime}`;
                    response += ".";
                    return response;
                }

                return "I'm sorry, I couldn't understand that. Please specify a task and a duration (e.g., 'read for 30 minutes') or time range (e.g., 'work meeting from 2pm to 3pm').";
            };

            const parseTime = (timeStr) => {
                if (!timeStr) return null;
                let hours = 0;
                let minutes = 0;
                const lcTimeStr = timeStr.toLowerCase();
                const pm = lcTimeStr.includes('pm');
                const am = lcTimeStr.includes('am');
                
                let timeParts = lcTimeStr.replace(/am|pm/i, '').trim().split(':');
                hours = parseInt(timeParts[0]);
                minutes = timeParts.length > 1 ? parseInt(timeParts[1]) : 0;
                
                if (isNaN(hours)) return null;

                if (pm && hours < 12) { hours += 12; } 
                else if (am && hours === 12) { hours = 0; }
                else if (!am && !pm && hours < 8) { hours += 12; }
                
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            };
            
            const addAIMessage = (message, isUser = false) => {
                const messageEl = document.createElement('div');
                messageEl.className = `ai-message ${isUser ? 'ai-user' : 'ai-bot'}`;
                messageEl.textContent = message;
                aiConversation.appendChild(messageEl);
                aiConversation.scrollTop = aiConversation.scrollHeight;
            };

            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                let duration = (parseInt(taskHoursInput.value) || 0) * 60 + (parseInt(taskMinutesInput.value) || 0);
                
                if (!duration && taskStartTimeInput.value && taskEndTimeInput.value) {
                    const start = new Date(`1970-01-01T${taskStartTimeInput.value}`);
                    const end = new Date(`1970-01-01T${taskEndTimeInput.value}`);
                    if (end <= start) { alert("End time must be after start time."); return; }
                    duration = Math.round((end - start) / 60000);
                }

                if (!taskNameInput.value.trim()) { alert("Please provide a task name."); return; }
                if (duration <= 0) { alert("Please provide a valid duration or time range."); return; }

                tasks.push({
                    id: Date.now() + Math.random().toString(16).slice(2),
                    name: taskNameInput.value.trim(), date: taskDateInput.value, 
                    startTime: taskStartTimeInput.value, endTime: taskEndTimeInput.value, 
                    notes: taskNotesInput.value.trim(), duration: duration,
                    icon: getIconForTask(taskNameInput.value), completed: false, 
                    createdAt: new Date().toISOString()
                });

                saveTasks();
                renderTasksForDate(selectedCalendarDate); 
                renderCalendar(); 
                taskForm.reset();
                taskDateInput.value = toYYYYMMDD(selectedCalendarDate);
            });

            taskListEl.addEventListener('click', e => {
                const button = e.target.closest('button');
                if (!button) return;
                const taskId = button.dataset.id;
                
                if (button.classList.contains('delete-task')) {
                    if (confirm("Are you sure?")) {
                        tasks = tasks.filter(t => t.id !== taskId);
                        saveTasks(); 
                        renderTasksForDate(selectedCalendarDate || new Date()); 
                        renderCalendar();
                    }
                } else if (button.classList.contains('complete-task')) {
                     const taskIndex = tasks.findIndex(t => t.id === taskId);
                     if(taskIndex === -1) return;
                     if (tasks[taskIndex].completed) { tasks[taskIndex].completed = false; updateStats(0, -1); } 
                     else { completeTask(taskId, false); }
                    saveTasks(); 
                    renderTasksForDate(selectedCalendarDate || new Date()); 
                    renderCalendar();
                } else if (button.classList.contains('start-focus')) {
                    const taskToStart = tasks.find(t => t.id === taskId);
                    if(taskToStart) startFocusSession(taskToStart);
                }
            });

            pauseResumeBtn.addEventListener('click', togglePause);
            completeBtn.addEventListener('click', () => {
                if (currentTaskID) completeTask(currentTaskID, true);
                endFocusSession();
            });
            exitFocusBtn.addEventListener('click', endFocusSession);

            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            calendarToggleBtn.addEventListener('click', toggleCalendar);
            pomodoroModeBtn.addEventListener('click', () => startFocusSession({ name: "Pomodoro Session", icon: "fas fa-clock", duration: pomodoroDuration, id: null }, true));
            pomodoroBtn.addEventListener('click', () => startFocusSession({ name: "Pomodoro Session", icon: "fas fa-clock", duration: pomodoroDuration, id: null }, true));
            settingsBtn.addEventListener('click', showSettings);
            themeDashboardBtn.addEventListener('click', showThemeDashboard);
            saveSettingsBtn.addEventListener('click', saveSettingsToStorage);
            cancelSettingsBtn.addEventListener('click', hideSettings);
            settingsOverlay.addEventListener('click', () => { hideSettings(); hideThemeDashboard(); });
            blurIntensityInput.addEventListener('input', () => { 
                blurValueDisplay.textContent = `${blurIntensityInput.value}px`;
                document.documentElement.style.setProperty('--blur-effect', `blur(${blurIntensityInput.value}px)`);
             });
            workHoursEnabled.addEventListener('change', () => { workHoursInputs.style.display = workHoursEnabled.checked ? 'flex' : 'none'; });
            
            themeCategories.forEach(category => {
                category.addEventListener('click', () => {
                    document.querySelector('.theme-category.active').classList.remove('active');
                    category.classList.add('active');
                    filterThemes(category.dataset.category);
                });
            });
            
            aiAssistantBtn.addEventListener('click', () => { aiAssistantPanel.style.display = 'flex'; aiInput.focus(); });
            aiCloseBtn.addEventListener('click', () => { aiAssistantPanel.style.display = 'none'; });
            
            const handleAISubmit = () => {
                const query = aiInput.value.trim();
                if (query) {
                    addAIMessage(query, true);
                    aiInput.value = '';
                    setTimeout(() => { const response = processAIRequest(query); addAIMessage(response, false); }, 500);
                }
            };
            
            aiSendBtn.addEventListener('click', handleAISubmit);
            aiInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAISubmit(); });

            const initializeApp = () => {
                blurIntensity = parseInt(localStorage.getItem('blurIntensity') || '20');
                document.documentElement.style.setProperty('--blur-effect', `blur(${blurIntensity}px)`);
                pomodoroDuration = parseInt(localStorage.getItem('pomodoroDuration') || '25');
                breakDuration = parseInt(localStorage.getItem('breakDuration') || '5');
                longBreakDuration = parseInt(localStorage.getItem('longBreakDuration') || '15');
                
                applyTheme(localStorage.getItem('focusTimerTheme') || 'default');
                populateThemeDashboard();
                loadTasks(); loadStats();
                
                const today = new Date();
                selectedCalendarDate = today;
                taskDateInput.value = toYYYYMMDD(today);
                renderCalendar();
                renderTasksForDate(today);
                
                calendarView.style.display = 'flex';
                welcomeView.style.display = 'none';

                checkFocusHours();
                workHoursCheckInterval = setInterval(checkFocusHours, 60 * 1000); // Check every minute
            };

            initializeApp();
        });
    </script>
</body>
</html>
