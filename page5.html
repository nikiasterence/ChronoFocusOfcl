<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Gridora - AI Document Assistant</title>
    <link rel="icon" href="https://raw.githubusercontent.com/workwithasa/Gridora/main/Chronofocus.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- PDF & Download Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- Themes & Variables --- */
        :root {
            --sidebar-width: min(90vw, 400px);
            --header-height: 80px;
            --border-radius: 24px;
            --border-radius-pill: 50px;
            --transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            --font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
            --z-overlay: 1000;
            --z-sidebar: 1001;
            --z-modal: 2000;
            --z-island: 3000;
        }

        /* Light Theme */
        [data-theme="light"] {
            --theme-bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --theme-bg-color: #f6f6f3;
            --theme-surface-bg: rgba(255, 255, 255, 0.6);
            --theme-text-primary: #1d1d1f;
            --theme-text-secondary: #5a5a5f;
            --theme-border-color: rgba(0, 0, 0, 0.08);
            --theme-accent-primary: #007aff;
            --theme-accent-secondary: #0056b3;
            --theme-accent-translucent: rgba(0, 122, 255, 0.1);
            --theme-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --theme-bg-gradient: linear-gradient(135deg, #2c3e50 0%, #171c23 100%);
            --theme-bg-color: #171c23;
            --theme-surface-bg: rgba(28, 33, 39, 0.8);
            --theme-text-primary: #e5e5ea;
            --theme-text-secondary: #a3a3a3;
            --theme-border-color: rgba(80, 80, 80, 0.6);
            --theme-accent-primary: #0a84ff;
            --theme-accent-secondary: #3b9bff;
            --theme-accent-translucent: rgba(10, 132, 255, 0.15);
            --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Midnight Theme */
        [data-theme="midnight"] {
            --theme-bg-gradient: linear-gradient(135deg, #0d1117 0%, #010409 100%);
            --theme-bg-color: #010409;
            --theme-surface-bg: rgba(13, 17, 23, 0.8);
            --theme-text-primary: #c9d1d9;
            --theme-text-secondary: #8b949e;
            --theme-border-color: rgba(48, 54, 61, 0.6);
            --theme-accent-primary: #58a6ff;
            --theme-accent-secondary: #3081f7;
            --theme-accent-translucent: rgba(88, 166, 255, 0.15);
            --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        /* NEW: Ultra Dark Theme */
        [data-theme="ultra-dark"] {
            --theme-bg-gradient: linear-gradient(135deg, #000000 0%, #080808 100%);
            --theme-bg-color: #000000;
            --theme-surface-bg: rgba(18, 18, 18, 0.8);
            --theme-text-primary: #e0e0e0;
            --theme-text-secondary: #a0a0a0;
            --theme-border-color: rgba(60, 60, 60, 0.7);
            --theme-accent-primary: #1DB954; /* Spotify Green */
            --theme-accent-secondary: #1ed760;
            --theme-accent-translucent: rgba(29, 185, 84, 0.15);
            --theme-shadow: 0 10px 35px rgba(0, 0, 0, 0.4);
        }

        /* NEW: Cotton Candy Theme */
        [data-theme="cotton-candy"] {
            --theme-bg-gradient: linear-gradient(135deg, #ffdde1 0%, #ee9ca7 100%);
            --theme-bg-color: #fce4ec;
            --theme-surface-bg: rgba(255, 255, 255, 0.7);
            --theme-text-primary: #6d4c41;
            --theme-text-secondary: #8d6e63;
            --theme-border-color: rgba(239, 154, 154, 0.5);
            --theme-accent-primary: #f06292; /* Sweet Pink */
            --theme-accent-secondary: #ec407a;
            --theme-accent-translucent: rgba(240, 98, 146, 0.15);
            --theme-shadow: 0 10px 30px rgba(236, 64, 122, 0.15);
        }
        
        /* NEW: Golden Theme */
        [data-theme="golden"] {
            --theme-bg-gradient: linear-gradient(135deg, #FFD700 0%, #FDBB2D 100%);
            --theme-bg-color: #fff8e1;
            --theme-surface-bg: rgba(255, 236, 179, 0.7);
            --theme-text-primary: #4e342e;
            --theme-text-secondary: #6d4c41;
            --theme-border-color: rgba(255, 202, 40, 0.6);
            --theme-accent-primary: #ffa000; /* Amber */
            --theme-accent-secondary: #ff8f00;
            --theme-accent-translucent: rgba(255, 160, 0, 0.15);
            --theme-shadow: 0 10px 30px rgba(255, 143, 0, 0.2);
        }
        
        /* Ocean Theme */
        [data-theme="ocean"] {
            --theme-bg-gradient: linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%);
            --theme-bg-color: #e0f7fa;
            --theme-surface-bg: rgba(255, 255, 255, 0.7);
            --theme-text-primary: #0b2d48;
            --theme-text-secondary: #4a6a84;
            --theme-border-color: rgba(100, 150, 200, 0.5);
            --theme-accent-primary: #0077c2;
            --theme-accent-secondary: #005082;
            --theme-accent-translucent: rgba(0, 119, 194, 0.15);
            --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        }


        /* --- Base Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
        }
        html { -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--theme-bg-color);
            background-image: var(--theme-bg-gradient);
            color: var(--theme-text-primary);
            min-height: 100vh;
            overflow: hidden;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
            touch-action: manipulation;
            transition: background 0.8s ease;
        }

        /* Dynamic Motion Background */
        body::before {
            content: '';
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: radial-gradient(circle at top left, var(--theme-accent-translucent) 0%, transparent 25%),
                              radial-gradient(circle at bottom right, var(--theme-accent-translucent) 0%, transparent 25%);
            z-index: -1;
            animation: drift 40s ease-in-out infinite alternate;
            transition: background-image 0.8s ease;
        }
        @keyframes drift {
            from { transform: translate(-15%, -15%) rotate(0deg); }
            to { transform: translate(15%, 15%) rotate(15deg); }
        }

        .app-container { display: flex; height: 100vh; overflow: hidden; position: relative; }
        .glass {
            background: var(--theme-surface-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: var(--border-radius);
            border: 1px solid var(--theme-border-color);
            box-shadow: var(--theme-shadow);
            transition: var(--transition);
        }

        /* --- Entry Page --- */
        #entry-page {
            position: fixed; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background-color: var(--theme-bg-color);
            background-image: var(--theme-bg-gradient);
            z-index: 9999;
            transition: opacity 0.8s ease, visibility 0.8s;
            animation: fadeIn 1s ease-in-out;
            padding: 1rem;
            text-align: center;
        }
        #entry-page.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .entry-title { font-size: clamp(2.5rem, 8vw, 4rem); margin-bottom: 1rem; font-weight: 700; color: var(--theme-text-primary); }
        .entry-subtitle { font-size: clamp(1rem, 4vw, 1.25rem); max-width: 600px; color: var(--theme-text-secondary); margin-bottom: 3rem; }
        .entry-button {
            background: var(--theme-surface-bg); border: 1px solid var(--theme-border-color);
            border-radius: var(--border-radius-pill); padding: 1.2rem 2.5rem; font-size: 1.1rem;
            font-weight: 600; color: var(--theme-text-primary); cursor: pointer; margin: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: all 0.3s ease;
            animation: float 4s ease-in-out infinite;
        }
        .entry-button i { margin-right: 12px; }
        .entry-button:nth-child(3) { animation-delay: 0.2s; }
        .entry-button:hover {
            transform: translateY(-8px) scale(1.05); box-shadow: 0 12px 30px rgba(0,0,0,0.1);
            background: var(--theme-accent-translucent); border-color: var(--theme-accent-primary);
            color: var(--theme-accent-primary);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-7px); } }

        /* --- Main Layout --- */
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column;
            overflow: hidden; padding-top: calc(var(--header-height) - 10px); position: relative;
        }

        /* --- Dynamic Island --- */
        .dynamic-island {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: var(--z-island); background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.1); display: flex;
            align-items: center; justify-content: center; color: white; padding: 0 20px;
            border-radius: var(--border-radius-pill); cursor: pointer; transition: var(--transition);
            height: 50px; min-width: 250px; box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        }
        .dynamic-island:not(.expanded) { animation: breath 3s infinite ease-in-out; }
        @keyframes breath {
            0%, 100% { transform: translateX(-50%) scale(1); box-shadow: 0 10px 40px rgba(0,0,0,0.25);}
            50% { transform: translateX(-50%) scale(1.03); box-shadow: 0 15px 50px rgba(0,0,0,0.3);}
        }
        .island-idle-content { display: flex; align-items: center; gap: 10px; transition: opacity 0.3s ease, transform 0.3s ease; }
        .dynamic-island.expanded .island-idle-content { opacity: 0; transform: scale(0.8); pointer-events: none; }
        .island-controls {
            display: flex; gap: 10px; align-items: center; opacity: 0;
            pointer-events: none; position: absolute;
            transition: opacity 0.4s 0.2s ease, transform 0.4s 0.2s ease;
            transform: translateY(10px);
        }
        .island-btn {
            background: rgba(255, 255, 255, 0.1); color: white;
            width: 48px; height: 48px; border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.1rem; transition: all 0.3s ease;
        }
        .island-btn:hover { background: var(--theme-accent-primary); transform: scale(1.1); }
        .island-btn:active { transform: scale(0.95); } /* Better Touch Feedback */
        /* Expanded State */
        .dynamic-island.expanded {
            height: 80px; width: auto; padding: 0 40px;
            min-width: 450px; border-radius: 40px;
        }
        .dynamic-island.expanded .island-controls { opacity: 1; pointer-events: auto; transform: translateY(0); }

        .content-area {
            flex-grow: 1; overflow-y: auto;
            padding: clamp(12px, 3vw, 20px); margin: 20px;
            border-radius: var(--border-radius); position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .empty-state {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100%; text-align: center;
            padding: 2rem; color: var(--theme-text-secondary);
        }
        .empty-state i {
            font-size: clamp(3rem, 8vw, 5rem);
            color: var(--theme-accent-primary);
            opacity: 0.6; margin-bottom: 1.5rem;
        }

        /* --- PDF & Text Editor Styles --- */
        #drag-drop-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); border: 3px dashed var(--theme-accent-primary);
            border-radius: var(--border-radius); display: none; align-items: center;
            justify-content: center; font-size: clamp(1.2rem, 4vw, 1.5rem);
            font-weight: 600; color: white; z-index: var(--z-overlay);
            text-align: center; padding: 2rem;
        }
        #drag-drop-overlay.visible { display: flex; }
        #pdf-viewer { display: none; position: relative; }
        #pdf-viewer .page-container { margin: 0 auto 20px auto; box-shadow: var(--theme-shadow); max-width: 100%; overflow: hidden; border-radius: 12px; }
        #pdf-viewer canvas { display: block; width: 100%; height: auto; max-width: 100%; }
        #text-editor { display: none; min-height: 70vh; width: 100%; padding: clamp(1rem, 4vw, 2rem); font-size: clamp(1rem, 3vw, 1.15rem); line-height: 1.8; color: var(--theme-text-primary); border: none; outline: none; background: transparent; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; -webkit-user-select: text; user-select: text; }
        #text-editor:empty:before { content: attr(data-placeholder); color: var(--theme-text-secondary); opacity: 0.7; pointer-events: none; }

        .pdf-text-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden; opacity: 0.2; line-height: 1; user-select: text; }
        .pdf-text-layer::selection { background: var(--theme-accent-translucent); }
        .pdf-text-layer span { color: transparent; position: absolute; white-space: pre; cursor: text; transform-origin: 0% 0%; }
        
        /* --- AI Sidebar --- */
        .ai-sidebar {
            position: fixed; top: 0; right: 0; width: var(--sidebar-width); height: 100vh;
            transform: translateX(100%); transition: transform var(--transition);
            z-index: var(--z-sidebar); display: flex; flex-direction: column;
            padding: 20px; box-shadow: -10px 0 40px rgba(0, 0, 0, 0.2); overflow-y: auto;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }
        .ai-sidebar.open { transform: translateX(0); }
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--theme-border-color);
            position: sticky; top: -20px; background: var(--theme-surface-bg); backdrop-filter: blur(12px); z-index: 10; margin: -20px -20px 20px -20px; padding: 20px 20px 15px 20px;
        }
        .sidebar-title { font-size: 1.25rem; font-weight: 700; }
        .header-btn {
            background: transparent; color: var(--theme-text-secondary); width: 44px;
            height: 44px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; cursor: pointer; border: none; font-size: 1.2rem;
            transition: var(--transition); touch-action: manipulation; -webkit-tap-highlight-color: transparent;
        }
        .header-btn:hover, .header-btn:active { background-color: var(--theme-accent-translucent); color: var(--theme-accent-primary); transform: scale(1.05); }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding-top: 10px;}
        .ai-section { margin-bottom: 25px; }
        .ai-section h4 { display: flex; align-items: center; gap: 10px; font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--theme-border-color); color: var(--theme-text-primary); }
        .ai-section i { color: var(--theme-accent-primary); }
        .ai-output { background: rgba(0,0,0,0.03); border: 1px solid var(--theme-border-color); padding: 15px; border-radius: 18px; min-height: 80px; font-size: 0.95rem; line-height: 1.6; color: var(--theme-text-secondary); white-space: pre-wrap; word-wrap: break-word; user-select: text; transition: var(--transition); }
        .ai-output mark { background-color: var(--theme-accent-translucent); border-radius: 4px; padding: 2px 4px; color: var(--theme-text-primary); font-weight: 600; }
        .ai-input { width: 100%; padding: 14px; background: var(--theme-surface-bg); border: 1px solid var(--theme-border-color); border-radius: 18px; color: var(--theme-text-primary); font-size: 1rem; margin-bottom: 10px; outline: none; transition: var(--transition); }
        .ai-input:focus { border-color: var(--theme-accent-primary); box-shadow: 0 0 0 3px var(--theme-accent-translucent); }
        .ai-button, .summary-option-btn {
            width: 100%; padding: 14px; background-color: var(--theme-accent-primary);
            color: white; border: none; border-radius: var(--border-radius-pill); cursor: pointer;
            font-weight: 600; transition: var(--transition); display: flex; align-items: center;
            justify-content: center; gap: 8px; margin-top: 10px; font-size: 1rem;
            touch-action: manipulation;
        }
        .ai-button:hover, .summary-option-btn:hover { background-color: var(--theme-accent-secondary); transform: scale(1.02); }
        .ai-button:active, .summary-option-btn:active { transform: scale(0.98); }
        .ai-button:disabled, .summary-option-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; background-color: var(--theme-accent-secondary); }
        .summary-options { display: flex; gap: 8px; margin-top: 10px; }
        .summary-option-btn { flex: 1; margin-top: 0; padding: 10px; font-size: 0.85rem; border-radius: var(--border-radius-pill); }

        /* --- Settings Panel --- */
        .panel-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px);
            z-index: var(--z-modal); display: none; align-items: center; justify-content: center; padding: 1rem;
        }
        .panel-overlay.visible { display: flex; animation: fadeIn 0.5s ease; }
        .settings-panel { padding: 30px; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
        .setting-group { margin-bottom: 25px; }
        .setting-group > label:first-child { display: block; font-weight: 600; margin-bottom: 15px; color: var(--theme-text-primary); font-size: 1.1rem; }
        .theme-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; }
        .theme-options input { display: none; }
        .theme-options label { padding: 14px 20px; border-radius: 18px; cursor: pointer; border: 2px solid var(--theme-border-color); transition: var(--transition); text-align: center; font-size: 0.9rem; }
        .theme-options input:checked + label {
            border-color: var(--theme-accent-primary); background-color: var(--theme-accent-translucent);
            transform: translateY(-2px) scale(1.02); font-weight: 600; color: var(--theme-accent-primary);
        }

        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .dynamic-island { min-width: 180px; height: 45px; }
            .dynamic-island.expanded { width: 95%; min-width: 95%; height: auto; padding: 15px; flex-direction: column; gap: 15px; border-radius: 32px; }
            .dynamic-island.expanded .island-controls { position: static; transform: none; opacity: 1; pointer-events: auto; flex-wrap: wrap; justify-content: center;}
            .island-btn { width: 44px; height: 44px; }
            .ai-sidebar {
                border-radius: var(--border-radius) var(--border-radius) 0 0;
                width: 100vw; height: 90vh; bottom: 0; top: auto;
                transform: translateY(100%);
            }
            .ai-sidebar.open { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Entry Page -->
    <div id="entry-page">
        <h1 class="entry-title">Welcome to Gridora</h1>
        <p class="entry-subtitle">Your AI-Powered Assistant for reading, summarizing, and understanding any document.</p>
        <button id="entry-read-pdf" class="entry-button"><i class="fas fa-file-pdf"></i> Analyze PDF</button>
        <button id="entry-use-ai" class="entry-button"><i class="fas fa-keyboard"></i> Use Text Editor</button>
    </div>

    <!-- Main App -->
    <div id="drag-drop-overlay">
        <div>
            <i class="fas fa-file-pdf fa-3x"></i><br><br>Drop PDF Here to Analyze
        </div>
    </div>
    <div class="app-container">
        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">

            <!-- Dynamic Island -->
            <div class="dynamic-island" id="dynamic-island">
                <div class="island-idle-content">
                    <i class="fas fa-brain"></i>&nbsp;
                    <strong>Optichain AI</strong>
                </div>
                <div class="island-controls">
                     <button class="island-btn" id="island-ai-btn" title="Access Optichain AI"><i class="fas fa-robot"></i></button>
                     <label for="pdf-upload" class="island-btn" title="Upload PDF or Image" id="upload-label"><i class="fas fa-upload"></i></label>
                     <button class="island-btn" id="island-paste-btn" title="Paste from Clipboard"><i class="fas fa-paste"></i></button>
                     <button class="island-btn" id="island-text-mode-btn" title="Switch to Text Editor"><i class="fas fa-keyboard"></i></button>
                     <button class="island-btn" id="island-settings-btn" title="Settings"><i class="fas fa-cog"></i></button>
                </div>
            </div>

            <input type="file" id="pdf-upload" accept=".pdf,image/*" style="display: none;" aria-label="PDF file input">

            <div id="content-area" class="content-area glass">
                <input type="text" id="document-title" placeholder="Enter document title here..." style="width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 18px; border: 1px solid var(--theme-border-color); background-color: var(--theme-surface-bg); color: var(--theme-text-primary); font-size: 1.1rem;">
                <div id="pdf-viewer"></div>
                <div id="text-editor" contenteditable="true" spellcheck="true" data-placeholder="Type, paste, or start with an AI prompt here..."></div>
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-search"></i>
                    <h2>Welcome to Your Workspace</h2>
                    <p>Upload a PDF or switch to the text editor to begin.</p>
                </div>
            </div>
        </main>

        <!-- AI Assistant Sidebar -->
        <aside class="ai-sidebar glass" id="aiSidebar" role="complementary">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Gridora AI</h2>
                <button class="header-btn" id="ai-close-btn" aria-label="Close AI assistant">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                 <!-- Smart Summary Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-file-alt"></i>Smart Summary</h4>
                    <div id="summary-output" class="ai-output">Click a size to generate an intelligent summary of your document.</div>
                    <div class="summary-options">
                        <button id="summarize-btn-small" class="summary-option-btn" data-size="small">Small</button>
                        <button id="summarize-btn-medium" class="summary-option-btn" data-size="medium">Medium</button>
                        <button id="summarize-btn-large" class="summary-option-btn" data-size="large">Large</button>
                    </div>
                </div>

                <!-- Writing Assistant Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-pen-ruler"></i>Writing Assistant</h4>
                    <div id="writing-output" class="ai-output">Get suggestions to improve your writing clarity, style, and impact.</div>
                    <button id="writing-btn" class="ai-button"><i class="fas fa-magic"></i>Analyze Writing</button>
                </div>

                <!-- NEW: Grammar Fixer Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-spell-check"></i>Fix Grammar</h4>
                    <div id="grammar-output" class="ai-output">Find and correct grammatical errors in your text.</div>
                    <button id="grammar-btn" class="ai-button"><i class="fas fa-wrench"></i>Suggest Fixes</button>
                </div>
                
                <!-- Ask Anything Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-question-circle"></i>Ask Anything</h4>
                    <input type="text" id="qa-input" class="ai-input" placeholder="Ask a question about the content...">
                    <div id="qa-answer" class="ai-output">Get intelligent answers based on the content.</div>
                    <button id="qa-btn" class="ai-button"><i class="fas fa-search"></i>Get Answer</button>
                </div>
                
                <!-- Key Points Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-list-ul"></i>Key Points</h4>
                    <div id="keypoints-output" class="ai-output">Extract the most important points from your document.</div>
                    <button id="keypoints-btn" class="ai-button"><i class="fas fa-lightbulb"></i>Extract Points</button>
                </div>

                <!-- NEW: Key Words Section -->
                 <div class="ai-section">
                    <h4><i class="fas fa-tags"></i>Key Words</h4>
                    <div id="keywords-output" class="ai-output">Find the most frequent and important keywords.</div>
                    <button id="keywords-btn" class="ai-button"><i class="fas fa-search-dollar"></i>Find Keywords</button>
                </div>
                
                <!-- Study Quiz Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-graduation-cap"></i>Study Quiz</h4>
                    <div id="quiz-output" class="ai-output">Generate a quiz to test your knowledge of the document.</div>
                    <button id="quiz-btn" class="ai-button"><i class="fas fa-question"></i>Generate Quiz</button>
                </div>
                <!-- Content Analysis Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-chart-pie"></i>Content Analysis</h4>
                    <div id="analysis-output" class="ai-output">Analyze the sentiment and tone of your document.</div>
                    <button id="analysis-btn" class="ai-button"><i class="fas fa-magnifying-glass-chart"></i>Analyze Content</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Settings Panel -->
    <div class="panel-overlay" id="settings-overlay">
        <div class="settings-panel glass">
             <div class="sidebar-header" style="border-bottom: 1px solid var(--theme-border-color); margin: -30px -30px 20px -30px; padding: 20px 30px;">
                <h2 class="sidebar-title">Settings</h2>
                <button class="header-btn" id="settings-close-btn" aria-label="Close settings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="setting-group">
                <label>Appearance</label>
                <div class="theme-options">
                    <input type="radio" id="theme-light" name="theme" value="light">
                    <label for="theme-light">Light</label>
                    <input type="radio" id="theme-dark" name="theme" value="dark">
                    <label for="theme-dark">Dark</label>
                    <input type="radio" id="theme-midnight" name="theme" value="midnight">
                    <label for="theme-midnight">Midnight</label>
                    <input type="radio" id="theme-ultra-dark" name="theme" value="ultra-dark">
                    <label for="theme-ultra-dark">Ultra Dark</label>
                    <input type="radio" id="theme-ocean" name="theme" value="ocean">
                    <label for="theme-ocean">Ocean</label>
                    <input type="radio" id="theme-cotton-candy" name="theme" value="cotton-candy">
                    <label for="theme-cotton-candy">Cotton Candy</label>
                    <input type="radio" id="theme-golden" name="theme" value="golden">
                    <label for="theme-golden">Golden</label>
                </div>
            </div>
        </div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';

    // --- State and DOM Elements ---
    let state = {
        pdfDoc: null,
        extractedText: '',
        currentMode: 'empty', // can be 'pdf', 'text', 'empty'
        isAiProcessing: false,
        isPdfLoading: false,
    };

    class OptiChainAI {
        constructor() { this.stopWords = new Set(['a', 'about', 'above', 'after', 'again', 'against', 'all', 'am', 'an', 'and', 'any', 'are', 'as', 'at', 'be', 'because', 'been', 'before', 'being', 'below', 'between', 'both', 'but', 'by', 'can', 'cannot', 'could', 'did', 'do', 'does', 'doing', 'down', 'during', 'each', 'few', 'for', 'from', 'further', 'had', 'has', 'have', 'having', 'he', 'her', 'here', 'hers', 'herself', 'him', 'himself', 'his', 'how', 'i', 'if', 'in', 'into', 'is', 'it', 'its', 'itself', 'me', 'more', 'most', 'my', 'myself', 'no', 'nor', 'not', 'of', 'off', 'on', 'once', 'only', 'or', 'other', 'our', 'ours', 'ourselves', 'out', 'over', 'own', 'same', 'she', 'should', 'so', 'some', 'such', 'than', 'that', 'the', 'their', 'theirs', 'them', 'themselves', 'then', 'there', 'these', 'they', 'this', 'those', 'through', 'to', 'too', 'under', 'until', 'up', 'very', 'was', 'we', 'were', 'what', 'when', 'where', 'which', 'while', 'who', 'whom', 'why', 'with', 'you', 'your', 'yours', 'yourself', 'yourselves']); }
        preprocessText(text) { if (!text || typeof text !== 'string') return ''; let processed = text; processed = processed.replace(/ﬁ/g, 'fi').replace(/ﬂ/g, 'fl'); processed = processed.replace(/\s+/g, ' ').trim(); processed = processed.replace(/([a-z])-\s+([a-z])/g, '$1$2'); return processed; }
        tokenizeSentences(text) { if (!text) return []; return text.match(/[^.!?]+[.!?]\s*(?=[A-Z]|\d|"|“|‘|$)/g)?.map(s => s.trim()).filter(s => s.length > 15 && s.length < 1500) || []; }
        generateSummary(text, size = 'medium') { let targetSentenceCount; switch (size) { case 'small': targetSentenceCount = 3; break; case 'large': targetSentenceCount = 8; break; default: targetSentenceCount = 5; } const sentences = this.tokenizeSentences(this.preprocessText(text)); if (sentences.length <= targetSentenceCount) { return sentences.join(' '); } const keywords = this.extractKeyWords(text, 20); const scoredSentences = sentences.map((sentence, i) => { const sentenceLower = sentence.toLowerCase(); let score = 0; const positionRatio = i / sentences.length; if (positionRatio < 0.2) score += 2.0; if (positionRatio > 0.8) score += 1.5; keywords.forEach(kw => { if (sentenceLower.includes(kw.word)) { score += kw.score; } }); if (sentence.length < 20 || sentence.length > 800) score *= 0.5; const cuePhrases = ['in conclusion', 'in summary', 'the main point', 'importantly', 'essentially']; if (cuePhrases.some(phrase => sentenceLower.startsWith(phrase))) score *= 2.0; return { sentence, score, index: i }; }); const topSentences = scoredSentences.sort((a, b) => b.score - a.score).slice(0, targetSentenceCount).sort((a, b) => a.index - b.index); return topSentences.map(item => item.sentence).join(' '); }
        answerQuestion(text, question) { const sentences = this.tokenizeSentences(this.preprocessText(text)); const questionWords = new Set(question.toLowerCase().replace('?', '').split(/\s+/).filter(w => !this.stopWords.has(w) && w.length > 2)); if (questionWords.size === 0) return "Please ask a more specific question."; let bestSentence = { text: "", score: -1 }; sentences.forEach(sentence => { const sentenceLower = sentence.toLowerCase(); let score = 0; let matchedWords = 0; questionWords.forEach(qWord => { if (sentenceLower.includes(qWord)) { score += 2; matchedWords++; } }); if (matchedWords > 1) score += matchedWords * 3; if (/\b(is|are|was|were)\b/i.test(sentence) && sentence.length < 250) score *= 1.5; if (score > bestSentence.score) bestSentence = { text: sentence, score: score }; }); if (bestSentence.score <= 1) return "I could not find a confident answer. Try rephrasing your question."; let answerText = bestSentence.text; questionWords.forEach(word => { const regex = new RegExp(`\\b(${word})\\b`, 'gi'); answerText = answerText.replace(regex, `<mark>$1</mark>`); }); return answerText; }
        extractKeyWords(text, count = 15) { const words = this.preprocessText(text).toLowerCase().replace(/[^\w\s]/g, ' ').split(/\s+/).filter(word => word.length > 3 && !this.stopWords.has(word)); const wordFreq = {}; words.forEach(word => { wordFreq[word] = (wordFreq[word] || 0) + 1; }); const scores = Object.entries(wordFreq).map(([word, freq]) => ({ word, score: freq * Math.log(words.length / (wordFreq[word] || 1)) })); return scores.sort((a, b) => b.score - a.score).slice(0, count); }
        extractKeyPoints(text) { const summary = this.generateSummary(text, 'large'); const points = summary.split('. ').filter(p => p.trim().length > 0).map(p => p.trim() + '.'); return points.map((point, index) => `${index + 1}. ${point}`).join('\n\n') || "No key points could be extracted."; }
        analyzeWriting(text) { const sentences = this.tokenizeSentences(this.preprocessText(text)); let results = { passive: [], fillers: [], weasels: [] }; const passiveRegex = /\b(am|is|are|was|were|be|being|been)\b\s\w+ed\b/i; sentences.forEach(s => { if(passiveRegex.test(s)) results.passive.push(s); }); const fillerRegex = /\b(basically|actually|literally|like|just|really|very|stuff|things|you know|sort of|kind of)\b/gi; const fillerMatches = text.match(fillerRegex); if (fillerMatches) results.fillers = [...new Set(fillerMatches)]; const weaselRegex = /\b(many|various|several|some|few|most|often|sometimes|arguably|perhaps|could|might)\b/gi; const weaselMatches = text.match(weaselRegex); if (weaselMatches) results.weasels = [...new Set(weaselMatches)]; let report = "✍️ **Writing Analysis**\n\n"; if (results.passive.length > 0) { report += `**Passive Voice:** ${results.passive.length} sentence(s) might be in passive voice. Consider making them more active.\n*Example: "${results.passive[0]}"*\n\n`; } if (results.fillers.length > 0) { report += `**Filler Words:** Found common filler words. Your writing might be stronger without them.\n*Examples: ${results.fillers.slice(0, 5).join(', ')}*\n\n`; } if (results.weasels.length > 0) { report += `**Vague Language:** These words can make your writing less direct.\n*Examples: ${results.weasels.slice(0, 5).join(', ')}*\n\n`; } if (report.length < 50) return "✅ Your writing looks clear and direct! No major issues found."; return report; }
        generateQuiz(text) { const sentences = this.tokenizeSentences(this.preprocessText(text)); const keywords = this.extractKeyWords(text, 10); let quiz = []; keywords.forEach(kw => { const keywordSentences = sentences.filter(s => s.toLowerCase().includes(kw.word)); if(keywordSentences.length > 0) { const questionSentence = keywordSentences[0]; const question = questionSentence.replace(new RegExp(kw.word, 'ig'), '_____'); quiz.push({question: question, answer: kw.word}); } }); if (quiz.length === 0) return "Could not generate a quiz from this text."; return quiz.slice(0, 5).map((item, index) => `${index + 1}. ${item.question}\n   <mark>Answer: ${item.answer}</mark>`).join('\n\n'); }
        analyzeContent(text) { const positiveWords = ['good', 'great', 'excellent', 'amazing', 'awesome', 'love', 'like', 'happy', 'beautiful', 'wonderful']; const negativeWords = ['bad', 'terrible', 'horrible', 'awful', 'hate', 'dislike', 'sad', 'ugly', 'boring']; let positiveScore = 0; let negativeScore = 0; const words = this.preprocessText(text).toLowerCase().split(/\s+/); words.forEach(word => { if(positiveWords.includes(word)) positiveScore++; if(negativeWords.includes(word)) negativeScore++; }); let sentiment = "Neutral"; if (positiveScore > negativeScore * 1.5) sentiment = "Positive"; else if (negativeScore > positiveScore * 1.5) sentiment = "Negative"; return `**Sentiment Analysis:** ${sentiment}\n\n**Positive Keywords:** ${positiveScore}\n**Negative Keywords:** ${negativeScore}`; }
        fixGrammar(text) {
            let correctedText = text;
            const corrections = {
                ' their is ': ' there is ', ' their are ': ' there are ', ' theyre ': ' they\'re ', ' its ': ' it\'s ', // Common confusables
                ' alot ': ' a lot ', 'definately': 'definitely', 'seperate': 'separate',
                ' i ': ' I ' // Capitalization
            };
            let suggestions = [];
            for (const [error, fix] of Object.entries(corrections)) {
                const regex = new RegExp(error, 'gi');
                if (regex.test(correctedText)) {
                    suggestions.push(`Replaced "<mark>${error.trim()}</mark>" with "<mark>${fix.trim()}</mark>"`);
                    correctedText = correctedText.replace(regex, fix);
                }
            }
            if (suggestions.length === 0) return "✅ No common grammatical errors found.";
            return `**Grammar Suggestions:**\n\n${suggestions.join('\n')}\n\n*Note: These are automated suggestions. Please review them carefully.*`;
        }
    }
    const AI = new OptiChainAI();

    // Simplified DOM Elements object
    const DOMElements = {
        mainContent: document.getElementById('mainContent'),
        pdfUpload: document.getElementById('pdf-upload'),
        emptyState: document.getElementById('emptyState'),
        pdfViewer: document.getElementById('pdf-viewer'),
        textEditor: document.getElementById('text-editor'),
        aiSidebar: document.getElementById('aiSidebar'),
        dragDropOverlay: document.getElementById('drag-drop-overlay'),
        documentTitle: document.getElementById('document-title'),
        entryPage: document.getElementById('entry-page'),
        dynamicIsland: document.getElementById('dynamic-island'),
        settingsOverlay: document.getElementById('settings-overlay'),
    };
    
    function initialize() {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        setupEventListeners();
        loadSettings();
        resetAiOutputs();
    }
    
    function setMode(mode) {
        state.currentMode = mode;
        DOMElements.pdfViewer.style.display = 'none';
        DOMElements.textEditor.style.display = 'none';
        DOMElements.emptyState.style.display = 'none';

        if (mode === 'pdf') {
            DOMElements.pdfViewer.style.display = 'block';
        } else if (mode === 'text') {
            DOMElements.textEditor.style.display = 'block';
        } else {
            DOMElements.emptyState.style.display = 'flex';
        }
    }

    function setupEventListeners() {
        // Entry Page
        document.getElementById('entry-read-pdf').addEventListener('click', () => { hideEntryPage(); setTimeout(() => DOMElements.pdfUpload.click(), 500); });
        document.getElementById('entry-use-ai').addEventListener('click', () => { hideEntryPage(); setMode('text'); });

        // Dynamic Island
        DOMElements.dynamicIsland.addEventListener('click', (e) => { if (!e.target.closest('.island-btn') && !e.target.closest('label')) DOMElements.dynamicIsland.classList.toggle('expanded'); });
        document.addEventListener('click', (e) => { if (!DOMElements.dynamicIsland.contains(e.target) && DOMElements.dynamicIsland.classList.contains('expanded')) DOMElements.dynamicIsland.classList.remove('expanded'); });
        document.getElementById('island-ai-btn').addEventListener('click', toggleAiSidebar);
        document.getElementById('island-paste-btn').addEventListener('click', pasteFromClipboard);
        document.getElementById('island-text-mode-btn').addEventListener('click', () => setMode('text'));
        document.getElementById('island-settings-btn').addEventListener('click', toggleSettings);

        // File Handling
        DOMElements.pdfUpload.addEventListener('change', handleFileSelect, false);
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => document.body.addEventListener(evt, preventDefaults, false));
        ['dragenter', 'dragover'].forEach(evt => DOMElements.mainContent.addEventListener(evt, showDropOverlay, false));
        ['dragleave', 'drop'].forEach(evt => DOMElements.mainContent.addEventListener(evt, hideDropOverlay, false));
        DOMElements.mainContent.addEventListener('drop', handleDrop, false);

        // Sidebar and Settings
        document.getElementById('ai-close-btn').addEventListener('click', toggleAiSidebar);
        document.getElementById('settings-close-btn').addEventListener('click', toggleSettings);
        DOMElements.settingsOverlay.addEventListener('click', (e) => { if (e.target === DOMElements.settingsOverlay) toggleSettings(); });

        // AI Buttons
        document.querySelectorAll('[id^="summarize-btn-"]').forEach(btn => btn.addEventListener('click', (e) => handleAIAction('summarize', { size: e.target.dataset.size })));
        const aiActions = ['writing', 'grammar', 'qa', 'keypoints', 'keywords', 'quiz', 'analysis'];
        aiActions.forEach(action => { document.getElementById(`${action}-btn`)?.addEventListener('click', () => handleAIAction(action)); });

        document.getElementById('qa-input').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); handleAIAction('qa'); } });
        DOMElements.textEditor.addEventListener('paste', handlePaste);
        
        // Theme selection
        document.querySelectorAll('.theme-options input').forEach(input => {
            input.addEventListener('change', (e) => setTheme(e.target.value));
        });
    }

    // --- Core Functions (UI, File Handling, AI) ---

    function hideEntryPage() {
        DOMElements.entryPage.classList.add('hidden');
        document.body.style.overflow = 'auto'; 
    }

    function toggleAiSidebar() { DOMElements.aiSidebar.classList.toggle('open'); }
    function toggleSettings() { DOMElements.settingsOverlay.classList.toggle('visible'); }

    function setTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('gridora_theme', themeName);
        document.querySelector(`input[value="${themeName}"]`).checked = true;
    }

    function loadSettings() {
        const theme = localStorage.getItem('gridora_theme') || 'light';
        setTheme(theme);
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file && file.type === 'application/pdf') {
            DOMElements.documentTitle.value = file.name.replace(/\.pdf$/i, '');
            loadPdfFromFile(file);
        } else {
            showError('Please select a valid PDF file.');
        }
    }
    
    function handleDrop(e) {
        const file = e.dataTransfer.files[0];
        if (file && file.type === 'application/pdf') {
            DOMElements.documentTitle.value = file.name.replace(/\.pdf$/i, '');
            loadPdfFromFile(file);
        } else {
            showError('Dropped file is not a valid PDF.');
        }
    }
    
    function loadPdfFromFile(file) {
        const fileReader = new FileReader();
        fileReader.onload = (e) => loadPdf(new Uint8Array(e.target.result));
        fileReader.readAsArrayBuffer(file);
    }
    
    async function loadPdf(typedarray) {
        if (state.isPdfLoading) return;
        state.isPdfLoading = true;
        setLoadingState(true, 'Loading PDF...');
        setMode('pdf');

        try {
            state.pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
            DOMElements.pdfViewer.innerHTML = '';
            
            let textPromises = [];
            for (let i = 1; i <= state.pdfDoc.numPages; i++) {
                textPromises.push(state.pdfDoc.getPage(i).then(page => page.getTextContent()));
            }
            const allTextContents = await Promise.all(textPromises);
            state.extractedText = allTextContents.map(tc => tc.items.map(item => item.str).join(' ')).join('\n\n');
            
            for (let pageNum = 1; pageNum <= state.pdfDoc.numPages; pageNum++) {
                await renderPage(pageNum, allTextContents[pageNum - 1]);
            }
            resetAiOutputs();
        } catch (error) {
            console.error('Error loading PDF:', error);
            showError('Failed to load PDF. It may be corrupt or protected.');
            setMode('empty');
        } finally {
            state.isPdfLoading = false;
            setLoadingState(false);
        }
    }

    async function renderPage(pageNum, textContent) {
        const page = await state.pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: 1.5 });
        const pageContainer = document.createElement('div');
        pageContainer.className = 'page-container';
        pageContainer.style.position = 'relative';
        const canvas = document.createElement('canvas');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        const textLayerDiv = document.createElement('div');
        textLayerDiv.className = 'pdf-text-layer';
        pageContainer.append(canvas, textLayerDiv);
        DOMElements.pdfViewer.appendChild(pageContainer);
        
        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        textLayerDiv.style.width = viewport.width + 'px';
        textLayerDiv.style.height = viewport.height + 'px';
        pdfjsLib.renderTextLayer({ textContent, container: textLayerDiv, viewport, textDivs: [] });
    }

    async function handleAIAction(action, options = {}) {
        if (state.isAiProcessing) return;
        const title = DOMElements.documentTitle.value.trim();
        if (!title) { showError('Please provide a title for the document before using AI features.'); return; }
        
        const text = (state.currentMode === 'pdf') ? state.extractedText : DOMElements.textEditor.textContent;
        if (text.trim().length < 50) { showError('Please provide at least 50 characters of text for AI analysis.'); return; }
        
        const buttonMap = {
            summarize: 'summarize-btn-medium', qa: 'qa-btn', writing: 'writing-btn', 
            grammar: 'grammar-btn', keypoints: 'keypoints-btn', keywords: 'keywords-btn', 
            quiz: 'quiz-btn', analysis: 'analysis-btn'
        };
        const outputMap = {
            summarize: 'summary-output', qa: 'qa-answer', writing: 'writing-output',
            grammar: 'grammar-output', keypoints: 'keypoints-output', keywords: 'keywords-output',
            quiz: 'quiz-output', analysis: 'analysis-output'
        };

        const button = document.getElementById(buttonMap[action]);
        const outputEl = document.getElementById(outputMap[action]);
        if (!button || !outputEl) { console.error(`Invalid AI action or element mapping: ${action}`); return; }

        state.isAiProcessing = true;
        document.querySelectorAll('.ai-button, .summary-option-btn').forEach(btn => btn.disabled = true);
        
        const originalHTML = button.innerHTML;
        const thinkingHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...';
        if (action === 'summarize') {
            document.querySelectorAll('.summary-option-btn').forEach(b => b.innerHTML = '<i class="fas fa-spinner fa-spin"></i>');
        } else {
            button.innerHTML = thinkingHTML;
        }
        
        await new Promise(resolve => setTimeout(resolve, 50)); // Allow UI to update
        
        try {
            let result;
            switch (action) {
                case 'summarize':
                    result = AI.generateSummary(text, options.size);
                    await typeEffect(outputEl, result);
                    break;
                case 'writing':
                    result = AI.analyzeWriting(text);
                    outputEl.innerHTML = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    break;
                case 'grammar':
                    result = AI.fixGrammar(text);
                    outputEl.innerHTML = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    break;
                case 'qa':
                    const question = document.getElementById('qa-input').value.trim();
                    if (!question) { showError('Please enter a question.'); throw new Error('No Question'); }
                    result = AI.answerQuestion(text, question);
                    outputEl.innerHTML = result;
                    break;
                case 'keypoints':
                    result = AI.extractKeyPoints(text);
                    await typeEffect(outputEl, result);
                    break;
                 case 'keywords':
                    const keywords = AI.extractKeyWords(text, 15);
                    result = keywords.map(kw => `<mark style="display: inline-block; margin: 2px 4px; padding: 3px 8px; border-radius: 8px;">${kw.word}</mark>`).join('');
                    if (!result) result = "No significant keywords found.";
                    outputEl.innerHTML = result;
                    break;
                case 'quiz':
                    result = AI.generateQuiz(text);
                    outputEl.innerHTML = result.replace(/\n/g, '<br>');
                    break;
                case 'analysis':
                    result = AI.analyzeContent(text);
                    outputEl.innerHTML = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    break;
                default: throw new Error('Unknown action.');
            }
        } catch (error) {
            if (error.message !== 'No Question') {
                console.error(`AI action '${action}' failed:`, error);
                outputEl.textContent = `An error occurred. Please try again.`;
            }
        } finally {
            state.isAiProcessing = false;
            document.querySelectorAll('.ai-button, .summary-option-btn').forEach(btn => btn.disabled = false);
            if (action === 'summarize') {
                document.getElementById('summarize-btn-small').innerHTML = "Small";
                document.getElementById('summarize-btn-medium').innerHTML = "Medium";
                document.getElementById('summarize-btn-large').innerHTML = "Large";
            } else {
                button.innerHTML = originalHTML;
            }
        }
    }

    // --- Helper Functions ---
    async function typeEffect(element, text, speed = 10) { element.innerHTML = ''; for (let i = 0; i < text.length; i++) { element.innerHTML += text.charAt(i); await new Promise(resolve => setTimeout(resolve, speed)); } }
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    function showDropOverlay() { DOMElements.dragDropOverlay.classList.add('visible'); }
    function hideDropOverlay() { DOMElements.dragDropOverlay.classList.remove('visible'); }
    function setLoadingState(isLoading, message = '') { if (isLoading) { DOMElements.pdfViewer.innerHTML = `<div class="empty-state" style="height: 50vh;"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top: 1.5rem;">${message}</p></div>`; } else { if (!DOMElements.pdfViewer.hasChildNodes()) setMode('empty'); } }
    function showError(message) { const toast = document.createElement('div'); toast.textContent = message; toast.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background-color: #d32f2f; color:white; padding:12px 20px; border-radius:18px; z-index:9999; font-weight:500; box-shadow: 0 5px 15px rgba(0,0,0,0.2);'; document.body.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; toast.remove(); }, 4000); }
    function handlePaste(e) { e.preventDefault(); const text = (e.clipboardData || window.clipboardData).getData('text/plain'); document.execCommand('insertText', false, text); }
    async function pasteFromClipboard() {
        setMode('text');
        try {
            const text = await navigator.clipboard.readText();
            DOMElements.textEditor.focus();
            document.execCommand('insertText', false, text);
        } catch (err) {
            console.error('Failed to read clipboard contents: ', err);
            showError("Could not paste from clipboard. Your browser might require permissions.");
        }
    }

    function resetAiOutputs() {
        document.getElementById('summary-output').innerHTML = 'Click a size to generate an intelligent summary of your document.';
        document.getElementById('writing-output').innerHTML = 'Get suggestions to improve your writing.';
        document.getElementById('grammar-output').innerHTML = 'Find and correct grammatical errors in your text.';
        document.getElementById('qa-answer').innerHTML = 'Ask a question to get answers based on the content.';
        document.getElementById('keypoints-output').innerHTML = 'Extract the most important points and concepts.';
        document.getElementById('keywords-output').innerHTML = 'Find the most frequent and important keywords.';
        document.getElementById('quiz-output').innerHTML = 'Generate a quiz to test your knowledge.';
        document.getElementById('analysis-output').innerHTML = 'Analyze the sentiment and tone of the document.';
    }

    initialize();
});
</script>
</body>
</html>. 
