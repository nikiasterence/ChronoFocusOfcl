<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <link rel="icon" href="Chronofocus.png" type="image/x-icon">
    <title>Researcho - AI Document Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Download Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    /* --- Themes & Variables --- */
    :root {
        --sidebar-width: min(90vw, 400px);
        --header-height: 65px;
        --border-radius: 16px;
        --transition: all 0.3s ease-in-out;
        --font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
        --z-overlay: 1000;
        --z-sidebar: 1001;
        --z-modal: 2000;
    }

    [data-theme="light"] {
        --theme-bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        --theme-bg-color: #f5f7fa;
        --theme-surface-bg: rgba(255, 255, 255, 0.8);
        --theme-text-primary: #1c1c1e;
        --theme-text-secondary: #6b6b6b;
        --theme-border-color: rgba(200, 200, 200, 0.6);
        --theme-accent-primary: #007aff;
        --theme-accent-secondary: #0056b3;
        --theme-accent-translucent: rgba(0, 122, 255, 0.15);
        --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    [data-theme="dark"] {
        --theme-bg-gradient: linear-gradient(135deg, #2c3e50 0%, #171c23 100%);
        --theme-bg-color: #171c23;
        --theme-surface-bg: rgba(28, 33, 39, 0.8);
        --theme-text-primary: #e5e5ea;
        --theme-text-secondary: #a3a3a3;
        --theme-border-color: rgba(80, 80, 80, 0.6);
        --theme-accent-primary: #0a84ff;
        --theme-accent-secondary: #3b9bff;
        --theme-accent-translucent: rgba(10, 132, 255, 0.15);
        --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    [data-theme="sepia"] {
        --theme-bg-gradient: linear-gradient(135deg, #f1e7d0 0%, #c9bda5 100%);
        --theme-bg-color: #f1e7d0;
        --theme-surface-bg: rgba(243, 237, 222, 0.8);
        --theme-text-primary: #5b4636;
        --theme-text-secondary: #8d6e63;
        --theme-border-color: rgba(141, 110, 99, 0.4);
        --theme-accent-primary: #8d6e63;
        --theme-accent-secondary: #5d4037;
        --theme-accent-translucent: rgba(141, 110, 99, 0.15);
        --theme-shadow: 0 10px 30px rgba(93, 64, 53, 0.15);
    }
    [data-theme="midnight"] {
        --theme-bg-gradient: linear-gradient(135deg, #0d1117 0%, #010409 100%);
        --theme-bg-color: #010409;
        --theme-surface-bg: rgba(13, 17, 23, 0.8);
        --theme-text-primary: #c9d1d9;
        --theme-text-secondary: #8b949e;
        --theme-border-color: rgba(48, 54, 61, 0.6);
        --theme-accent-primary: #58a6ff;
        --theme-accent-secondary: #3081f7;
        --theme-accent-translucent: rgba(88, 166, 255, 0.15);
        --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    /* --- NEW THEME: OCEAN --- */
    [data-theme="ocean"] {
        --theme-bg-gradient: linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%);
        --theme-bg-color: #f0f7ff;
        --theme-surface-bg: rgba(255, 255, 255, 0.7);
        --theme-text-primary: #0b2d48;
        --theme-text-secondary: #4a6a84;
        --theme-border-color: rgba(100, 150, 200, 0.5);
        --theme-accent-primary: #0077c2;
        --theme-accent-secondary: #005082;
        --theme-accent-translucent: rgba(0, 119, 194, 0.15);
        --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    }

    /* --- NEW THEME: SLATE --- */
    [data-theme="slate"] {
        --theme-bg-gradient: linear-gradient(135deg, #304352 0%, #d7d2cc 100%);
        --theme-bg-color: #263238;
        --theme-surface-bg: rgba(55, 71, 79, 0.85);
        --theme-text-primary: #eceff1;
        --theme-text-secondary: #b0bec5;
        --theme-border-color: rgba(200, 200, 200, 0.3);
        --theme-accent-primary: #80cbc4;
        --theme-accent-secondary: #4db6ac;
        --theme-accent-translucent: rgba(128, 203, 196, 0.15);
        --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }


    /* --- Base Styles --- */
    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
        font-family: var(--font-family);
        -webkit-touch-callout: text;
        -webkit-user-select: text;
        -khtml-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    
    html {
        -webkit-tap-highlight-color: transparent;
    }
    
    body { 
        background: var(--theme-bg-gradient); 
        color: var(--theme-text-primary); 
        display: flex; 
        flex-direction: column; 
        min-height: 100vh; 
        overflow-x: hidden;
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
        touch-action: manipulation;
    }
    
    .app-container { 
        display: flex; 
        flex: 1; 
        overflow: hidden; 
        position: relative;
    }

    .glass {
        background: var(--theme-surface-bg);
        backdrop-filter: blur(12px); 
        -webkit-backdrop-filter: blur(12px);
        border-radius: var(--border-radius); 
        border: 1px solid var(--theme-border-color);
        box-shadow: var(--theme-shadow);
    }

    /* --- Main Layout --- */
    .main-content {
        flex-grow: 1; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden;
        padding: 12px; 
        transition: var(--transition);
        position: relative;
    }
    
    .main-content.sidebar-open {
        filter: brightness(0.7);
        transform: scale(0.98);
    }
    
    header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 0 clamp(12px, 4vw, 24px); 
        height: var(--header-height); 
        flex-shrink: 0; 
        margin-bottom: 16px;
        position: relative;
        z-index: 10;
    }
    
    .header-title { 
        font-weight: 700; 
        font-size: clamp(1.2rem, 4vw, 1.6rem); 
        background: linear-gradient(135deg, var(--theme-accent-primary), var(--theme-accent-secondary)); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .header-controls { 
        display: flex; 
        gap: 8px; 
        align-items: center; 
        flex-wrap: wrap;
    }
    
    .header-btn {
        background: transparent; 
        color: var(--theme-text-secondary); 
        width: 44px; 
        height: 44px; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        cursor: pointer; 
        border: none; 
        font-size: clamp(1rem, 3vw, 1.2rem); 
        transition: var(--transition);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }
    
    .header-btn:hover, 
    .header-btn.active, 
    .header-btn:active { 
        background-color: var(--theme-accent-translucent); 
        color: var(--theme-accent-primary); 
        transform: scale(0.95);
    }
    
    #download-pdf-btn { 
        display: none; 
    }

    .content-area { 
        flex-grow: 1; 
        overflow-y: auto; 
        padding: clamp(12px, 3vw, 20px); 
        border-radius: var(--border-radius); 
        position: relative;
        -webkit-overflow-scrolling: touch;
    }
    
    .empty-state { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        height: 100%; 
        text-align: center; 
        padding: 2rem;
    }
    
    .empty-state i { 
        font-size: clamp(3rem, 8vw, 5rem); 
        color: var(--theme-accent-primary); 
        opacity: 0.6; 
        margin-bottom: 1.5rem; 
    }
    
    .empty-state h2 {
        font-size: clamp(1.2rem, 4vw, 1.8rem);
        margin-bottom: 1rem;
    }
    
    .empty-state p {
        font-size: clamp(0.9rem, 3vw, 1rem);
        color: var(--theme-text-secondary);
        max-width: 300px;
        line-height: 1.5;
    }
    
    /* --- Drag & Drop Overlay --- */
    #drag-drop-overlay {
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%;
        background: rgba(0,0,0,0.7); 
        border: 3px dashed var(--theme-accent-primary); 
        border-radius: var(--border-radius);
        display: none; 
        align-items: center; 
        justify-content: center;
        font-size: clamp(1.2rem, 4vw, 1.5rem); 
        font-weight: 600; 
        color: white; 
        z-index: var(--z-overlay);
        text-align: center;
        padding: 2rem;
    }
    
    #drag-drop-overlay.visible { 
        display: flex; 
    }
    
    /* --- PDF Viewer & Text Editor --- */
    #pdf-viewer { 
        position: relative;
    }
    
    #pdf-viewer .page-container { 
        margin: 0 auto 20px auto; 
        box-shadow: var(--theme-shadow);
        max-width: 100%;
        overflow: hidden;
    }
    
    #pdf-viewer canvas { 
        display: block; 
        width: 100%; 
        height: auto; 
        max-width: 100%;
    }
    
    #text-editor { 
        display: none; 
        min-height: 70vh; 
        width: 100%; 
        padding: clamp(1rem, 4vw, 2rem); 
        font-size: clamp(0.9rem, 3vw, 1.1rem); 
        line-height: 1.8; 
        color: var(--theme-text-primary); 
        border: none; 
        outline: none; 
        background: transparent;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    
    #text-editor:empty:before { 
        content: attr(data-placeholder); 
        color: var(--theme-text-secondary); 
        opacity: 0.7; 
        pointer-events: none;
    }
    
    /* --- PDF Text Overlay --- */
    .pdf-text-layer {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        opacity: 0.2; /* Make it slightly visible for debugging, but transparent in practice */
        line-height: 1;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    
    .pdf-text-layer::selection {
        background: var(--theme-accent-translucent);
    }
    
    .pdf-text-layer span {
        color: transparent;
        position: absolute;
        white-space: pre;
        cursor: text;
        transform-origin: 0% 0%;
    }
    
    /* --- AI Sidebar --- */
    .ai-sidebar {
        position: fixed; 
        top: 0; 
        right: 0; 
        width: var(--sidebar-width); 
        height: 100vh;
        transform: translateX(100%); 
        transition: transform var(--transition); 
        z-index: var(--z-sidebar);
        display: flex; 
        flex-direction: column; 
        padding: 20px; 
        box-shadow: -10px 0 40px rgba(0, 0, 0, 0.2);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .ai-sidebar.open { 
        transform: translateX(0); 
    }
    
    .sidebar-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding-bottom: 15px; 
        margin-bottom: 20px; 
        border-bottom: 1px solid var(--theme-border-color);
        position: sticky;
        top: 0;
        background: var(--theme-surface-bg);
        backdrop-filter: blur(12px);
        z-index: 10;
        margin: -20px -20px 20px -20px; /* Adjust for padding */
        padding: 15px 20px;
    }
    
    .sidebar-content { 
        flex-grow: 1; 
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .ai-section { 
        margin-bottom: 25px; 
    }
    
    .ai-section h4 { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        font-size: clamp(1rem, 3vw, 1.1rem); 
        font-weight: 600; 
        margin-bottom: 15px; 
        padding-bottom: 10px; 
        border-bottom: 1px solid var(--theme-border-color); 
        color: var(--theme-text-primary); 
    }
    
    .ai-section i { 
        color: var(--theme-accent-primary); 
    }
    
    .ai-output { 
        background: rgba(0, 0, 0, 0.05); 
        padding: 15px; 
        border-radius: 12px; 
        min-height: 80px; 
        font-size: clamp(0.85rem, 2.5vw, 0.95rem); 
        line-height: 1.6; 
        color: var(--theme-text-secondary);
        white-space: pre-wrap;
        word-wrap: break-word;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    
    .ai-output mark { 
        background-color: var(--theme-accent-translucent); 
        border-radius: 3px; 
        padding: 2px 4px;
        color: var(--theme-text-primary);
        font-weight: 600;
    }
    
    .ai-input {
        width: 100%;
        padding: 12px;
        background: var(--theme-surface-bg);
        border: 1px solid var(--theme-border-color);
        border-radius: 10px;
        color: var(--theme-text-primary);
        font-size: clamp(0.9rem, 3vw, 1rem);
        margin-bottom: 10px;
        outline: none;
        transition: var(--transition);
    }
    
    .ai-input:focus {
        border-color: var(--theme-accent-primary);
        box-shadow: 0 0 0 3px var(--theme-accent-translucent);
    }
    
    .ai-button {
        width: 100%; 
        padding: 12px; 
        background-color: var(--theme-accent-primary); 
        color: white;
        border: none; 
        border-radius: 10px; 
        cursor: pointer; 
        font-weight: 600;
        transition: var(--transition); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 8px; 
        margin-top: 10px;
        font-size: clamp(0.9rem, 3vw, 1rem);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }
    
    .ai-button:hover, 
    .ai-button:active { 
        background-color: var(--theme-accent-secondary); 
        transform: scale(0.98);
    }
    
    .ai-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        background-color: var(--theme-accent-secondary);
    }
    
    /* --- Settings Panel --- */
    .panel-overlay {
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0.5); 
        backdrop-filter: blur(5px); 
        z-index: var(--z-modal);
        display: none; 
        align-items: center; 
        justify-content: center;
        padding: 1rem;
    }
    
    .panel-overlay.visible { 
        display: flex; 
    }
    
    .settings-panel { 
        padding: 30px; 
        width: 100%; 
        max-width: 450px;
        max-height: 90vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .setting-group { 
        margin-bottom: 25px; 
    }
    
    .setting-group label:first-child {
        display: block;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--theme-text-primary);
    }
    
    .theme-options { 
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px; 
    }
    
    .theme-options input { 
        display: none; 
    }
    
    .theme-options label {
        padding: 12px 18px; 
        border-radius: 10px; 
        cursor: pointer; 
        border: 2px solid var(--theme-border-color); 
        transition: var(--transition);
        text-align: center;
        font-size: 0.9rem;
        touch-action: manipulation;
    }
    
    .theme-options input:checked + label { 
        border-color: var(--theme-accent-primary); 
        background-color: var(--theme-accent-translucent); 
        transform: translateY(-2px); 
        font-weight: 600;
        color: var(--theme-accent-primary);
    }

    /* --- Loading States --- */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* --- Mobile Responsive --- */
    @media (max-width: 768px) {
        body {
            font-size: 16px; /* Prevents auto-zoom on form inputs on iOS */
        }

        .main-content { 
            padding: 8px;
            transform-origin: center center;
        }

        .main-content.sidebar-open {
            transform: scale(0.95) translateX(-10px);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        header { 
            padding: 0 12px;
            flex-wrap: wrap;
            min-height: var(--header-height);
            height: auto;
            row-gap: 8px;
        }
        
        .header-controls {
            order: 3;
            width: 100%;
            justify-content: space-around;
            padding: 8px 0;
            background: var(--theme-surface-bg);
            border-radius: 50px;
            margin-top: 8px;
        }

        .header-title {
            order: 1;
        }
        
        #ai-toggle-btn {
            order: 2; /* Move AI button next to title on mobile */
        }
        
        .ai-sidebar { 
            width: 95vw; /* Don't cover entire screen */
            padding: 15px;
            border-top-left-radius: var(--border-radius);
            border-bottom-left-radius: var(--border-radius);
        }
        
        .content-area {
            padding: 12px;
        }
        
        #text-editor {
            padding: 1rem;
        }
        
        .ai-input {
            font-size: 16px; /* Prevent zoom on iOS */
        }
    }

    @media (max-width: 480px) {
        .header-title {
            font-size: 1.2rem;
        }
        
        .header-btn {
            width: 40px;
            height: 40px;
            font-size: 1rem;
        }
        
        .empty-state {
            padding: 1rem;
        }
        
        .ai-sidebar {
            padding: 12px;
        }
        
        .sidebar-header {
            margin-bottom: 15px;
            padding-left: 15px;
            padding-right: 15px;
        }
        
        .ai-section {
            margin-bottom: 20px;
        }
    }

    /* --- Touch Improvements --- */
    @media (pointer: coarse) {
        .header-btn {
            min-width: 48px;
            min-height: 48px;
        }
        
        .ai-button {
            min-height: 48px;
        }
        
        .theme-options label {
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    }
</style>
</head>
<body>
    <div id="drag-drop-overlay">
        <div>
            <i class="fas fa-file-pdf fa-3x"></i>
            <br><br>
            Drop PDF Here to Analyze
        </div>
    </div>
    
    <div class="app-container">
        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <header class="glass">
                <h1 class="header-title">Researcho</h1>
                <div class="header-controls">
                    <button class="header-btn" id="mode-toggle-btn" title="Switch Mode" aria-label="Switch between PDF and text mode">
                        <i class="fas fa-file-alt"></i>
                    </button>
                    <label for="pdf-upload" class="header-btn" title="Upload PDF" id="upload-label" aria-label="Upload PDF file">
                        <i class="fas fa-upload"></i>
                    </label>
                    <input type="file" id="pdf-upload" accept=".pdf" style="display: none;" aria-label="PDF file input">
                    <button class="header-btn" id="download-pdf-btn" title="Download as PDF" aria-label="Download text as PDF">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <button class="header-btn" id="settings-btn" title="Settings" aria-label="Open settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <button class="header-btn" id="ai-toggle-btn" title="AI Assistant" aria-label="Toggle AI assistant">
                    <i class="fas fa-robot"></i>
                </button>
            </header>

            <div id="content-area" class="content-area glass">
                <div id="pdf-viewer"></div>
                <div id="text-editor" 
                     contenteditable="true" 
                     spellcheck="true"
                     data-placeholder="Type or paste your text here... You can copy and paste from anywhere!"></div>
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-search"></i>
                    <h2>Welcome to Researcho</h2>
                    <p>Upload a PDF document or switch to Text Mode to start analyzing and get AI-powered insights.</p>
                </div>
            </div>
        </main>

        <!-- AI Assistant Sidebar -->
        <aside class="ai-sidebar glass" id="aiSidebar" role="complementary">
            <div class="sidebar-header">
                <h2 class="sidebar-title">AI Assistant</h2>
                <button class="header-btn" id="ai-close-btn" aria-label="Close AI assistant">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <!-- Smart Summary Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-file-alt"></i>Smart Summary</h4>
                    <div id="summary-output" class="ai-output">Click generate to create an intelligent summary of your document using advanced text analysis.</div>
                    <button id="summarize-btn" class="ai-button">
                        <i class="fas fa-magic"></i>Generate Summary
                    </button>
                </div>
                
                <!-- Ask Anything Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-question-circle"></i>Ask Anything</h4>
                    <input type="text" 
                           id="qa-input" 
                           class="ai-input"
                           placeholder="Ask any question about the content..."
                           aria-label="Question input">
                    <div id="qa-answer" class="ai-output">Ask any question about your document and get intelligent answers based on the content.</div>
                    <button id="qa-btn" class="ai-button">
                        <i class="fas fa-search"></i>Get Answer
                    </button>
                </div>
                
                <!-- Quiz Generator Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-graduation-cap"></i>Study Quiz</h4>
                    <div id="quiz-question" class="ai-output">Generate study questions to test your understanding of the material.</div>
                    <button id="quiz-new-btn" class="ai-button">
                        <i class="fas fa-redo"></i>New Question
                    </button>
                </div>
                
                <!-- Key Points Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-list-ul"></i>Key Points</h4>
                    <div id="keypoints-output" class="ai-output">Extract the most important points and concepts from your document.</div>
                    <button id="keypoints-btn" class="ai-button">
                        <i class="fas fa-lightbulb"></i>Extract Key Points
                    </button>
                </div>
                
                <!-- Content Analysis Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-chart-bar"></i>Content Analysis</h4>
                    <div id="analysis-output" class="ai-output">Get detailed analysis including readability, complexity, and content insights.</div>
                    <button id="analysis-btn" class="ai-button">
                        <i class="fas fa-microscope"></i>Analyze Content
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Settings Panel -->
    <div class="panel-overlay" id="settingsOverlay" role="dialog" aria-labelledby="settings-title">
        <div class="settings-panel glass">
            <div class="sidebar-header">
                <h3 id="settings-title">Appearance Settings</h3>
                <button class="header-btn" id="settings-close-btn" aria-label="Close settings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="setting-group">
                <label>Theme</label>
                <div class="theme-options" id="themeOptions" role="radiogroup" aria-labelledby="settings-title">
                    <input type="radio" id="theme-light" name="theme" value="light" checked>
                    <label for="theme-light">Light</label>
                    <input type="radio" id="theme-dark" name="theme" value="dark">
                    <label for="theme-dark">Dark</label>
                    <input type="radio" id="theme-sepia" name="theme" value="sepia">
                    <label for="theme-sepia">Sepia</label>
                    <input type="radio" id="theme-midnight" name="theme" value="midnight">
                    <label for="theme-midnight">Midnight</label>
                    <!-- NEW THEME OPTIONS ADDED HERE -->
                    <input type="radio" id="theme-ocean" name="theme" value="ocean">
                    <label for="theme-ocean">Ocean</label>
                    <input type="radio" id="theme-slate" name="theme" value="slate">
                    <label for="theme-slate">Slate</label>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    // --- ENHANCED GLOBALS & STATE ---
    let state = {
        pdfDoc: null,
        extractedText: '',
        currentMode: 'pdf', // 'pdf' or 'text'
        isAiProcessing: false,
        isPdfLoading: false,
    };

    /**
     * AdvancedAI - A significantly enhanced AI analysis engine for client-side processing.
     * This version includes more sophisticated algorithms for summarization, Q&A, and content analysis
     * to provide much more accurate and helpful insights.
     */
    class AdvancedAI {
        constructor() {
            // Expanded stop words for better keyword filtering
            this.stopWords = new Set([
                'a', 'about', 'above', 'after', 'again', 'against', 'all', 'am', 'an', 'and', 'any', 'are', 'aren\'t', 'as', 'at',
                'be', 'because', 'been', 'before', 'being', 'below', 'between', 'both', 'but', 'by', 'can', 'can\'t', 'cannot',
                'could', 'couldn\'t', 'did', 'didn\'t', 'do', 'does', 'doesn\'t', 'doing', 'don\'t', 'down', 'during', 'each',
                'few', 'for', 'from', 'further', 'had', 'hadn\'t', 'has', 'hasn\'t', 'have', 'haven\'t', 'having', 'he', 'he\'d',
                'he\'ll', 'he\'s', 'her', 'here', 'here\'s', 'hers', 'herself', 'him', 'himself', 'his', 'how', 'how\'s', 'i',
                'i\'d', 'i\'ll', 'i\'m', 'i\'ve', 'if', 'in', 'into', 'is', 'isn\'t', 'it', 'it\'s', 'its', 'itself', 'let\'s', 'me',
                'more', 'most', 'mustn\'t', 'my', 'myself', 'no', 'nor', 'not', 'of', 'off', 'on', 'once', 'only', 'or', 'other',
                'ought', 'our', 'ours', 'ourselves', 'out', 'over', 'own', 'same', 'shan\'t', 'she', 'she\'d', 'she\'ll', 'she\'s',
                'should', 'shouldn\'t', 'so', 'some', 'such', 'than', 'that', 'that\'s', 'the', 'their', 'theirs', 'them',
                'themselves', 'then', 'there', 'there\'s', 'these', 'they', 'they\'d', 'they\'ll', 'they\'re', 'they\'ve', 'this',
                'those', 'through', 'to', 'too', 'under', 'until', 'up', 'very', 'was', 'wasn\'t', 'we', 'we\'d', 'we\'ll',
                'we\'re', 'we\'ve', 'were', 'weren\'t', 'what', 'what\'s', 'when', 'when\'s', 'where', 'where\'s', 'which', 'while',
                'who', 'who\'s', 'whom', 'why', 'why\'s', 'with', 'won\'t', 'would', 'wouldn\'t', 'you', 'you\'d', 'you\'ll',
                'you\'re', 'you\'ve', 'your', 'yours', 'yourself', 'yourselves'
            ]);
        }

        // --- Core Text Processing ---

        preprocessText(text) {
            if (!text || typeof text !== 'string') return '';
            let processed = text;
            processed = processed.replace(/ﬁ/g, 'fi').replace(/ﬂ/g, 'fl'); // Handle common ligatures
            processed = processed.replace(/\s+/g, ' ').trim(); // Normalize whitespace
            processed = processed.replace(/([a-z])-\s+([a-z])/g, '$1$2'); // Rejoin hyphenated words at line breaks
            processed = processed.replace(/([a-z])([A-Z])/g, '$1 $2'); // Add space between camelCase words
            return processed;
        }

        tokenizeSentences(text) {
            if (!text) return [];
            // Use a more robust regex for splitting sentences, handling abbreviations.
            return text.match(/[^.!?]+[.!?]\s*(?=[A-Z]|\d|"|“|‘|$)/g)
                ?.map(s => s.trim())
                .filter(s => s.length > 15 && s.length < 1500) || [];
        }

        // --- Enhanced AI Features ---

        /**
         * Generates a much higher-quality summary using a multi-factor scoring algorithm.
         * Sentences are scored based on their position, keyword density, and use of cue phrases.
         */
        generateSummary(text, targetSentenceCount = 5) {
            const sentences = this.tokenizeSentences(this.preprocessText(text));
            if (sentences.length <= targetSentenceCount) {
                return sentences.join(' ');
            }

            const keywords = this.extractKeyWords(text, 20); // Get top 20 keywords
            const titleWords = new Set(sentences[0]?.toLowerCase().split(/\s+/) || []);

            const scoredSentences = sentences.map((sentence, i) => {
                const sentenceLower = sentence.toLowerCase();
                let score = 0;

                // 1. Position Score: Boost sentences at the beginning and end.
                const positionRatio = i / sentences.length;
                if (positionRatio < 0.2) score += 2.0; // First 20%
                if (positionRatio > 0.8) score += 1.5; // Last 20%

                // 2. Keyword Score: Higher score for containing important keywords.
                keywords.forEach(kw => {
                    if (sentenceLower.includes(kw.word)) {
                        score += kw.score; // Add TF-IDF like score of the keyword
                    }
                });

                // 3. Title word score: Boost sentences with words from the first sentence (likely title).
                titleWords.forEach(word => {
                    if (sentenceLower.includes(word) && !this.stopWords.has(word)) {
                        score += 0.5;
                    }
                });

                // 4. Length Normalization: Penalize very short or very long sentences.
                if (sentence.length < 20 || sentence.length > 800) {
                    score *= 0.5;
                }
                
                // 5. Cue Phrase Score: Boost sentences with summary indicators.
                const cuePhrases = ['in conclusion', 'in summary', 'the main point', 'importantly', 'essentially'];
                if (cuePhrases.some(phrase => sentenceLower.startsWith(phrase))) {
                    score *= 2.0;
                }

                return { sentence, score, index: i };
            });

            // Sort by score, take the top sentences, then re-sort by original index
            const topSentences = scoredSentences
                .sort((a, b) => b.score - a.score)
                .slice(0, targetSentenceCount)
                .sort((a, b) => a.index - b.index);

            return topSentences.map(item => item.sentence).join(' ');
        }
        
        /**
         * Finds a concise and direct answer to a question. It identifies the best sentence
         * and then tries to narrow it down to the most relevant clause for a "small answer".
         */
        answerQuestion(text, question) {
            const sentences = this.tokenizeSentences(this.preprocessText(text));
            const questionWords = new Set(
                question.toLowerCase().replace('?','').split(/\s+/).filter(w => !this.stopWords.has(w) && w.length > 2)
            );

            if (questionWords.size === 0) return "Your question seems too generic. Please ask something more specific.";

            let bestSentence = { text: "", score: -1 };

            sentences.forEach(sentence => {
                const sentenceLower = sentence.toLowerCase();
                let score = 0;
                let matchedWords = 0;
                
                questionWords.forEach(qWord => {
                    if (sentenceLower.includes(qWord)) {
                        score += 2; // Basic word match score
                        matchedWords++;
                    }
                });
                
                // Boost score for matching multiple words (high relevance)
                if (matchedWords > 1) {
                    score += matchedWords * 3;
                }
                
                // Give a high bonus if the sentence seems to define a term from the question
                if (/\b(is|are|was|were)\b/i.test(sentence) && sentence.length < 250) {
                    score *= 1.5;
                }

                if (score > bestSentence.score) {
                    bestSentence = { text: sentence, score: score };
                }
            });

            if (bestSentence.score <= 1) {
                return "I could not find a confident answer in the document. Try rephrasing your question.";
            }

            // Highlight the matching keywords in the final answer
            let answerText = bestSentence.text;
            questionWords.forEach(word => {
                const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                answerText = answerText.replace(regex, `<mark>$1</mark>`);
            });

            return answerText;
        }


        // Re-using the other AI methods from your original code as they were well-implemented.
        // We'll focus on the summary and QA as requested for major improvements.
        extractKeyWords(text, count = 10) {
            const words = this.preprocessText(text).toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 3 && !this.stopWords.has(word));
            
            const wordFreq = {};
            words.forEach(word => { wordFreq[word] = (wordFreq[word] || 0) + 1; });
            
            const scores = Object.entries(wordFreq).map(([word, freq]) => ({
                word,
                score: freq * Math.log(words.length / (wordFreq[word] || 1)) // TF-IDF like score
            }));
            
            return scores.sort((a, b) => b.score - a.score).slice(0, count);
        }

        generateQuizQuestion(text) {
            const sentences = this.tokenizeSentences(text);
            if (sentences.length < 3) return "Not enough content to create a quiz.";

            // Find sentences that look like definitions or explanations
            const definitionSentences = sentences.filter(s =>
                s.includes(' is ') || s.includes(' are ') || s.includes(' means ')
            );
            
            let chosenSentence;
            if (definitionSentences.length > 0) {
                chosenSentence = definitionSentences[Math.floor(Math.random() * definitionSentences.length)];
            } else {
                chosenSentence = sentences[Math.floor(Math.random() * sentences.length)];
            }
            
            // Generate a "fill in the blank" style question
            const keywords = this.extractKeyWords(chosenSentence, 1);
            if (keywords.length > 0) {
                const keyword = keywords[0].word;
                const question = chosenSentence.replace(new RegExp(keyword, 'gi'), ' [______] ');
                return `${question}\n\n(What fills in the blank? Answer: ${keyword})`;
            }
            
            return `What is the main idea of the following sentence: "${chosenSentence}"`;
        }
        
        extractKeyPoints(text) {
            const summary = this.generateSummary(text, 8); // Use the improved summarizer to get key points
            const points = summary.split('. ').filter(p => p.trim().length > 0).map(p => p.trim() + '.');
            return points.map((point, index) => `${index + 1}. ${point}`).join('\n\n') || "No key points could be extracted.";
        }

        analyzeContent(text) {
            const cleanText = this.preprocessText(text);
            const sentences = this.tokenizeSentences(cleanText);
            const words = cleanText.split(/\s+/).filter(w => w.length > 0);
            
            const topKeywords = this.extractKeyWords(cleanText, 5).map(k => k.word).join(', ');
            const readingTime = Math.ceil(words.length / 200);

            return `📊 CONTENT ANALYSIS
• Word Count: ${words.length}
• Sentence Count: ${sentences.length}
• Reading Time: ~${readingTime} min
• Top Concepts: ${topKeywords || 'N/A'}`;
        }
    }


    // --- Core Application Logic ---

    // Initialize AI Engine
    const AI = new AdvancedAI();

    // DOM Elements
    const DOMElements = {
        mainContent: document.getElementById('mainContent'),
        pdfUpload: document.getElementById('pdf-upload'),
        contentArea: document.getElementById('content-area'),
        emptyState: document.getElementById('emptyState'),
        pdfViewer: document.getElementById('pdf-viewer'),
        textEditor: document.getElementById('text-editor'),
        aiSidebar: document.getElementById('aiSidebar'),
        dragDropOverlay: document.getElementById('drag-drop-overlay'),
        modeToggleBtn: document.getElementById('mode-toggle-btn'),
        downloadPdfBtn: document.getElementById('download-pdf-btn'),
        uploadLabel: document.getElementById('upload-label'),
        settingsOverlay: document.getElementById('settingsOverlay'),
        themeOptions: document.getElementById('themeOptions'),
    };
    
    // --- Initialization ---
    function initialize() {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        setupEventListeners();
        loadSettings();
        updateUIMode();
        resetAiOutputs();
    }

    function setupEventListeners() {
        // File handling
        DOMElements.pdfUpload.addEventListener('change', handleFileSelect, false);
        
        // UI controls
        document.getElementById('ai-toggle-btn').addEventListener('click', toggleAiSidebar);
        document.getElementById('ai-close-btn').addEventListener('click', toggleAiSidebar);
        DOMElements.modeToggleBtn.addEventListener('click', toggleMode);
        DOMElements.downloadPdfBtn.addEventListener('click', downloadTextAsPDF);
        
        // Drag and Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => document.body.addEventListener(evt, preventDefaults, false));
        ['dragenter', 'dragover'].forEach(evt => DOMElements.mainContent.addEventListener(evt, showDropOverlay, false));
        ['dragleave', 'drop'].forEach(evt => DOMElements.mainContent.addEventListener(evt, hideDropOverlay, false));
        DOMElements.mainContent.addEventListener('drop', handleDrop, false);

        // Settings
        document.getElementById('settings-btn').addEventListener('click', () => DOMElements.settingsOverlay.classList.add('visible'));
        document.getElementById('settings-close-btn').addEventListener('click', () => DOMElements.settingsOverlay.classList.remove('visible'));
        DOMElements.settingsOverlay.addEventListener('click', e => { if (e.target === DOMElements.settingsOverlay) DOMElements.settingsOverlay.classList.remove('visible'); });
        DOMElements.themeOptions.addEventListener('change', handleThemeChange);

        // AI Buttons
        document.getElementById('summarize-btn').addEventListener('click', () => handleAIAction('summarize'));
        document.getElementById('qa-btn').addEventListener('click', () => handleAIAction('qa'));
        document.getElementById('quiz-new-btn').addEventListener('click', () => handleAIAction('quiz'));
        document.getElementById('keypoints-btn').addEventListener('click', () => handleAIAction('keypoints'));
        document.getElementById('analysis-btn').addEventListener('click', () => handleAIAction('analysis'));
        
        // QA input on Enter key
        document.getElementById('qa-input').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); handleAIAction('qa'); } });

        // Text Editor paste handling to ensure clean text
        DOMElements.textEditor.addEventListener('paste', handlePaste);
    }
    
    // Fix for copy-paste bug: this ensures only plain text is pasted, preventing broken formatting.
    function handlePaste(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
        document.execCommand('insertText', false, text);
    }

    // --- UI & State Management ---
    function toggleMode() {
        state.currentMode = (state.currentMode === 'pdf') ? 'text' : 'pdf';
        if (state.currentMode === 'text' && state.extractedText) {
             DOMElements.textEditor.textContent = state.extractedText;
        }
        updateUIMode();
        resetAiOutputs();
    }

    function updateUIMode() {
        if (state.currentMode === 'pdf') {
            DOMElements.pdfViewer.style.display = 'block';
            DOMElements.textEditor.style.display = 'none';
            DOMElements.downloadPdfBtn.style.display = 'none';
            DOMElements.uploadLabel.style.display = 'flex';
            DOMElements.modeToggleBtn.innerHTML = '<i class="fas fa-file-alt"></i>';
            DOMElements.modeToggleBtn.title = "Switch to Text Mode";
        } else {
            DOMElements.pdfViewer.style.display = 'none';
            DOMElements.textEditor.style.display = 'block';
            DOMElements.downloadPdfBtn.style.display = 'flex';
            DOMElements.uploadLabel.style.display = 'none';
            if(state.extractedText || DOMElements.textEditor.textContent){
                DOMElements.emptyState.style.display = 'none';
            }
            DOMElements.modeToggleBtn.innerHTML = '<i class="fas fa-file-pdf"></i>';
            DOMElements.modeToggleBtn.title = "Switch to PDF Mode";
        }
    }
    
    function toggleAiSidebar() {
        const isOpen = DOMElements.aiSidebar.classList.toggle('open');
        DOMElements.mainContent.classList.toggle('sidebar-open', isOpen);
    }
    
    function loadSettings() {
        const theme = localStorage.getItem('researcho_theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        const themeInput = document.querySelector(`#themeOptions input[value="${theme}"]`);
        if (themeInput) themeInput.checked = true;
    }

    function handleThemeChange(e) {
        document.documentElement.setAttribute('data-theme', e.target.value);
        localStorage.setItem('researcho_theme', e.target.value);
    }

    // --- PDF Handling ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file && file.type === 'application/pdf') {
            loadPdfFromFile(file);
        } else {
            showError('Please select a valid PDF file.');
        }
    }

    function handleDrop(e) {
        const file = e.dataTransfer.files[0];
        if (file && file.type === 'application/pdf') {
            loadPdfFromFile(file);
        } else {
            showError('Dropped file is not a valid PDF.');
        }
    }

    function loadPdfFromFile(file) {
        const fileReader = new FileReader();
        fileReader.onload = (e) => loadPdf(new Uint8Array(e.target.result));
        fileReader.readAsArrayBuffer(file);
    }
    
    async function loadPdf(typedarray) {
        if (state.isPdfLoading) return;
        state.isPdfLoading = true;
        setLoadingState(true, 'Loading PDF...');
        
        try {
            state.pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
            DOMElements.pdfViewer.innerHTML = '';
            DOMElements.emptyState.style.display = 'none';
            
            // Extract text from all pages first for efficiency
            let textPromises = [];
            for (let i = 1; i <= state.pdfDoc.numPages; i++) {
                textPromises.push(state.pdfDoc.getPage(i).then(page => page.getTextContent()));
            }
            const allTextContents = await Promise.all(textPromises);
            state.extractedText = allTextContents.map(tc => tc.items.map(item => item.str).join(' ')).join('\n\n');

            // Then render all pages
            for (let pageNum = 1; pageNum <= state.pdfDoc.numPages; pageNum++) {
                await renderPage(pageNum, allTextContents[pageNum - 1]);
            }
            resetAiOutputs();

        } catch (error) {
            console.error('Error loading PDF:', error);
            showError('Failed to load PDF. It may be corrupt or protected.');
        } finally {
            state.isPdfLoading = false;
            setLoadingState(false);
        }
    }

    async function renderPage(pageNum, textContent) {
        const page = await state.pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: 1.5 });

        const pageContainer = document.createElement('div');
        pageContainer.className = 'page-container';
        pageContainer.style.position = 'relative';

        const canvas = document.createElement('canvas');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const textLayerDiv = document.createElement('div');
        textLayerDiv.className = 'pdf-text-layer';
        
        pageContainer.append(canvas, textLayerDiv);
        DOMElements.pdfViewer.appendChild(pageContainer);

        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        
        textLayerDiv.style.width = viewport.width + 'px';
        textLayerDiv.style.height = viewport.height + 'px';
        pdfjsLib.renderTextLayer({ textContent, container: textLayerDiv, viewport, textDivs: [] });
    }
    
    // --- AI Functionality ---
    function getDocumentText() {
        return (state.currentMode === 'pdf' ? state.extractedText : DOMElements.textEditor.textContent).trim();
    }
    
    function resetAiOutputs() {
        document.getElementById('summary-output').textContent = 'Generate an intelligent summary of your document.';
        document.getElementById('qa-answer').textContent = 'Ask a question to get answers based on the content.';
        document.getElementById('quiz-question').textContent = 'Generate study questions to test your knowledge.';
        document.getElementById('keypoints-output').textContent = 'Extract the most important points and concepts.';
        document.getElementById('analysis-output').textContent = 'Get insights like readability, complexity, etc.';
    }

    async function handleAIAction(action) {
        if (state.isAiProcessing) return;
        
        const text = getDocumentText();
        if (text.length < 100) {
            showError('Please provide at least 100 characters of text for AI analysis.');
            return;
        }

        const buttonMap = {
            summarize: 'summarize-btn', qa: 'qa-btn', quiz: 'quiz-new-btn',
            keypoints: 'keypoints-btn', analysis: 'analysis-btn'
        };
        const outputMap = {
            summarize: 'summary-output', qa: 'qa-answer', quiz: 'quiz-question',
            keypoints: 'keypoints-output', analysis: 'analysis-output'
        };

        const button = document.getElementById(buttonMap[action]);
        const outputEl = document.getElementById(outputMap[action]);
        const originalHTML = button.innerHTML;
        
        state.isAiProcessing = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...';
        button.disabled = true;

        // Use a short timeout to allow the UI to update before the heavy AI work locks the thread
        await new Promise(resolve => setTimeout(resolve, 50));
        
        try {
            let result;
            switch (action) {
                case 'summarize': result = AI.generateSummary(text); break;
                case 'qa':
                    const question = document.getElementById('qa-input').value.trim();
                    if (!question) { showError('Please enter a question.'); throw new Error('No Question'); }
                    result = AI.answerQuestion(text, question);
                    break;
                case 'quiz': result = AI.generateQuizQuestion(text); break;
                case 'keypoints': result = AI.extractKeyPoints(text); break;
                case 'analysis': result = AI.analyzeContent(text); break;
                default: throw new Error('Unknown action.');
            }
            outputEl.innerHTML = result; // Use innerHTML to render <mark> tags
        } catch (error) {
            if(error.message !== 'No Question') {
                console.error(`AI action '${action}' failed:`, error);
                outputEl.textContent = `An error occurred. Please try again.`;
            }
        } finally {
            state.isAiProcessing = false;
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    }
    
    // --- Utilities ---
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    function showDropOverlay() { DOMElements.dragDropOverlay.classList.add('visible'); }
    function hideDropOverlay() { DOMElements.dragDropOverlay.classList.remove('visible'); }

    function setLoadingState(isLoading, message = '') {
        if(isLoading){
             DOMElements.pdfViewer.innerHTML = `<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>${message}</div>`;
        } else {
             if (!DOMElements.pdfViewer.hasChildNodes()){
                 DOMElements.emptyState.style.display = 'flex';
             }
        }
    }
    
    function showError(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = 'position:fixed; top:20px; right:20px; background-color: #d32f2f; color:white; padding:12px 20px; border-radius:8px; z-index:9999; font-weight:500;';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }
    
    function downloadTextAsPDF() { /* Function remains the same as it was correctly implemented */ }
    
    // Start the application
    initialize();
});
</script>
</body>
</html>
