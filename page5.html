<!DOCTYPE html>
<html lang="en" data-theme="apple-notes">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <link rel="icon" href="Chronofocus.png" type="image/x-icon">
    <title>Gridora - AI Document Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF & Download Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- Enhanced Variables & Base Styles --- */
        :root {
            --sidebar-width: min(90vw, 400px);
            --header-height: 65px;
            --border-radius: 24px;
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
            --z-overlay: 1000;
            --z-sidebar: 1001;
            --z-modal: 2000;
            --dynamic-island-height: 40px;
            --dynamic-island-expanded-height: 80px;
        }

        /* --- Enhanced APPLE NOTES THEME --- */
        [data-theme="apple-notes"] {
            --theme-bg-gradient: linear-gradient(135deg, #f5f5f0 0%, #e8e8e0 100%);
            --theme-bg-color: #f7f7f0;
            --theme-bg-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="4" viewBox="0 0 4 4"><path fill="%239C92AC" fill-opacity="0.06" d="M1 3h1v1H1V3zm2-2h1v1H3V1z"></path></svg>');
            --theme-surface-bg: #ffffff;
            --theme-text-primary: #1c1c1e;
            --theme-text-secondary: #6b6b6b;
            --theme-border-color: #e5e5e0;
            --theme-accent-primary: #FFCC00;
            --theme-accent-secondary: #e6b800;
            --theme-accent-translucent: rgba(255, 204, 0, 0.2);
            --theme-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            --theme-card-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            --theme-sidebar-bg: #fdfdfa;
            --dynamic-island-bg: #1c1c1e;
        }

        /* --- Other themes remain the same as in original code --- */
        [data-theme="grammarly"] {
            --theme-bg-gradient: linear-gradient(135deg, #f9f9f9 0%, #e8e8e8 100%);
            --theme-bg-color: #f5f5f5;
            --theme-bg-image: none;
            --theme-surface-bg: #ffffff;
            --theme-text-primary: #1a1a1a;
            --theme-text-secondary: #666666;
            --theme-border-color: #e0e0e0;
            --theme-accent-primary: #15C39A;
            --theme-accent-secondary: #12a785;
            --theme-accent-translucent: rgba(21, 195, 154, 0.2);
            --theme-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --theme-card-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            --theme-sidebar-bg: #fafafa;
            --dynamic-island-bg: #15C39A;
        }
        [data-theme="light"] {
            --theme-bg-gradient: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            --theme-bg-color: #ffffff;
            --theme-bg-image: none;
            --theme-surface-bg: #f9f9f9;
            --theme-text-primary: #1a1a1a;
            --theme-text-secondary: #666666;
            --theme-border-color: #e0e0e0;
            --theme-accent-primary: #007AFF;
            --theme-accent-secondary: #0056CC;
            --theme-accent-translucent: rgba(0, 122, 255, 0.2);
            --theme-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --theme-card-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            --theme-sidebar-bg: #f5f5f5;
            --dynamic-island-bg: #007AFF;
        }
        [data-theme="dark"] {
            --theme-bg-gradient: linear-gradient(135deg, #1c1c1e 0%, #2c2c2e 100%);
            --theme-bg-color: #1c1c1e;
            --theme-bg-image: none;
            --theme-surface-bg: #2c2c2e;
            --theme-text-primary: #ffffff;
            --theme-text-secondary: #a0a0a0;
            --theme-border-color: #3a3a3c;
            --theme-accent-primary: #0A84FF;
            --theme-accent-secondary: #0066CC;
            --theme-accent-translucent: rgba(10, 132, 255, 0.2);
            --theme-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            --theme-card-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            --theme-sidebar-bg: #2c2c2e;
            --dynamic-island-bg: #0A84FF;
        }
        [data-theme="sepia"] {
            --theme-bg-gradient: linear-gradient(135deg, #f5f0e6 0%, #e8e0d0 100%);
            --theme-bg-color: #f5f0e6;
            --theme-bg-image: none;
            --theme-surface-bg: #f9f5ed;
            --theme-text-primary: #3c2f2f;
            --theme-text-secondary: #7a6a5a;
            --theme-border-color: #d9c7a7;
            --theme-accent-primary: #8B4513;
            --theme-accent-secondary: #654321;
            --theme-accent-translucent: rgba(139, 69, 19, 0.2);
            --theme-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --theme-card-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            --theme-sidebar-bg: #f9f5ed;
            --dynamic-island-bg: #8B4513;
        }
        [data-theme="midnight"] {
            --theme-bg-gradient: linear-gradient(135deg, #0d0d0d 0%, #1a1a1a 100%);
            --theme-bg-color: #0d0d0d;
            --theme-bg-image: none;
            --theme-surface-bg: #1a1a1a;
            --theme-text-primary: #ffffff;
            --theme-text-secondary: #a0a0a0;
            --theme-border-color: #2a2a2a;
            --theme-accent-primary: #BB86FC;
            --theme-accent-secondary: #9b5fe0;
            --theme-accent-translucent: rgba(187, 134, 252, 0.2);
            --theme-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            --theme-card-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --theme-sidebar-bg: #1a1a1a;
            --dynamic-island-bg: #BB86FC;
        }
        [data-theme="ocean"] {
            --theme-bg-gradient: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            --theme-bg-color: #e3f2fd;
            --theme-bg-image: none;
            --theme-surface-bg: #ffffff;
            --theme-text-primary: #0d47a1;
            --theme-text-secondary: #546e7a;
            --theme-border-color: #bbdefb;
            --theme-accent-primary: #2196F3;
            --theme-accent-secondary: #1976D2;
            --theme-accent-translucent: rgba(33, 150, 243, 0.2);
            --theme-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --theme-card-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            --theme-sidebar-bg: #f5fbff;
            --dynamic-island-bg: #2196F3;
        }
        [data-theme="slate"] {
            --theme-bg-gradient: linear-gradient(135deg, #37474f 0%, #263238 100%);
            --theme-bg-color: #37474f;
            --theme-bg-image: none;
            --theme-surface-bg: #455a64;
            --theme-text-primary: #ffffff;
            --theme-text-secondary: #b0bec5;
            --theme-border-color: #546e7a;
            --theme-accent-primary: #78909C;
            --theme-accent-secondary: #607D8B;
            --theme-accent-translucent: rgba(120, 144, 156, 0.2);
            --theme-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            --theme-card-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            --theme-sidebar-bg: #455a64;
            --dynamic-island-bg: #78909C;
        }

        /* --- Enhanced Base Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
            -webkit-touch-callout: text;
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        html {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--theme-bg-color);
            background-image: var(--theme-bg-image), var(--theme-bg-gradient);
            color: var(--theme-text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
            touch-action: manipulation;
        }

        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .glass {
            background: var(--theme-surface-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: var(--border-radius);
            border: 1px solid var(--theme-border-color);
            box-shadow: var(--theme-shadow);
        }

        /* --- Enhanced Dynamic Island --- */
        .dynamic-island {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: var(--dynamic-island-height);
            background-color: var(--dynamic-island-bg);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: var(--transition);
            overflow: hidden;
            animation: island-appear 0.5s ease-out;
            cursor: pointer;
        }

        .dynamic-island-content {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--theme-surface-bg);
            font-size: 0.8rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .dynamic-island.expanded {
            width: 280px;
            height: var(--dynamic-island-expanded-height);
            animation: island-expand 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .dynamic-island.hidden {
            transform: translateX(-50%) translateY(-100px);
            opacity: 0;
        }

        .dynamic-island-tools {
            display: none;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 8px;
            width: 100%;
            height: 100%;
        }

        .dynamic-island.expanded .dynamic-island-tools {
            display: flex;
            animation: tools-appear 0.3s ease-out 0.2s both;
        }

        .dynamic-island.expanded .dynamic-island-content {
            display: none;
        }

        .dynamic-tool {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }

        .dynamic-tool:hover {
            background-color: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        @keyframes island-appear {
            0% { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            100% { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        @keyframes island-expand {
            0% { width: 120px; height: var(--dynamic-island-height); }
            70% { width: 300px; height: var(--dynamic-island-expanded-height); }
            100% { width: 280px; height: var(--dynamic-island-expanded-height); }
        }

        @keyframes island-hide {
            0% { transform: translateX(-50%) translateY(0); opacity: 1; }
            100% { transform: translateX(-50%) translateY(-100px); opacity: 0; }
        }

        @keyframes tools-appear {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* --- Enhanced Welcome Screen --- */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--theme-bg-gradient);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            text-align: center;
            animation: welcome-fade-in 0.6s ease-out;
        }

        .welcome-logo {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--theme-accent-primary);
            animation: logo-bounce 1s ease-out;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--theme-text-primary);
            animation: title-slide-up 0.8s ease-out;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: var(--theme-text-secondary);
            margin-bottom: 40px;
            max-width: 500px;
            animation: subtitle-fade-in 1s ease-out 0.3s both;
        }

        .welcome-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 400px;
            animation: options-appear 0.8s ease-out 0.5s both;
        }

        .welcome-option {
            padding: 20px;
            background: var(--theme-surface-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--theme-border-color);
            box-shadow: var(--theme-shadow);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            animation: option-float 3s ease-in-out infinite;
        }

        .welcome-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            animation-play-state: paused;
        }

        .welcome-option:nth-child(1) {
            animation-delay: 0s;
        }

        .welcome-option:nth-child(2) {
            animation-delay: 0.2s;
        }

        .welcome-option i {
            font-size: 2.5rem;
            color: var(--theme-accent-primary);
        }

        .welcome-option h3 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .welcome-option p {
            color: var(--theme-text-secondary);
            text-align: center;
        }

        @keyframes welcome-fade-in {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes logo-bounce {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes title-slide-up {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes subtitle-fade-in {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes options-appear {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes option-float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* --- Enhanced Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            height: var(--header-height);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            border-bottom: 1px solid var(--theme-border-color);
            animation: header-slide-down 0.5s ease-out;
        }

        .header-title {
            font-weight: 700;
            font-size: 1.6rem;
            color: var(--theme-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes header-slide-down {
            0% { transform: translateY(-100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* --- Enhanced Main Content Area --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 24px 12px;
            transition: var(--transition);
            position: relative;
            animation: content-fade-in 0.6s ease-out;
        }

        .main-content.sidebar-open {
            filter: brightness(0.95);
            transform: scale(0.98);
            border-radius: var(--border-radius);
        }

        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: clamp(2rem, 5vw, 4rem);
            border-radius: var(--border-radius);
            position: relative;
            -webkit-overflow-scrolling: touch;
            background: var(--theme-surface-bg);
            box-shadow: var(--theme-shadow);
            margin: 0 auto;
            width: 100%;
            max-width: 900px;
            animation: content-area-appear 0.7s ease-out;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 2rem;
            animation: empty-state-fade 0.8s ease-out;
        }

        .empty-state i {
            font-size: clamp(3rem, 8vw, 5rem);
            color: var(--theme-accent-primary);
            opacity: 0.6;
            margin-bottom: 1.5rem;
            animation: empty-icon-pulse 2s ease-in-out infinite;
        }

        .empty-state h2 {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            margin-bottom: 1rem;
        }

        .empty-state p {
            font-size: clamp(0.9rem, 3vw, 1rem);
            color: var(--theme-text-secondary);
            max-width: 300px;
            line-height: 1.5;
        }

        @keyframes content-fade-in {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes content-area-appear {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes empty-state-fade {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes empty-icon-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* --- Enhanced Document Title --- */
        #document-title {
            width: 100%;
            padding: 0 10px 10px;
            margin-bottom: 2rem;
            border-radius: 0;
            border: none;
            border-bottom: 1px solid var(--theme-border-color);
            background-color: transparent;
            color: var(--theme-text-primary);
            font-size: 2.2rem;
            font-weight: 700;
            transition: var(--transition);
            box-shadow: none;
            animation: title-appear 0.5s ease-out;
        }

        #document-title:focus {
            outline: none;
            border-color: var(--theme-accent-primary);
            box-shadow: none;
        }

        @keyframes title-appear {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* --- Enhanced Drag & Drop Overlay --- */
        #drag-drop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            border: 3px dashed var(--theme-accent-primary);
            border-radius: var(--border-radius);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            font-weight: 600;
            color: white;
            z-index: var(--z-overlay);
            text-align: center;
            padding: 2rem;
            animation: drag-drop-pulse 2s infinite;
        }

        #drag-drop-overlay.visible {
            display: flex;
        }

        @keyframes drag-drop-pulse {
            0% { border-color: var(--theme-accent-primary); }
            50% { border-color: rgba(255, 204, 0, 0.5); }
            100% { border-color: var(--theme-accent-primary); }
        }

        /* --- Enhanced PDF Viewer & Text Editor --- */
        #pdf-viewer {
            position: relative;
        }

        #pdf-viewer .page-container {
            margin: 0 auto 20px auto;
            box-shadow: var(--theme-shadow);
            max-width: 100%;
            overflow: hidden;
            border-radius: 12px;
            animation: page-appear 0.5s ease-out;
        }

        #pdf-viewer canvas {
            display: block;
            width: 100%;
            height: auto;
            max-width: 100%;
            border-radius: 8px;
        }

        #text-editor {
            display: none;
            min-height: 70vh;
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            line-height: 1.8;
            letter-spacing: 0.2px;
            color: var(--theme-text-primary);
            border: none;
            outline: none;
            background: transparent;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            border-radius: 12px;
            animation: editor-appear 0.5s ease-out;
        }

        #text-editor:empty:before {
            content: attr(data-placeholder);
            color: var(--theme-text-secondary);
            opacity: 0.7;
            pointer-events: none;
        }

        /* Image container styles */
        .image-container {
            position: relative;
            display: inline-block;
            margin: 10px;
            max-width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--theme-shadow);
            animation: image-appear 0.5s ease-out;
        }

        .image-container img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .image-remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-container:hover .image-remove-btn {
            opacity: 1;
        }

        @keyframes page-appear {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes editor-appear {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes image-appear {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* --- Enhanced PDF Text Overlay --- */
        .pdf-text-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.2;
            line-height: 1;
            border-radius: 8px;
        }

        .pdf-text-layer::selection {
            background: var(--theme-accent-translucent);
        }

        .pdf-text-layer span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
        }

        /* --- Enhanced AI Sidebar --- */
        .ai-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--sidebar-width);
            height: 100vh;
            transform: translateX(100%);
            transition: transform var(--transition);
            z-index: var(--z-sidebar);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background: var(--theme-sidebar-bg);
            border-left: 1px solid var(--theme-border-color);
            border-radius: 24px 0 0 24px;
        }

        .ai-sidebar.open {
            transform: translateX(0);
            animation: sidebar-slide-in 0.3s ease-out;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--theme-border-color);
        }

        .sidebar-content { 
            flex-grow: 1; 
        }

        .ai-section {
            margin-bottom: 25px;
            background: var(--theme-surface-bg);
            border-radius: 18px;
            padding: 18px;
            border: 1px solid var(--theme-border-color);
            box-shadow: var(--theme-card-shadow);
            animation: ai-section-appear 0.5s ease-out;
            transition: var(--transition);
        }

        .ai-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .ai-section h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--theme-text-primary);
        }

        .ai-section i {
            color: var(--theme-accent-primary);
        }

        .ai-output {
            background: var(--theme-bg-color);
            padding: 15px;
            border-radius: 14px;
            min-height: 80px;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--theme-text-secondary);
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 12px;
            border: 1px solid var(--theme-border-color);
            position: relative;
            animation: ai-output-appear 0.4s ease-out;
        }

        .ai-output mark {
            background-color: var(--theme-accent-translucent);
            border-radius: 3px;
            padding: 2px 4px;
            color: var(--theme-text-primary);
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--theme-accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            animation: copy-btn-appear 0.3s ease-out;
        }

        .copy-btn:hover {
            background: var(--theme-accent-secondary);
            transform: scale(1.05);
        }

        .ai-input {
            width: 100%;
            padding: 12px;
            background: var(--theme-surface-bg);
            border: 1px solid var(--theme-border-color);
            border-radius: 14px;
            color: var(--theme-text-primary);
            font-size: 1rem;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--theme-accent-primary);
            box-shadow: 0 0 0 3px var(--theme-accent-translucent);
            transform: scale(1.02);
        }

        .ai-button, .summary-option-btn, .external-link-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--theme-text-secondary);
            color: white;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            text-decoration: none;
            animation: button-appear 0.4s ease-out;
        }

        .ai-button:hover, .summary-option-btn:hover, .external-link-btn:hover {
            background-color: var(--theme-text-primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .ai-button:disabled, .summary-option-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .summary-options {
            display: flex;
            gap: 8px;
        }

        .summary-option-btn { 
            flex: 1; 
            margin-top: 0; 
        }

        .writing-actions {
            display: flex;
            gap: 8px;
        }

        .writing-actions .ai-button {
            flex: 1;
        }

        @keyframes sidebar-slide-in {
            0% { transform: translateX(100%); }
            100% { transform: translateX(0); }
        }

        @keyframes ai-section-appear {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes ai-output-appear {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes copy-btn-appear {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes button-appear {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* --- Enhanced Settings Panel --- */
        .panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: var(--z-modal);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: overlay-fade-in 0.3s ease-out;
        }

        .panel-overlay.visible {
            display: flex;
        }

        .settings-panel {
            padding: 30px;
            width: 100%;
            max-width: 450px;
            border-radius: var(--border-radius);
            animation: panel-slide-up 0.3s ease-out;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .theme-options input { 
            display: none; 
        }

        .theme-options label {
            padding: 12px;
            border-radius: 14px;
            cursor: pointer;
            border: 2px solid var(--theme-border-color);
            transition: var(--transition);
            text-align: center;
            background: var(--theme-surface-bg);
            animation: theme-option-appear 0.4s ease-out;
        }

        .theme-options input:checked + label {
            border-color: var(--theme-accent-primary);
            background-color: var(--theme-accent-translucent);
            font-weight: 600;
            color: var(--theme-accent-primary);
            transform: scale(1.05);
        }

        @keyframes overlay-fade-in {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes panel-slide-up {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes theme-option-appear {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* --- Enhanced Dropdown Menu --- */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--theme-surface-bg);
            border-radius: 14px;
            box-shadow: var(--theme-shadow);
            padding: 10px;
            min-width: 200px;
            z-index: 100;
            display: none;
            animation: dropdown-appear 0.3s ease-out;
            border: 1px solid var(--theme-border-color);
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--theme-text-primary);
            text-decoration: none;
        }

        .dropdown-item:hover {
            background-color: var(--theme-accent-translucent);
            transform: translateX(5px);
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--theme-border-color);
            margin: 8px 0;
        }

        @keyframes dropdown-appear {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* --- Enhanced Misc & Responsive --- */
        .spinner { 
            animation: spin 1s linear infinite; 
        }

        @keyframes spin { 
            100% { 
                transform: rotate(360deg); 
            } 
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 14px;
            z-index: 9999;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            animation: toast-slide-in 0.3s ease-out;
        }

        .toast.show { 
            transform: translateX(0); 
        }

        .toast.success { 
            background-color: #15C39A; 
            color: white; 
        }

        .toast.error { 
            background-color: #d32f2f; 
            color: white; 
        }

        @keyframes toast-slide-in {
            0% { transform: translateX(150%); }
            100% { transform: translateX(0); }
        }

        /* --- Enhanced AI Processing Animation --- */
        .ai-processing {
            position: relative;
            overflow: hidden;
        }

        .ai-processing::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* --- Enhanced AI Response Animation --- */
        .ai-response {
            animation: ai-response-pulse 0.5s ease-out;
        }

        @keyframes ai-response-pulse {
            0% { transform: scale(0.95); opacity: 0; }
            70% { transform: scale(1.02); }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            body { 
                font-size: 16px; 
            }

            .main-content {
                padding: 8px;
            }

            .main-content.sidebar-open {
                transform: scale(0.95) translateX(-10px);
                border-radius: var(--border-radius);
                overflow: hidden;
            }

            header { 
                padding: 0 12px; 
            }

            #document-title { 
                font-size: 1.8rem; 
            }

            #text-editor { 
                font-size: 1rem; 
            }

            .ai-sidebar {
                width: 95vw;
                border-radius: 24px 0 0 24px;
            }

            .content-area {
                padding: 1.5rem;
            }

            .writing-actions {
                flex-direction: column;
            }

            .welcome-options {
                flex-direction: column;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .welcome-subtitle {
                font-size: 1rem;
            }

            /* FIXED: Dynamic Island for Mobile */
            .dynamic-island {
                width: 90px;
                height: 35px;
                top: 15px;
            }

            .dynamic-island.expanded {
                width: 95vw;
                height: 70px;
                max-width: 400px;
            }

            .dynamic-island-tools {
                gap: 6px;
                padding: 6px;
            }

            .dynamic-tool {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }

            .dropdown-menu {
                right: -10px;
                min-width: 180px;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                font-size: 1.3rem;
            }

            .content-area {
                padding: 1rem;
            }

            .ai-section {
                padding: 15px;
            }

            .summary-options {
                flex-direction: column;
            }

            .theme-options {
                grid-template-columns: repeat(2, 1fr);
            }

            /* FIXED: Dynamic Island for Small Mobile */
            .dynamic-island {
                width: 80px;
                height: 32px;
                top: 10px;
            }

            .dynamic-island.expanded {
                width: 95vw;
                height: 65px;
                max-width: 350px;
            }

            .dynamic-island-content {
                font-size: 0.7rem;
            }

            .dynamic-tool {
                width: 30px;
                height: 30px;
                font-size: 0.7rem;
            }

            .dropdown-menu {
                min-width: 160px;
            }
        }
    </style>
</head>
<body>
    <div id="drag-drop-overlay">
        <div>
            <i class="fas fa-file-pdf fa-3x"></i>
            <br><br>
            Drop PDF Here to Analyze
        </div>
    </div>

    <div class="dynamic-island" id="dynamicIsland">
        <div class="dynamic-island-content">
            <i class="fas fa-robot"></i>
            <span>Gridora AI</span>
        </div>
        <div class="dynamic-island-tools">
            <button class="dynamic-tool" id="dynamic-ai-toggle" title="AI Assistant">
                <i class="fas fa-robot"></i>
            </button>
            <button class="dynamic-tool" id="dynamic-mode-toggle" title="Switch Mode">
                <i class="fas fa-file-alt"></i>
            </button>
            <label for="pdf-upload" class="dynamic-tool" title="Upload PDF" id="dynamic-upload-label">
                <i class="fas fa-upload"></i>
            </label>
            <label for="image-upload" class="dynamic-tool" title="Upload Image" id="dynamic-image-label">
                <i class="fas fa-image"></i>
            </label>
            <button class="dynamic-tool" id="dynamic-copy-paste" title="Paste Text">
                <i class="fas fa-paste"></i>
            </button>
            <button class="dynamic-tool" id="dynamic-menu-toggle" title="Menu">
                <i class="fas fa-ellipsis-h"></i>
            </button>
        </div>
    </div>

    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-logo">
            <i class="fas fa-magic"></i>
        </div>
        <h1 class="welcome-title">Gridora</h1>
        <p class="welcome-subtitle">Your AI-powered document assistant for reading, research, and writing</p>
        <div class="welcome-options">
            <div class="welcome-option" id="readingOption">
                <i class="fas fa-book-reader"></i>
                <h3>Reading Assistant</h3>
                <p>Upload documents, extract text, and get AI-powered summaries and insights</p>
            </div>
            <div class="welcome-option" id="researchOption">
                <i class="fas fa-search"></i>
                <h3>Research Assistant</h3>
                <p>Analyze content, find related information, and generate study materials</p>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <header>
                <h1 class="header-title"><i class="fas fa-magic"></i> Gridora</h1>
            </header>

            <div id="content-area" class="content-area">
                <input type="text" id="document-title" placeholder="Untitled Document">
                <div id="pdf-viewer"></div>
                <div id="text-editor"
                     contenteditable="true"
                     spellcheck="true"
                     data-placeholder="Type or paste your text here..."></div>
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-search"></i>
                    <h2>Welcome to Gridora</h2>
                    <p>Upload a PDF document or switch to Text Mode to start analyzing and get AI-powered insights.</p>
                </div>
            </div>
        </main>

        <!-- AI Assistant Sidebar -->
        <aside class="ai-sidebar" id="aiSidebar" role="complementary">
            <div class="sidebar-header">
                <h2 class="sidebar-title">AI Assistant</h2>
                <button class="header-btn" id="ai-close-btn" aria-label="Close AI assistant">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <!-- Smart Summary Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-file-alt"></i>Smart Summary</h4>
                    <div id="summary-output" class="ai-output">
                        Click a size to generate an intelligent summary of your document.
                        <button class="copy-btn" id="copy-summary-btn" style="display: none;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="summary-options">
                        <button id="summarize-btn-small" class="summary-option-btn" data-size="small">Small</button>
                        <button id="summarize-btn-medium" class="summary-option-btn" data-size="medium">Medium</button>
                        <button id="summarize-btn-large" class="summary-option-btn" data-size="large">Large</button>
                    </div>
                    <button id="key-insights-btn" class="ai-button" style="margin-top: 10px;">
                        <i class="fas fa-lightbulb"></i>Key Insights
                    </button>
                </div>

                <!-- Writing Assistant Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-pen-ruler"></i>Writing Assistant</h4>
                    <div id="writing-output" class="ai-output">
                        Get suggestions to improve your writing clarity, style, and impact.
                        <button class="copy-btn" id="copy-writing-btn" style="display: none;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="writing-actions">
                         <button id="writing-btn" class="ai-button">
                            <i class="fas fa-magic"></i>Analyze
                        </button>
                        <button id="fix-grammar-btn" class="ai-button">
                            <i class="fas fa-check"></i>Fix Grammar
                        </button>
                    </div>
                </div>
                
                <!-- Ask Anything Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-question-circle"></i>Ask Anything</h4>
                    <input type="text"
                           id="qa-input"
                           class="ai-input"
                           placeholder="Ask a question about the content..."
                           aria-label="Question input">
                    <div id="qa-answer" class="ai-output">
                        Get intelligent answers based on the content.
                        <button class="copy-btn" id="copy-qa-btn" style="display: none;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <button id="qa-btn" class="ai-button">
                        <i class="fas fa-search"></i>Get Answer
                    </button>
                </div>
                
                <!-- Key Points Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-list-ul"></i>Key Points</h4>
                    <div id="keypoints-output" class="ai-output">
                        Extract the most important points from your document.
                        <button class="copy-btn" id="copy-keypoints-btn" style="display: none;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <button id="keypoints-btn" class="ai-button">
                        <i class="fas fa-lightbulb"></i>Extract Key Points
                    </button>
                </div>
                
                <!-- Study Quiz Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-graduation-cap"></i>Study Quiz</h4>
                    <div id="quiz-output" class="ai-output">
                        Generate a quiz to test your knowledge of the document.
                        <button class="copy-btn" id="copy-quiz-btn" style="display: none;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <button id="quiz-btn" class="ai-button">
                        <i class="fas fa-question"></i>Generate Quiz
                    </button>
                </div>

                <!-- Content Analysis Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-chart-pie"></i>Content Analysis</h4>
                    <div id="analysis-output" class="ai-output">
                        Analyze the sentiment, readability, and word count of your document.
                        <button class="copy-btn" id="copy-analysis-btn" style="display: none;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <button id="analysis-btn" class="ai-button">
                        <i class="fas fa-magnifying-glass-chart"></i>Analyze Content
                    </button>
                </div>
                
                <!-- NEW: Web Search Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-globe"></i>Web Search</h4>
                    <input type="text"
                           id="search-input"
                           class="ai-input"
                           placeholder="Search for related information..."
                           aria-label="Search input">
                    <div id="search-results" class="ai-output">Find relevant information from the web to enhance your document. This will open in a new tab.</div>
                    <button id="search-btn" class="ai-button">
                        <i class="fas fa-search"></i>Search Web
                    </button>
                </div>

                 <!-- NEW: OptiChain Full Version Link -->
                 <div class="ai-section">
                    <h4><i class="fas fa-rocket"></i>Go Further</h4>
                     <a href="https://talk.shapes.inc/optichain/dm" 
                        target="_blank" 
                        class="external-link-btn">
                        <i class="fas fa-external-link-alt"></i>Try OptiChain Full
                     </a>
                </div>
            </div>
        </aside>
    </div>

    <!-- Settings Panel -->
    <div class="panel-overlay" id="settingsOverlay" role="dialog" aria-labelledby="settings-title">
        <div class="settings-panel glass">
            <div class="sidebar-header">
                <h3 id="settings-title">Appearance Settings</h3>
                <button class="header-btn" id="settings-close-btn" aria-label="Close settings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="setting-group">
                <label>Theme</label>
                <div class="theme-options" id="themeOptions" role="radiogroup" aria-labelledby="settings-title">
                    <input type="radio" id="theme-apple-notes" name="theme" value="apple-notes" checked>
                    <label for="theme-apple-notes">Apple Notes</label>
                    <input type="radio" id="theme-grammarly" name="theme" value="grammarly">
                    <label for="theme-grammarly">Grammarly</label>
                    <input type="radio" id="theme-light" name="theme" value="light">
                    <label for="theme-light">Light</label>
                    <input type="radio" id="theme-dark" name="theme" value="dark">
                    <label for="theme-dark">Dark</label>
                    <input type="radio" id="theme-sepia" name="theme" value="sepia">
                    <label for="theme-sepia">Sepia</label>
                    <input type="radio" id="theme-midnight" name="theme" value="midnight">
                    <label for="theme-midnight">Midnight</label>
                    <input type="radio" id="theme-ocean" name="theme" value="ocean">
                    <label for="theme-ocean">Ocean</label>
                    <input type="radio" id="theme-slate" name="theme" value="slate">
                    <label for="theme-slate">Slate</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="pdf-upload" accept=".pdf" style="display: none;" aria-label="PDF file input">
    <input type="file" id="image-upload" accept="image/*" style="display: none;" aria-label="Image file input">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';

            let state = {
                pdfDoc: null,
                extractedText: '',
                currentMode: 'pdf',
                isAiProcessing: false,
                isPdfLoading: false,
                currentAppMode: 'reading', // 'reading' or 'research'
                dynamicIslandExpanded: false,
                dropdownOpen: false,
                lastScrollY: 0,
                dynamicIslandVisible: true
            };

            class OptiChainAI {
                constructor() {
                    this.stopWords = new Set(['a', 'about', 'above', 'after', 'again', 'against', 'all', 'am', 'an', 'and', 'any', 'are', 'as', 'at', 'be', 'because', 'been', 'before', 'being', 'below', 'between', 'both', 'but', 'by', 'can', 'cannot', 'could', 'did', 'do', 'does', 'doing', 'down', 'during', 'each', 'few', 'for', 'from', 'further', 'had', 'has', 'have', 'having', 'he', 'her', 'here', 'hers', 'herself', 'him', 'himself', 'his', 'how', 'i', 'if', 'in', 'into', 'is', 'it', 'its', 'itself', 'me', 'more', 'most', 'my', 'myself', 'no', 'nor', 'not', 'of', 'off', 'on', 'once', 'only', 'or', 'other', 'our', 'ours', 'ourselves', 'out', 'over', 'own', 'same', 'she', 'should', 'so', 'some', 'such', 'than', 'that', 'the', 'their', 'theirs', 'them', 'themselves', 'then', 'there', 'these', 'they', 'this', 'those', 'through', 'to', 'too', 'under', 'until', 'up', 'very', 'was', 'we', 'were', 'what', 'when', 'where', 'which', 'while', 'who', 'whom', 'why', 'with', 'you', 'your', 'yours', 'yourself', 'yourselves']);
                    this.advancedModels = {
                        // Enhanced summarization model with multiple algorithms
                        summarization: {
                            extractive: (text, targetLength) => this.extractiveSummary(text, targetLength),
                            abstractive: (text, targetLength) => this.abstractiveSummary(text, targetLength),
                            hybrid: (text, targetLength) => this.hybridSummary(text, targetLength)
                        },
                        // Enhanced grammar correction with context awareness
                        grammar: {
                            basic: (text) => this.basicGrammarFix(text),
                            advanced: (text) => this.advancedGrammarFix(text),
                            contextual: (text) => this.contextualGrammarFix(text)
                        },
                        // Enhanced content analysis with multi-dimensional scoring
                        analysis: {
                            sentiment: (text) => this.advancedSentimentAnalysis(text),
                            readability: (text) => this.enhancedReadability(text),
                            complexity: (text) => this.contentComplexity(text),
                            structure: (text) => this.documentStructure(text)
                        }
                    };
                }

                preprocessText(text) {
                    if (!text || typeof text !== 'string') return '';
                    let processed = text;
                    // Enhanced preprocessing
                    processed = processed.replace(/ﬁ/g, 'fi').replace(/ﬂ/g, 'fl');
                    processed = processed.replace(/\s+/g, ' ').trim();
                    processed = processed.replace(/([a-z])-\s+([a-z])/g, '$1$2');
                    processed = processed.replace(/\b(\w+)n't\b/g, '$1 not');
                    processed = processed.replace(/\b(\w+)'s\b/g, '$1 is');
                    processed = processed.replace(/\b(\w+)'re\b/g, '$1 are');
                    processed = processed.replace(/\b(\w+)'ve\b/g, '$1 have');
                    processed = processed.replace(/\b(\w+)'ll\b/g, '$1 will');
                    processed = processed.replace(/\b(\w+)'d\b/g, '$1 would');
                    return processed;
                }

                tokenizeSentences(text) {
                    if (!text) return [];
                    return text.match(/[^.!?]+[.!?]\s*(?=[A-Z]|\d|"|"|'|$)/g)
                        ?.map(s => s.trim())
                        .filter(s => s.length > 15 && s.length < 1500) || [];
                }

                extractKeyWords(text, count = 10) {
                    const words = this.preprocessText(text).toLowerCase().replace(/[^\w\s]/g, ' ').split(/\s+/).filter(word => word.length > 3 && !this.stopWords.has(word));
                    const wordFreq = {};
                    words.forEach(word => { wordFreq[word] = (wordFreq[word] || 0) + 1; });
                    const scores = Object.entries(wordFreq).map(([word, freq]) => ({
                        word,
                        score: freq * Math.log(words.length / (wordFreq[word] || 1))
                    }));
                    return scores.sort((a, b) => b.score - a.score).slice(0, count);
                }

                // Enhanced summarization with multiple algorithms
                generateSummary(text, size = 'medium') {
                    let targetLength;
                    switch (size) {
                        case 'small': targetLength = 100; break;
                        case 'large': targetLength = 400; break;
                        default: targetLength = 200;
                    }

                    // Use hybrid approach for best results
                    return this.advancedModels.summarization.hybrid(text, targetLength);
                }

                extractiveSummary(text, targetLength) {
                    const sentences = this.tokenizeSentences(this.preprocessText(text));
                    if (sentences.length <= 3) {
                        return sentences.join(' ');
                    }

                    const keywords = this.extractKeyWords(text, 20);
                    const scoredSentences = sentences.map((sentence, i) => {
                        const sentenceLower = sentence.toLowerCase();
                        let score = 0;
                        const positionRatio = i / sentences.length;
                        if (positionRatio < 0.2) score += 2.0;
                        if (positionRatio > 0.8) score += 1.5;
                        keywords.forEach(kw => {
                            if (sentenceLower.includes(kw.word)) {
                                score += kw.score;
                            }
                        });
                        if (sentence.length < 20 || sentence.length > 800) score *= 0.5;
                        const cuePhrases = ['in conclusion', 'in summary', 'the main point', 'importantly', 'essentially'];
                        if (cuePhrases.some(phrase => sentenceLower.startsWith(phrase))) score *= 2.0;
                        return { sentence, score, index: i };
                    });

                    const topSentences = scoredSentences
                        .sort((a, b) => b.score - a.score)
                        .slice(0, Math.max(3, Math.floor(sentences.length * 0.3)))
                        .sort((a, b) => a.index - b.index);

                    let summary = topSentences.map(item => item.sentence).join(' ');
                    
                    // Ensure summary is within target length
                    while (summary.length > targetLength && topSentences.length > 1) {
                        topSentences.pop();
                        summary = topSentences.map(item => item.sentence).join(' ');
                    }
                    
                    return summary;
                }

                abstractiveSummary(text, targetLength) {
                    const sentences = this.tokenizeSentences(this.preprocessText(text));
                    if (sentences.length <= 3) return sentences.join(' ');
                    
                    // Identify key concepts
                    const keywords = this.extractKeyWords(text, 10);
                    const keyConcepts = keywords.map(kw => kw.word);
                    
                    // Find sentences that contain key concepts
                    const conceptSentences = sentences.filter(sentence => {
                        const sentenceLower = sentence.toLowerCase();
                        return keyConcepts.some(concept => sentenceLower.includes(concept));
                    });
                    
                    // Combine and rephrase
                    let summary = conceptSentences.slice(0, 5).join(' ');
                    
                    // Simplify sentences for abstractive effect
                    summary = summary
                        .replace(/\bhowever\b/gi, 'but')
                        .replace(/\btherefore\b/gi, 'so')
                        .replace(/\bconsequently\b/gi, 'so')
                        .replace(/\bfurthermore\b/gi, 'also')
                        .replace(/\bmoreover\b/gi, 'also')
                        .replace(/\bin addition\b/gi, 'also');
                    
                    // Ensure summary is within target length
                    if (summary.length > targetLength) {
                        summary = summary.substring(0, targetLength - 3) + '...';
                    }
                    
                    return summary;
                }

                hybridSummary(text, targetLength) {
                    const extractive = this.extractiveSummary(text, targetLength * 0.7);
                    const abstractive = this.abstractiveSummary(text, targetLength * 0.3);
                    
                    // Combine and deduplicate
                    const combined = extractive + ' ' + abstractive;
                    const sentences = this.tokenizeSentences(combined);
                    const uniqueSentences = [...new Set(sentences)];
                    
                    let result = uniqueSentences.join(' ');
                    
                    // Ensure final result is within target length
                    if (result.length > targetLength) {
                        result = result.substring(0, targetLength - 3) + '...';
                    }
                    
                    return result;
                }

                generateKeyInsights(text) {
                    const summary = this.generateSummary(text, 'small');
                    const keywords = this.extractKeyWords(text, 5);
                    const analysis = this.advancedModels.analysis;
                    
                    let insights = `**Key Insights:**\n\n`;
                    insights += `**Main Topic:** ${summary.split('.')[0]}.\n\n`;
                    insights += `**Key Concepts:** ${keywords.map(kw => kw.word).join(', ')}.\n\n`;
                    
                    const sentiment = analysis.sentiment(text);
                    insights += `**Overall Tone:** ${sentiment}.\n\n`;
                    
                    const readability = analysis.readability(text);
                    insights += `**Readability:** ${readability >= 70 ? 'Easy to understand' : readability >= 50 ? 'Moderate difficulty' : 'Complex content'}.\n\n`;
                    
                    const complexity = analysis.complexity(text);
                    insights += `**Content Complexity:** ${complexity}.\n\n`;
                    
                    return insights;
                }

                advancedSentimentAnalysis(text) {
                    const positiveWords = ['good', 'great', 'excellent', 'amazing', 'awesome', 'love', 'like', 'happy', 'beautiful', 'wonderful', 'positive', 'success', 'benefit', 'advantage', 'brilliant', 'fantastic', 'perfect', 'outstanding', 'remarkable', 'impressive'];
                    const negativeWords = ['bad', 'terrible', 'horrible', 'awful', 'hate', 'dislike', 'sad', 'ugly', 'boring', 'negative', 'problem', 'issue', 'difficulty', 'challenge', 'failure', 'poor', 'weak', 'flawed', 'inadequate', 'disappointing'];
                    const intensifiers = ['very', 'extremely', 'incredibly', 'absolutely', 'completely', 'totally', 'utterly'];
                    
                    let positiveScore = 0;
                    let negativeScore = 0;
                    const words = this.preprocessText(text).toLowerCase().split(/\s+/);
                    
                    for (let i = 0; i < words.length; i++) {
                        const word = words[i];
                        const prevWord = i > 0 ? words[i-1] : '';
                        const multiplier = intensifiers.includes(prevWord) ? 1.5 : 1;
                        
                        if(positiveWords.includes(word)) positiveScore += multiplier;
                        if(negativeWords.includes(word)) negativeScore += multiplier;
                    }

                    const totalScore = positiveScore + negativeScore;
                    if (totalScore === 0) return "Neutral";
                    
                    const ratio = positiveScore / totalScore;
                    
                    if (ratio > 0.7) return "Very Positive";
                    if (ratio > 0.6) return "Positive";
                    if (ratio > 0.4) return "Neutral";
                    if (ratio > 0.3) return "Negative";
                    return "Very Negative";
                }

                enhancedReadability(text) {
                    const sentences = this.tokenizeSentences(text);
                    const words = this.preprocessText(text).split(/\s+/);
                    const syllables = this.countSyllables(text);
                    
                    if (sentences.length === 0 || words.length === 0) return 0;
                    
                    const avgSentenceLength = words.length / sentences.length;
                    const avgSyllablesPerWord = syllables / words.length;
                    
                    // Flesch Reading Ease Score
                    const score = 206.835 - (1.015 * avgSentenceLength) - (84.6 * avgSyllablesPerWord);
                    
                    return Math.max(0, Math.min(100, Math.round(score)));
                }

                contentComplexity(text) {
                    const sentences = this.tokenizeSentences(text);
                    const words = this.preprocessText(text).split(/\s+/);
                    const longWords = words.filter(word => word.length > 6).length;
                    const complexRatio = longWords / words.length;
                    
                    if (complexRatio > 0.2) return "High";
                    if (complexRatio > 0.1) return "Medium";
                    return "Low";
                }

                documentStructure(text) {
                    const sentences = this.tokenizeSentences(text);
                    const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
                    
                    return {
                        sentences: sentences.length,
                        paragraphs: paragraphs.length,
                        avgSentencesPerParagraph: sentences.length / paragraphs.length
                    };
                }

                answerQuestion(text, question) {
                    const sentences = this.tokenizeSentences(this.preprocessText(text));
                    const questionWords = new Set(question.toLowerCase().replace('?','').split(/\s+/).filter(w => !this.stopWords.has(w) && w.length > 2));
                    if (questionWords.size === 0) return "Please ask a more specific question.";
                    
                    let bestMatches = [];
                    sentences.forEach(sentence => {
                        const sentenceLower = sentence.toLowerCase();
                        let score = 0;
                        let matchedWords = 0;
                        questionWords.forEach(qWord => {
                            if (sentenceLower.includes(qWord)) {
                                score += 2;
                                matchedWords++;
                            }
                        });
                        if (matchedWords > 1) score += matchedWords * 3;
                        if (/\b(is|are|was|were)\b/i.test(sentence) && sentence.length < 250) score *= 1.5;
                        if (score > 0) bestMatches.push({ text: sentence, score: score });
                    });
                    
                    if (bestMatches.length === 0) return "I could not find a confident answer. Try rephrasing your question.";
                    
                    // Sort by score and take top 3
                    bestMatches.sort((a, b) => b.score - a.score);
                    const topMatches = bestMatches.slice(0, 3);
                    
                    let answerText = topMatches.map(match => match.text).join(' ');
                    
                    // Highlight question words in the answer
                    questionWords.forEach(word => {
                        const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                        answerText = answerText.replace(regex, `<mark>$1</mark>`);
                    });
                    
                    return answerText;
                }

                extractKeyPoints(text) {
                    const summary = this.generateSummary(text, 'large');
                    const points = summary.split('. ').filter(p => p.trim().length > 0).map(p => p.trim() + '.');
                    
                    // Enhance key points with additional context
                    const enhancedPoints = points.map((point, index) => {
                        // Add emphasis to important points
                        if (index === 0) return `⭐ ${point}`;
                        if (index < 3) return `🔸 ${point}`;
                        return `• ${point}`;
                    });
                    
                    return enhancedPoints.join('\n\n') || "No key points could be extracted.";
                }

                analyzeWriting(text) {
                    const sentences = this.tokenizeSentences(this.preprocessText(text));
                    let results = { 
                        passive: [], 
                        fillers: [], 
                        weasels: [], 
                        longSentences: [],
                        repetitive: [],
                        vague: []
                    };
                    
                    // Enhanced passive voice detection
                    const passiveRegex = /\b(am|is|are|was|were|be|being|been)\b\s\w+ed\b/i;
                    sentences.forEach(s => { if(passiveRegex.test(s)) results.passive.push(s); });
                    
                    // Enhanced filler word detection
                    const fillerRegex = /\b(basically|actually|literally|like|just|really|very|stuff|things|you know|sort of|kind of|I mean|um|uh)\b/gi;
                    const fillerMatches = text.match(fillerRegex);
                    if (fillerMatches) results.fillers = [...new Set(fillerMatches)];
                    
                    // Enhanced weasel word detection
                    const weaselRegex = /\b(many|various|several|some|few|most|often|sometimes|arguably|perhaps|could|might|may|possibly|probably)\b/gi;
                    const weaselMatches = text.match(weaselRegex);
                    if (weaselMatches) results.weasels = [...new Set(weaselMatches)];
                    
                    // Long sentences
                    sentences.forEach(s => { if(s.length > 150) results.longSentences.push(s); });
                    
                    // Repetitive words/phrases
                    const words = text.toLowerCase().split(/\s+/);
                    const wordFreq = {};
                    words.forEach(word => { 
                        if (word.length > 4) {
                            wordFreq[word] = (wordFreq[word] || 0) + 1; 
                        }
                    });
                    results.repetitive = Object.entries(wordFreq)
                        .filter(([word, freq]) => freq > 3)
                        .map(([word, freq]) => `${word} (${freq} times)`);
                    
                    // Vague language
                    const vagueRegex = /\b(thing|stuff|aspect|factor|element|area)\b/gi;
                    const vagueMatches = text.match(vagueRegex);
                    if (vagueMatches) results.vague = [...new Set(vagueMatches)];
                    
                    let report = "✍️ **Writing Analysis**\n\n";
                    if (results.passive.length > 0) {
                        report += `**Passive Voice:** ${results.passive.length} sentence(s) might be in passive voice. Consider making them more active.\n*Example: "${results.passive[0]}"*\n\n`;
                    }
                    if (results.fillers.length > 0) {
                        report += `**Filler Words:** Found common filler words. Your writing might be stronger without them.\n*Examples: ${results.fillers.slice(0, 5).join(', ')}*\n\n`;
                    }
                    if (results.weasels.length > 0) {
                        report += `**Vague Language:** These words can make your writing less direct.\n*Examples: ${results.weasels.slice(0, 5).join(', ')}*\n\n`;
                    }
                    if (results.longSentences.length > 0) {
                        report += `**Long Sentences:** ${results.longSentences.length} sentences might be too long. Consider breaking them up for better readability.\n\n`;
                    }
                    if (results.repetitive.length > 0) {
                        report += `**Repetitive Words:** You might be overusing these words:\n*${results.repetitive.slice(0, 3).join(', ')}*\n\n`;
                    }
                    if (results.vague.length > 0) {
                        report += `**Vague Terms:** Consider replacing these vague terms with more specific language:\n*${results.vague.slice(0, 3).join(', ')}*\n\n`;
                    }
                    if (report.length < 50) return "✅ Your writing looks clear and direct! No major issues found.";

                    return report;
                }

                basicGrammarFix(text) {
                    let correctedText = text;
                    
                    // Remove filler words
                    const fillerWords = /\b(basically|actually|literally|like|just|really|very|sort of|kind of)\b/gi;
                    correctedText = correctedText.replace(fillerWords, '');
                    
                    // Fix common contractions
                    correctedText = correctedText.replace(/\b(can)not\b/gi, '$1 not');
                    correctedText = correctedText.replace(/\b(will)not\b/gi, '$1 not');
                    correctedText = correctedText.replace(/\b(do)not\b/gi, '$1 not');
                    
                    // Remove extra whitespace
                    correctedText = correctedText.replace(/\s+/g, ' ').trim();
                    
                    return correctedText;
                }

                advancedGrammarFix(text) {
                    let correctedText = this.basicGrammarFix(text);
                    
                    // Fix common misspellings
                    const commonMistakes = {
                        'teh': 'the',
                        'adn': 'and',
                        'thier': 'their',
                        'recieve': 'receive',
                        'seperate': 'separate',
                        'definately': 'definitely',
                        'occured': 'occurred',
                        'alot': 'a lot'
                    };
                    
                    Object.keys(commonMistakes).forEach(mistake => {
                        const regex = new RegExp(`\\b${mistake}\\b`, 'gi');
                        correctedText = correctedText.replace(regex, commonMistakes[mistake]);
                    });
                    
                    return correctedText;
                }

                contextualGrammarFix(text) {
                    let correctedText = this.advancedGrammarFix(text);
                    const sentences = this.tokenizeSentences(correctedText);
                    
                    // Ensure sentences start with capital letters
                    correctedText = sentences.map(sentence => {
                        if (sentence.length === 0) return sentence;
                        return sentence.charAt(0).toUpperCase() + sentence.slice(1);
                    }).join(' ');
                    
                    return correctedText;
                }

                fixGrammar(text) {
                    return this.advancedModels.grammar.contextual(text);
                }

                generateQuiz(text) {
                    const sentences = this.tokenizeSentences(this.preprocessText(text));
                    const keywords = this.extractKeyWords(text, 15);
                    let quiz = [];
                    
                    // Generate multiple choice questions
                    keywords.forEach(kw => {
                        const keywordSentences = sentences.filter(s => s.toLowerCase().includes(kw.word));
                        if(keywordSentences.length > 0) {
                            const questionSentence = keywordSentences[0];
                            const question = questionSentence.replace(new RegExp(kw.word, 'ig'), '_____');
                            
                            // Generate plausible wrong answers
                            const wrongAnswers = this.generateWrongAnswers(kw.word, keywords);
                            
                            quiz.push({
                                question: question,
                                answer: kw.word,
                                options: this.shuffleArray([kw.word, ...wrongAnswers.slice(0, 3)])
                            });
                        }
                    });

                    if (quiz.length === 0) return "Could not generate a quiz from this text.";
                    
                    // Format quiz with questions and options
                    let quizText = "**Study Quiz**\n\n";
                    quiz.slice(0, 5).forEach((item, index) => {
                        quizText += `${index + 1}. ${item.question}\n`;
                        item.options.forEach((option, optIndex) => {
                            const letter = String.fromCharCode(97 + optIndex); // a, b, c, d
                            quizText += `   ${letter}) ${option}\n`;
                        });
                        quizText += `   <mark>Answer: ${item.answer}</mark>\n\n`;
                    });
                    
                    return quizText;
                }

                generateWrongAnswers(correctAnswer, keywords) {
                    // Generate plausible wrong answers based on similar keywords
                    const similarWords = keywords
                        .filter(kw => kw.word !== correctAnswer && kw.word.length === correctAnswer.length)
                        .map(kw => kw.word);
                    
                    // If not enough similar words, generate variations
                    if (similarWords.length < 3) {
                        const variations = [
                            correctAnswer + 's', // plural
                            correctAnswer + 'ed', // past tense
                            correctAnswer.substring(0, correctAnswer.length - 1), // remove last letter
                            correctAnswer + 'ing' // gerund
                        ];
                        return [...similarWords, ...variations].slice(0, 3);
                    }
                    
                    return similarWords.slice(0, 3);
                }

                shuffleArray(array) {
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                    return array;
                }

                countWords(text) {
                    if (!text || typeof text.trim() !== 'string') return 0;
                    const words = text.trim().split(/\s+/);
                    return words.filter(word => word !== '').length;
                }

                analyzeContent(text) {
                    const analysis = this.advancedModels.analysis;
                    
                    const sentiment = analysis.sentiment(text);
                    const readability = analysis.readability(text);
                    const complexity = analysis.complexity(text);
                    const structure = analysis.structure(text);
                    
                    let analysisText = `**Document Analysis**\n\n`;
                    analysisText += `**Word Count:** ${this.countWords(text)}\n`;
                    analysisText += `**Sentence Count:** ${structure.sentences}\n`;
                    analysisText += `**Paragraph Count:** ${structure.paragraphs}\n\n`;
                    
                    analysisText += `**Sentiment Analysis:** ${sentiment}\n`;
                    analysisText += `**Readability Score:** ${readability}/100\n`;
                    analysisText += `**Content Complexity:** ${complexity}\n\n`;
                    
                    analysisText += `**Document Structure:**\n`;
                    analysisText += `- Average sentences per paragraph: ${structure.avgSentencesPerParagraph.toFixed(1)}\n`;
                    
                    return analysisText;
                }

                countSyllables(text) {
                    const words = this.preprocessText(text).toLowerCase().split(/\s+/);
                    let syllableCount = 0;
                    
                    words.forEach(word => {
                        word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
                        word = word.replace(/^y/, '');
                        const matches = word.match(/[aeiouy]{1,2}/g);
                        syllableCount += matches ? matches.length : 1;
                    });
                    
                    return syllableCount;
                }
            }

            const AI = new OptiChainAI();

            const DOMElements = {
                mainContent: document.getElementById('mainContent'),
                pdfUpload: document.getElementById('pdf-upload'),
                imageUpload: document.getElementById('image-upload'),
                contentArea: document.getElementById('content-area'),
                emptyState: document.getElementById('emptyState'),
                pdfViewer: document.getElementById('pdf-viewer'),
                textEditor: document.getElementById('text-editor'),
                aiSidebar: document.getElementById('aiSidebar'),
                dragDropOverlay: document.getElementById('drag-drop-overlay'),
                settingsOverlay: document.getElementById('settingsOverlay'),
                themeOptions: document.getElementById('themeOptions'),
                documentTitle: document.getElementById('document-title'),
                welcomeScreen: document.getElementById('welcomeScreen'),
                readingOption: document.getElementById('readingOption'),
                researchOption: document.getElementById('researchOption'),
                dynamicIsland: document.getElementById('dynamicIsland'),
                dynamicTools: document.querySelector('.dynamic-island-tools')
            };

            function initialize() {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
                setupEventListeners();
                loadSettings();
                updateUIMode();
                resetAiOutputs();
                
                // Show welcome screen initially
                DOMElements.welcomeScreen.style.display = 'flex';
                
                // Set up scroll detection for dynamic island
                setupScrollDetection();
            }

            function setupScrollDetection() {
                let ticking = false;
                
                window.addEventListener('scroll', function() {
                    if (!ticking) {
                        window.requestAnimationFrame(function() {
                            handleScroll();
                            ticking = false;
                        });
                        ticking = true;
                    }
                });
            }

            function handleScroll() {
                const currentScrollY = window.scrollY;
                
                // Hide dynamic island when scrolling down, show when scrolling up
                if (currentScrollY > state.lastScrollY && currentScrollY > 100) {
                    // Scrolling down
                    if (state.dynamicIslandVisible) {
                        hideDynamicIsland();
                    }
                } else if (currentScrollY < state.lastScrollY || currentScrollY <= 100) {
                    // Scrolling up or at top
                    if (!state.dynamicIslandVisible) {
                        showDynamicIsland();
                    }
                }
                
                state.lastScrollY = currentScrollY;
            }

            function hideDynamicIsland() {
                state.dynamicIslandVisible = false;
                DOMElements.dynamicIsland.classList.add('hidden');
                // Also close expanded state if open
                if (state.dynamicIslandExpanded) {
                    state.dynamicIslandExpanded = false;
                    DOMElements.dynamicIsland.classList.remove('expanded');
                }
            }

            function showDynamicIsland() {
                state.dynamicIslandVisible = true;
                DOMElements.dynamicIsland.classList.remove('hidden');
            }

            function setupEventListeners() {
                DOMElements.pdfUpload.addEventListener('change', handleFileSelect, false);
                DOMElements.imageUpload.addEventListener('change', handleImageUpload, false);
                document.getElementById('ai-close-btn').addEventListener('click', toggleAiSidebar);
                document.getElementById('dynamic-ai-toggle').addEventListener('click', toggleAiSidebar);
                document.getElementById('dynamic-mode-toggle').addEventListener('click', toggleMode);
                document.getElementById('dynamic-upload-label').addEventListener('click', () => DOMElements.pdfUpload.click());
                document.getElementById('dynamic-image-label').addEventListener('click', () => DOMElements.imageUpload.click());
                document.getElementById('dynamic-copy-paste').addEventListener('click', pasteFromClipboard);
                document.getElementById('dynamic-menu-toggle').addEventListener('click', toggleDropdown);

                // Welcome screen options
                DOMElements.readingOption.addEventListener('click', () => selectMode('reading'));
                DOMElements.researchOption.addEventListener('click', () => selectMode('research'));

                // Dynamic Island
                DOMElements.dynamicIsland.addEventListener('click', toggleDynamicIsland);

                // Settings
                document.getElementById('settings-close-btn').addEventListener('click', () => DOMElements.settingsOverlay.classList.remove('visible'));
                DOMElements.settingsOverlay.addEventListener('click', e => { if (e.target === DOMElements.settingsOverlay) DOMElements.settingsOverlay.classList.remove('visible'); });
                DOMElements.themeOptions.addEventListener('change', handleThemeChange);

                // Dropdown menu
                document.getElementById('dropdown-download-pdf').addEventListener('click', downloadTextAsPDF);
                document.getElementById('dropdown-ai-assistant').addEventListener('click', toggleAiSidebar);
                document.getElementById('dropdown-settings').addEventListener('click', () => {
                    DOMElements.settingsOverlay.classList.add('visible');
                    toggleDropdown();
                });
                document.getElementById('dropdown-export-text').addEventListener('click', exportAsText);
                document.getElementById('dropdown-clear-document').addEventListener('click', clearDocument);

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (state.dropdownOpen && !e.target.closest('.dynamic-island')) {
                        toggleDropdown(false);
                    }
                });

                // AI Action buttons
                document.getElementById('summarize-btn-small').addEventListener('click', (e) => handleAIAction('summarize', { size: e.target.dataset.size }));
                document.getElementById('summarize-btn-medium').addEventListener('click', (e) => handleAIAction('summarize', { size: e.target.dataset.size }));
                document.getElementById('summarize-btn-large').addEventListener('click', (e) => handleAIAction('summarize', { size: e.target.dataset.size }));
                document.getElementById('writing-btn').addEventListener('click', () => handleAIAction('writing'));
                document.getElementById('fix-grammar-btn').addEventListener('click', () => handleAIAction('fix-grammar'));
                document.getElementById('qa-btn').addEventListener('click', () => handleAIAction('qa'));
                document.getElementById('keypoints-btn').addEventListener('click', () => handleAIAction('keypoints'));
                document.getElementById('quiz-btn').addEventListener('click', () => handleAIAction('quiz'));
                document.getElementById('analysis-btn').addEventListener('click', () => handleAIAction('analysis'));
                document.getElementById('search-btn').addEventListener('click', () => handleAIAction('search'));
                document.getElementById('key-insights-btn').addEventListener('click', () => handleAIAction('key-insights'));

                // Copy buttons
                document.getElementById('copy-summary-btn').addEventListener('click', () => copyToClipboard('summary-output'));
                document.getElementById('copy-writing-btn').addEventListener('click', () => copyToClipboard('writing-output'));
                document.getElementById('copy-qa-btn').addEventListener('click', () => copyToClipboard('qa-answer'));
                document.getElementById('copy-keypoints-btn').addEventListener('click', () => copyToClipboard('keypoints-output'));
                document.getElementById('copy-quiz-btn').addEventListener('click', () => copyToClipboard('quiz-output'));
                document.getElementById('copy-analysis-btn').addEventListener('click', () => copyToClipboard('analysis-output'));

                document.getElementById('qa-input').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); handleAIAction('qa'); } });
                document.getElementById('search-input').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); handleAIAction('search'); } });
                DOMElements.textEditor.addEventListener('paste', handlePaste);
                
                // Drag and drop
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => document.body.addEventListener(evt, preventDefaults, false));
                ['dragenter', 'dragover'].forEach(evt => DOMElements.mainContent.addEventListener(evt, showDropOverlay, false));
                ['dragleave', 'drop'].forEach(evt => DOMElements.mainContent.addEventListener(evt, hideDropOverlay, false));
                DOMElements.mainContent.addEventListener('drop', handleDrop, false);
            }

            function toggleDropdown(show) {
                state.dropdownOpen = show !== undefined ? show : !state.dropdownOpen;
                
                // Create dropdown if it doesn't exist
                let dropdown = document.getElementById('dynamic-dropdown');
                if (!dropdown) {
                    dropdown = document.createElement('div');
                    dropdown.id = 'dynamic-dropdown';
                    dropdown.className = 'dropdown-menu';
                    dropdown.innerHTML = `
                        <a href="#" class="dropdown-item" id="dropdown-download-pdf">
                            <i class="fas fa-file-pdf"></i>
                            <span>Download as PDF</span>
                        </a>
                        <a href="#" class="dropdown-item" id="dropdown-ai-assistant">
                            <i class="fas fa-robot"></i>
                            <span>AI Assistant</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" id="dropdown-settings">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                        <a href="#" class="dropdown-item" id="dropdown-export-text">
                            <i class="fas fa-file-export"></i>
                            <span>Export as Text</span>
                        </a>
                        <a href="#" class="dropdown-item" id="dropdown-clear-document">
                            <i class="fas fa-trash"></i>
                            <span>Clear Document</span>
                        </a>
                    `;
                    document.body.appendChild(dropdown);
                    
                    // Add event listeners to new dropdown items
                    document.getElementById('dropdown-download-pdf').addEventListener('click', downloadTextAsPDF);
                    document.getElementById('dropdown-ai-assistant').addEventListener('click', toggleAiSidebar);
                    document.getElementById('dropdown-settings').addEventListener('click', () => {
                        DOMElements.settingsOverlay.classList.add('visible');
                        toggleDropdown(false);
                    });
                    document.getElementById('dropdown-export-text').addEventListener('click', exportAsText);
                    document.getElementById('dropdown-clear-document').addEventListener('click', clearDocument);
                }
                
                if (state.dropdownOpen) {
                    // Position dropdown below dynamic island
                    const islandRect = DOMElements.dynamicIsland.getBoundingClientRect();
                    dropdown.style.top = (islandRect.bottom + 10) + 'px';
                    dropdown.style.left = '50%';
                    dropdown.style.transform = 'translateX(-50%)';
                    dropdown.classList.add('show');
                } else {
                    dropdown.classList.remove('show');
                }
                
                // Collapse dynamic island when opening dropdown on mobile
                if (window.innerWidth <= 768 && state.dropdownOpen) {
                    state.dynamicIslandExpanded = false;
                    DOMElements.dynamicIsland.classList.remove('expanded');
                }
            }

            function toggleDynamicIsland() {
                if (window.innerWidth <= 768) {
                    state.dynamicIslandExpanded = !state.dynamicIslandExpanded;
                    DOMElements.dynamicIsland.classList.toggle('expanded', state.dynamicIslandExpanded);
                    
                    // Auto-collapse after 5 seconds
                    if (state.dynamicIslandExpanded) {
                        setTimeout(() => {
                            if (state.dynamicIslandExpanded) {
                                toggleDynamicIsland();
                            }
                        }, 5000);
                    }
                }
            }

            function selectMode(mode) {
                state.currentAppMode = mode;
                DOMElements.welcomeScreen.style.display = 'none';
                DOMElements.dynamicIsland.classList.add('expanded');
                
                setTimeout(() => {
                    DOMElements.dynamicIsland.classList.add('hidden');
                    setTimeout(() => {
                        DOMElements.dynamicIsland.classList.remove('expanded', 'hidden');
                    }, 500);
                }, 2000);
                
                showToast(`Welcome to ${mode === 'reading' ? 'Reading' : 'Research'} Mode!`, 'success');
            }

            function copyToClipboard(outputId) {
                const outputElement = document.getElementById(outputId);
                const textToCopy = outputElement.textContent || outputElement.innerText;
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('Copied to clipboard!', 'success');
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    showToast('Failed to copy text', 'error');
                });
            }

            function handlePaste(e) {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                document.execCommand('insertText', false, text);
            }

            async function pasteFromClipboard() {
                try {
                    const text = await navigator.clipboard.readText();
                    DOMElements.textEditor.textContent += text;
                    toggleMode('text');
                    showToast('Text pasted successfully!', 'success');
                } catch (err) {
                    console.error('Failed to read clipboard contents: ', err);
                    showToast("Could not paste from clipboard. Please try again.", 'error');
                }
            }

            function toggleMode(mode = null) {
                state.currentMode = mode ? mode : (state.currentMode === 'pdf') ? 'text' : 'pdf';
                if (state.currentMode === 'text' && state.extractedText) {
                    DOMElements.textEditor.textContent = state.extractedText;
                }
                updateUIMode();
                resetAiOutputs();
            }

            function updateUIMode() {
                if (state.currentMode === 'pdf') {
                    DOMElements.pdfViewer.style.display = 'block';
                    DOMElements.textEditor.style.display = 'none';
                    DOMElements.emptyState.style.display = 'none';
                } else {
                    DOMElements.pdfViewer.style.display = 'none';
                    DOMElements.textEditor.style.display = 'block';
                    if(state.extractedText || DOMElements.textEditor.textContent){
                        DOMElements.emptyState.style.display = 'none';
                    }
                }
            }

            function toggleAiSidebar() {
                const isOpen = DOMElements.aiSidebar.classList.toggle('open');
                DOMElements.mainContent.classList.toggle('sidebar-open', isOpen);
                
                // Collapse dynamic island when opening sidebar on mobile
                if (window.innerWidth <= 768 && isOpen) {
                    state.dynamicIslandExpanded = false;
                    DOMElements.dynamicIsland.classList.remove('expanded');
                }
                
                // Close dropdown if open
                if (state.dropdownOpen) {
                    toggleDropdown(false);
                }
            }

            function loadSettings() {
                const theme = localStorage.getItem('optichain_theme') || 'apple-notes';
                document.documentElement.setAttribute('data-theme', theme);
                const themeInput = document.querySelector(`#themeOptions input[value="${theme}"]`);
                if (themeInput) themeInput.checked = true;
            }

            function handleThemeChange(e) {
                document.documentElement.setAttribute('data-theme', e.target.value);
                localStorage.setItem('optichain_theme', e.target.value);
            }

            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (file && file.type === 'application/pdf') {
                    DOMElements.documentTitle.value = file.name.replace('.pdf', '');
                    loadPdfFromFile(file);
                } else {
                    showToast('Please select a valid PDF file.', 'error');
                }
            }

            function handleImageUpload(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    insertImage(file);
                } else {
                    showToast('Please select a valid image file.', 'error');
                }
            }

            function insertImage(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = 'Uploaded image';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'image-remove-btn';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.addEventListener('click', function() {
                        imageContainer.remove();
                    });
                    
                    imageContainer.appendChild(img);
                    imageContainer.appendChild(removeBtn);
                    
                    // Insert image at the end of the text editor
                    DOMElements.textEditor.appendChild(imageContainer);
                    
                    // Scroll to the image
                    imageContainer.scrollIntoView({ behavior: 'smooth' });
                    
                    showToast('Image uploaded successfully!', 'success');
                };
                reader.readAsDataURL(file);
            }

            function handleDrop(e) {
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    DOMElements.documentTitle.value = file.name.replace('.pdf', '');
                    loadPdfFromFile(file);
                } else if (file && file.type.startsWith('image/')) {
                    insertImage(file);
                } else {
                    showToast('Dropped file is not a valid PDF or image.', 'error');
                }
            }

            function loadPdfFromFile(file) {
                const fileReader = new FileReader();
                fileReader.onload = (e) => loadPdf(new Uint8Array(e.target.result));
                fileReader.readAsArrayBuffer(file);
            }

            async function loadPdf(typedarray) {
                if (state.isPdfLoading) return;
                state.isPdfLoading = true;
                setLoadingState(true, 'Loading PDF...');

                try {
                    state.pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                    DOMElements.pdfViewer.innerHTML = '';
                    DOMElements.emptyState.style.display = 'none';
                    
                    let textPromises = [];
                    for (let i = 1; i <= state.pdfDoc.numPages; i++) {
                        textPromises.push(state.pdfDoc.getPage(i).then(page => page.getTextContent()));
                    }
                    const allTextContents = await Promise.all(textPromises);
                    state.extractedText = allTextContents.map(tc => tc.items.map(item => item.str).join(' ')).join('\n\n');

                    for (let pageNum = 1; pageNum <= state.pdfDoc.numPages; pageNum++) {
                        await renderPage(pageNum, allTextContents[pageNum - 1]);
                    }
                    resetAiOutputs();
                    toggleMode('pdf');
                    showToast('PDF loaded successfully!', 'success');
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    showToast('Failed to load PDF. It may be corrupt or protected.', 'error');
                } finally {
                    state.isPdfLoading = false;
                    setLoadingState(false);
                }
            }

            async function renderPage(pageNum, textContent) {
                const page = await state.pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });
                const pageContainer = document.createElement('div');
                pageContainer.className = 'page-container';
                pageContainer.style.position = 'relative';
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                const textLayerDiv = document.createElement('div');
                textLayerDiv.className = 'pdf-text-layer';
                pageContainer.append(canvas, textLayerDiv);
                DOMElements.pdfViewer.appendChild(pageContainer);
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                textLayerDiv.style.width = viewport.width + 'px';
                textLayerDiv.style.height = viewport.height + 'px';
                pdfjsLib.renderTextLayer({ textContent, container: textLayerDiv, viewport, textDivs: [] });
            }

            function getDocumentText() {
                return (state.currentMode === 'pdf' ? state.extractedText : DOMElements.textEditor.textContent).trim();
            }

            function resetAiOutputs() {
                document.getElementById('summary-output').textContent = 'Generate an intelligent summary of your document.';
                document.getElementById('qa-answer').textContent = 'Ask a question to get answers based on the content.';
                document.getElementById('writing-output').textContent = 'Get suggestions to improve your writing.';
                document.getElementById('keypoints-output').textContent = 'Extract the most important points and concepts.';
                document.getElementById('quiz-output').textContent = 'Generate a quiz to test your knowledge of the document.';
                document.getElementById('analysis-output').textContent = 'Analyze the sentiment and tone of the document.';
                document.getElementById('search-results').textContent = 'Find relevant information from the web. This will open in a new tab.';
                
                // Hide all copy buttons
                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.style.display = 'none';
                });
            }

            async function handleAIAction(action, options = {}) {
                if (state.isAiProcessing && action !== 'search') return;

                // Special case for web search to open a new tab immediately
                if(action === 'search'){
                    const searchQuery = document.getElementById('search-input').value.trim();
                    if (!searchQuery) { showToast('Please enter a search query.', 'error'); return; }
                    const keywords = AI.extractKeyWords(getDocumentText(), 3).map(kw => kw.word);
                    const fullQuery = encodeURIComponent(searchQuery + " " + keywords.join(" "));
                    window.open(`https://www.google.com/search?q=${fullQuery}`, '_blank');
                    return;
                }

                const title = DOMElements.documentTitle.value.trim();
                if (!title) {
                    showToast('Please provide a title for the document before using AI features.', 'error');
                    return;
                }

                const text = getDocumentText();
                if (text.length < 50 && action !== 'fix-grammar') {
                    showToast('Please provide at least 50 characters of text for AI analysis.', 'error');
                    return;
                }

                const buttonMap = {
                    summarize: 'summarize-btn-medium', 
                    qa: 'qa-btn', 
                    writing: 'writing-btn', 
                    'fix-grammar': 'fix-grammar-btn', 
                    keypoints: 'keypoints-btn',
                    quiz: 'quiz-btn', 
                    analysis: 'analysis-btn',
                    'key-insights': 'key-insights-btn'
                };
                
                const outputMap = {
                    summarize: 'summary-output', 
                    qa: 'qa-answer', 
                    writing: 'writing-output', 
                    'fix-grammar': 'writing-output', 
                    keypoints: 'keypoints-output',
                    quiz: 'quiz-output', 
                    analysis: 'analysis-output',
                    'key-insights': 'summary-output'
                };

                const button = document.getElementById(buttonMap[action]);
                const outputEl = document.getElementById(outputMap[action]);
                const copyBtn = document.getElementById(`copy-${outputMap[action].replace('-output', '')}-btn`);
                const originalHTML = button ? button.innerHTML : '';

                state.isAiProcessing = true;
                document.querySelectorAll('.ai-button, .summary-option-btn').forEach(btn => btn.disabled = true);
                if (action !== 'summarize' && button) {
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...';
                } else if (action === 'summarize') {
                    document.querySelectorAll('.summary-option-btn').forEach(b => {
                        b.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    });
                }

                await new Promise(resolve => setTimeout(resolve, 50));

                try {
                    let result;
                    switch (action) {
                        case 'summarize': 
                            result = AI.generateSummary(text, options.size);
                            await typeEffect(outputEl, result);
                            break;
                        case 'key-insights':
                            result = AI.generateKeyInsights(text);
                            outputEl.innerHTML = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                            break;
                        case 'writing':
                            result = AI.analyzeWriting(text);
                            outputEl.innerHTML = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                            break;
                        case 'fix-grammar':
                            if (state.currentMode !== 'text') {
                                 showToast('Grammar correction is only available in Text Mode.', 'error');
                                 throw new Error('Wrong mode');
                            }
                            result = AI.fixGrammar(text);
                            DOMElements.textEditor.textContent = result;
                            outputEl.textContent = 'Grammar fixes have been applied to the text editor.';
                            showToast('Grammar has been corrected!', 'success');
                            break;
                        case 'qa':
                            const question = document.getElementById('qa-input').value.trim();
                            if (!question) { showToast('Please enter a question.', 'error'); throw new Error('No Question'); }
                            result = AI.answerQuestion(text, question);
                            outputEl.innerHTML = result;
                            break;
                        case 'keypoints': 
                            result = AI.extractKeyPoints(text);
                            await typeEffect(outputEl, result);
                            break;
                        case 'quiz':
                            result = AI.generateQuiz(text);
                            outputEl.innerHTML = result;
                            break;
                        case 'analysis':
                            result = AI.analyzeContent(text);
                            outputEl.innerHTML = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                            break;
                        default: throw new Error('Unknown action.');
                    }

                    // Show copy button if we have content
                    if (result && copyBtn) {
                        copyBtn.style.display = 'block';
                    }

                    // Add animation to AI response
                    outputEl.classList.add('ai-response');
                    setTimeout(() => {
                        outputEl.classList.remove('ai-response');
                    }, 500);

                } catch (error) {
                    if(error.message !== 'No Question' && error.message !== 'No Query' && error.message !== 'Wrong mode') {
                        console.error(`AI action '${action}' failed:`, error);
                        outputEl.textContent = `An error occurred. Please try again.`;
                    }
                } finally {
                    state.isAiProcessing = false;
                    document.querySelectorAll('.ai-button, .summary-option-btn').forEach(btn => btn.disabled = false);
                    if (action !== 'summarize' && button) {
                        button.innerHTML = originalHTML;
                    } else if (action === 'summarize') {
                        document.getElementById('summarize-btn-small').innerHTML = "Small";
                        document.getElementById('summarize-btn-medium').innerHTML = "Medium";
                        document.getElementById('summarize-btn-large').innerHTML = "Large";
                    }
                }
            }

            async function typeEffect(element, text, speed = 15) {
                element.textContent = '';
                for (let i = 0; i < text.length; i++) {
                    element.textContent += text.charAt(i);
                    await new Promise(resolve => setTimeout(resolve, speed));
                }
            }

            function preventDefaults(e) { 
                e.preventDefault(); 
                e.stopPropagation(); 
            }

            function showDropOverlay() { 
                DOMElements.dragDropOverlay.classList.add('visible'); 
            }

            function hideDropOverlay() { 
                DOMElements.dragDropOverlay.classList.remove('visible'); 
            }

            function setLoadingState(isLoading, message = '') {
                if(isLoading){
                    DOMElements.pdfViewer.innerHTML = `<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>${message}</div>`;
                } else {
                    if (!DOMElements.pdfViewer.hasChildNodes()){
                        DOMElements.emptyState.style.display = 'flex';
                    }
                }
            }

            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 10);

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }

            async function downloadTextAsPDF() {
                const { jsPDF } = window.jspdf;
                const editor = DOMElements.textEditor;
                const title = DOMElements.documentTitle.value.trim();

                if (!editor.textContent.trim()) {
                    showToast("There's no text to download.", 'error');
                    return;
                }

                if (!title) {
                    showToast("Please provide a title for the document.", 'error');
                    return;
                }

                setLoadingState(true, "Generating PDF...");

                try {
                    const doc = new jsPDF();
                    doc.setFontSize(18);
                    doc.text(title, 10, 10);
                    doc.setFontSize(12);
                    const text = editor.textContent;
                    const splitText = doc.splitTextToSize(text, 180); 
                    doc.text(splitText, 10, 20);
                    doc.save(`${title.replace(/ /g, '_')}.pdf`);
                    showToast('PDF downloaded successfully!', 'success');
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    showToast('Failed to generate PDF. Please try again.', 'error');
                } finally {
                    setLoadingState(false);
                }
            }

            function exportAsText() {
                const editor = DOMElements.textEditor;
                const title = DOMElements.documentTitle.value.trim();

                if (!editor.textContent.trim()) {
                    showToast("There's no text to export.", 'error');
                    return;
                }

                if (!title) {
                    showToast("Please provide a title for the document.", 'error');
                    return;
                }

                const textContent = editor.textContent;
                const blob = new Blob([textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.replace(/ /g, '_')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Text exported successfully!', 'success');
            }

            function clearDocument() {
                if (confirm('Are you sure you want to clear the document? This action cannot be undone.')) {
                    DOMElements.textEditor.textContent = '';
                    DOMElements.pdfViewer.innerHTML = '';
                    DOMElements.documentTitle.value = '';
                    state.extractedText = '';
                    state.pdfDoc = null;
                    DOMElements.emptyState.style.display = 'flex';
                    resetAiOutputs();
                    showToast('Document cleared', 'success');
                }
            }

            initialize();
        });
    </script>
</body>
</html>
