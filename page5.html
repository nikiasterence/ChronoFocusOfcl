<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <link rel="icon" href="Chronofocus.png" type="image/x-icon">
    <title>Researcho - AI Document Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF & Download Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    /* --- Themes & Variables --- */
    :root {
        --sidebar-width: min(90vw, 400px);
        --header-height: 65px;
        --border-radius: 16px;
        --transition: all 0.3s ease-in-out;
        --font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
        --z-overlay: 1000;
        --z-sidebar: 1001;
        --z-modal: 2000;
    }

    [data-theme="light"] {
        --theme-bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        --theme-bg-color: #f5f7fa;
        --theme-surface-bg: rgba(255, 255, 255, 0.8);
        --theme-text-primary: #1c1c1e;
        --theme-text-secondary: #6b6b6b;
        --theme-border-color: rgba(200, 200, 200, 0.6);
        --theme-accent-primary: #007aff;
        --theme-accent-secondary: #0056b3;
        --theme-accent-translucent: rgba(0, 122, 255, 0.15);
        --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    [data-theme="dark"] {
        --theme-bg-gradient: linear-gradient(135deg, #2c3e50 0%, #171c23 100%);
        --theme-bg-color: #171c23;
        --theme-surface-bg: rgba(28, 33, 39, 0.8);
        --theme-text-primary: #e5e5ea;
        --theme-text-secondary: #a3a3a3;
        --theme-border-color: rgba(80, 80, 80, 0.6);
        --theme-accent-primary: #0a84ff;
        --theme-accent-secondary: #3b9bff;
        --theme-accent-translucent: rgba(10, 132, 255, 0.15);
        --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    [data-theme="sepia"] {
        --theme-bg-gradient: linear-gradient(135deg, #f1e7d0 0%, #c9bda5 100%);
        --theme-bg-color: #f1e7d0;
        --theme-surface-bg: rgba(243, 237, 222, 0.8);
        --theme-text-primary: #5b4636;
        --theme-text-secondary: #8d6e63;
        --theme-border-color: rgba(141, 110, 99, 0.4);
        --theme-accent-primary: #8d6e63;
        --theme-accent-secondary: #5d4037;
        --theme-accent-translucent: rgba(141, 110, 99, 0.15);
        --theme-shadow: 0 10px 30px rgba(93, 64, 53, 0.15);
    }
    [data-theme="midnight"] {
        --theme-bg-gradient: linear-gradient(135deg, #0d1117 0%, #010409 100%);
        --theme-bg-color: #010409;
        --theme-surface-bg: rgba(13, 17, 23, 0.8);
        --theme-text-primary: #c9d1d9;
        --theme-text-secondary: #8b949e;
        --theme-border-color: rgba(48, 54, 61, 0.6);
        --theme-accent-primary: #58a6ff;
        --theme-accent-secondary: #3081f7;
        --theme-accent-translucent: rgba(88, 166, 255, 0.15);
        --theme-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    /* --- Base Styles --- */
    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
        font-family: var(--font-family);
        -webkit-touch-callout: text;
        -webkit-user-select: text;
        -khtml-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    
    body { 
        background: var(--theme-bg-gradient); 
        color: var(--theme-text-primary); 
        display: flex; 
        flex-direction: column; 
        min-height: 100vh; 
        overflow-x: hidden;
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
        touch-action: manipulation;
    }
    
    .app-container { 
        display: flex; 
        flex: 1; 
        overflow: hidden; 
        position: relative;
    }

    .glass {
        background: var(--theme-surface-bg);
        backdrop-filter: blur(12px); 
        -webkit-backdrop-filter: blur(12px);
        border-radius: var(--border-radius); 
        border: 1px solid var(--theme-border-color);
        box-shadow: var(--theme-shadow);
    }

    /* --- Main Layout --- */
    .main-content {
        flex-grow: 1; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden;
        padding: 12px; 
        transition: var(--transition);
        position: relative;
    }
    
    .main-content.sidebar-open {
        filter: brightness(0.7);
    }
    
    header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 0 clamp(12px, 4vw, 24px); 
        height: var(--header-height); 
        flex-shrink: 0; 
        margin-bottom: 16px;
        position: relative;
        z-index: 10;
    }
    
    .header-title { 
        font-weight: 700; 
        font-size: clamp(1.2rem, 4vw, 1.6rem); 
        background: linear-gradient(135deg, var(--theme-accent-primary), var(--theme-accent-secondary)); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .header-controls { 
        display: flex; 
        gap: 8px; 
        align-items: center; 
        flex-wrap: wrap;
    }
    
    .header-btn {
        background: transparent; 
        color: var(--theme-text-secondary); 
        width: 44px; 
        height: 44px; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        cursor: pointer; 
        border: none; 
        font-size: clamp(1rem, 3vw, 1.2rem); 
        transition: var(--transition);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }
    
    .header-btn:hover, 
    .header-btn.active, 
    .header-btn:active { 
        background-color: var(--theme-accent-translucent); 
        color: var(--theme-accent-primary); 
        transform: scale(0.95);
    }
    
    #download-pdf-btn { 
        display: none; 
    }

    .content-area { 
        flex-grow: 1; 
        overflow-y: auto; 
        padding: clamp(12px, 3vw, 20px); 
        border-radius: var(--border-radius); 
        position: relative;
        -webkit-overflow-scrolling: touch;
    }
    
    .empty-state { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        height: 100%; 
        text-align: center; 
        padding: 2rem;
    }
    
    .empty-state i { 
        font-size: clamp(3rem, 8vw, 5rem); 
        color: var(--theme-accent-primary); 
        opacity: 0.6; 
        margin-bottom: 1.5rem; 
    }
    
    .empty-state h2 {
        font-size: clamp(1.2rem, 4vw, 1.8rem);
        margin-bottom: 1rem;
    }
    
    .empty-state p {
        font-size: clamp(0.9rem, 3vw, 1rem);
        color: var(--theme-text-secondary);
        max-width: 300px;
        line-height: 1.5;
    }
    
    /* --- Drag & Drop Overlay --- */
    #drag-drop-overlay {
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%;
        background: rgba(0,0,0,0.7); 
        border: 3px dashed var(--theme-accent-primary); 
        border-radius: var(--border-radius);
        display: none; 
        align-items: center; 
        justify-content: center;
        font-size: clamp(1.2rem, 4vw, 1.5rem); 
        font-weight: 600; 
        color: white; 
        z-index: var(--z-overlay);
        text-align: center;
        padding: 2rem;
    }
    
    #drag-drop-overlay.visible { 
        display: flex; 
    }
    
    /* --- PDF Viewer & Text Editor --- */
    #pdf-viewer { 
        position: relative;
    }
    
    #pdf-viewer .page-container { 
        margin: 0 auto 20px auto; 
        box-shadow: var(--theme-shadow);
        max-width: 100%;
        overflow: hidden;
    }
    
    #pdf-viewer canvas { 
        display: block; 
        width: 100%; 
        height: auto; 
        max-width: 100%;
    }
    
    #text-editor { 
        display: none; 
        min-height: 70vh; 
        width: 100%; 
        padding: clamp(1rem, 4vw, 2rem); 
        font-size: clamp(0.9rem, 3vw, 1.1rem); 
        line-height: 1.8; 
        color: var(--theme-text-primary); 
        border: none; 
        outline: none; 
        background: transparent;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    
    #text-editor:empty:before { 
        content: attr(data-placeholder); 
        color: var(--theme-text-secondary); 
        opacity: 0.7; 
        pointer-events: none;
    }
    
    /* --- PDF Text Overlay --- */
    .pdf-text-layer {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        opacity: 0;
        line-height: 1;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    
    .pdf-text-layer::selection {
        background: rgba(0, 122, 255, 0.3);
    }
    
    .pdf-text-layer span {
        color: transparent;
        position: absolute;
        white-space: pre;
        cursor: text;
        transform-origin: 0% 0%;
    }
    
    /* --- AI Sidebar --- */
    .ai-sidebar {
        position: fixed; 
        top: 0; 
        right: 0; 
        width: var(--sidebar-width); 
        height: 100vh;
        transform: translateX(100%); 
        transition: transform var(--transition); 
        z-index: var(--z-sidebar);
        display: flex; 
        flex-direction: column; 
        padding: 20px; 
        box-shadow: -10px 0 40px rgba(0, 0, 0, 0.2);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .ai-sidebar.open { 
        transform: translateX(0); 
    }
    
    .sidebar-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding-bottom: 15px; 
        margin-bottom: 20px; 
        border-bottom: 1px solid var(--theme-border-color);
        position: sticky;
        top: 0;
        background: var(--theme-surface-bg);
        backdrop-filter: blur(12px);
        z-index: 10;
    }
    
    .sidebar-content { 
        flex-grow: 1; 
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .ai-section { 
        margin-bottom: 25px; 
    }
    
    .ai-section h4 { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        font-size: clamp(1rem, 3vw, 1.1rem); 
        font-weight: 600; 
        margin-bottom: 15px; 
        padding-bottom: 10px; 
        border-bottom: 1px solid var(--theme-border-color); 
        color: var(--theme-text-primary); 
    }
    
    .ai-section i { 
        color: var(--theme-accent-primary); 
    }
    
    .ai-output { 
        background: rgba(0, 0, 0, 0.05); 
        padding: 15px; 
        border-radius: 12px; 
        min-height: 80px; 
        font-size: clamp(0.85rem, 2.5vw, 0.95rem); 
        line-height: 1.6; 
        color: var(--theme-text-secondary);
        white-space: pre-wrap;
        word-wrap: break-word;
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    
    .ai-output mark { 
        background-color: var(--theme-accent-translucent); 
        border-radius: 3px; 
        padding: 2px 4px;
    }
    
    .ai-input {
        width: 100%;
        padding: 12px;
        background: var(--theme-surface-bg);
        border: 1px solid var(--theme-border-color);
        border-radius: 10px;
        color: var(--theme-text-primary);
        font-size: clamp(0.9rem, 3vw, 1rem);
        margin-bottom: 10px;
        outline: none;
        transition: var(--transition);
    }
    
    .ai-input:focus {
        border-color: var(--theme-accent-primary);
        box-shadow: 0 0 0 3px var(--theme-accent-translucent);
    }
    
    .ai-button {
        width: 100%; 
        padding: 12px; 
        background-color: var(--theme-accent-primary); 
        color: white;
        border: none; 
        border-radius: 10px; 
        cursor: pointer; 
        font-weight: 600;
        transition: var(--transition); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 8px; 
        margin-top: 10px;
        font-size: clamp(0.9rem, 3vw, 1rem);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }
    
    .ai-button:hover, 
    .ai-button:active { 
        background-color: var(--theme-accent-secondary); 
        transform: scale(0.98);
    }
    
    .ai-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    /* --- Settings Panel --- */
    .panel-overlay {
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0.5); 
        backdrop-filter: blur(5px); 
        z-index: var(--z-modal);
        display: none; 
        align-items: center; 
        justify-content: center;
        padding: 1rem;
    }
    
    .panel-overlay.visible { 
        display: flex; 
    }
    
    .settings-panel { 
        padding: 30px; 
        width: 100%; 
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .setting-group { 
        margin-bottom: 25px; 
    }
    
    .setting-group label:first-child {
        display: block;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--theme-text-primary);
    }
    
    .theme-options { 
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px; 
    }
    
    .theme-options input { 
        display: none; 
    }
    
    .theme-options label {
        padding: 12px 18px; 
        border-radius: 10px; 
        cursor: pointer; 
        border: 2px solid var(--theme-border-color); 
        transition: var(--transition);
        text-align: center;
        font-size: 0.9rem;
        touch-action: manipulation;
    }
    
    .theme-options input:checked + label { 
        border-color: var(--theme-accent-primary); 
        background-color: var(--theme-accent-translucent); 
        transform: translateY(-2px); 
    }

    /* --- Loading States --- */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* --- Mobile Responsive --- */
    @media (max-width: 768px) {
        .main-content { 
            padding: 8px; 
        }
        
        header { 
            padding: 0 12px;
            flex-wrap: wrap;
            min-height: var(--header-height);
            height: auto;
        }
        
        .header-controls {
            order: 2;
            width: 100%;
            justify-content: center;
            margin-top: 8px;
        }
        
        .ai-sidebar { 
            width: 100vw;
            padding: 15px;
        }
        
        .content-area {
            padding: 12px;
        }
        
        #text-editor {
            font-size: 16px; /* Prevent zoom on iOS */
            padding: 1rem;
        }
        
        .ai-input {
            font-size: 16px; /* Prevent zoom on iOS */
        }
    }

    @media (max-width: 480px) {
        .header-title {
            font-size: 1.2rem;
        }
        
        .header-btn {
            width: 40px;
            height: 40px;
            font-size: 1rem;
        }
        
        .empty-state {
            padding: 1rem;
        }
        
        .ai-sidebar {
            padding: 12px;
        }
        
        .sidebar-header {
            margin-bottom: 15px;
        }
        
        .ai-section {
            margin-bottom: 20px;
        }
    }

    /* --- Touch Improvements --- */
    @media (pointer: coarse) {
        .header-btn {
            min-width: 48px;
            min-height: 48px;
        }
        
        .ai-button {
            min-height: 48px;
        }
        
        .theme-options label {
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    }
</style>
</head>
<body>
    <div id="drag-drop-overlay">
        <div>
            <i class="fas fa-file-pdf fa-3x"></i>
            <br><br>
            Drop PDF Here to Analyze
        </div>
    </div>
    
    <div class="app-container">
        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <header class="glass">
                <h1 class="header-title">Researcho</h1>
                <div class="header-controls">
                    <button class="header-btn" id="mode-toggle-btn" title="Switch Mode" aria-label="Switch between PDF and text mode">
                        <i class="fas fa-file-alt"></i>
                    </button>
                    <label for="pdf-upload" class="header-btn" title="Upload PDF" id="upload-label" aria-label="Upload PDF file">
                        <i class="fas fa-upload"></i>
                    </label>
                    <input type="file" id="pdf-upload" accept=".pdf" style="display: none;" aria-label="PDF file input">
                    <button class="header-btn" id="download-pdf-btn" title="Download as PDF" aria-label="Download text as PDF">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <button class="header-btn" id="settings-btn" title="Settings" aria-label="Open settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="header-btn" id="ai-toggle-btn" title="AI Assistant" aria-label="Toggle AI assistant">
                        <i class="fas fa-robot"></i>
                    </button>
                </div>
            </header>

            <div id="content-area" class="content-area glass">
                <div id="pdf-viewer"></div>
                <div id="text-editor" 
                     contenteditable="true" 
                     spellcheck="true"
                     data-placeholder="Type or paste your text here... You can copy and paste from anywhere!"></div>
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-search"></i>
                    <h2>Welcome to Researcho</h2>
                    <p>Upload a PDF document or switch to Text Mode to start analyzing and get AI-powered insights.</p>
                </div>
            </div>
        </main>

        <!-- AI Assistant Sidebar -->
        <aside class="ai-sidebar glass" id="aiSidebar" role="complementary">
            <div class="sidebar-header">
                <h2 class="sidebar-title">AI Assistant</h2>
                <button class="header-btn" id="ai-close-btn" aria-label="Close AI assistant">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <!-- Smart Summary Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-file-alt"></i>Smart Summary</h4>
                    <div id="summary-output" class="ai-output">Click generate to create an intelligent summary of your document using advanced text analysis.</div>
                    <button id="summarize-btn" class="ai-button">
                        <i class="fas fa-magic"></i>Generate Summary
                    </button>
                </div>
                
                <!-- Ask Anything Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-question-circle"></i>Ask Anything</h4>
                    <input type="text" 
                           id="qa-input" 
                           class="ai-input"
                           placeholder="Ask any question about the content..."
                           aria-label="Question input">
                    <div id="qa-answer" class="ai-output">Ask any question about your document and get intelligent answers based on the content.</div>
                    <button id="qa-btn" class="ai-button">
                        <i class="fas fa-search"></i>Get Answer
                    </button>
                </div>
                
                <!-- Quiz Generator Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-graduation-cap"></i>Study Quiz</h4>
                    <div id="quiz-question" class="ai-output">Generate study questions to test your understanding of the material.</div>
                    <button id="quiz-new-btn" class="ai-button">
                        <i class="fas fa-redo"></i>New Question
                    </button>
                </div>
                
                <!-- Key Points Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-list-ul"></i>Key Points</h4>
                    <div id="keypoints-output" class="ai-output">Extract the most important points and concepts from your document.</div>
                    <button id="keypoints-btn" class="ai-button">
                        <i class="fas fa-lightbulb"></i>Extract Key Points
                    </button>
                </div>
                
                <!-- Content Analysis Section -->
                <div class="ai-section">
                    <h4><i class="fas fa-chart-bar"></i>Content Analysis</h4>
                    <div id="analysis-output" class="ai-output">Get detailed analysis including readability, complexity, and content insights.</div>
                    <button id="analysis-btn" class="ai-button">
                        <i class="fas fa-microscope"></i>Analyze Content
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Settings Panel -->
    <div class="panel-overlay" id="settingsOverlay" role="dialog" aria-labelledby="settings-title">
        <div class="settings-panel glass">
            <div class="sidebar-header">
                <h3 id="settings-title">Appearance Settings</h3>
                <button class="header-btn" id="settings-close-btn" aria-label="Close settings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="setting-group">
                <label>Theme</label>
                <div class="theme-options" id="themeOptions" role="radiogroup" aria-labelledby="settings-title">
                    <input type="radio" id="theme-light" name="theme" value="light" checked>
                    <label for="theme-light">Light</label>
                    <input type="radio" id="theme-dark" name="theme" value="dark">
                    <label for="theme-dark">Dark</label>
                    <input type="radio" id="theme-sepia" name="theme" value="sepia">
                    <label for="theme-sepia">Sepia</label>
                    <input type="radio" id="theme-midnight" name="theme" value="midnight">
                    <label for="theme-midnight">Midnight</label>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    // --- ENHANCED GLOBALS & STATE ---
    let state = {
        pdfDoc: null,
        extractedText: '',
        currentMode: 'pdf', // 'pdf' or 'text'
        isProcessing: false,
        textLayers: [],
        currentPageCount: 0
    };

    // Enhanced AI Analysis Engine
    class AdvancedAI {
        constructor() {
            this.stopWords = new Set([
                'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'is', 'are', 'was', 'were', 'be', 'been', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'can', 'this', 'that', 'these', 'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his', 'her', 'its', 'our', 'their', 'mine', 'yours', 'hers', 'ours', 'theirs'
            ]);
            this.sentencePatterns = {
                question: /(?:what|who|when|where|why|how|which|whose|whom)\s.*?\?/gi,
                definition: /(?:is|are|means?|refers?\s+to|defined\s+as|known\s+as)\s+(.{10,100})/gi,
                cause: /(?:because|due\s+to|caused\s+by|results?\s+from|leads?\s+to|triggers?)/gi,
                sequence: /(?:first|second|third|then|next|finally|subsequently|afterwards|before|after)/gi,
                comparison: /(?:compared\s+to|versus|unlike|similar\s+to|different\s+from|in\s+contrast)/gi,
                emphasis: /(?:important|significant|crucial|essential|vital|key|main|primary|major)/gi
            };
        }

        // Enhanced text preprocessing
        preprocessText(text) {
            if (!text || typeof text !== 'string') return '';
            
            // Normalize whitespace and remove excessive line breaks
            text = text.replace(/\s+/g, ' ').trim();
            
            // Fix common PDF extraction issues
            text = text.replace(/([a-z])([A-Z])/g, '$1 $2'); // Split camelCase
            text = text.replace(/(\w)(\d)/g, '$1 $2'); // Separate words from numbers
            text = text.replace(/(\d)(\w)/g, '$1 $2'); // Separate numbers from words
            
            return text;
        }

        // Advanced sentence tokenization
        tokenizeSentences(text) {
            text = this.preprocessText(text);
            
            // Enhanced sentence boundary detection
            const sentences = text
                .replace(/([.!?])\s*([A-Z])/g, '$1|$2')
                .split('|')
                .map(s => s.trim())
                .filter(s => s.length > 20 && s.length < 1000)
                .filter(s => /[.!?]$/.test(s));
                
            return sentences;
        }

        // Advanced word extraction and scoring
        extractKeyWords(text, minLength = 3) {
            const words = text.toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .split(/\s+/)
                .filter(word => 
                    word.length >= minLength && 
                    !this.stopWords.has(word) &&
                    !/^\d+$/.test(word)
                );

            const wordFreq = {};
            const wordPositions = {};

            words.forEach((word, index) => {
                wordFreq[word] = (wordFreq[word] || 0) + 1;
                if (!wordPositions[word]) wordPositions[word] = [];
                wordPositions[word].push(index);
            });

            // Calculate TF-IDF-like scoring
            const totalWords = words.length;
            const scores = {};

            Object.keys(wordFreq).forEach(word => {
                const tf = wordFreq[word] / totalWords;
                const positions = wordPositions[word];
                const positionScore = positions.reduce((sum, pos) => 
                    sum + (1 / (1 + pos * 0.01)), 0) / positions.length;
                
                scores[word] = tf * positionScore * Math.log(word.length);
            });

            return Object.entries(scores)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 50)
                .map(([word, score]) => ({ word, score, frequency: wordFreq[word] }));
        }

        // Enhanced similarity calculation using multiple methods
        calculateSimilarity(text1, text2) {
            const words1 = new Set(this.preprocessText(text1).toLowerCase().split(/\s+/));
            const words2 = new Set(this.preprocessText(text2).toLowerCase().split(/\s+/));
            
            // Jaccard similarity
            const intersection = new Set([...words1].filter(x => words2.has(x)));
            const union = new Set([...words1, ...words2]);
            const jaccard = intersection.size / union.size;
            
            // Cosine similarity with word frequencies
            const allWords = [...union];
            const vector1 = allWords.map(word => words1.has(word) ? 1 : 0);
            const vector2 = allWords.map(word => words2.has(word) ? 1 : 0);
            
            const dotProduct = vector1.reduce((sum, val, i) => sum + val * vector2[i], 0);
            const magnitude1 = Math.sqrt(vector1.reduce((sum, val) => sum + val * val, 0));
            const magnitude2 = Math.sqrt(vector2.reduce((sum, val) => sum + val * val, 0));
            const cosine = dotProduct / (magnitude1 * magnitude2) || 0;
            
            // Weighted combination
            return (jaccard * 0.4) + (cosine * 0.6);
        }

        // Advanced TextRank implementation
        generateSummary(text, maxSentences = 5) {
            const sentences = this.tokenizeSentences(text);
            
            if (sentences.length <= maxSentences) {
                return sentences.join(' ');
            }

            // Build similarity matrix
            const matrix = Array(sentences.length).fill(null)
                .map(() => Array(sentences.length).fill(0));

            for (let i = 0; i < sentences.length; i++) {
                for (let j = i + 1; j < sentences.length; j++) {
                    const similarity = this.calculateSimilarity(sentences[i], sentences[j]);
                    matrix[i][j] = similarity;
                    matrix[j][i] = similarity;
                }
            }

            // Calculate sentence scores using PageRank algorithm
            let scores = Array(sentences.length).fill(1);
            const damping = 0.85;
            const iterations = 100;

            for (let iter = 0; iter < iterations; iter++) {
                const newScores = Array(sentences.length).fill(1 - damping);
                
                for (let i = 0; i < sentences.length; i++) {
                    let sum = 0;
                    let totalSimilarity = 0;
                    
                    for (let j = 0; j < sentences.length; j++) {
                        if (i !== j && matrix[i][j] > 0) {
                            totalSimilarity += matrix[i][j];
                        }
                    }
                    
                    if (totalSimilarity > 0) {
                        for (let j = 0; j < sentences.length; j++) {
                            if (i !== j && matrix[i][j] > 0) {
                                sum += (matrix[i][j] / totalSimilarity) * scores[j];
                            }
                        }
                    }
                    
                    newScores[i] += damping * sum;
                }
                
                scores = newScores;
            }

            // Select top sentences and maintain original order
            const rankedSentences = sentences
                .map((sentence, index) => ({ sentence, score: scores[index], index }))
                .sort((a, b) => b.score - a.score)
                .slice(0, maxSentences)
                .sort((a, b) => a.index - b.index);

            return rankedSentences.map(item => item.sentence).join(' ');
        }

        // Intelligent question answering
        answerQuestion(text, question) {
            const questionWords = this.preprocessText(question.toLowerCase())
                .split(/\s+/)
                .filter(word => !this.stopWords.has(word));

            if (questionWords.length === 0) {
                return "Please provide a more specific question.";
            }

            const sentences = this.tokenizeSentences(text);
            const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 50);

            // Score paragraphs based on question relevance
            let bestMatch = { text: "", score: 0 };

            [...sentences, ...paragraphs].forEach(segment => {
                const segmentLower = segment.toLowerCase();
                let score = 0;

                // Exact phrase matching (highest priority)
                if (segmentLower.includes(question.toLowerCase())) {
                    score += 10;
                }

                // Question word matching
                questionWords.forEach(word => {
                    if (segmentLower.includes(word)) {
                        score += 2;
                    }
                    
                    // Fuzzy matching for typos
                    const fuzzyMatches = segmentLower.split(/\s+/).filter(segmentWord => 
                        this.levenshteinDistance(word, segmentWord) <= 2 && word.length > 3
                    );
                    score += fuzzyMatches.length * 1;
                });

                // Boost score for segments with multiple question words
                const matchCount = questionWords.filter(word => 
                    segmentLower.includes(word)
                ).length;
                
                if (matchCount > 1) {
                    score += matchCount * 2;
                }

                // Context pattern matching
                Object.values(this.sentencePatterns).forEach(pattern => {
                    if (pattern.test(segmentLower)) {
                        score += 1;
                    }
                });

                if (score > bestMatch.score) {
                    bestMatch = { text: segment, score };
                }
            });

            if (bestMatch.score === 0) {
                return "I couldn't find relevant information to answer that question. Try rephrasing or asking about different aspects of the content.";
            }

            // Highlight question words in the answer
            let highlightedAnswer = bestMatch.text;
            questionWords.forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                highlightedAnswer = highlightedAnswer.replace(regex, `<mark>$&</mark>`);
            });

            return highlightedAnswer;
        }

        // Generate intelligent quiz questions
        generateQuizQuestion(text) {
            const sentences = this.tokenizeSentences(text);
            const keywords = this.extractKeyWords(text, 4).slice(0, 20);
            
            if (sentences.length < 3) {
                return "Need more content to generate quiz questions.";
            }

            const questionTemplates = [
                // Definition questions
                {
                    pattern: /(.{20,})\s+(?:is|are|means?|refers?\s+to)\s+(.{20,100})/i,
                    generator: (match) => `What ${match[2]}?`
                },
                // Process questions  
                {
                    pattern: /(.{20,})\s+(?:causes?|leads?\s+to|results?\s+in)\s+(.{20,100})/i,
                    generator: (match) => `What causes ${match[2]}?`
                },
                // Characteristic questions
                {
                    pattern: /(.{20,100})\s+(?:has|have|contains?|includes?)\s+(.{20,100})/i,
                    generator: (match) => `What does ${match[1]} contain?`
                },
                // Function questions
                {
                    pattern: /(.{20,100})\s+(?:functions?|works?|operates?)\s+(?:by|through|via)\s+(.{20,100})/i,
                    generator: (match) => `How does ${match[1]} function?`
                }
            ];

            // Try pattern-based questions first
            for (const sentence of sentences) {
                for (const template of questionTemplates) {
                    const match = sentence.match(template.pattern);
                    if (match) {
                        return template.generator(match);
                    }
                }
            }

            // Fallback: Generate questions based on key concepts
            if (keywords.length > 0) {
                const keyword = keywords[Math.floor(Math.random() * Math.min(5, keywords.length))];
                const questionStarters = [
                    `What is the significance of ${keyword.word}?`,
                    `How does ${keyword.word} relate to the main topic?`,
                    `What are the key characteristics of ${keyword.word}?`,
                    `Why is ${keyword.word} important in this context?`
                ];
                return questionStarters[Math.floor(Math.random() * questionStarters.length)];
            }

            return "Unable to generate a quiz question from the current content. Try providing more detailed text.";
        }

        // Extract key points and insights
        extractKeyPoints(text) {
            const sentences = this.tokenizeSentences(text);
            const keywords = this.extractKeyWords(text);
            
            // Identify important sentences using multiple criteria
            const scoredSentences = sentences.map(sentence => {
                let score = 0;
                const sentenceLower = sentence.toLowerCase();
                
                // Boost sentences with keywords
                keywords.slice(0, 20).forEach(({ word, frequency }) => {
                    if (sentenceLower.includes(word)) {
                        score += frequency * 2;
                    }
                });
                
                // Boost sentences with emphasis patterns
                Object.entries(this.sentencePatterns).forEach(([type, pattern]) => {
                    const matches = sentence.match(pattern);
                    if (matches) {
                        score += matches.length * (type === 'emphasis' ? 3 : 1);
                    }
                });
                
                // Boost sentences with numbers/statistics
                if (/\d+%|\d+\.\d+|\$\d+|\d+ (?:times?|years?|percent)/.test(sentence)) {
                    score += 2;
                }
                
                // Boost sentences at the beginning (often introductory/important)
                const position = sentences.indexOf(sentence);
                if (position < 3) score += 2;
                
                return { sentence, score };
            });
            
            // Get top key points
            const keyPoints = scoredSentences
                .sort((a, b) => b.score - a.score)
                .slice(0, 8)
                .map((item, index) => `${index + 1}. ${item.sentence}`)
                .join('\n\n');
                
            return keyPoints || "No significant key points could be extracted from the content.";
        }

        // Comprehensive content analysis
        analyzeContent(text) {
            const sentences = this.tokenizeSentences(text);
            const words = text.toLowerCase().replace(/[^\w\s]/g, ' ').split(/\s+/).filter(w => w.length > 0);
            const keywords = this.extractKeyWords(text);
            
            // Calculate readability metrics
            const avgWordsPerSentence = words.length / sentences.length || 0;
            const longWords = words.filter(word => word.length > 6).length;
            const readabilityScore = 206.835 - (1.015 * avgWordsPerSentence) - (84.6 * (longWords / words.length));
            
            // Content complexity analysis
            const uniqueWords = new Set(words).size;
            const lexicalDiversity = uniqueWords / words.length || 0;
            
            // Topic identification
            const topKeywords = keywords.slice(0, 10).map(k => k.word).join(', ');
            
            // Reading time estimation (200 words per minute average)
            const readingTime = Math.ceil(words.length / 200);
            
            return `📊 CONTENT ANALYSIS

📖 Reading Statistics:
• Total Words: ${words.length.toLocaleString()}
• Sentences: ${sentences.length.toLocaleString()}
• Unique Words: ${uniqueWords.toLocaleString()}
• Estimated Reading Time: ${readingTime} minute${readingTime !== 1 ? 's' : ''}

📈 Readability Metrics:
• Average Words per Sentence: ${avgWordsPerSentence.toFixed(1)}
• Lexical Diversity: ${(lexicalDiversity * 100).toFixed(1)}%
• Readability Score: ${readabilityScore.toFixed(0)} (${this.getReadabilityLevel(readabilityScore)})

🔑 Main Topics:
${topKeywords}

💡 Content Insights:
• ${sentences.length < 10 ? 'Brief content' : sentences.length < 50 ? 'Moderate length content' : 'Comprehensive document'}
• ${lexicalDiversity > 0.7 ? 'High vocabulary diversity' : lexicalDiversity > 0.5 ? 'Moderate vocabulary diversity' : 'Limited vocabulary diversity'}
• ${avgWordsPerSentence > 20 ? 'Complex sentence structure' : avgWordsPerSentence > 15 ? 'Moderate complexity' : 'Simple sentence structure'}`;
        }

        getReadabilityLevel(score) {
            if (score >= 90) return 'Very Easy';
            if (score >= 80) return 'Easy';
            if (score >= 70) return 'Fairly Easy';
            if (score >= 60) return 'Standard';
            if (score >= 50) return 'Fairly Difficult';
            if (score >= 30) return 'Difficult';
            return 'Very Difficult';
        }

        // Levenshtein distance for fuzzy matching
        levenshteinDistance(str1, str2) {
            const matrix = Array(str2.length + 1).fill(null).map(() => Array(str1.length + 1).fill(null));
            
            for (let i = 0; i <= str1.length; i++) matrix[0][i] = i;
            for (let j = 0; j <= str2.length; j++) matrix[j][0] = j;
            
            for (let j = 1; j <= str2.length; j++) {
                for (let i = 1; i <= str1.length; i++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j - 1][i] + 1,     // deletion
                        matrix[j][i - 1] + 1,     // insertion
                        matrix[j - 1][i - 1] + cost // substitution
                    );
                }
            }
            
            return matrix[str2.length][str1.length];
        }
    }

    // Initialize AI Engine
    const AI = new AdvancedAI();

    // --- DOM ELEMENTS ---
    const DOMElements = {
        mainContent: document.getElementById('mainContent'),
        pdfUpload: document.getElementById('pdf-upload'),
        contentArea: document.getElementById('content-area'),
        emptyState: document.getElementById('emptyState'),
        pdfViewer: document.getElementById('pdf-viewer'),
        textEditor: document.getElementById('text-editor'),
        aiSidebar: document.getElementById('aiSidebar'),
        dragDropOverlay: document.getElementById('drag-drop-overlay'),
        modeToggleBtn: document.getElementById('mode-toggle-btn'),
        downloadPdfBtn: document.getElementById('download-pdf-btn'),
        uploadLabel: document.getElementById('upload-label'),
        settingsOverlay: document.getElementById('settingsOverlay'),
        themeOptions: document.getElementById('themeOptions'),
        summaryOutput: document.getElementById('summary-output'),
        qaInput: document.getElementById('qa-input'),
        qaAnswer: document.getElementById('qa-answer'),
        quizQuestion: document.getElementById('quiz-question'),
        keypointsOutput: document.getElementById('keypoints-output'),
        analysisOutput: document.getElementById('analysis-output'),
    };

    // --- INITIALIZATION ---
    function initialize() {
        try {
            // Set PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
            
            setupEventListeners();
            loadSettings();
            updateUIMode();
            resetAiOutputs();
            
            // Enable paste functionality
            enableCopyPaste();
            
            console.log('Researcho initialized successfully');
        } catch (error) {
            console.error('Initialization error:', error);
        }
    }

    function setupEventListeners() {
        try {
            // File handling
            DOMElements.pdfUpload.addEventListener('change', handleFileSelect, false);
            
            // UI controls
            document.getElementById('ai-toggle-btn').addEventListener('click', toggleAiSidebar);
            document.getElementById('ai-close-btn').addEventListener('click', toggleAiSidebar);
            DOMElements.modeToggleBtn.addEventListener('click', toggleMode);
            DOMElements.downloadPdfBtn.addEventListener('click', downloadTextAsPDF);
            
            // Drag and Drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                DOMElements.mainContent.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                DOMElements.mainContent.addEventListener(eventName, showDropOverlay, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                DOMElements.mainContent.addEventListener(eventName, hideDropOverlay, false);
            });
            
            DOMElements.mainContent.addEventListener('drop', handleDrop, false);

            // Settings Panel
            document.getElementById('settings-btn').addEventListener('click', () => {
                DOMElements.settingsOverlay.classList.add('visible');
            });
            
            document.getElementById('settings-close-btn').addEventListener('click', () => {
                DOMElements.settingsOverlay.classList.remove('visible');
            });
            
            DOMElements.settingsOverlay.addEventListener('click', (e) => {
                if (e.target === DOMElements.settingsOverlay) {
                    DOMElements.settingsOverlay.classList.remove('visible');
                }
            });
            
            DOMElements.themeOptions.addEventListener('change', handleThemeChange);

            // AI Buttons with loading states
            document.getElementById('summarize-btn').addEventListener('click', () => handleAIAction('summarize'));
            document.getElementById('qa-btn').addEventListener('click', () => handleAIAction('qa'));
            document.getElementById('quiz-new-btn').addEventListener('click', () => handleAIAction('quiz'));
            document.getElementById('keypoints-btn').addEventListener('click', () => handleAIAction('keypoints'));
            document.getElementById('analysis-btn').addEventListener('click', () => handleAIAction('analysis'));
            
            // Enhanced keyboard shortcuts
            DOMElements.qaInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleAIAction('qa');
                }
            });

            // Text editor enhancements
            DOMElements.textEditor.addEventListener('paste', handlePaste);
            DOMElements.textEditor.addEventListener('input', debounce(handleTextChange, 500));
            
        } catch (error) {
            console.error('Event listener setup error:', error);
        }
    }

    // Enhanced copy-paste functionality
    function enableCopyPaste() {
        // Ensure text is selectable everywhere
        document.body.style.webkitUserSelect = 'text';
        document.body.style.mozUserSelect = 'text';
        document.body.style.msUserSelect = 'text';
        document.body.style.userSelect = 'text';
        
        // Add copy functionality to AI outputs
        document.querySelectorAll('.ai-output').forEach(output => {
            output.addEventListener('dblclick', selectText);
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'a':
                        if (e.target === DOMElements.textEditor) {
                            // Allow default select all in text editor
                            return;
                        }
                        break;
                    case 'v':
                        if (e.target === DOMElements.textEditor) {
                            // Allow default paste in text editor
                            return;
                        }
                        break;
                }
            }
        });
    }

    function selectText(element) {
        const range = document.createRange();
        range.selectNodeContents(element.target);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }

    function handlePaste(e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const selection = window.getSelection();
        
        if (selection.rangeCount) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(document.createTextNode(paste));
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
        }
    }

    function handleTextChange() {
        // Auto-save or other text change handling could go here
        resetAiOutputs();
    }

    // Utility functions
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showDropOverlay() {
        DOMElements.dragDropOverlay.classList.add('visible');
    }

    function hideDropOverlay() {
        DOMElements.dragDropOverlay.classList.remove('visible');
    }

    // --- UI & STATE MANAGEMENT ---
    function toggleMode() {
        state.currentMode = (state.currentMode === 'pdf') ? 'text' : 'pdf';
        updateUIMode();
        resetAiOutputs();
    }

    function updateUIMode() {
        if (state.currentMode === 'pdf') {
            DOMElements.pdfViewer.style.display = 'block';
            DOMElements.textEditor.style.display = 'none';
            DOMElements.downloadPdfBtn.style.display = 'none';
            DOMElements.uploadLabel.style.display = 'flex';
            DOMElements.modeToggleBtn.innerHTML = '<i class="fas fa-file-alt"></i>';
            DOMElements.modeToggleBtn.title = "Switch to Text Mode";
        } else {
            DOMElements.pdfViewer.style.display = 'none';
            DOMElements.textEditor.style.display = 'block';
            DOMElements.downloadPdfBtn.style.display = 'flex';
            DOMElements.uploadLabel.style.display = 'none';
            DOMElements.emptyState.style.display = 'none';
            DOMElements.modeToggleBtn.innerHTML = '<i class="fas fa-file-pdf"></i>';
            DOMElements.modeToggleBtn.title = "Switch to PDF Mode";
            DOMElements.textEditor.focus();
        }
    }

    function toggleAiSidebar() {
        DOMElements.aiSidebar.classList.toggle('open');
        DOMElements.mainContent.classList.toggle('sidebar-open');
        
        // Focus management for accessibility
        if (DOMElements.aiSidebar.classList.contains('open')) {
            DOMElements.qaInput.focus();
        }
    }

    function loadSettings() {
        const savedTheme = localStorage.getItem('researcho_theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        const themeInput = document.querySelector(`#themeOptions input[value="${savedTheme}"]`);
        if (themeInput) themeInput.checked = true;
    }

    function handleThemeChange(e) {
        const theme = e.target.value;
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('researcho_theme', theme);
    }
    
    // --- FILE & PDF HANDLING ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file && file.type === 'application/pdf') {
            const fileReader = new FileReader();
            fileReader.onload = (e) => {
                try {
                    loadPdf(new Uint8Array(e.target.result));
                } catch (error) {
                    console.error('File reading error:', error);
                    showError('Error reading PDF file. Please try again.');
                }
            };
            fileReader.readAsArrayBuffer(file);
        } else {
            showError('Please select a valid PDF file.');
        }
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            handleFileSelect({ target: { files: files } });
        }
    }
    
    async function loadPdf(typedarray) {
        if (state.isProcessing) return;
        
        state.isProcessing = true;
        DOMElements.pdfViewer.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--theme-text-secondary);"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Loading PDF...</div>';
        
        try {
            state.pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
            state.extractedText = '';
            state.textLayers = [];
            DOMElements.pdfViewer.innerHTML = '';
            DOMElements.emptyState.style.display = 'none';

            for (let pageNum = 1; pageNum <= state.pdfDoc.numPages; pageNum++) {
                await renderPage(pageNum);
            }
            
            state.currentPageCount = state.pdfDoc.numPages;
            resetAiOutputs();
            
        } catch (error) {
            console.error('Error loading PDF:', error);
            showError('Could not load the PDF file. Please ensure it\'s a valid PDF and try again.');
        } finally {
            state.isProcessing = false;
        }
    }

    async function renderPage(pageNum) {
        try {
            const page = await state.pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            
            // Create page container
            const pageContainer = document.createElement('div');
            pageContainer.className = 'page-container';
            pageContainer.style.position = 'relative';
            pageContainer.style.marginBottom = '20px';
            
            // Create canvas for PDF rendering
            const canvas = document.createElement('canvas');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            pageContainer.appendChild(canvas);
            
            // Create text layer for selection
            const textLayerDiv = document.createElement('div');
            textLayerDiv.className = 'pdf-text-layer';
            textLayerDiv.style.width = viewport.width + 'px';
            textLayerDiv.style.height = viewport.height + 'px';
            pageContainer.appendChild(textLayerDiv);
            
            DOMElements.pdfViewer.appendChild(pageContainer);

            // Render PDF page
            await page.render({ 
                canvasContext: canvas.getContext('2d'), 
                viewport: viewport 
            }).promise;
            
            // Render text layer for selection
            const textContent = await page.getTextContent();
            
            // Build text layer HTML
            const textLayer = {
                textContent: textContent,
                container: textLayerDiv,
                viewport: viewport,
                textDivs: []
            };

            // Extract text content
            const pageText = textContent.items.map(item => item.str).join(' ');
            state.extractedText += pageText + '\n\n';
            
            // Render selectable text layer
            pdfjsLib.renderTextLayer(textLayer);
            state.textLayers.push(textLayer);
            
        } catch (error) {
            console.error(`Error rendering page ${pageNum}:`, error);
        }
    }
    
    function downloadTextAsPDF() {
        if (!DOMElements.textEditor.textContent.trim()) {
            showError('No text content to download.');
            return;
        }

        const button = DOMElements.downloadPdfBtn;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;

        try {
            const { jsPDF } = window.jspdf;
            const textContent = DOMElements.textEditor.textContent;
            
            // Create PDF with proper text wrapping
            const pdf = new jsPDF();
            const pageWidth = pdf.internal.pageSize.width - 20; // margins
            const lineHeight = 10;
            let y = 20;
            
            const lines = pdf.splitTextToSize(textContent, pageWidth);
            
            lines.forEach(line => {
                if (y > pdf.internal.pageSize.height - 20) {
                    pdf.addPage();
                    y = 20;
                }
                pdf.text(line, 10, y);
                y += lineHeight;
            });
            
            pdf.save("researcho-document.pdf");
            
        } catch (error) {
            console.error('PDF generation error:', error);
            showError('Error generating PDF. Please try again.');
        } finally {
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    }
    
    // --- AI FUNCTIONALITY ---
    function getDocumentText() {
        const text = state.currentMode === 'pdf' ? state.extractedText : DOMElements.textEditor.textContent;
        return text.trim();
    }
    
    function resetAiOutputs() {
        DOMElements.summaryOutput.textContent = 'Click generate to create an intelligent summary of your document using advanced text analysis.';
        DOMElements.qaAnswer.textContent = 'Ask any question about your document and get intelligent answers based on the content.';
        DOMElements.quizQuestion.textContent = 'Generate study questions to test your understanding of the material.';
        DOMElements.keypointsOutput.textContent = 'Extract the most important points and concepts from your document.';
        DOMElements.analysisOutput.textContent = 'Get detailed analysis including readability, complexity, and content insights.';
    }
    
    async function handleAIAction(action) {
        const text = getDocumentText();
        
        if (!text || text.length < 50) {
            showError('Please provide more content (at least 50 characters) for AI analysis.');
            return;
        }

        const buttons = {
            'summarize': document.getElementById('summarize-btn'),
            'qa': document.getElementById('qa-btn'),
            'quiz': document.getElementById('quiz-new-btn'),
            'keypoints': document.getElementById('keypoints-btn'),
            'analysis': document.getElementById('analysis-btn')
        };

        const outputs = {
            'summarize': DOMElements.summaryOutput,
            'qa': DOMElements.qaAnswer,
            'quiz': DOMElements.quizQuestion,
            'keypoints': DOMElements.keypointsOutput,
            'analysis': DOMElements.analysisOutput
        };

        const button = buttons[action];
        const output = outputs[action];
        
        if (!button || !output) return;

        // Set loading state
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        button.disabled = true;
        output.classList.add('loading');

        try {
            let result = '';

            switch (action) {
                case 'summarize':
                    result = AI.generateSummary(text, 5);
                    break;

                case 'qa':
                    const question = DOMElements.qaInput.value.trim();
                    if (!question) {
                        showError('Please enter a question first.');
                        return;
                    }
                    result = AI.answerQuestion(text, question);
                    break;

                case 'quiz':
                    result = AI.generateQuizQuestion(text);
                    break;

                case 'keypoints':
                    result = AI.extractKeyPoints(text);
                    break;

                case 'analysis':
                    result = AI.analyzeContent(text);
                    break;

                default:
                    result = 'Unknown action requested.';
            }

            // Display result with typing animation
            await typeText(output, result);

        } catch (error) {
            console.error(`AI ${action} error:`, error);
            output.textContent = `Error processing ${action}. Please try again.`;
        } finally {
            // Reset button state
            button.innerHTML = originalHTML;
            button.disabled = false;
            output.classList.remove('loading');
        }
    }

    // Typing animation for AI responses
    async function typeText(element, text) {
        element.innerHTML = '';
        const chars = text.split('');
        
        for (let i = 0; i < chars.length; i++) {
            element.innerHTML += chars[i];
            
            // Add small delay for typing effect
            if (i % 5 === 0) {
                await new Promise(resolve => setTimeout(resolve, 20));
            }
        }
    }

    // --- UTILITY FUNCTIONS ---
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function showError(message) {
        // Create a simple toast notification
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4757;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: var(--theme-shadow);
            z-index: 10000;
            font-weight: 600;
            max-width: 300px;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    // --- INITIALIZE APP ---
    initialize();
});
</script>
</body>
</html>
