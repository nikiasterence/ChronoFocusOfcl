<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="Chronofocus.png" type="image/x-icon">
  <title>Chrono Focus ‚Äî Enter</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Internal CSS -->
  <style>
    :root {
      /* Liquid Glass Theme - Light Mode */
      --bg-gradient-start: #E9F1F8;
      --bg-gradient-end: #DDEBF7;
      --text-primary: #1F2937;
      --text-secondary: #4B5563;
      --text-on-accent: #FFFFFF;
      --header-text: #111827;
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(200, 215, 230, 0.5);
      --shadow-color: rgba(100, 116, 139, 0.15);
      --button-focus: rgba(59, 130, 246, 0.4);
      --accent-gradient: linear-gradient(135deg, #3B82F6, #1D4ED8);
      --error-color: #EF4444;
      --icon-bg: #E0E7FF;
      --icon-fg: #3730A3;
      --loader-color: #3B82F6;
      --liquid-effect: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      --liquid-border: 1px solid rgba(255, 255, 255, 0.2);
      --liquid-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        /* Liquid Glass Theme - Dark Mode */
        --bg-gradient-start: #0f172a;
        --bg-gradient-end: #1e293b;
        --text-primary: #E2E8F0;
        --text-secondary: #94A3B8;
        --text-on-accent: #FFFFFF;
        --header-text: #FFFFFF;
        --glass-bg: rgba(30, 41, 59, 0.3);
        --glass-border: rgba(71, 85, 105, 0.2);
        --shadow-color: rgba(0, 0, 0, 0.3);
        --button-focus: rgba(96, 165, 250, 0.5);
        --accent-gradient: linear-gradient(135deg, #38BDF8, #3B82F6);
        --error-color: #F87171;
        --icon-bg: #1E293B;
        --icon-fg: #7DD3FC;
        --loader-color: #38BDF8;
        --liquid-effect: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
        --liquid-border: 1px solid rgba(255, 255, 255, 0.1);
        --liquid-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      }
    }

    *, *::before, *::after { box-sizing: border-box; }
    html { height: 100%; -webkit-text-size-adjust: 100%; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      color: var(--text-primary);
      background: linear-gradient(-45deg, var(--bg-gradient-start), var(--bg-gradient-end), #4A00E0, #8E2DE2);
      background-size: 400% 400%;
      animation: gradient 25s ease infinite;
      display: grid;
      place-items: center;
      padding: 1rem;
      overflow-y: auto;
      position: relative;
    }

    /* Liquid Glass Background Elements */
    .liquid-bg-element {
      position: absolute;
      border-radius: 50%;
      filter: blur(40px);
      opacity: 0.4;
      z-index: 0;
      animation: float 15s ease-in-out infinite;
    }
    .liquid-bg-element:nth-child(1) {
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.3) 0%, rgba(59, 130, 246, 0) 70%);
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }
    .liquid-bg-element:nth-child(2) {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.3) 0%, rgba(139, 92, 246, 0) 70%);
      bottom: 10%;
      right: 10%;
      animation-delay: -5s;
    }
    .liquid-bg-element:nth-child(3) {
      width: 250px;
      height: 250px;
      background: radial-gradient(circle, rgba(14, 165, 233, 0.3) 0%, rgba(14, 165, 233, 0) 70%);
      top: 50%;
      left: 80%;
      animation-delay: -10s;
    }

    /* --- Animations --- */
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-20px) scale(0.98); }
    }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes liquidPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    @keyframes liquidBorder {
      0%, 100% { border-color: rgba(255, 255, 255, 0.2); }
      50% { border-color: rgba(255, 255, 255, 0.4); }
    }
    @keyframes keyPress {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(0.95); }
    }
    @keyframes enterSlide {
      0% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0); }
    }
    @keyframes pageTransition {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
      100% { opacity: 0; transform: scale(0.9); }
    }

    /* --- Base Container & Modules --- */
    .container {
      width: min(95vw, 450px);
      padding: 40px;
      background: var(--glass-bg);
      border-radius: 28px;
      box-shadow: var(--liquid-shadow);
      backdrop-filter: blur(25px) saturate(150%);
      -webkit-backdrop-filter: blur(25px) saturate(150%);
      border: var(--liquid-border);
      text-align: center;
      z-index: 2;
      opacity: 0;
      transform: translateY(20px) scale(0.98);
      visibility: hidden;
      transition: opacity 0.5s cubic-bezier(0.25, 1, 0.5, 1), transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
      position: absolute;
      animation: liquidPulse 8s ease-in-out infinite;
    }
    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--liquid-effect);
      border-radius: 28px;
      z-index: -1;
    }
    .container.active {
      opacity: 1;
      transform: translateY(0) scale(1);
      visibility: visible;
      animation: fadeIn 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards, liquidPulse 8s ease-in-out infinite;
      position: relative;
    }
    .hidden { display: none; }

    /* --- Header & Typography --- */
    header { margin-bottom: 32px; }
    .logo {
      width: 60px; height: 60px; border-radius: 16px;
      background: var(--icon-bg); color: var(--icon-fg);
      display: inline-flex; align-items: center; justify-content: center;
      margin-bottom: 20px; font-size: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s ease-in-out;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: var(--liquid-border);
    }
    .logo:hover { transform: scale(1.1) rotate(5deg); }
    h1 { font-size: 26px; margin: 0; font-weight: 700; color: var(--header-text); }
    p { margin: 8px 0 0; color: var(--text-secondary); font-size: 16px; line-height: 1.6; }
    .footer p { margin-top: 32px; font-size: 13px; color: var(--text-secondary); opacity: 0.8; }

    /* --- Form Elements --- */
    .form-group { margin-bottom: 22px; text-align: left; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary); font-size: 14px; }
    .form-control, .region-select {
      appearance: none; -webkit-appearance: none;
      width: 100%;
      border: var(--liquid-border);
      border-radius: 12px;
      padding: 15px; font-size: 16px; font-weight: 500; color: var(--text-primary);
      background: rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease-in-out;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .form-control::placeholder { color: var(--text-secondary); }
    .form-control:focus, .region-select:focus {
      outline: none;
      box-shadow: 0 0 0 4px var(--button-focus);
      border-color: rgba(255, 255, 255, 0.4);
      background-color: rgba(255,255,255,0.15);
      animation: liquidBorder 2s infinite;
    }
    
    /* --- Buttons --- */
    .btn {
      appearance: none; width: 100%; border: 0; border-radius: 12px; padding: 16px;
      font-size: 16px; font-weight: 600; color: var(--text-on-accent); cursor: pointer;
      background: var(--accent-gradient);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 2px 5px rgba(0,0,0,0.05);
      transition: transform 0.2s cubic-bezier(0.25, 1, 0.5, 1), box-shadow 0.2s cubic-bezier(0.25, 1, 0.5, 1);
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .btn:hover::before {
      left: 100%;
    }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.15), 0 4px 10px rgba(0,0,0,0.08); }
    .btn:active { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .btn:focus-visible { outline: none; box-shadow: 0 0 0 4px var(--button-focus); }
    .btn:disabled { cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
    .btn.loading { position: relative; color: transparent; }
    .btn.loading::after {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      width: 20px; height: 20px;
      margin-top: -10px; margin-left: -10px;
      border: 3px solid rgba(255, 255, 255, 0.5);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* --- Registration Specifics --- */
    .profile-pic-group { display: flex; flex-direction: column; align-items: center; gap: 12px; margin-bottom: 24px; }
    #pfp-preview { width: 88px; height: 88px; border-radius: 50%; background: var(--glass-bg); color: var(--text-secondary); display: grid; place-items:center; font-size: 40px; background-size: cover; background-position: center; border: 2px solid var(--glass-border); transition: transform 0.3s ease; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    #pfp-upload-label { cursor: pointer; color: #3B82F6; font-weight: 500; font-size: 15px; padding: 8px 16px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); transition: all 0.2s; }
    #pfp-upload-label:hover { background: rgba(59, 130, 246, 0.2); transform: translateY(-2px); }
    #pfp-upload:focus + #pfp-upload-label { outline: 2px solid var(--button-focus); border-radius: 4px; }

    /* --- PIN Lock Screen --- */
    .pin-display { display: flex; justify-content: center; gap: 16px; margin: 32px 0; transition: transform 0.2s; }
    .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--text-secondary); transition: background-color 0.2s, transform 0.2s, border-color 0.2s; }
    .pin-dot.filled { background-color: var(--header-text); border-color: var(--header-text); transform: scale(1.1); }
    .pin-display.shake { animation: shake 0.5s ease-in-out; }

    .pin-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 280px; margin: 0 auto; }
    .pin-keypad button {
      width: 75px; height: 75px; border-radius: 50%; border: var(--liquid-border); background: rgba(255, 255, 255, 0.1); color: var(--header-text);
      font-size: 28px; font-weight: 400; cursor: pointer; transition: all 0.2s;
      display: grid; place-items: center; /* Ensures content is centered perfectly */
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .pin-keypad button:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-3px); }
    .pin-keypad button:active { 
      transform: scale(0.9); 
      background: var(--glass-border);
      animation: keyPress 0.2s ease;
    }

    /* --- Main App Screen --- */
    .user-profile-header { display: flex; flex-direction: column; align-items: center; gap: 16px; margin-bottom: 28px; }
    #user-pfp { width: 80px; height: 80px; border-radius: 50%; background-size: cover; background-position: center; border: 3px solid var(--glass-border); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    #user-greeting { font-size: 24px; font-weight: 600; color: var(--header-text); }

    .select-container { position: relative; width: 100%; }
    .select-container::after { content: '‚åÑ'; font-size: 20px; line-height: 1; position: absolute; top: 50%; right: 20px; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }
    .success { display: none; margin-top: 16px; font-size: 15px; color: var(--header-text); font-weight: 500; }
    
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
    
    .settings-button {
      position: absolute; top: 16px; right: 16px; background: none; border: none; cursor: pointer;
      color: var(--text-secondary); font-size: 28px; padding: 8px; border-radius: 50%;
      transition: background-color 0.2s, color 0.2s, transform 0.2s;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .settings-button:hover { background-color: var(--glass-bg); color: var(--text-primary); transform: rotate(15deg); }
    
    /* --- Initial Loader --- */
    #loader {
        color: var(--loader-color);
        font-size: 24px;
        transition: opacity 0.4s ease;
        position: absolute;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 10;
    }
    #loader.hidden { opacity: 0; pointer-events: none; }

    /* --- Version Badge --- */
    .version-badge {
      position: absolute;
      bottom: 16px;
      left: 16px;
      font-size: 12px;
      color: var(--text-secondary);
      opacity: 0.7;
      z-index: 1;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* --- Toggle Switch --- */
    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 20px 0;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      border: var(--liquid-border);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .toggle-label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 15px;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.2);
      transition: .4s;
      border-radius: 34px;
      border: var(--liquid-border);
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input:checked + .toggle-slider {
      background: var(--accent-gradient);
    }
    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* --- ‚≠ê RESPONSIVE IMPROVEMENTS FOR MOBILE ‚≠ê --- */
    @media (max-width: 480px) {
      body {
        padding: 0.5rem;
        min-height: -webkit-fill-available;
      }
      .container {
        padding: 24px 20px; /* Reduced horizontal padding */
        box-shadow: 0 8px 32px var(--shadow-color);
      }
      .container.active {
        animation: fadeIn 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
      }
      h1 { font-size: 22px; }
      p { font-size: 15px; }
      .logo { width: 50px; height: 50px; font-size: 24px; margin-bottom: 16px; }
      header { margin-bottom: 24px; }

      .form-group { margin-bottom: 18px; }
      .form-control, .region-select { padding: 14px; }
      .btn { padding: 15px; }

      .pin-keypad {
        gap: 12px; /* Reduced gap */
        max-width: 250px; /* Further constrained width */
      }
      .pin-keypad button {
        width: 65px;
        height: 65px;
        font-size: 26px;
      }
      #user-greeting { font-size: 21px; }
      
      .liquid-bg-element {
        display: none; /* Hide liquid elements on very small screens */
      }
      
      .toggle-container {
        padding: 10px 14px;
      }
    }
  </style>
</head>
<body>
    <!-- Liquid Glass Background Elements -->
    <div class="liquid-bg-element"></div>
    <div class="liquid-bg-element"></div>
    <div class="liquid-bg-element"></div>
    
    <!-- Version Badge -->
    <div class="version-badge">Zenith 1 ¬∑ Beta 7</div>
    
    <div id="loader">Loading...</div>

<div id="registration-container" class="container">
  <header><div class="logo">üöÄ</div><h1>Create Your Profile</h1><p>Start your journey to focus and tranquility. This is a one-time setup.</p></header>
  <form id="registration-form" novalidate>
    <div class="profile-pic-group">
        <div id="pfp-preview">üë§</div>
        <input type="file" id="pfp-upload" class="sr-only" accept="image/*">
        <label for="pfp-upload" id="pfp-upload-label" tabindex="0">Upload a Profile Picture</label>
    </div>
    <div class="form-group"><label for="name">Name</label><input type="text" id="name" class="form-control" required placeholder="Enter your name" autofocus></div>
    <div class="form-group"><label for="email">Email</label><input type="email" id="email" class="form-control" required placeholder="Enter your email"></div>
    <div class="form-group"><label for="password">Password</label><input type="password" id="password" class="form-control" required placeholder="Create a password"></div>
    <div class="form-group"><label for="gender">Gender</label><div class="select-container"><select id="gender" class="form-control" required><option value="" disabled selected>Select...</option><option value="Male">Male</option><option value="Female">Female</option><option value="Prefer not to say">Prefer not to say</option></select></div></div>
    <div class="form-group"><label for="age">Age</label><input type="number" id="age" class="form-control" required min="12" placeholder="Your age (must be 12+)"></div>
    <button type="submit" class="btn" id="registerBtn">Create Profile</button>
  </form>
</div>

<div id="pin-container" class="container">
    <header><div class="logo" id="pin-logo">üîí</div><h1 id="pin-title">Set Your 4-Digit PIN</h1><p id="pin-subtitle">For quick and secure access.</p></header>
    <div class="pin-display" id="pin-display"><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div></div>
    <div class="pin-keypad" id="pin-keypad">
        <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button>
        <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button>
        <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button>
        <span></span><button data-key="0">0</button><button data-key="del">‚å´</button>
    </div>
    <div class="toggle-container">
      <span class="toggle-label">Enable Passcode</span>
      <label class="toggle-switch">
        <input type="checkbox" id="passcode-toggle" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
</div>

<main id="main-content" class="container">
    <button id="settings-btn" class="settings-button" title="Settings" aria-label="Open Settings">‚öôÔ∏è</button>
    <header class="user-profile-header">
        <div id="user-pfp"></div><h1 id="user-greeting">Welcome!</h1>
    </header>
    <p style="margin-top:0;">Find your flow, peacefully.</p>
    <div class="region-selector-wrapper" style="margin: 32px 0;">
        <label for="region-select" class="sr-only">Select Your Region</label>
        <div class="select-container"><select id="region-select" class="form-control" required><option value="" disabled selected>Choose your region...</option><option value="USA">USA</option><option value="Canada">Canada</option><option value="China">China</option><option value="Bangladesh">Bangladesh</option><option value="UK">United Kingdom</option><option value="Australia">Australia</option><option value="Japan">Japan</option><option value="Germany">Germany</option><option value="India">India</option></select></div>
    </div>
    <button class="btn enter" id="enterBtn" disabled>Enter</button>
    <div id="success" class="success" role="status" aria-live="polite"></div>
    <footer class="footer"><p>¬© <span id="year"></span> Chrono Focus ¬∑ Crafted by CozytuStudios Team</p></footer>
</main>
  <script>
    (function() {
      'use strict';
      
      const USER_DATA_KEY = 'chronoFocus-userData';
      const USER_PIN_KEY = 'chronoFocus-userPin';
      const SAVED_REGION_KEY = 'chronoFocus-userRegion';
      const PASSCODE_ENABLED_KEY = 'chronoFocus-passcodeEnabled';
      const VERSION = 'Zenith 1 ¬∑ Beta 7';

      // Global reference to keypad event handler to allow proper removal
      let pinKeypadHandler = null;

      document.addEventListener('DOMContentLoaded', initialize);

      function initialize() {
        document.getElementById('year').textContent = new Date().getFullYear();
        setTimeout(checkUserState, 200); // Brief delay for smooth rendering
        
        // Add keyboard support for password field
        document.getElementById('password').addEventListener('keydown', function(e) {
          // Allow normal typing but prevent form submission on Enter
          if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('registration-form').requestSubmit();
          }
        });
        
        // Add Enter key support for region selection
        document.getElementById('region-select').addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !document.getElementById('enterBtn').disabled) {
            document.getElementById('enterBtn').click();
          }
        });
        
        // Add Enter key support for Enter button
        document.getElementById('enterBtn').addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !this.disabled) {
            this.click();
          }
        });
      }
      
      function checkUserState() {
        const storedData = localStorage.getItem(USER_DATA_KEY);
        const userData = storedData ? JSON.parse(storedData) : null;
        const userPin = localStorage.getItem(USER_PIN_KEY);
        const passcodeEnabled = localStorage.getItem(PASSCODE_ENABLED_KEY) !== 'false';
        
        document.getElementById('loader').classList.add('hidden');

        if (!userData) {
          showModule('registration-container');
          setupRegistration();
        } else if (!userPin && passcodeEnabled) {
          showModule('pin-container');
          setupPinScreen('set', userData); 
        } else {
          if (passcodeEnabled) {
            showModule('pin-container');
            setupPinScreen('login', userData);
          } else {
            showMainApp(userData);
          }
        }
      }

      function showModule(moduleId) {
          const containers = document.querySelectorAll('.container');
          containers.forEach(c => {
            if (c.id === moduleId) {
              c.classList.add('active');
            } else {
              c.classList.remove('active');
            }
          });
      }

      function setupRegistration(isUpdate = false) {
          const form = document.getElementById('registration-form');
          const pfpUpload = document.getElementById('pfp-upload');
          const pfpPreview = document.getElementById('pfp-preview');
          const nameInput = document.getElementById('name');
          const emailInput = document.getElementById('email');
          const passwordInput = document.getElementById('password');
          const genderInput = document.getElementById('gender');
          const ageInput = document.getElementById('age');
          const registerBtn = document.getElementById('registerBtn');
          let pfpData = null;

          if (isUpdate) {
            const userData = JSON.parse(localStorage.getItem(USER_DATA_KEY));
            pfpData = userData.pfp;
            if (pfpData) {
                pfpPreview.style.backgroundImage = `url(${pfpData})`;
                pfpPreview.textContent = '';
            }
            nameInput.value = userData.name;
            emailInput.value = userData.email;
            genderInput.value = userData.gender;
            ageInput.value = userData.age;
            registerBtn.textContent = 'Update Profile';
            document.querySelector('#registration-container h1').textContent = 'Update Your Profile';
            document.querySelector('#registration-container p').textContent = 'Keep your information up to date.';
          }

          pfpUpload.addEventListener('change', (e) => {
              const file = e.target.files?.[0];
              if (!file) return;

              if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('File is too large. Please select an image under 5MB.');
                return;
              }

              const reader = new FileReader();
              reader.onload = (event) => {
                  pfpData = event.target.result;
                  pfpPreview.style.backgroundImage = `url(${pfpData})`;
                  pfpPreview.textContent = '';
              };
              reader.onerror = () => {
                alert('Error reading file. Please try another image.');
              };
              reader.readAsDataURL(file);
          });
          
          form.onsubmit = (e) => {
              e.preventDefault();
              if (form.checkValidity() === false) {
                  alert("Please fill out all fields correctly.");
                  return;
              }
              const age = parseInt(ageInput.value, 10);
              if (age < 12) {
                  alert("You must be at least 12 years old to register.");
                  return;
              }
              
              const newUserData = {
                  pfp: pfpData, 
                  name: nameInput.value.trim(),
                  email: emailInput.value.trim(), 
                  gender: genderInput.value,
                  age: age
              };
              
              localStorage.setItem(USER_DATA_KEY, JSON.stringify(newUserData));
              
              if(isUpdate) {
                alert('Profile updated successfully!');
                showMainApp(newUserData);
              } else {
                const passcodeEnabled = localStorage.getItem(PASSCODE_ENABLED_KEY) !== 'false';
                if (passcodeEnabled) {
                  showModule('pin-container');
                  setupPinScreen('set', newUserData);
                } else {
                  showMainApp(newUserData);
                }
              }
          };
      }

      function setupPinScreen(mode, userData) {
          let currentPin = "";
          let tempPin = "";
          const pinDisplayDots = document.querySelectorAll('#pin-display .pin-dot');
          const keypad = document.getElementById('pin-keypad');
          const title = document.getElementById('pin-title');
          const subtitle = document.getElementById('pin-subtitle');
          const logo = document.getElementById('pin-logo');
          const pinDisplay = document.getElementById('pin-display');
          const passcodeToggle = document.getElementById('passcode-toggle');
          const savedPin = localStorage.getItem(USER_PIN_KEY);
          const passcodeEnabled = localStorage.getItem(PASSCODE_ENABLED_KEY) !== 'false';

          // Set initial toggle state
          passcodeToggle.checked = passcodeEnabled;

          // Handle passcode toggle
          passcodeToggle.addEventListener('change', function() {
            localStorage.setItem(PASSCODE_ENABLED_KEY, this.checked);
            if (!this.checked && mode === 'login') {
              showMainApp(userData);
            }
          });

          const updatePinDisplay = () => pinDisplayDots.forEach((dot, i) => dot.classList.toggle('filled', i < currentPin.length));
          const resetPinDisplay = () => { currentPin = ""; updatePinDisplay(); };
          
          function handleIncorrectPin() {
              pinDisplay.classList.add('shake');
              setTimeout(() => {
                  pinDisplay.classList.remove('shake');
                  resetPinDisplay();
              }, 600);
          }

          const modes = {
              set: { title: 'Set Your 4-Digit PIN', subtitle: 'This will be used for quick, secure access.', logo: 'üîí', next: (newPin) => { localStorage.setItem(USER_PIN_KEY, newPin); showMainApp(userData); } },
              login: { title: `Welcome Back, ${userData.name}`, subtitle: 'Please enter your PIN to continue.', logo: 'üîë', next: (enteredPin) => (enteredPin === savedPin ? showMainApp(userData) : handleIncorrectPin()) },
              confirmOld: { title: 'Enter Your Current PIN', subtitle: 'Please confirm your old PIN to proceed.', logo: 'üîê', next: (enteredPin) => {
                  if (enteredPin === savedPin) {
                    const action = confirm("Do you want to change your PIN? OK for PIN change, Cancel to edit your profile.");
                    if(action) { setupPinScreen('setNew', userData); } 
                    else { showModule('registration-container'); setupRegistration(true); }
                  } else { handleIncorrectPin(); }
              }},
              setNew: { title: 'Set a New PIN', subtitle: 'Enter your new 4-digit PIN.', logo: 'üîí', next: (newPin) => { tempPin = newPin; resetPinDisplay(); setupPinScreen('confirmNew', userData); } },
              confirmNew: { title: 'Confirm Your New PIN', subtitle: 'Please re-enter your new PIN.', logo: '‚úÖ', next: (confirmedPin) => (confirmedPin === tempPin ? (localStorage.setItem(USER_PIN_KEY, confirmedPin), alert('PIN updated successfully!'), showMainApp(userData)) : (alert('PINs do not match. Please try again.'), setupPinScreen('setNew', userData))) }
          };

          title.textContent = modes[mode].title;
          subtitle.textContent = modes[mode].subtitle;
          logo.textContent = modes[mode].logo;
          resetPinDisplay();

          if (pinKeypadHandler) { keypad.removeEventListener('click', pinKeypadHandler); }
          
          pinKeypadHandler = (e) => {
              const key = e.target.closest('[data-key]')?.dataset.key;
              if (!key) return;

              if (key === 'del') { currentPin = currentPin.slice(0, -1); } 
              else if (currentPin.length < 4) { currentPin += key; }
              
              updatePinDisplay();
              
              if (currentPin.length === 4) {
                  setTimeout(() => modes[mode].next(currentPin), 250); 
              }
          };
          
          keypad.addEventListener('click', pinKeypadHandler);
          
          // Add keyboard support for PIN entry
          document.addEventListener('keydown', function(e) {
            if (e.key >= '0' && e.key <= '9' && currentPin.length < 4) {
              currentPin += e.key;
              updatePinDisplay();
              if (currentPin.length === 4) {
                setTimeout(() => modes[mode].next(currentPin), 250);
              }
            } else if (e.key === 'Backspace') {
              currentPin = currentPin.slice(0, -1);
              updatePinDisplay();
            }
          });
      }
      
      function showMainApp(userData) {
          showModule('main-content');
          setupMainApp(userData);
      }
      
      function setupMainApp(userData) {
        const regionSelect = document.getElementById('region-select');
        const enterBtn = document.getElementById('enterBtn');
        const successMsg = document.getElementById('success');
        const settingsBtn = document.getElementById('settings-btn');
        
        // This function enables/disables the 'Enter' button based on selection
        const validateSelection = () => {
            enterBtn.disabled = !regionSelect.value;
        };

        // This function sets the initial value of the dropdown
        const loadSavedRegion = () => {
            // Get the saved region from localStorage
            const savedRegion = localStorage.getItem(SAVED_REGION_KEY);
            // If a region was saved, set the dropdown to that value
            if (savedRegion) {
                regionSelect.value = savedRegion;
            }
            // Check if the button should be enabled initially
            validateSelection();
        };
        
        const personalizeHeader = () => {
            document.getElementById('user-greeting').textContent = `Welcome, ${userData.name}`;
            const userPfp = document.getElementById('user-pfp');
            if (userData.pfp) {
                userPfp.style.backgroundImage = `url(${userData.pfp})`;
                userPfp.textContent = '';
            } else {
                userPfp.style.backgroundImage = '';
                userPfp.textContent = 'üë§';
            }
        };

        const handleEntry = () => {
            // Get the *currently selected* value from the dropdown
            const selectedRegion = regionSelect.value;
            // Guard against empty selection, just in case
            if (!selectedRegion) return; 

            enterBtn.disabled = true;
            enterBtn.classList.add('loading'); 
            
            // Add enter animation
            enterBtn.style.animation = 'enterSlide 0.5s ease';
            
            // Save the newly selected region to localStorage
            localStorage.setItem(SAVED_REGION_KEY, selectedRegion);
            
            successMsg.textContent = `‚úì Preparing your sanctuary in ${selectedRegion}‚Ä¶`;
            successMsg.style.display = 'block';
            
            // Add page transition animation
            document.querySelector('.container.active').style.animation = 'pageTransition 0.8s ease forwards';
            
            setTimeout(() => {
                // Here you would redirect to the main part of the app
                console.log(`Redirecting to app for region: ${selectedRegion}`);
                window.location.href = 'page1.html'; // Example redirection
            }, 800);
        };
        
        const handleSettings = () => {
            showModule('pin-container');
            setupPinScreen('confirmOld', userData);
        };
        
        // Setup event listeners
        regionSelect.onchange = validateSelection;
        enterBtn.onclick = handleEntry;
        settingsBtn.onclick = handleSettings;
        
        // Initial setup calls
        personalizeHeader();
        loadSavedRegion();
      }

    })();
  </script>
</body>
</html>
