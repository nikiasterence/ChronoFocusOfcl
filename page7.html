<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BrainPulse </title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--glass: rgba(255,255,255,0.035)}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071029 0%, #001224 100%);color:#e6eef8}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:32px}
    .card{width:920px;max-width:96vw;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:18px;padding:20px;box-shadow:0 10px 30px rgba(2,6,23,0.6);display:grid;grid-template-columns:1fr 360px;gap:18px}

    /* Left - game area */
    .game-area{padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border-radius:12px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-size:20px;font-weight:700;letter-spacing:0.2px}
    .hud{display:flex;gap:8px;align-items:center}
    .chip{background:var(--glass);padding:8px 10px;border-radius:10px;font-size:13px}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:10px}
    .btn{aspect-ratio:1/1;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;user-select:none;transition:transform .12s ease, box-shadow .12s ease;box-shadow:0 6px 14px rgba(2,6,23,0.5)}
    .btn:active{transform:translateY(2px)}
    .btn.on{transform:scale(1.05);box-shadow:0 12px 30px rgba(124,58,237,0.22)}

    /* Right - controls */
    .sidebar{padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:12px}
    .big{font-size:28px;font-weight:800}
    .muted{opacity:.85;font-size:13px}
    .controls{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    button.primary{background:linear-gradient(90deg,var(--accent),#4f46e5);border:none;color:white;padding:12px;border-radius:12px;font-weight:700;cursor:pointer}
    .small{font-size:13px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}

    .progress{height:12px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);width:0%}

    .footer{margin-top:12px;font-size:13px;opacity:.9}

    /* popup */
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    .modal{background:#07101a;padding:20px;border-radius:14px;box-shadow:0 12px 40px rgba(2,6,23,0.8);min-width:320px}

    /* leaderboard */
    .scores{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .score-row{display:flex;justify-content:space-between;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02)}

    @media(max-width:880px){.card{grid-template-columns:1fr;}
      .sidebar{order:2}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application">
      <div class="game-area">
        <div class="topbar">
          <div>
            <div class="title">BrainPulse — Pattern Rush</div>
            <div class="muted">Repeat the pattern. Fast + accurate = higher Brain Score. Very addictive.</div>
          </div>
          <div class="hud">
            <div class="chip">Level: <span id="level">1</span></div>
            <div class="chip">Streak: <span id="streak">0</span></div>
            <div class="chip">Lives: <span id="lives">3</span></div>
          </div>
        </div>

        <div id="grid" class="grid" aria-label="game grid"></div>

        <div style="display:flex;gap:12px;margin-top:12px;align-items:center;">
          <div style="flex:1">
            <div class="progress"><i id="progressFill"></i></div>
            <div class="muted" style="margin-top:6px;font-size:13px">Time left for this round: <span id="timeLeft">—</span> s</div>
          </div>
          <div style="width:160px;text-align:right">
            <div style="font-weight:800;font-size:20px">Brain Score</div>
            <div id="bscore" style="font-size:22px;color:var(--accent);font-weight:900">0</div>
          </div>
        </div>

        <div class="footer">Tip: Keep calm — speed helps but mistakes cost more. Try to build streaks for huge multipliers.</div>
      </div>

      <div class="sidebar">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div class="big">Play</div>
            <div class="muted">Quick, addictive pattern memory that scales difficulty.</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Top</div>
            <div id="topScore" style="font-weight:900;font-size:18px;color:var(--accent)">0</div>
          </div>
        </div>

        <div class="controls">
          <button id="startBtn" class="primary">Start Game</button>
          <div style="display:flex;gap:8px">
            <button id="hintBtn" class="small">Show Hint (-1 life)</button>
            <button id="strictBtn" class="small">Toggle Strict Mode</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:6px">
            <select id="gridSize" class="small" title="Grid size">
              <option value="4" selected>4x4 (Default)</option>
              <option value="3">3x3 (Easy)</option>
              <option value="5">5x5 (Insane)</option>
            </select>
            <button id="resetScores" class="small">Reset Leaderboard</button>
          </div>

          <div style="margin-top:8px">
            <div class="muted">Game Stats</div>
            <div style="display:flex;gap:8px;margin-top:6px">
              <div class="chip">Rounds: <span id="rounds">0</span></div>
              <div class="chip">Accuracy: <span id="acc">100%</span></div>
            </div>

            <div class="muted" style="margin-top:8px">Leaderboard</div>
            <div id="scores" class="scores"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <template id="btnTemplate">
    <div class="btn" role="button" tabindex="0"></div>
  </template>

  <script>
    // --- Game variables ---
    const gridEl = document.getElementById('grid');
    const startBtn = document.getElementById('startBtn');
    const hintBtn = document.getElementById('hintBtn');
    const strictBtn = document.getElementById('strictBtn');
    const gridSizeSel = document.getElementById('gridSize');

    const levelEl = document.getElementById('level');
    const streakEl = document.getElementById('streak');
    const livesEl = document.getElementById('lives');
    const bscoreEl = document.getElementById('bscore');
    const topScoreEl = document.getElementById('topScore');
    const scoresEl = document.getElementById('scores');
    const roundsEl = document.getElementById('rounds');
    const accEl = document.getElementById('acc');
    const progressFill = document.getElementById('progressFill');
    const timeLeftEl = document.getElementById('timeLeft');

    let size = 4;
    let buttons = [];
    let sequence = [];
    let playerIndex = 0;
    let accepting = false;
    let level = 1;
    let lives = 3;
    let streak = 0;
    let rounds = 0;
    let correctCount = 0;
    let totalInputs = 0;
    let brainScore = 0;
    let strictMode = false;
    let roundTimer = null;
    let roundTimeLimit = 6; // base seconds
    let reactionTimes = [];

    // --- Utilities ---
    function randInt(max){ return Math.floor(Math.random()*max); }

    function createGrid(n){
      gridEl.innerHTML=''; buttons=[];
      gridEl.style.gridTemplateColumns = `repeat(${n}, 1fr)`;
      for(let i=0;i<n*n;i++){
        const tpl = document.getElementById('btnTemplate').content.cloneNode(true);
        const btn = tpl.querySelector('.btn');
        btn.dataset.index = i;
        btn.addEventListener('click', onPlayerClick);
        btn.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') onPlayerClick({target:btn})});
        btn.innerHTML = '';
        gridEl.appendChild(btn);
        buttons.push(btn);
      }
    }

    function flash(index, time=350){
      const el = buttons[index];
      if(!el) return;
      el.classList.add('on');
      // subtle sound (using WebAudio)
      playTone(200 + (index*40)%800, 120);
      setTimeout(()=>el.classList.remove('on'), time);
    }

    // WebAudio simple tone
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audioCtx = AudioCtx ? new AudioCtx() : null;
    function playTone(freq, dur=150){
      if(!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type='sine'; o.frequency.value=freq; g.gain.value=0.02;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.05); o.stop(audioCtx.currentTime + 0.06); }, dur);
    }

    // --- Game flow ---
    function newRound(){
      accepting = false;
      playerIndex = 0;
      sequence.push(randInt(size*size));
      level = sequence.length; // level grows with length
      levelEl.textContent = level;
      rounds++;
      roundsEl.textContent = rounds;
      roundTimeLimit = Math.max(2.2, 6 - (level*0.2));
      showSequence(0);
    }

    function showSequence(i){
      if(i>=sequence.length){
        accepting = true;
        startRoundTimer(roundTimeLimit);
        return;
      }
      const idx = sequence[i];
      setTimeout(()=>{
        flash(idx, 360);
        setTimeout(()=> showSequence(i+1), 360);
      }, 300);
    }

    function startRoundTimer(seconds){
      clearInterval(roundTimer);
      let remaining = seconds;
      timeLeftEl.textContent = remaining.toFixed(1);
      progressFill.style.width = '100%';
      const start = performance.now();
      roundTimer = setInterval(()=>{
        remaining -= 0.1;
        if(remaining<=0){ clearInterval(roundTimer); timeLeftEl.textContent = '0.0'; progressFill.style.width='0%'; onRoundFail('timeout'); return; }
        timeLeftEl.textContent = remaining.toFixed(1);
        const perc = Math.max(0,(remaining/seconds)*100);
        progressFill.style.width = perc + '%';
      },100);
      // store start time in a closure for reaction time calc
      roundStartTime = start;
    }

    function onPlayerClick(e){
      if(!accepting) return;
      const idx = Number(e.target.dataset.index);
      totalInputs++;
      const correct = idx === sequence[playerIndex];
      flash(idx,140);
      const reaction = performance.now();
      // approximate reaction per input
      if(playerIndex===0){ reactionTimes.push( (reaction - roundStartTime) ); }
      else{ reactionTimes.push( (reaction - roundStartTime) / (playerIndex+1) ); }

      if(correct){
        playerIndex++;
        correctCount++;
        if(playerIndex>=sequence.length){
          // round success
          accepting = false; clearInterval(roundTimer);
          const avgReaction = reactionTimes.length ? reactionTimes.reduce((a,b)=>a+b,0)/reactionTimes.length : 0;
          onRoundSuccess(avgReaction);
        }
      } else {
        onRoundFail('wrong');
      }
      updateHUD();
    }

    function onRoundSuccess(avgReaction){
      streak++;
      // scoring formula (tunable): base points + speed bonus + streak multiplier + accuracy
      const base = level * 50;
      const speedBonus = Math.max(0, Math.round((1000 - avgReaction) / 10));
      const streakMult = 1 + Math.min(2, streak * 0.06);
      const roundPoints = Math.round((base + speedBonus) * streakMult);
      brainScore += roundPoints;
      bscoreEl.textContent = brainScore;
      sequence.length < 999 && setTimeout(()=> newRound(), 900);
    }

    function onRoundFail(reason){
      accepting = false;
      clearInterval(roundTimer);
      streak = 0;
      lives -= 1;
      if(reason==='timeout') playTone(80, 300);
      else playTone(120, 200);
      if(lives<=0){
        setTimeout(()=> gameOver(), 500);
      } else {
        // repeat same sequence unless strict mode
        if(strictMode){ sequence = []; brainScore = Math.max(0, brainScore - 20); }
        reactionTimes = [];
        setTimeout(()=> showSequence(0), 800);
      }
      updateHUD();
    }

    function updateHUD(){
      streakEl.textContent = streak;
      livesEl.textContent = lives;
      roundsEl.textContent = rounds;
      accEl.textContent = totalInputs? Math.round((correctCount/totalInputs)*100) + '%' : '100%';
      progressFill.style.width = '100%';
      topScoreEl.textContent = getTopScore();
    }

    function gameOver(){
      accepting = false; clearInterval(roundTimer);
      // final brain score adjustments: accuracy & rounds multiplier
      const accuracy = totalInputs ? (correctCount / totalInputs) : 1;
      const finalScore = Math.round(brainScore * (0.7 + accuracy*0.6) + rounds*10 + Math.max(0, 150 - (reactionTimes.reduce((a,b)=>a+b,0)/(reactionTimes.length||1))));
      storeScore(finalScore);
      showModal('Game Over', `Your Brain Score: ${finalScore}\nRounds: ${rounds}\nAccuracy: ${Math.round(accuracy*100)}%`);
      resetGameState(false);
    }

    // --- Leaderboard using localStorage ---
    function getScores(){
      try{ return JSON.parse(localStorage.getItem('brainpulse_scores')||'[]'); }catch(e){return []}
    }
    function storeScore(score){
      const list = getScores();
      list.push({score, date: new Date().toISOString()});
      list.sort((a,b)=>b.score-a.score);
      localStorage.setItem('brainpulse_scores', JSON.stringify(list.slice(0,12)));
      renderScores();
    }
    function resetScores(){ localStorage.removeItem('brainpulse_scores'); renderScores(); }
    function getTopScore(){ const s = getScores()[0]; return s? s.score : 0; }

    function renderScores(){
      const list = getScores();
      scoresEl.innerHTML = '';
      if(list.length===0){ scoresEl.innerHTML = '<div class="muted">No scores yet — be the first!</div>'; return; }
      list.forEach((it,idx)=>{
        const row = document.createElement('div'); row.className='score-row';
        row.innerHTML = `<div>#${idx+1} — ${new Date(it.date).toLocaleString()}</div><div style="font-weight:800;color:var(--accent)">${it.score}</div>`;
        scoresEl.appendChild(row);
      });
    }

    // --- UI helpers ---
    function showModal(title, text){
      const o = document.createElement('div'); o.className='overlay';
      o.innerHTML = `<div class="modal"><div style="font-weight:800;font-size:18px">${title}</div><pre style="white-space:pre-wrap;margin-top:8px">${text}</pre><div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end"><button id="closeModal" class="primary">Close</button></div></div>`;
      document.body.appendChild(o);
      document.getElementById('closeModal').addEventListener('click', ()=>{ document.body.removeChild(o); });
    }

    // --- Controls ---
    function resetGameState(full=true){
      sequence = [];
      playerIndex = 0;
      accepting = false;
      level = 1; levelEl.textContent = level;
      lives = 3; livesEl.textContent = lives;
      streak = 0; streakEl.textContent = streak;
      rounds = 0; roundsEl.textContent = rounds;
      correctCount = 0; totalInputs = 0;
      brainScore = 0; bscoreEl.textContent = brainScore;
      reactionTimes = [];
      if(full){ renderScores(); }
    }

    startBtn.addEventListener('click', ()=>{
      // unlock audio context on mobile
      if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
      size = Number(gridSizeSel.value);
      createGrid(size);
      resetGameState(false);
      setTimeout(()=> newRound(), 400);
    });

    hintBtn.addEventListener('click', ()=>{
      if(lives<=1){ showModal('No hints', 'You need at least 1 life to use a hint.'); return; }
      lives -= 1; livesEl.textContent = lives; accepting=false; clearInterval(roundTimer);
      // show the sequence slowly
      showSequence(0);
    });

    strictBtn.addEventListener('click', ()=>{ strictMode = !strictMode; strictBtn.textContent = strictMode ? 'Strict: ON' : 'Toggle Strict Mode'; });

    document.getElementById('resetScores').addEventListener('click', ()=>{ if(confirm('Reset leaderboard?')) resetScores(); });

    // preload grid and leaderboard
    createGrid(size);
    renderScores();
    updateHUD();

    // small accessibility: allow number keys to click cells for small grids
    window.addEventListener('keydown', (e)=>{
      if(!buttons.length) return;
      const k = Number(e.key);
      if(Number.isInteger(k) && k>=1 && k<=buttons.length){ buttons[k-1].click(); }
    });

    // init animation
    (function pulseDemo(){
      // small demo ping to show it's alive
      const i = randInt(buttons.length||1);
      buttons[i] && buttons[i].classList.add('on');
      setTimeout(()=> buttons[i] && buttons[i].classList.remove('on'), 700);
      setTimeout(pulseDemo, 1800);
    })();

  </script>
</body>
</html>
