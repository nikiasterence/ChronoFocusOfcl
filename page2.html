<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyVERSE - Your Cosmic Study Companion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <style>
        :root {
            /* Theme will be dynamically set by JS */
            --primary-glow: #8A2BE2;
            --secondary-glow: #5D3FD3;
            --tertiary-glow: #9370DB;
            --background: #121212;
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --card-bg: rgba(30, 30, 46, 0.7);
            --accent: #BB86FC;
            
            /* Dock size variables, default to medium */
            --dock-icon-size: 60px;
            --dock-padding: 12px;
            --app-padding: 30px;
        }

        /* Mobile-first approach */
        @media (max-width: 768px) {
            :root {
                --mobile-scale: 0.85;
                --dock-icon-size: 50px;
                --dock-padding: 8px;
                --app-padding: 20px;
            }
        }

        @media (max-width: 480px) {
            :root {
                --mobile-scale: 0.75;
                --dock-icon-size: 45px;
                --dock-padding: 6px;
                --app-padding: 15px;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        /* Enhanced Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--accent), var(--primary-glow));
            border-radius: 12px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--primary-glow), var(--secondary-glow));
        }

        body {
            min-height: 100vh;
            background-color: var(--background);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            color: var(--text-primary);
            flex-direction: column;
            gap: 20px;
            padding-bottom: 150px;
            transition: background-color 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow-x: hidden;
        }

        /* Enhanced Aurora Background */
        .aurora-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -2; overflow: hidden;
        }

        .aurora-item {
            position: absolute; border-radius: 50%;
            filter: blur(120px); opacity: 0;
            transition: all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .aurora-item:nth-child(1) {
            width: 600px; height: 600px;
            background: radial-gradient(circle, var(--primary-glow), transparent 70%);
            top: 10%; left: 10%;
            animation: aurora-glow-1 20s infinite alternate ease-in-out;
        }

        .aurora-item:nth-child(2) {
            width: 500px; height: 500px;
            background: radial-gradient(circle, var(--secondary-glow), transparent 70%);
            bottom: 5%; right: 5%;
            animation: aurora-glow-2 25s infinite alternate ease-in-out;
        }

        .aurora-item:nth-child(3) {
            width: 400px; height: 400px;
            background: radial-gradient(circle, var(--tertiary-glow), transparent 70%);
            top: 50%; left: 50%;
            animation: aurora-glow-3 18s infinite alternate ease-in-out;
        }

        .aurora-item:nth-child(4) {
            width: 350px; height: 350px;
            background: radial-gradient(circle, var(--primary-glow), transparent 70%);
            top: 25%; right: 20%;
            animation: aurora-glow-2 22s infinite alternate-reverse ease-in-out;
        }

        @keyframes aurora-glow-1 {
            0% { transform: scale(1) translate(0, 0) rotate(0deg); opacity: 0.2; }
            50% { transform: scale(1.3) translate(20px, -20px) rotate(45deg); opacity: 0.4; }
            100% { transform: scale(1.6) translate(40px, -40px) rotate(90deg); opacity: 0.3; }
        }
        @keyframes aurora-glow-2 {
            0% { transform: scale(1) translate(0, 0) rotate(0deg); opacity: 0.3; }
            50% { transform: scale(1.2) translate(-15px, 25px) rotate(-45deg); opacity: 0.5; }
            100% { transform: scale(1.4) translate(-30px, 50px) rotate(-90deg); opacity: 0.4; }
        }
        @keyframes aurora-glow-3 {
            0% { transform: scale(1) translate(-50%, -50%) rotate(0deg); opacity: 0.25; }
            50% { transform: scale(1.25) translate(-45%, -55%) rotate(90deg); opacity: 0.45; }
            100% { transform: scale(1.5) translate(-40%, -60%) rotate(180deg); opacity: 0.35; }
        }

        /* Enhanced App Container with Liquid Glass Effect */
        .app {
            width: min(95%, 600px); 
            background: var(--card-bg);
            backdrop-filter: blur(25px) saturate(1.8);
            -webkit-backdrop-filter: blur(25px) saturate(1.8);
            border-radius: 28px; 
            padding: var(--app-padding); 
            box-shadow: 
                0 15px 60px var(--shadow-color),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 -1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border); 
            text-align: center;
            position: relative; 
            z-index: 1;
            transform: scale(var(--mobile-scale));
        }

        .app::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 28px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 50%,
                rgba(255, 255, 255, 0.02) 100%);
            pointer-events: none;
            z-index: -1;
        }

        h1 {
            font-size: clamp(2rem, 4vw, 2.8rem); 
            margin-bottom: 25px; 
            display: flex;
            justify-content: center; 
            align-items: center; 
            gap: 15px;
            font-weight: 700;
            text-shadow: 0 3px 15px rgba(0, 0, 0, 0.3);
            color: var(--accent);
            animation: glow-pulse 3s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            from { text-shadow: 0 3px 15px rgba(0, 0, 0, 0.3), 0 0 30px var(--accent); }
            to { text-shadow: 0 3px 15px rgba(0, 0, 0, 0.3), 0 0 50px var(--accent); }
        }

        .tip-container {
            min-height: 150px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; margin: 20px 0; padding: 20px;
            background: rgba(0,0,0,0.25); 
            backdrop-filter: blur(15px);
            border-radius: 24px;
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.3),
                0 8px 32px rgba(0, 0, 0, 0.2); 
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid var(--glass-border); 
            position: relative;
        }

        .tip-container:hover {
            transform: translateY(-5px);
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.2),
                0 15px 45px rgba(0, 0, 0, 0.3);
        }

        #tip { 
            font-size: clamp(1rem, 2.5vw, 1.1rem); 
            line-height: 1.6; 
            text-shadow: 0 2px 8px var(--shadow-color); 
            font-weight: 400; 
        }

        .copy-tip-btn {
            position: absolute; top: 12px; right: 12px;
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
            border: none; color: var(--text-primary);
            padding: 10px 12px; border-radius: 12px; 
            cursor: pointer; opacity: 0.6; 
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .tip-container:hover .copy-tip-btn { 
            opacity: 1; 
            transform: scale(1.1);
            background: rgba(255,255,255,0.2);
        }

        .copy-feedback {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: linear-gradient(135deg, var(--accent), var(--primary-glow));
            color: var(--background);
            padding: 12px 20px;
            border-radius: 12px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            pointer-events: none;
            font-weight: 600;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* Enhanced Caffeine Counter */
        .caffeine-counter {
            margin-top: 20px; padding: 18px; 
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: 20px; 
            display: flex; justify-content: space-between;
            align-items: center; 
            box-shadow: 
                inset 0 0 15px rgba(0, 0, 0, 0.2),
                0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--glass-border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .caffeine-counter:hover {
            transform: translateY(-2px);
            box-shadow: 
                inset 0 0 15px rgba(0, 0, 0, 0.15),
                0 12px 35px rgba(0, 0, 0, 0.2);
        }

        .caffeine-display { 
            font-size: clamp(0.9rem, 2vw, 1rem); 
            font-weight: 500; 
        }
        
        .caffeine-warning { 
            color: #ff6b6b; 
            font-size: clamp(0.75rem, 1.8vw, 0.8rem); 
            margin-top: 5px; 
            display: none; 
            font-weight: bold; 
            animation: warning-pulse 1s infinite;
        }

        @keyframes warning-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .reset-btn {
            padding: 10px 16px; 
            font-size: clamp(0.75rem, 1.8vw, 0.8rem); 
            border-radius: 14px;
            background: var(--glass-bg); 
            backdrop-filter: blur(10px);
            color: var(--text-secondary);
            border: 1px solid var(--glass-border); 
            cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .reset-btn:hover { 
            background: rgba(255,255,255,0.15); 
            color: var(--text-primary);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        /* Calendar Styles */
        .calendar-container {
            margin-top: 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 18px;
            border: 1px solid var(--glass-border);
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .calendar-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-header h3 {
            font-size: clamp(1.1rem, 2.5vw, 1.3rem);
            color: var(--accent);
        }

        .calendar-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            padding: 8px;
            border-radius: 12px;
        }

        .calendar-toggle:hover {
            color: var(--accent);
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1) rotate(180deg);
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .calendar-day {
            height: clamp(32px, 6vw, 40px);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: clamp(0.8rem, 2vw, 0.95rem);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }

        .calendar-day.header {
            font-weight: 600;
            color: var(--accent);
            cursor: default;
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.normal {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
        }

        .calendar-day.today {
            background: linear-gradient(135deg, var(--accent), var(--primary-glow));
            color: var(--background);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .calendar-day.has-tip:hover {
            background: linear-gradient(135deg, rgba(187, 134, 252, 0.3), rgba(138, 43, 226, 0.3));
            transform: scale(1.1);
        }

        .day-tip {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            font-size: clamp(0.9rem, 2vw, 0.95rem);
            display: none;
            border: 1px solid var(--glass-border);
        }

        /* DOCK SIZE STYLES */
        .dock.size-small { 
            --dock-icon-size: 48px; 
            --dock-padding: 8px;
            gap: 4px;
        }
        .dock.size-medium { 
            --dock-icon-size: 60px;
            --dock-padding: 12px;
            gap: 6px;
        }
        .dock.size-large { 
            --dock-icon-size: 72px;
            --dock-padding: 16px;
            gap: 8px;
        }
        
        /* ENHANCED DOCK STYLES */
        .dock {
            position: fixed; 
            display: flex;
            align-items: center; 
            padding: var(--dock-padding); 
            background: rgba(18, 18, 30, 0.85);
            backdrop-filter: blur(30px) saturate(1.8); 
            -webkit-backdrop-filter: blur(30px) saturate(1.8);
            box-shadow: 
                0 12px 50px var(--shadow-color),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border); 
            z-index: 100;
            transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1);
            transform-origin: center;
        }

        /* Enhanced Dock Positions */
        .dock.dock-bottom {
            bottom: 20px; 
            left: 50%; 
            border-radius: 28px;
            flex-direction: row; 
            transform: translateX(-50%);
        }

        .dock.dock-left {
            left: 15px; 
            top: 50%; 
            border-radius: 28px;
            flex-direction: column;
            transform: translateY(-50%);
        }

        .dock.dock-right {
            right: 15px; 
            top: 50%; 
            border-radius: 28px;
            flex-direction: column;
            transform: translateY(-50%);
        }

        /* Super Fluid Dock Icons */
        .dock-icon {
            width: var(--dock-icon-size);
            height: var(--dock-icon-size);
            border-radius: 18px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            /* Let JS handle transitions for smoothness */
            /* transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); */
            position: relative;
            color: white; 
            font-size: calc(var(--dock-icon-size) * 0.45);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.4),
                inset 0 1px 2px rgba(255,255,255,0.2),
                inset 0 -1px 2px rgba(0, 0, 0, 0.3);
            text-decoration: none; 
            flex-shrink: 0;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Liquid Shine Effect */
        .dock-icon::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: conic-gradient(from 0deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            transition: opacity 0.8s ease;
            opacity: 0;
        }

        .dock-icon:hover::before {
            animation: liquid-shine 2s infinite linear;
            opacity: 1;
        }

        @keyframes liquid-shine {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Magnetic Hover Effect - Will be controlled by JS for smoothness */
        .dock-icon:hover { 
            /* transform is now handled by JS */
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.6),
                inset 0 2px 4px rgba(255,255,255,0.3),
                0 0 30px var(--accent);
            z-index: 10;
        }

        .dock.dock-left .dock-icon:hover { 
            /* transform is now handled by JS */
        }
        
        .dock.dock-right .dock-icon:hover { 
            /* transform is now handled by JS */
        }

        /* Ripple Effect on Click */
        .dock-icon::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: translate(-50%, -50%);
            transition: width 0.4s ease-out, height 0.4s ease-out, opacity 0.5s ease-out;
            pointer-events: none;
            opacity: 1;
        }

        .dock-icon:active::after {
            width: 200%; 
            height: 200%;
            opacity: 0;
        }

        /* Enhanced Icon Labels */
        .dock-icon-label {
            position: absolute; 
            font-size: clamp(0.7rem, 1.8vw, 0.8rem);
            color: var(--text-primary); 
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            white-space: nowrap; 
            font-weight: 600;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            padding: 8px 12px;
            border-radius: 12px;
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            transform: translateY(10px); /* Initial state for smooth appearance */
        }

        .dock-icon:hover .dock-icon-label {
            opacity: 1;
            transform: translateY(0);
        }
        
        .dock.dock-bottom .dock-icon-label { 
            bottom: calc(100% + 15px);
            left: 50%;
            transform: translateX(-50%) translateY(10px);
        }
        .dock.dock-bottom .dock-icon:hover .dock-icon-label {
            transform: translateX(-50%) translateY(0);
        }
        
        .dock.dock-left .dock-icon-label { 
            left: calc(100% + 15px);
            top: 50%; 
            transform: translateY(-50%) translateX(-10px);
        }
        .dock.dock-left .dock-icon:hover .dock-icon-label {
            transform: translateY(-50%) translateX(0);
        }
        
        .dock.dock-right .dock-icon-label { 
            right: calc(100% + 15px); 
            top: 50%; 
            transform: translateY(-50%) translateX(10px);
        }
        .dock.dock-right .dock-icon:hover .dock-icon-label {
            transform: translateY(-50%) translateX(0);
        }


        /* Enhanced Dock Icon Gradients */
        .dock-tip { background: linear-gradient(135deg, #FF9A8B 0%, #FF6A88 50%, #FF99AC 100%); }
        .dock-study { background: linear-gradient(135deg, #FAD961 0%, #F76B1C 100%); }
        .dock-measure { background: linear-gradient(135deg, #42E695 0%, #3BB2B8 100%); }
        .dock-caffeine { background: linear-gradient(135deg, #A172FF 0%, #6B5CE7 100%); }
        .dock-researcho { background: linear-gradient(135deg, #4ECDC4 0%, #00CEC9 100%); }
        .dock-typing { background: linear-gradient(135deg, #5EE7DF 0%, #B490CA 100%); }
        .dock-puzzle { background: linear-gradient(135deg, #6A11CB 0%, #2575FC 100%); }
        .dock-draw { background: linear-gradient(135deg, #F5576C 0%, #F093FB 100%); }
        .dock-whiteboard { background: linear-gradient(135deg, #4FACFE 0%, #00F2FE 100%); }
        .dock-booknest { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .dock-moodly { background: linear-gradient(135deg, #F8B9D6 0%, #E87CC2 100%); }
        .dock-pomodoro { background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); }
        .dock-deep-focus { background: linear-gradient(135deg, #6577F6 0%, #855CF8 100%); }
        .dock-focus { background: linear-gradient(135deg, #8338EC 0%, #3A86FF 100%); }
        .dock-motivation { background: linear-gradient(135deg, #FB5607 0%, #FF006E 100%); }
        .dock-task { background: linear-gradient(135deg, #2196F3 0%, #673AB7 100%); }
        .dock-chono-copilot { background: linear-gradient(135deg, #4FACFE 0%, #21D4FD 100%); }
        .dock-code-cody { background: linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%); }
        .dock-ai-chat { background: linear-gradient(135deg, #00B4DB, #0083B0); }

        /* Enhanced Focus Submenu */
        .focus-submenu {
            position: absolute;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid var(--glass-border);
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 
                0 15px 50px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            z-index: 101;
        }

        .dock.dock-bottom .focus-submenu {
            bottom: 110%; 
            left: 50%;
            transform: translateX(-50%) translateY(10px) scale(0.9);
        }
        
        .dock.dock-bottom .dock-icon.dock-focus:hover .focus-submenu {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0) scale(1);
        }

        .dock.dock-left .focus-submenu {
            left: 110%;
            top: 50%;
            transform: translateY(-50%) translateX(-10px) scale(0.9);
        }
        
        .dock.dock-left .dock-icon.dock-focus:hover .focus-submenu {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(0) scale(1);
        }

        .dock.dock-right .focus-submenu {
            right: 110%;
            top: 50%;
            transform: translateY(-50%) translateX(10px) scale(0.9);
        }
        
        .dock.dock-right .dock-icon.dock-focus:hover .focus-submenu {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(0) scale(1);
        }

        .focus-submenu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 12px;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-size: clamp(0.85rem, 2vw, 0.9rem);
            backdrop-filter: blur(5px);
        }
        
        .focus-submenu-item:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            transform: translateX(5px);
        }
        
        .focus-submenu-item i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        /* SETTINGS AND THEME CONTROLS */
        .app-controls {
            position: absolute; 
            top: 15px; 
            right: 20px;
            z-index: 10; 
            display: flex; 
            gap: 12px;
        }
        
        .control-group { 
            position: relative; 
        }
        
        .control-icon { 
            font-size: clamp(1.1rem, 2.5vw, 1.3rem); 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
            text-shadow: 0 3px 10px rgba(0,0,0,0.4); 
            color: var(--accent);
            padding: 8px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .control-group:hover .control-icon:not(#theme-control-icon) { 
            transform: scale(1.2) rotate(25deg); 
            color: var(--secondary-glow); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .control-icon#theme-control-icon:hover {  
            transform: scale(1.2) rotate(25deg); 
            color: var(--secondary-glow); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .control-options {
            position: absolute; 
            top: 120%; 
            right: 0;
            background: var(--card-bg); 
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px; 
            padding: 12px;
            display: flex; 
            gap: 8px; 
            opacity: 0;
            visibility: hidden; 
            transform: translateY(15px) scale(0.9);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
            min-width: max-content; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            z-index: 10;
        }

        .control-group:hover .control-options { 
            opacity: 1; 
            visibility: visible; 
            transform: translateY(0) scale(1); 
        }

        .pos-btn, .size-btn { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
            border: 1px solid transparent;
            color: var(--text-primary); 
            padding: 8px 12px; 
            border-radius: 10px;
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            font-size: clamp(0.75rem, 1.8vw, 0.85rem);
            font-weight: 500;
        }
        
        .pos-btn:hover, .size-btn:hover { 
            background: rgba(255,255,255,0.2); 
            transform: scale(1.05);
        }
        
        .pos-btn.active, .size-btn.active { 
            background: linear-gradient(135deg, var(--accent), var(--primary-glow)); 
            border-color: rgba(255,255,255,0.5);
            color: var(--background);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* ===== ENHANCED THEME MODAL STYLES ===== */
        .theme-modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .theme-modal-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .theme-modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            padding: 35px;
            border-radius: 28px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 
                0 25px 80px rgba(0,0,0,0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            transform: scale(var(--mobile-scale));
        }

        .theme-modal-content h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--accent);
            font-size: clamp(1.6rem, 4vw, 2.2rem);
            text-shadow: 0 3px 15px rgba(0, 0, 0, 0.3);
        }

        .theme-modal-close-btn {
            position: absolute;
            top: 18px; right: 18px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: none;
            color: var(--text-primary);
            width: 40px; height: 40px;
            border-radius: 50%;
            font-size: 1.6rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }
        
        .theme-modal-close-btn:hover {
            background: var(--accent);
            color: var(--background);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(clamp(70px, 15vw, 90px), 1fr));
            gap: 18px;
            overflow-y: auto;
            padding: 15px;
            max-height: 60vh;
        }

        .theme-dot {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 16px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
            background-color: transparent;
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .theme-dot:hover {
            transform: scale(1.1) rotate(5deg);
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
        }
        
        .theme-dot .theme-color-swatch {
            flex: 1;
            height: 100%;
            transition: all 0.3s ease;
        }

        .theme-dot-label {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            font-size: clamp(0.6rem, 1.5vw, 0.7rem);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 4px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        /* ===== ENHANCED CHAT AI STYLES ===== */
        .chat-window {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: clamp(300px, 80vw, 380px);
            height: clamp(400px, 60vh, 550px);
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 20px 60px var(--shadow-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
            transform: translateY(30px) scale(0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .chat-window.open {
            transform: translateY(0) scale(1);
            opacity: 1;
            visibility: visible;
        }

        .chat-header {
            padding: 20px;
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
            color: var(--accent);
            text-align: center;
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 85%;
            line-height: 1.5;
            font-size: clamp(0.9rem, 2vw, 1rem);
            backdrop-filter: blur(10px);
            animation: message-appear 0.4s ease-out;
        }

        @keyframes message-appear {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            background: linear-gradient(135deg, var(--accent), var(--primary-glow));
            color: var(--background);
            align-self: flex-end;
            border-bottom-right-radius: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .chat-message.ai {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            color: var(--text-secondary);
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid var(--glass-border);
        }

        .chat-input-area {
            display: flex;
            padding: 18px;
            border-top: 1px solid var(--glass-border);
            gap: 12px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.03);
        }

        #chat-input {
            flex-grow: 1;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 0 18px;
            color: var(--text-primary);
            font-size: clamp(0.9rem, 2vw, 1rem);
            height: 45px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        #chat-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(187, 134, 252, 0.4);
            background: rgba(0,0,0,0.6);
        }

        #chat-send-btn {
            background: linear-gradient(135deg, var(--accent), var(--primary-glow));
            border: none;
            color: var(--background);
            width: 45px;
            height: 45px;
            border-radius: 14px;
            font-size: clamp(1.1rem, 2.5vw, 1.3rem);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        #chat-send-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        /* ENHANCED RESPONSIVE STYLES */
        @media (max-width: 768px) {
            body {
                padding: 15px;
                padding-bottom: 120px;
            }
            
            .dock.dock-bottom {
                width: 95%;
                overflow-x: auto;
                justify-content: flex-start;
                padding: 10px;
                -webkit-overflow-scrolling: touch;
            }
            
            .dock.dock-bottom::-webkit-scrollbar {
                display: none;
            }
            
            .dock.dock-left, .dock.dock-right {
                max-height: 80vh;
                overflow-y: auto;
                padding: 15px 8px;
            }

            .dock.dock-left::-webkit-scrollbar, .dock.dock-right::-webkit-scrollbar {
                 display: none;
            }
            
            .calendar-day {
                height: clamp(28px, 8vw, 35px);
                font-size: clamp(0.75rem, 2vw, 0.85rem);
            }
            
            .theme-grid {
                grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
                gap: 15px;
            }
            
            .theme-modal-content h2 {
                font-size: clamp(1.4rem, 5vw, 1.8rem);
            }
            
            .chat-window {
                width: 95vw;
                height: 65vh;
                bottom: 15px;
                right: 2.5vw;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
                padding-bottom: 100px;
            }
            
            .caffeine-counter {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 15px;
            }
            
            .calendar {
                gap: 4px;
            }
            
            .calendar-day {
                height: clamp(26px, 8vw, 32px);
                font-size: clamp(0.7rem, 2vw, 0.8rem);
            }
            
            .app-controls {
                top: 12px;
                right: 15px;
                gap: 8px;
            }
            
            .control-icon {
                font-size: 1.1rem;
                padding: 6px;
            }
            
            .theme-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                gap: 12px;
            }
        }

        /* Enhanced Loading Animation */
        .app {
            animation: app-entrance 1s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        @keyframes app-entrance {
            0% {
                opacity: 0;
                transform: scale(calc(var(--mobile-scale) * 0.95)) translateY(40px);
            }
            100% {
                opacity: 1;
                transform: scale(var(--mobile-scale)) translateY(0);
            }
        }

        /* Dock entrance animation */
        .dock {
            animation: dock-entrance 0.8s cubic-bezier(0.25, 1, 0.5, 1) 0.3s both;
        }

        @keyframes dock-entrance {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        .dock.dock-bottom {
             animation-name: dock-entrance-bottom;
        }
         @keyframes dock-entrance-bottom {
            0% { opacity: 0; transform: translateX(-50%) translateY(50px); }
            100% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .dock.dock-left {
            animation-name: dock-entrance-left;
        }
        @keyframes dock-entrance-left {
            0% { opacity: 0; transform: translateY(-50%) translateX(-50px); }
            100% { opacity: 1; transform: translateY(-50%) translateX(0); }
        }

        .dock.dock-right {
            animation-name: dock-entrance-right;
        }
        @keyframes dock-entrance-right {
            0% { opacity: 0; transform: translateY(-50%) translateX(50px); }
            100% { opacity: 1; transform: translateY(-50%) translateX(0); }
        }
    </style>
</head>
<body>
    <div class="aurora-container">
        <div class="aurora-item"></div><div class="aurora-item"></div>
        <div class="aurora-item"></div><div class="aurora-item"></div>
    </div>

    <div class="dock dock-bottom size-medium">
        <div class="dock-icon dock-tip" onclick="newTip()" aria-label="New Tip"><i class="fas fa-lightbulb"></i><div class="dock-icon-label">New Tip</div></div>
        <a href="page12.html" class="dock-icon dock-motivation" aria-label="Motivation"><i class="fas fa-fist-raised"></i><div class="dock-icon-label">Motivation</div></a>
        <a href="page16.html" class="dock-icon dock-task" aria-label="Tasks"><i class="fas fa-tasks"></i><div class="dock-icon-label">Tasks</div></a>
        <div class="dock-icon dock-focus" onclick="window.location.href='page9.html'" aria-label="Focus Modes">
            <i class="fas fa-bullseye"></i>
            <div class="dock-icon-label">Focus</div>
            <div class="focus-submenu">
                <a href="page13.html" class="focus-submenu-item"><i class="fas fa-hourglass-start"></i> Pomodoro</a>
                <a href="page9.html" class="focus-submenu-item"><i class="fas fa-brain"></i> Deep Focus</a>
            </div>
        </div>
        <div class="dock-icon dock-study" onclick="openStudyWithMe()" aria-label="Study With Me"><i class="fab fa-youtube"></i><div class="dock-icon-label">Study With Me</div></div>
        <a href="page10.html" class="dock-icon dock-measure" aria-label="Measure"><i class="fas fa-ruler-combined"></i><div class="dock-icon-label">Measure</div></a>
        <div class="dock-icon dock-caffeine" onclick="addCaffeine(this)" aria-label="Add Caffeine"><i class="fas fa-coffee"></i><div class="dock-icon-label">Add Caffeine</div></div>
        <div id="chat-ai-dock-icon" class="dock-icon dock-ai-chat" aria-label="Study AI"><i class="fas fa-robot"></i><div class="dock-icon-label">Study AI</div></div>
        <a href="page5.html" class="dock-icon dock-researcho" aria-label="Researcho"><i class="fas fa-magnifying-glass-chart"></i><div class="dock-icon-label">Researcho</div></a>
        <a href="page6.html" class="dock-icon dock-typing" aria-label="Typing Test"><i class="fas fa-keyboard"></i><div class="dock-icon-label">Typing Test</div></a>
        <a href="page7.html" class="dock-icon dock-puzzle" aria-label="Puzzles"><i class="fas fa-puzzle-piece"></i><div class="dock-icon-label">Puzzles</div></a>
        <a href="page4.html" class="dock-icon dock-draw" aria-label="Formula Station"><i class="fas fa-pen"></i><div class="dock-icon-label">Formula Station</div></a>
        <a href="page8.html" class="dock-icon dock-whiteboard" aria-label="White Board"><i class="fas fa-chalkboard"></i><div class="dock-icon-label">White Board</div></a>
        <a href="page13.html" class="dock-icon dock-booknest" aria-label="BookNest"><i class="fas fa-book-open-reader"></i><div class="dock-icon-label">BookNest</div></a>
        <a href="page11.html" class="dock-icon dock-moodly" aria-label="Moodly"><i class="fas fa-smile-beam"></i><div class="dock-icon-label">Moodly</div></a>
        <a href="page17.html" class="dock-icon dock-code-cody" aria-label="Code Cody"><i class="fas fa-code"></i><div class="dock-icon-label">Code Cody</div></a>
    </div>

    <div class="app">
        <div class="app-controls">
             <div class="control-group">
                <i class="fas fa-ruler-horizontal control-icon"></i>
                <div class="control-options">
                    <button class="size-btn" data-size="small">S</button>
                    <button class="size-btn active" data-size="medium">M</button>
                    <button class="size-btn" data-size="large">L</button>
                </div>
            </div>
             <div class="control-group">
                <i class="fas fa-cog control-icon"></i>
                <div class="control-options">
                    <button class="pos-btn" data-pos="left">Left</button>
                    <button class="pos-btn active" data-pos="bottom">Bottom</button>
                    <button class="pos-btn" data-pos="right">Right</button>
                </div>
            </div>
            <div class="control-group">
                <i class="fas fa-palette control-icon" id="theme-control-icon"></i>
            </div>
        </div>

        <h1><i class="fas fa-brain"></i> StudyVERSE</h1>
        <div class="tip-container">
            <div class="copy-feedback" id="copy-feedback">Copied!</div>
            <button class="copy-tip-btn" onclick="copyTip()"><i class="fas fa-copy"></i></button>
            <p id="tip">Welcome! Click the lightbulb for a study tip.</p>
        </div>
        <div class="caffeine-counter">
            <div>
                <span class="caffeine-display">Caffeine: <span id="caffeine-count">0</span> mg</span>
                <div class="caffeine-warning" id="caffeine-warning">Max recommended: 400mg</div>
            </div>
            <button class="reset-btn" onclick="resetCaffeine()"><i class="fas fa-redo"></i> Reset</button>
        </div>

        <div class="calendar-container">
            <div class="calendar-header">
                <h3>Study Calendar</h3>
                <button class="calendar-toggle" onclick="toggleCalendar()">
                    <i class="fas fa-chevron-up" id="calendar-toggle-icon"></i>
                </button>
            </div>
            <div id="calendar-content">
                <div class="calendar" id="calendar">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
                <div class="day-tip" id="day-tip"></div>
            </div>
        </div>
    </div>

    <!-- ===== ENHANCED THEME MODAL ===== -->
    <div class="theme-modal-overlay" id="theme-modal-overlay">
        <div class="theme-modal-content">
            <button class="theme-modal-close-btn" id="theme-modal-close-btn">&times;</button>
            <h2>Choose a Theme</h2>
            <div class="theme-grid" id="theme-grid-container">
                <!-- Theme boxes will be dynamically generated here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- ===== ENHANCED CHAT AI INTERFACE ===== -->
    <div class="chat-window" id="chat-window">
        <div class="chat-header">StudyVERSE AI</div>
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be injected by JavaScript -->
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Ask me something...">
            <button id="chat-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // --- DOM ELEMENT SELECTORS ---
        const tipElement = document.getElementById("tip");
        const caffeineCountEl = document.getElementById("caffeine-count");
        const caffeineWarningEl = document.getElementById("caffeine-warning");
        const dockElement = document.querySelector(".dock");
        const posButtons = document.querySelectorAll('.pos-btn');
        const sizeButtons = document.querySelectorAll('.size-btn');
        const calendarElement = document.getElementById("calendar");
        const dayTipElement = document.getElementById("day-tip");
        const calendarToggleIcon = document.getElementById("calendar-toggle-icon");
        const copyFeedbackEl = document.getElementById('copy-feedback');
        
        // THEME MODAL SELECTORS
        const themeControlIcon = document.getElementById('theme-control-icon');
        const themeModalOverlay = document.getElementById('theme-modal-overlay');
        const themeModalCloseBtn = document.getElementById('theme-modal-close-btn');
        const themeGridContainer = document.getElementById('theme-grid-container');
        
        // CHAT AI SELECTORS
        const chatAiDockIcon = document.getElementById('chat-ai-dock-icon');
        const chatWindow = document.getElementById('chat-window');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');

        // --- APP STATE ---
        let caffeineIntake = 0;
        let calendarVisible = true;
        
        const tips = [ 
            "Break your study time into 25-minute intervals with the Pomodoro Technique.", "Use active recall by testing yourself, not just rereading notes.", "Explain what you've learned to someone else to solidify your understanding.", "Create a dedicated, distraction-free study zone.", "Use flashcards for key terms and concepts.", "Review material consistently, a little bit each day.", "Prioritize sleep; it's crucial for memory consolidation.", "Stay hydrated and eat nutritious brain food.", "Use mind maps to visualize connections between ideas.", "Take short, regular breaks to avoid burnout.", "Teach concepts to an imaginary audience to identify knowledge gaps.", "Use the Feynman Technique: simplify complex topics as if explaining to a child.", "Change study locations occasionally to improve memory retention.", "Practice spaced repetition for long-term memorization.", "Start with the most challenging material when your mind is freshest.", "Use mnemonic devices to remember complex information.", "Set specific, achievable goals for each study session.", "Connect new information to what you already know.", "Take notes by hand to improve information processing.", "Use background music without lyrics to enhance focus.", "Schedule regular review sessions instead of cramming.", "Break large projects into smaller, manageable tasks.", "Use the 80/20 rule: focus on the 20% that gives 80% of results.", "Test yourself frequently to monitor your progress.", "Reward yourself after completing study milestones.", "Use different colored pens for different types of information.", "Create a study schedule and stick to it consistently.", "Find a study partner for accountability and discussion.", "Avoid multitaskingfocus on one subject at a time.", "Use online resources and educational videos for difficult concepts.", "Practice problems actively instead of passively reading solutions."
        ];
        
        // --- THEME DEFINITIONS ---
        const themes = { 
            "cosmic-dark": { "--primary-glow": "#8A2BE2", "--secondary-glow": "#5D3FD3", "--tertiary-glow": "#9370DB", "--background": "#121212", "--text-primary": "#FFFFFF", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(30, 30, 46, 0.7)", "--accent": "#BB86FC" }, 
            "midnight-blue": { "--primary-glow": "#0f3460", "--secondary-glow": "#533483", "--tertiary-glow": "#1e90ff", "--background": "#1a1a2e", "--text-primary": "#e0e0e0", "--glass-bg": "rgba(0, 0, 0, 0.2)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(39, 39, 62, 0.7)", "--accent": "#4cc9f0" }, 
            "forest-deep": { "--primary-glow": "#0f3b2d", "--secondary-glow": "#1b5e45", "--tertiary-glow": "#2e8b56", "--background": "#0f3b2d", "--text-primary": "#e0f2e9", "--glass-bg": "rgba(0, 0, 0, 0.2)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(40, 80, 60, 0.7)", "--accent": "#42e695" }, 
            "synthwave": { "--primary-glow": "#f20089", "--secondary-glow": "#00f5d4", "--tertiary-glow": "#e500a4", "--background": "#2d00f7", "--text-primary": "#ffffff", "--glass-bg": "rgba(0, 0, 0, 0.2)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(80, 0, 200, 0.7)", "--accent": "#ff00ff" },
            "cozy-mocha": { "--primary-glow": "#c89f7f", "--secondary-glow": "#7c6a59", "--tertiary-glow": "#a5886e", "--background": "#4a3f35", "--text-primary": "#f5f5dc", "--glass-bg": "rgba(245, 245, 220, 0.1)", "--glass-border": "rgba(245, 245, 220, 0.2)", "--card-bg": "rgba(87, 72, 60, 0.7)", "--accent": "#e0cda9" },
            "sunset-peach": { "--primary-glow": "#ffc0cb", "--secondary-glow": "#ffa07a", "--tertiary-glow": "#ffdab9", "--background": "#ffeadb", "--text-primary": "#5c4033", "--glass-bg": "rgba(92, 64, 51, 0.08)", "--glass-border": "rgba(92, 64, 51, 0.15)", "--card-bg": "rgba(255, 237, 224, 0.7)", "--accent": "#ff6b6b" },
            "lavender-dream": { "--primary-glow": "#dda0dd", "--secondary-glow": "#d8bfd8", "--tertiary-glow": "#cbc3e3", "--background": "#e6e6fa", "--text-primary": "#483d8b", "--glass-bg": "rgba(72, 61, 139, 0.08)", "--glass-border": "rgba(72, 61, 139, 0.15)", "--card-bg": "rgba(238, 221, 255, 0.7)", "--accent": "#9370db" },
            "oceanic-abyss": { "--primary-glow": "#1f4287", "--secondary-glow": "#071e3d", "--tertiary-glow": "#278ea5", "--background": "#1d2b53", "--text-primary": "#f0f8ff", "--glass-bg": "rgba(31, 66, 135, 0.1)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(10, 25, 47, 0.7)", "--accent": "#21e6c1" },
            "crimson-study": { "--primary-glow": "#dc2626", "--secondary-glow": "#b91c1c", "--tertiary-glow": "#f87171", "--background": "#7f1d1d", "--text-primary": "#fecaca", "--glass-bg": "rgba(254, 202, 202, 0.08)", "--glass-border": "rgba(254, 202, 202, 0.2)", "--card-bg": "rgba(153, 27, 27, 0.7)", "--accent": "#ef4444" },
            "solarized-light": { "--primary-glow": "#eee8d5", "--secondary-glow": "#b58900", "--tertiary-glow": "#268bd2", "--background": "#fdf6e3", "--text-primary": "#657b83", "--glass-bg": "rgba(101, 123, 131, 0.08)", "--glass-border": "rgba(101, 123, 131, 0.15)", "--card-bg": "rgba(238, 232, 213, 0.7)", "--accent": "#d33682" },
            "liquid-gold": { "--primary-glow": "#FFD700", "--secondary-glow": "#FFA500", "--tertiary-glow": "#B8860B", "--background": "#000000", "--text-primary": "#FFFFFF", "--glass-bg": "rgba(255, 215, 0, 0.1)", "--glass-border": "rgba(255, 215, 0, 0.2)", "--card-bg": "rgba(20, 15, 0, 0.7)", "--accent": "#FFD700" },
            "starfall": { "--primary-glow": "#a2a8d3", "--secondary-glow": "#e7eaf6", "--tertiary-glow": "#38598b", "--background": "#0a043c", "--text-primary": "#ffffff", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(25, 20, 70, 0.7)", "--accent": "#e7eaf6" },
            "cyberpunk-neon": { "--primary-glow": "#701ebd", "--secondary-glow": "#f0f", "--tertiary-glow": "#0ff", "--background": "#1f1d36", "--text-primary": "#e9f5f9", "--glass-bg": "rgba(0, 255, 255, 0.1)", "--glass-border": "rgba(0, 255, 255, 0.2)", "--card-bg": "rgba(50, 48, 80, 0.7)", "--accent": "#00f0b5" },
            "enchanted-forest": { "--primary-glow": "#006400", "--secondary-glow": "#228b22", "--tertiary-glow": "#556b2f", "--background": "#102a24", "--text-primary": "#c4d8c6", "--glass-bg": "rgba(200, 220, 200, 0.1)", "--glass-border": "rgba(200, 220, 200, 0.2)", "--card-bg": "rgba(20, 50, 40, 0.7)", "--accent": "#98ff98" },
            "sakura-dream": { "--primary-glow": "#ffb7c5", "--secondary-glow": "#ffc0cb", "--tertiary-glow": "#ff69b4", "--background": "#f9e6e6", "--text-primary": "#613a3a", "--glass-bg": "rgba(97, 58, 58, 0.08)", "--glass-border": "rgba(97, 58, 58, 0.15)", "--card-bg": "rgba(255, 240, 240, 0.7)", "--accent": "#ff69b4" },
            "volcanic-ash": { "--primary-glow": "#ff4500", "--secondary-glow": "#ff8c00", "--tertiary-glow": "#ff6347", "--background": "#1e1e1e", "--text-primary": "#dcdcdc", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(40, 40, 40, 0.7)", "--accent": "#ff4500" },
            "arctic-dawn": { "--primary-glow": "#add8e6", "--secondary-glow": "#b0e0e6", "--tertiary-glow": "#87ceeb", "--background": "#f0f8ff", "--text-primary": "#003366", "--glass-bg": "rgba(0, 51, 102, 0.08)", "--glass-border": "rgba(0, 51, 102, 0.15)", "--card-bg": "rgba(225, 240, 255, 0.7)", "--accent": "#87cefa" },
            "nebula-haze": { "--primary-glow": "#da70d6", "--secondary-glow": "#ba55d3", "--tertiary-glow": "#9932cc", "--background": "#4c2a4c", "--text-primary": "#f5e6f5", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(90, 60, 90, 0.7)", "--accent": "#dda0dd" },
            "charcoal-slate": { "--primary-glow": "#708090", "--secondary-glow": "#778899", "--tertiary-glow": "#2f4f4f", "--background": "#36454f", "--text-primary": "#d3d3d3", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(60, 70, 80, 0.7)", "--accent": "#a9a9a9" },
            "nautical-depth": { "--primary-glow": "#008080", "--secondary-glow": "#20b2aa", "--tertiary-glow": "#5f9ea0", "--background": "#003153", "--text-primary": "#e0ffff", "--glass-bg": "rgba(224, 255, 255, 0.1)", "--glass-border": "rgba(224, 255, 255, 0.2)", "--card-bg": "rgba(0, 60, 90, 0.7)", "--accent": "#48d1cc" },
            "arcane-library": { "--primary-glow": "#483d8b", "--secondary-glow": "#8a2be2", "--tertiary-glow": "#9932cc", "--background": "#2e1a47", "--text-primary": "#e6e6fa", "--glass-bg": "rgba(230, 230, 250, 0.08)", "--glass-border": "rgba(230, 230, 250, 0.15)", "--card-bg": "rgba(50, 30, 70, 0.7)", "--accent": "#c792ea" },
            "rose-quartz": { "--primary-glow": "#e070a0", "--secondary-glow": "#f08080", "--tertiary-glow": "#db7093", "--background": "#3c1321", "--text-primary": "#f8dde9", "--glass-bg": "rgba(255, 255, 255, 0.1)", "--glass-border": "rgba(255, 255, 255, 0.2)", "--card-bg": "rgba(80, 30, 50, 0.7)", "--accent": "#ff9eb8" },
            "creamy-vanilla": { "--primary-glow": "#f3e5ab", "--secondary-glow": "#edeaaf", "--tertiary-glow": "#fafad2", "--background": "#fffdd0", "--text-primary": "#7a5c58", "--glass-bg": "rgba(122, 92, 88, 0.08)", "--glass-border": "rgba(122, 92, 88, 0.15)", "--card-bg": "rgba(255, 250, 230, 0.7)", "--accent": "#d4af37" },
            "olive-noir": { "--primary-glow": "#6b8e23", "--secondary-glow": "#556b2f", "--tertiary-glow": "#808000", "--background": "#232b2b", "--text-primary": "#e9f5e3", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(45, 55, 45, 0.7)", "--accent": "#bada55" },
            "emerald-path": { "--primary-glow": "#00a95c", "--secondary-glow": "#009b77", "--tertiary-glow": "#3cb371", "--background": "#013220", "--text-primary": "#d9eee1", "--glass-bg": "rgba(217, 238, 225, 0.1)", "--glass-border": "rgba(217, 238, 225, 0.2)", "--card-bg": "rgba(5, 60, 40, 0.7)", "--accent": "#50c878" },
            "graphite-gray": { "--primary-glow": "#8c92ac", "--secondary-glow": "#8d99ae", "--tertiary-glow": "#b3b3b3", "--background": "#353839", "--text-primary": "#edf2f4", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(60, 65, 70, 0.7)", "--accent": "#d8d8d8" },
            "bumblebee": { "--primary-glow": "#f4c430", "--secondary-glow": "#ffdb58", "--tertiary-glow": "#ffc300", "--background": "#202020", "--text-primary": "#ffffff", "--glass-bg": "rgba(255, 225, 0, 0.1)", "--glass-border": "rgba(255, 225, 0, 0.2)", "--card-bg": "rgba(40, 40, 40, 0.7)", "--accent": "#ffd700" },
            "cobalt-blue": { "--primary-glow": "#0047ab", "--secondary-glow": "#002366", "--tertiary-glow": "#1e90ff", "--background": "#00204a", "--text-primary": "#cce5ff", "--glass-bg": "rgba(204, 229, 255, 0.1)", "--glass-border": "rgba(204, 229, 255, 0.2)", "--card-bg": "rgba(0, 40, 80, 0.7)", "--accent": "#6699ff" },
            "mahogany": { "--primary-glow": "#c04000", "--secondary-glow": "#8b4513", "--tertiary-glow": "#a0522d", "--background": "#4a0404", "--text-primary": "#f8e8e8", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(80, 20, 20, 0.7)", "--accent": "#e97451" },
            "minimalist-beige": { "--primary-glow": "#e3dac9", "--secondary-glow": "#dcd0c0", "--tertiary-glow": "#c1b5a9", "--background": "#f5f5dc", "--text-primary": "#5d564c", "--glass-bg": "rgba(93, 86, 76, 0.08)", "--glass-border": "rgba(93, 86, 76, 0.15)", "--card-bg": "rgba(240, 240, 220, 0.7)", "--accent": "#8a795d" },
            "oceanic-calm": { "--primary-glow": "#2c7a7b", "--secondary-glow": "#1f6f8b", "--tertiary-glow": "#89c9b8", "--background": "#d4f1f4", "--text-primary": "#1f6f8b", "--glass-bg": "rgba(31, 111, 139, 0.08)", "--glass-border": "rgba(31, 111, 139, 0.15)", "--card-bg": "rgba(220, 245, 245, 0.7)", "--accent": "#17a2b8" },
            "retro-groove": { "--primary-glow": "#f9a826", "--secondary-glow": "#e67e22", "--tertiary-glow": "#d35400", "--background": "#3d2c22", "--text-primary": "#f5deb3", "--glass-bg": "rgba(245, 222, 179, 0.08)", "--glass-border": "rgba(245, 222, 179, 0.15)", "--card-bg": "rgba(78, 56, 42, 0.7)", "--accent": "#f9a826" },
            "minty-fresh": { "--primary-glow": "#99f3bd", "--secondary-glow": "#7de8a8", "--tertiary-glow": "#5ce092", "--background": "#f0fff8", "--text-primary": "#005c3d", "--glass-bg": "rgba(0, 92, 61, 0.05)", "--glass-border": "rgba(0, 92, 61, 0.1)", "--card-bg": "rgba(230, 255, 245, 0.7)", "--accent": "#3ddc84" },
            "gothic-elegance": { "--primary-glow": "#c0392b", "--secondary-glow": "#8e44ad", "--tertiary-glow": "#2c3e50", "--background": "#121013", "--text-primary": "#ecf0f1", "--glass-bg": "rgba(236, 240, 241, 0.08)", "--glass-border": "rgba(236, 240, 241, 0.15)", "--card-bg": "rgba(25, 22, 28, 0.7)", "--accent": "#9b59b6" },
            "sunny-day": { "--primary-glow": "#f1c40f", "--secondary-glow": "#f39c12", "--tertiary-glow": "#3498db", "--background": "#eaf6ff", "--text-primary": "#2c3e50", "--glass-bg": "rgba(44, 62, 80, 0.08)", "--glass-border": "rgba(44, 62, 80, 0.15)", "--card-bg": "rgba(240, 248, 255, 0.7)", "--accent": "#3498db" },
            "autumn-leaves": { "--primary-glow": "#d35400", "--secondary-glow": "#c0392b", "--tertiary-glow": "#f39c12", "--background": "#4e342e", "--text-primary": "#ffccbc", "--glass-bg": "rgba(255, 204, 188, 0.08)", "--glass-border": "rgba(255, 204, 188, 0.15)", "--card-bg": "rgba(94, 65, 55, 0.7)", "--accent": "#e67e22" },
            "strawberry-cream": { "--primary-glow": "#ff8fab", "--secondary-glow": "#fb6f92", "--tertiary-glow": "#ffc2d1", "--background": "#fff0f3", "--text-primary": "#c9184a", "--glass-bg": "rgba(201, 24, 74, 0.08)", "--glass-border": "rgba(201, 24, 74, 0.15)", "--card-bg": "rgba(255, 230, 235, 0.7)", "--accent": "#ff6392" },
            "hacker-matrix": { "--primary-glow": "#00ff00", "--secondary-glow": "#00dd00", "--tertiary-glow": "#00aa00", "--background": "#000000", "--text-primary": "#00ff00", "--glass-bg": "rgba(0, 255, 0, 0.08)", "--glass-border": "rgba(0, 255, 0, 0.15)", "--card-bg": "rgba(5, 20, 5, 0.7)", "--accent": "#00ff00" },
            "sandstone-canyon": { "--primary-glow": "#e9a26e", "--secondary-glow": "#d88a53", "--tertiary-glow": "#c77238", "--background": "#fdf4e3", "--text-primary": "#6d4c41", "--glass-bg": "rgba(109, 76, 65, 0.08)", "--glass-border": "rgba(109, 76, 65, 0.15)", "--card-bg": "rgba(250, 235, 215, 0.7)", "--accent": "#bf6936" },
            "wild-berries": { "--primary-glow": "#7209b7", "--secondary-glow": "#560bad", "--tertiary-glow": "#f72585", "--background": "#1e0c38", "--text-primary": "#f1e3ff", "--glass-bg": "rgba(241, 227, 255, 0.08)", "--glass-border": "rgba(241, 227, 255, 0.15)", "--card-bg": "rgba(48, 25, 72, 0.7)", "--accent": "#b5179e" }
        };

        // --- CORE FUNCTIONS ---
        
        /**
         * Plays a sound from a given URL.
         * @param {string} url - The URL of the sound file.
         */
        function playSound(url) { 
            try {
                new Audio(url).play(); 
            } catch (e) {
                console.error("Audio playback error:", e);
            }
        }
        
        /**
         * Fetches and displays a new random study tip.
         */
        function newTip() {
            playSound('https://www.soundjay.com/buttons/sounds/button-16.mp3');
            tipElement.style.opacity = 0;
            setTimeout(() => {
                const randomIndex = Math.floor(Math.random() * tips.length);
                const newTip = tips[randomIndex];
                tipElement.textContent = newTip;
                localStorage.setItem('currentTip', newTip);
                tipElement.style.opacity = 1;
            }, 300);
        }
        
        /**
         * Copies the current tip to the clipboard and shows feedback.
         */
        function copyTip() { 
            navigator.clipboard.writeText(tipElement.textContent).then(() => { 
                playSound('https://www.soundjay.com/buttons/sounds/button-7.mp3');
                copyFeedbackEl.style.opacity = 1;
                copyFeedbackEl.style.transform = 'translate(-50%, -50%) scale(1)';
                setTimeout(() => {
                    copyFeedbackEl.style.opacity = 0;
                    copyFeedbackEl.style.transform = 'translate(-50%, -50%) scale(0.8)';
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
        
        /**
         * Opens the "Study With Me" page in a new tab.
         */
        function openStudyWithMe() { 
            window.open('page3.html', '_blank'); 
        }

        /**
         * Adds a random amount of caffeine and updates the display.
         * @param {HTMLElement} element - The button element that was clicked.
         */
        function addCaffeine(element) {
            caffeineIntake += Math.floor(Math.random() * 81) + 40; // Add 40-120mg
            localStorage.setItem('caffeineIntake', caffeineIntake);
            updateCaffeineDisplay();

            const currentTransform = element.style.transform;
            element.style.transform = `${currentTransform} scale(1.1)`;
            setTimeout(() => { 
                element.style.transform = currentTransform.replace(/ scale\(.+\)/, '') || 'scale(1)';
            }, 200);
        }
        
        /**
         * Resets the caffeine intake to zero.
         */
        function resetCaffeine() {
            caffeineIntake = 0;
            localStorage.setItem('caffeineIntake', caffeineIntake);
            updateCaffeineDisplay();
        }

        /**
         * Updates the caffeine counter and warning message on the UI.
         */
        function updateCaffeineDisplay() {
            caffeineCountEl.textContent = caffeineIntake;
            caffeineWarningEl.style.display = 'none';
            if (caffeineIntake >= 400) { 
                caffeineWarningEl.style.display = "block"; 
                caffeineWarningEl.textContent = " Daily max exceeded!"; 
            } else if (caffeineIntake >= 300) { 
                caffeineWarningEl.style.display = "block"; 
                caffeineWarningEl.textContent = "Max recommended: 400mg"; 
            }
        }
        
        /**
         * Applies a selected theme to the entire page.
         * @param {string} themeName - The key of the theme in the `themes` object.
         */
        function setTheme(themeName) {
            const selectedTheme = themes[themeName]; 
            if (!selectedTheme) return false;
            
            for (const [key, value] of Object.entries(selectedTheme)) { 
                document.documentElement.style.setProperty(key, value); 
            }
            localStorage.setItem('studyVerseTheme', themeName);
            return true;
        }

        /**
         * Dynamically creates the theme selector boxes inside the theme modal.
         */
        function populateThemeSelector() {
            themeGridContainer.innerHTML = ''; // Clear existing options
            for (const themeName in themes) {
                const themeColors = themes[themeName];
                const displayName = themeName.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                const dot = document.createElement('button'); // Use button for accessibility
                dot.classList.add('theme-dot');
                dot.title = displayName;
                dot.dataset.theme = themeName;
                
                // Create the color swatches inside the box
                dot.innerHTML = `
                    <span class="theme-color-swatch" style="background-color: ${themeColors['--primary-glow']}"></span>
                    <span class="theme-color-swatch" style="background-color: ${themeColors['--accent']}"></span>
                    <span class="theme-color-swatch" style="background-color: ${themeColors['--background']}"></span>
                    <div class="theme-dot-label">${displayName}</div>
                `;

                dot.addEventListener('click', () => {
                    setTheme(themeName);
                    closeThemeModal(); // Close modal after selection
                });
                themeGridContainer.appendChild(dot);
            }
        }
        
        // --- THEME MODAL FUNCTIONS ---
        function openThemeModal() {
            themeModalOverlay.classList.add('visible');
        }

        function closeThemeModal() {
            themeModalOverlay.classList.remove('visible');
        }

        /**
         * Sets the position of the dock.
         * @param {string} position - 'left', 'bottom', or 'right'.
         */
        function setDockPosition(position) {
            const validPositions = ['left', 'bottom', 'right'];
            if (!validPositions.includes(position)) position = 'bottom'; 

            dockElement.classList.remove('dock-left', 'dock-bottom', 'dock-right');
            dockElement.classList.add(`dock-${position}`);

            posButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.pos === position));
            localStorage.setItem('studyVerseDockPosition', position);
        }

        /**
         * Sets the size of the dock icons.
         * @param {string} size - 'small', 'medium', or 'large'.
         */
        function setDockSize(size) {
            const validSizes = ['small', 'medium', 'large'];
            if (!validSizes.includes(size)) size = 'medium'; 

            dockElement.classList.remove('size-small', 'size-medium', 'size-large');
            dockElement.classList.add(`size-${size}`);

            sizeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.size === size));
            localStorage.setItem('studyVerseDockSize', size);
        }
        
        /**
         * Generates and displays the calendar for the current month.
         */
        function generateCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let calendarHTML = '';
            dayNames.forEach(day => { calendarHTML += `<div class="calendar-day header">${day}</div>`; });
            for (let i = 0; i < firstDay; i++) { calendarHTML += `<div class="calendar-day empty"></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = now.getDate() === day;
                const hasTip = Math.random() > 0.7; 
                calendarHTML += `<div class="calendar-day ${isToday ? 'today' : 'normal'} ${hasTip ? 'has-tip' : ''}" data-day="${day}">${day}</div>`;
            }
            calendarElement.innerHTML = calendarHTML;
            document.querySelectorAll('.calendar-day.has-tip').forEach(day => {
                day.addEventListener('click', () => {
                    const dayNum = day.getAttribute('data-day');
                    showDayTip(dayNum);
                });
            });
        }
        
        /**
         * Shows a random tip associated with a specific day.
         * @param {string|number} day - The day number clicked.
         */
        function showDayTip(day) {
            const randomTipIndex = Math.floor(Math.random() * tips.length);
            dayTipElement.textContent = `Tip for day ${day}: ${tips[randomTipIndex]}`;
            dayTipElement.style.display = 'block';
        }
        
        /**
         * Toggles the visibility of the calendar content.
         */
        function toggleCalendar() {
            const calendarContent = document.getElementById('calendar-content');
            calendarVisible = !calendarVisible;
            if (calendarVisible) {
                calendarContent.style.display = 'block';
                calendarToggleIcon.className = 'fas fa-chevron-up';
            } else {
                calendarContent.style.display = 'none';
                calendarToggleIcon.className = 'fas fa-chevron-down';
            }
        }
        
        // --- ENHANCED CHAT AI LOGIC ---
        
        const pageNavigationMap = {
            'motivation': 'page12.html',
            'tasks': 'page16.html',
            'task': 'page16.html',
            'pomodoro': 'page13.html',
            'deep focus': 'page9.html',
            'measure': 'page10.html',
            'researcho': 'page5.html',
            'research': 'page5.html',
            'typing test': 'page6.html',
            'typing': 'page6.html',
            'puzzle': 'page7.html',
            'puzzles': 'page7.html',
            'formulas': 'page4.html',
            'formula station': 'page4.html',
            'whiteboard': 'page8.html',
            'white board': 'page8.html',
            'booknest': 'page13.html',
            'books': 'page13.html',
            'mood': 'page11.html',
            'moodly': 'page11.html',
            'code cody': 'page17.html',
            'code': 'page17.html',
            'coding': 'page17.html'
        };

        function setupChatAI() {
            chatAiDockIcon.addEventListener('click', () => chatWindow.classList.toggle('open'));
            chatSendBtn.addEventListener('click', handleUserMessage);
            chatInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleUserMessage();
            });

            // Add an initial welcome message
            if(chatMessagesContainer.children.length === 0) {
               appendAiMessage("Hello! I'm the StudyVERSE assistant. How can I help you? You can ask me to change the theme or take you to a page.");
            }
        }

        function handleUserMessage() {
            const messageText = chatInput.value.trim();
            if (messageText === "") return;
            
            appendUserMessage(messageText);
            chatInput.value = "";

            setTimeout(() => {
                processAiCommand(messageText.toLowerCase());
            }, 500 + Math.random() * 400); // Simulate thinking
        }

        function appendUserMessage(text) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', 'user');
            messageEl.textContent = text;
            chatMessagesContainer.appendChild(messageEl);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function appendAiMessage(text) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', 'ai');
            messageEl.textContent = text;
            chatMessagesContainer.appendChild(messageEl);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function processAiCommand(command) {
            // Command: Change Theme
            const themeMatch = command.match(/(change|set) theme to (.+)/);
            if (themeMatch) {
                const requestedTheme = themeMatch[2].trim().replace(/\s+/g, '-');
                const themeDisplayName = requestedTheme.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                if (setTheme(requestedTheme)) {
                    appendAiMessage(`Of course! I've changed the theme to ${themeDisplayName}.`);
                } else {
                    appendAiMessage(`I'm sorry, I couldn't find a theme called "${themeDisplayName}". Try opening the theme palette to see available options.`);
                }
                return;
            }

            // Command: Navigation
            const navMatch = command.match(/(go to|take me to|open) (the )?(.+)/);
            if (navMatch) {
                const pageQuery = navMatch[3].trim().replace(/ page$/, ''); // "the puzzles page" -> "puzzles"
                if (pageNavigationMap[pageQuery]) {
                    const pageName = pageQuery.charAt(0).toUpperCase() + pageQuery.slice(1);
                    appendAiMessage(`Certainly, heading to the ${pageName} page now!`);
                    window.location.href = pageNavigationMap[pageQuery];
                } else {
                    appendAiMessage(`Sorry, I don't know where the "${pageQuery}" page is. Available pages include: tasks, puzzles, researcho, code cody, and more.`);
                }
                return;
            }
            
            // Basic conversation
            if (command.includes('hello') || command.includes('hi')) {
                appendAiMessage("Hi there! What can I assist you with today?");
                return;
            }

            if (command.includes('how are you')) {
                appendAiMessage("I'm just a set of instructions, but I'm operating perfectly! Ready to help you study.");
                return;
            }

            // Default fallback
            appendAiMessage("I'm not sure how to respond to that. You can ask me to 'change theme to...' or 'go to tasks'.");
        }
        
        /**
         * Loads the user's saved state from localStorage.
         */
        function loadState() {
            const savedCaffeine = localStorage.getItem('caffeineIntake');
            if (savedCaffeine !== null) { caffeineIntake = parseInt(savedCaffeine, 10) || 0; updateCaffeineDisplay(); }
            
            const savedTip = localStorage.getItem('currentTip');
            if (savedTip) { tipElement.textContent = savedTip; }

            populateThemeSelector(); // Generate themes inside the modal
            
            const savedTheme = localStorage.getItem('studyVerseTheme');
            setTheme(savedTheme && themes[savedTheme] ? savedTheme : 'cosmic-dark');
            
            const savedDockPos = localStorage.getItem('studyVerseDockPosition');
            setDockPosition(savedDockPos || 'bottom');
            
            const savedDockSize = localStorage.getItem('studyVerseDockSize');
            setDockSize(savedDockSize || 'medium');
            
            generateCalendar();
            setupChatAI(); // Initialize the enhanced Chat AI
        }

        /**
         * Initializes the smooth, Mac-style dock animation.
         */
        function initializeMacDockEffect() {
            const dock = document.querySelector('.dock');
            if (!dock) return;

            const icons = Array.from(dock.querySelectorAll('.dock-icon'));
            const maxScale = 1.8; // How big the icon gets when mouse is directly over it
            const influenceRadius = dock.offsetWidth / 3; // The "magnetic" radius of the mouse

            let animationFrameId = null;

            dock.addEventListener('mousemove', e => {
                // Cancel any pending animation frame to avoid multiple updates
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }

                // Request a new animation frame for the update
                animationFrameId = requestAnimationFrame(() => {
                    const isVertical = dock.classList.contains('dock-left') || dock.classList.contains('dock-right');
                    const mousePos = isVertical ? e.clientY : e.clientX;

                    icons.forEach(icon => {
                        const rect = icon.getBoundingClientRect();
                        const iconCenter = isVertical ? rect.top + rect.height / 2 : rect.left + rect.width / 2;
                        
                        const distance = Math.abs(mousePos - iconCenter);
                        
                        let scale = 1;
                        // Only apply effect if within the influence radius
                        if (distance < influenceRadius) {
                            // Use a cosine-based curve for a smoother falloff effect
                            scale = 1 + (maxScale - 1) * (1 - Math.sin((distance / influenceRadius) * (Math.PI/2)));
                        }

                        // Apply a fast transition for responsive tracking
                        icon.style.transition = 'transform 0.1s cubic-bezier(0.25, 0.8, 0.25, 1)'; 

                        if (isVertical) {
                            const moveDirection = dock.classList.contains('dock-left') ? 1 : -1;
                            const translation = (scale - 1) * icon.offsetWidth * 0.5 * moveDirection;
                            icon.style.transform = `translateX(${translation}px) scale(${scale})`;
                        } else {
                            const translation = (scale - 1) * icon.offsetHeight * 0.5;
                            icon.style.transform = `translateY(-${translation}px) scale(${scale})`;
                        }
                    });
                });
            });

            dock.addEventListener('mouseleave', () => {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                icons.forEach(icon => {
                    // Apply a smoother, slower transition when the mouse leaves the dock
                    icon.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)';
                    icon.style.transform = 'translate(0, 0) scale(1)';
                });
            });
        }
        
        // --- INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", () => {
            // Setup Event Listeners for controls
            posButtons.forEach(btn => {
                btn.addEventListener('click', () => setDockPosition(btn.dataset.pos));
            });
            sizeButtons.forEach(btn => {
                btn.addEventListener('click', () => setDockSize(btn.dataset.size));
            });
            
            // Setup Theme Modal Listeners
            themeControlIcon.addEventListener('click', openThemeModal);
            themeModalCloseBtn.addEventListener('click', closeThemeModal);
            themeModalOverlay.addEventListener('click', (event) => {
                if (event.target === themeModalOverlay) closeThemeModal();
            });

            // Load saved state
            loadState();
            // Initialize the new and improved dock effect
            initializeMacDockEffect();
        });

    </script>
</body>
</html>
