<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyVERSE - Your Cosmic Study Companion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <style>
        :root {
            /* Theme will be dynamically set by JS */
            --primary-glow: #8A2BE2;
            --secondary-glow: #5D3FD3;
            --tertiary-glow: #9370DB;
            --background: #121212;
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --card-bg: rgba(30, 30, 46, 0.7);
            --accent: #BB86FC;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(187, 134, 252, 0.8);
        }

        body {
            min-height: 100vh;
            background-color: var(--background);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            color: var(--text-primary);
            flex-direction: column;
            gap: 20px;
            padding-bottom: 150px;
            transition: background-color 0.8s ease, color 0.8s ease;
            overflow-x: hidden;
        }

        .aurora-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -2; overflow: hidden;
        }

        .aurora-item {
            position: absolute; border-radius: 50%;
            filter: blur(120px); opacity: 0;
            transition: background-color 0.8s ease;
        }

        .aurora-item:nth-child(1) {
            width: 600px; height: 600px;
            background: var(--primary-glow); top: 10%; left: 10%;
            animation: aurora-glow-1 20s infinite alternate ease-in-out;
        }

        .aurora-item:nth-child(2) {
            width: 500px; height: 500px;
            background: var(--secondary-glow); bottom: 5%; right: 5%;
            animation: aurora-glow-2 25s infinite alternate ease-in-out;
        }

        .aurora-item:nth-child(3) {
            width: 400px; height: 400px;
            background: var(--tertiary-glow); top: 50%; left: 50%;
            animation: aurora-glow-3 18s infinite alternate ease-in-out;
        }

        .aurora-item:nth-child(4) {
            width: 350px; height: 350px;
            background: var(--primary-glow); top: 25%; right: 20%;
            animation: aurora-glow-2 22s infinite alternate-reverse ease-in-out;
        }

        @keyframes aurora-glow-1 {
            0% { transform: scale(1) translate(0, 0) rotate(0deg); opacity: 0.3; }
            100% { transform: scale(1.6) translate(40px, -40px) rotate(90deg); opacity: 0.5; }
        }
        @keyframes aurora-glow-2 {
            0% { transform: scale(1) translate(0, 0) rotate(0deg); opacity: 0.4; }
            100% { transform: scale(1.4) translate(-30px, 50px) rotate(-90deg); opacity: 0.6; }
        }
        @keyframes aurora-glow-3 {
            0% { transform: scale(1) translate(-50%, -50%) rotate(0deg); opacity: 0.35; }
            100% { transform: scale(1.5) translate(-40%, -60%) rotate(180deg); opacity: 0.55; }
        }

        .app {
            width: 95%; max-width: 600px; background: var(--card-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 24px; padding: 30px; box-shadow: 0 10px 40px var(--shadow-color);
            border: 1px solid var(--glass-border); text-align: center;
            position: relative; z-index: 1;
        }

        h1 {
            font-size: 2.8rem; margin-bottom: 25px; display: flex;
            justify-content: center; align-items: center; gap: 15px;
            font-weight: 700;
            text-shadow: 0 3px 15px rgba(0, 0, 0, 0.3);
            color: var(--accent);
        }

        .tip-container {
            min-height: 150px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; margin: 20px 0; padding: 20px;
            background: rgba(0,0,0,0.2); border-radius: 20px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3); transition: all 0.4s ease;
            border: 1px solid var(--glass-border); position: relative;
        }

        #tip { 
            font-size: 1.1rem; line-height: 1.6; 
            text-shadow: 0 2px 8px var(--shadow-color); 
            font-weight: 400; 
        }

        .copy-tip-btn {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255,255,255,0.1); border: none; color: var(--text-primary);
            padding: 8px 10px; border-radius: 8px; cursor: pointer; opacity: 0.5; transition: all 0.3s;
        }
        .tip-container:hover .copy-tip-btn { opacity: 1; }

        .copy-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--accent);
            color: var(--background);
            padding: 8px 16px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.4s ease;
            pointer-events: none;
            font-weight: 500;
        }

        .caffeine-counter {
            margin-top: 20px; padding: 15px; background: var(--glass-bg);
            border-radius: 16px; display: flex; justify-content: space-between;
            align-items: center; box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
        }
        .caffeine-display { font-size: 1rem; font-weight: 500; }
        .caffeine-warning { color: #ff6b6b; font-size: 0.8rem; margin-top: 5px; display: none; font-weight: bold; }
        .reset-btn {
            padding: 8px 15px; font-size: 0.8rem; border-radius: 12px;
            background: var(--glass-bg); color: var(--text-secondary);
            border: 1px solid var(--glass-border); cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: all 0.3s ease;
        }
        .reset-btn:hover { background: rgba(255,255,255,0.15); color: var(--text-primary); }

        /* Calendar Styles */
        .calendar-container {
            margin-top: 25px;
            background: var(--glass-bg);
            border-radius: 16px;
            padding: 15px;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .calendar-toggle:hover {
            color: var(--accent);
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day.header {
            font-weight: 600;
            color: var(--accent);
            cursor: default;
        }

        .calendar-day.empty {
            background: transparent;
            cursor: default;
        }

        .calendar-day.normal {
            background: rgba(255, 255, 255, 0.05);
        }

        .calendar-day.today {
            background: var(--accent);
            color: #121212;
            font-weight: 600;
        }

        .calendar-day.has-tip:hover {
            background: rgba(187, 134, 252, 0.3);
        }

        .day-tip {
            margin-top: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            font-size: 0.95rem;
            display: none;
        }

        /* DOCK STYLES */
        .dock {
            position: fixed; display: flex;
            align-items: center; padding: 12px; background: rgba(18, 18, 30, 0.8);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--glass-border); z-index: 100;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        /* Positions */
        .dock.dock-bottom {
            bottom: 20px; left: 50%; border-radius: 24px;
            flex-direction: row; align-items: flex-end;
            transform: translateX(-50%);
        }
        .dock.dock-left {
            left: 15px; top: 50%; border-radius: 24px;
            flex-direction: column;
            transform: translateY(-50%);
        }
        .dock.dock-right {
            right: 15px; top: 50%; border-radius: 24px;
            flex-direction: column;
            transform: translateY(-50%);
        }

        .dock-icon {
            border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s ease-in-out; position: relative;
            color: white; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255,255,255,0.1);
            text-decoration: none; flex-shrink: 0;
            overflow: hidden;
        }

        .dock-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .dock-icon:hover::before {
            left: 100%;
        }

        /* Dock Size classes */
        .dock.size-small .dock-icon { width: 48px; height: 48px; font-size: 1.1rem; }
        .dock.size-medium .dock-icon { width: 60px; height: 60px; font-size: 1.4rem; }
        .dock.size-large .dock-icon { width: 72px; height: 72px; font-size: 1.7rem; }

        .dock.dock-bottom .dock-icon { margin: 0 6px; }
        .dock.dock-left .dock-icon, .dock.dock-right .dock-icon { margin: 6px 0; }

        .dock-icon:hover { 
            transform: translateY(-10px) scale(1.15); 
            box-shadow: 0 8px 24px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.1); 
        }
        .dock.dock-left .dock-icon:hover { transform: translateX(10px) scale(1.15); }
        .dock.dock-right .dock-icon:hover { transform: translateX(-10px) scale(1.15); }

        .dock-icon-label {
            position: absolute; 
            font-size: 0.75rem;
            color: var(--text-primary); 
            text-shadow: 0 1px 5px rgba(0,0,0,0.7);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            white-space: nowrap; 
            font-weight: 500;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 8px;
            border-radius: 6px;
            pointer-events: none;
        }

        .dock-icon:hover .dock-icon-label {
            opacity: 1;
        }

        .dock.dock-bottom .dock-icon-label { bottom: -30px; }
        .dock.dock-left .dock-icon-label { left: 115%; top: 50%; transform: translateY(-50%); }
        .dock.dock-right .dock-icon-label { right: 115%; top: 50%; transform: translateY(-50%); }

        /* Dock Icon Gradients */
        .dock-tip { background: linear-gradient(135deg, #FF9A8B, #FF6A88, #FF99AC); }
        .dock-study { background: linear-gradient(135deg, #FAD961, #F76B1C); }
        .dock-measure { background: linear-gradient(135deg, #42E695, #3BB2B8); }
        .dock-caffeine { background: linear-gradient(135deg, #A172FF, #6B5CE7); }
        .dock-cozynotes { background: linear-gradient(135deg, #FFDB7D, #FFB347); }
        .dock-typing { background: linear-gradient(135deg, #5EE7DF, #B490CA); }
        .dock-puzzle { background: linear-gradient(135deg, #6A11CB, #2575FC); }
        .dock-draw { background: linear-gradient(135deg, #F5576C, #F093FB); }
        .dock-whiteboard { background: linear-gradient(135deg, #4FACFE, #00F2FE); }
        .dock-books { background: linear-gradient(135deg, #C471F5, #FA71CD); }
        .dock-moodly { background: linear-gradient(135deg, #F8B9D6, #E87CC2); }
        .dock-pomodoro { background: linear-gradient(135deg, #FF6B6B, #FF8E53); }
        .dock-deep-focus { background: linear-gradient(135deg, #6577F6, #855CF8); }
        .dock-focus { background: linear-gradient(135deg, #8338EC, #3A86FF); }
        .dock-motivation { background: linear-gradient(135deg, #FB5607, #FF006E); }
        .dock-task { background: linear-gradient(135deg, #2196F3, #673AB7); }
        .dock-chono-copilot { background: linear-gradient(135deg, #4FACFE, #21D4FD); } /* New/reused gradient */

        /* Focus Submenu Styles */
        .focus-submenu {
            position: absolute;
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 1px solid var(--glass-border);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 101;
        }

        .dock.dock-bottom .focus-submenu {
            bottom: 110%; 
            left: 50%;
            transform: translateX(-50%);
        }
        .dock.dock-bottom .dock-icon.dock-focus:hover .focus-submenu {
            opacity: 1;
            visibility: visible;
            bottom: 120%;
        }

        .dock.dock-left .focus-submenu {
            left: 110%;
            top: 50%;
            transform: translateY(-50%);
        }
        .dock.dock-left .dock-icon.dock-focus:hover .focus-submenu {
            opacity: 1;
            visibility: visible;
            left: 120%;
        }

        .dock.dock-right .focus-submenu {
            right: 110%;
            top: 50%;
            transform: translateY(-50%);
        }
        .dock.dock-right .dock-icon.dock-focus:hover .focus-submenu {
            opacity: 1;
            visibility: visible;
            right: 120%;
        }

        .focus-submenu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            color: var(--text-primary);
            text-decoration: none;
            transition: background 0.2s;
            font-size: 0.9rem;
        }
        .focus-submenu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .focus-submenu-item i {
            width: 18px;
            text-align: center;
        }

        /* SETTINGS AND THEME CONTROLS */
        .app-controls {
            position: absolute; top: 15px; right: 20px;
            z-index: 10; display: flex; gap: 10px;
        }
        .control-group { position: relative; }
        .control-icon { 
            font-size: 1.2rem; 
            cursor: pointer; 
            transition: transform 0.3s, color 0.3s; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            color: var(--accent);
        }
        /* Keep hover for gear and ruler icons, but not the palette */
        .control-group:hover .control-icon:not(#theme-control-icon) { transform: scale(1.1) rotate(15deg); color: var(--secondary-glow); }
        .control-icon#theme-control-icon:hover {  transform: scale(1.1) rotate(15deg); color: var(--secondary-glow); }

        .control-options {
            position: absolute; top: 120%; right: 0;
            background: var(--card-bg); 
            border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 10px;
            display: flex; gap: 8px; opacity: 0;
            visibility: hidden; transform: translateY(10px);
            transition: all 0.3s; backdrop-filter: blur(15px);
            min-width: max-content; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* ONLY show these on hover for non-theme groups */
        .control-group:hover .control-options { opacity: 1; visibility: visible; transform: translateY(0); }


        .pos-btn, .size-btn { 
            background: rgba(255,255,255,0.1); border: 1px solid transparent;
            color: var(--text-primary); padding: 5px 10px; border-radius: 8px;
            cursor: pointer; transition: all 0.3s; font-size: 0.8rem;
        }
        .pos-btn:hover, .size-btn:hover { background: rgba(255,255,255,0.2); }
        .pos-btn.active, .size-btn.active { 
            background: var(--accent); 
            border-color: rgba(255,255,255,0.5);
            color: #121212;
        }

        /* ===== NEW THEME MODAL STYLES ===== */
        .theme-modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none; /* Changed from flex to none */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .theme-modal-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .theme-modal-content {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
            position: relative;
        }

        .theme-modal-content h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--accent);
            font-size: 2rem;
        }

        .theme-modal-close-btn {
            position: absolute;
            top: 15px; right: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-primary);
            width: 35px; height: 35px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }
        .theme-modal-close-btn:hover {
            background: var(--accent);
            color: var(--background);
            transform: rotate(90deg);
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            overflow-y: auto;
            padding: 10px;
        }

        .theme-dot {
            width: 100%;
            aspect-ratio: 1 / 1; /* Make it a square */
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
            background-color: transparent;
            position: relative;
        }
        .theme-dot:hover {
            transform: scale(1.1);
            border-color: var(--accent);
        }
        .theme-dot .theme-color-swatch {
            flex: 1; /* Each color swatch takes equal space */
            height: 100%;
        }

        .theme-dot-label {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            font-size: 0.65rem;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 3px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ===== CHAT AI STYLES ===== */
        .chat-ai-toggle {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #8338EC, #3A86FF);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 1001;
        }

        .chat-ai-toggle:hover {
            transform: scale(1.1) rotate(15deg);
        }

        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 350px;
            height: 500px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 10px 40px var(--shadow-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .chat-window.open {
            transform: translateY(0) scale(1);
            opacity: 1;
            visibility: visible;
        }

        .chat-header {
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
            color: var(--accent);
            text-align: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .chat-message.user {
            background-color: var(--accent);
            color: var(--background);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-message.ai {
            background-color: var(--glass-bg);
            color: var(--text-secondary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--glass-border);
            gap: 10px;
            flex-shrink: 0;
        }

        #chat-input {
            flex-grow: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 0 15px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }

        #chat-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent);
        }

        #chat-send-btn {
            background-color: var(--accent);
            border: none;
            color: var(--background, #121212);
            width: 45px;
            height: 45px;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        #chat-send-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        /* ===== NEW CHONO COPILOT MODAL STYLES ===== */
        .chono-modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .chono-modal-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .chono-modal-content {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            padding: 25px;
            border-radius: 24px;
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
            position: relative;
        }

        .chono-modal-close-btn {
            position: absolute;
            top: 10px; right: 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-primary);
            width: 30px; height: 30px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }
        .chono-modal-close-btn:hover {
            background: var(--accent);
            color: var(--background);
            transform: rotate(90deg);
        }

        /* RESPONSIVE STYLES */
        @media (max-width: 768px) {
            .app {
                padding: 25px;
            }
            h1 {
                font-size: 2.2rem;
            }
            #tip {
                font-size: 1rem;
            }
            .dock.dock-bottom {
                width: 90%;
                overflow-x: auto;
                justify-content: flex-start;
                padding: 10px 15px;
            }
            .dock.dock-left, .dock.dock-right {
                max-height: 80vh;
                overflow-y: auto;
                padding: 15px 10px;
            }
            .calendar-day {
                height: 30px;
                font-size: 0.8rem;
            }
            .theme-grid {
                 grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            }
             .theme-modal-content h2 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
                padding-bottom: 120px;
            }
            .caffeine-counter {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .dock.size-small .dock-icon { width: 42px; height: 42px; font-size: 1rem; }
            .dock.size-medium .dock-icon { width: 52px; height: 52px; font-size: 1.2rem; }
            .dock.size-large .dock-icon { width: 62px; height: 62px; font-size: 1.4rem; }
            .calendar {
                gap: 3px;
            }
            .calendar-day {
                height: 28px;
                font-size: 0.75rem;
            }
            /* Make chat window smaller on mobile */
            .chat-window {
                width: 90%;
                height: 60vh;
                bottom: 90px;
                right: 5%;
                max-width: 350px;
            }
             .chat-ai-toggle {
                bottom: 20px;
                right: 20px;
             }
        }
    </style>
</head>
<body>
    <div class="aurora-container">
        <div class="aurora-item"></div><div class="aurora-item"></div>
        <div class="aurora-item"></div><div class="aurora-item"></div>
    </div>

    <div class="dock dock-bottom size-medium">
        <div class="dock-icon dock-tip" onclick="newTip()" aria-label="New Tip"><i class="fas fa-lightbulb"></i><div class="dock-icon-label">New Tip</div></div>
        <a href="page12.html" class="dock-icon dock-motivation" aria-label="Motivation"><i class="fas fa-fist-raised"></i><div class="dock-icon-label">Motivation</div></a>
        <a href="page16.html" class="dock-icon dock-task" aria-label="Tasks"><i class="fas fa-tasks"></i><div class="dock-icon-label">Tasks</div></a>
        <div class="dock-icon dock-focus" onclick="window.location.href='page9.html'" aria-label="Focus Modes">
            <i class="fas fa-bullseye"></i>
            <div class="dock-icon-label">Focus</div>
            <div class="focus-submenu">
                <a href="page13.html" class="focus-submenu-item"><i class="fas fa-hourglass-start"></i> Pomodoro</a>
                <a href="page9.html" class="focus-submenu-item"><i class="fas fa-brain"></i> Deep Focus</a>
            </div>
        </div>
        <div class="dock-icon dock-study" onclick="openStudyWithMe()" aria-label="Study With Me"><i class="fab fa-youtube"></i><div class="dock-icon-label">Study With Me</div></div>
        <a href="page10.html" class="dock-icon dock-measure" aria-label="Measure"><i class="fas fa-ruler-combined"></i><div class="dock-icon-label">Measure</div></a>
        <div class="dock-icon dock-caffeine" onclick="addCaffeine(this)" aria-label="Add Caffeine"><i class="fas fa-coffee"></i><div class="dock-icon-label">Add Caffeine</div></div>
        <a href="page5.html" class="dock-icon dock-cozynotes" aria-label="CozyNotes"><i class="fas fa-sticky-note"></i><div class="dock-icon-label">CozyNotes</div></a>
        <a href="page6.html" class="dock-icon dock-typing" aria-label="Typing Test"><i class="fas fa-keyboard"></i><div class="dock-icon-label">Typing Test</div></a>
        <a href="page7.html" class="dock-icon dock-puzzle" aria-label="Puzzles"><i class="fas fa-puzzle-piece"></i><div class="dock-icon-label">Puzzles</div></a>
        <a href="page4.html" class="dock-icon dock-draw" aria-label="Formula Station"><i class="fas fa-pen"></i><div class="dock-icon-label">Formula Station</div></a>
        <a href="page8.html" class="dock-icon dock-whiteboard" aria-label="White Board"><i class="fas fa-chalkboard"></i><div class="dock-icon-label">White Board</div></a>
        <a href="https://www.ebanglalibrary.com/" target="_blank" class="dock-icon dock-books" aria-label="Books"><i class="fas fa-book-open"></i><div class="dock-icon-label">Books</div></a>
        <a href="page11.html" class="dock-icon dock-moodly" aria-label="Moodly"><i class="fas fa-smile-beam"></i><div class="dock-icon-label">Moodly</div></a>
        <div id="chono-copilot-icon" class="dock-icon dock-chono-copilot" aria-label="Chono Copilot"><i class="fab fa-microsoft"></i><div class="dock-icon-label">Chono Copilot</div></div>
    </div>

    <div class="app">
        <div class="app-controls">
             <div class="control-group">
                <i class="fas fa-ruler-horizontal control-icon"></i>
                <div class="control-options">
                    <button class="size-btn" data-size="small">S</button>
                    <button class="size-btn active" data-size="medium">M</button>
                    <button class="size-btn" data-size="large">L</button>
                </div>
            </div>
             <div class="control-group">
                <i class="fas fa-cog control-icon"></i>
                <div class="control-options">
                    <button class="pos-btn" data-pos="left">Left</button>
                    <button class="pos-btn active" data-pos="bottom">Bottom</button>
                    <button class="pos-btn" data-pos="right">Right</button>
                </div>
            </div>
            <div class="control-group">
                 <!-- This icon now opens the modal -->
                <i class="fas fa-palette control-icon" id="theme-control-icon"></i>
                 <!-- This container is no longer used for themes -->
                <div class="control-options" id="old-theme-options-container"></div>
            </div>
        </div>

        <h1><i class="fas fa-brain"></i> StudyVERSE</h1>
        <div class="tip-container">
            <div class="copy-feedback" id="copy-feedback">Copied!</div>
            <button class="copy-tip-btn" onclick="copyTip()"><i class="fas fa-copy"></i></button>
            <p id="tip">Welcome! Click the lightbulb for a study tip.</p>
        </div>
        <div class="caffeine-counter">
            <div>
                <span class="caffeine-display">Caffeine: <span id="caffeine-count">0</span> mg</span>
                <div class="caffeine-warning" id="caffeine-warning">Max recommended: 400mg</div>
            </div>
            <button class="reset-btn" onclick="resetCaffeine()"><i class="fas fa-redo"></i> Reset</button>
        </div>

        <div class="calendar-container">
            <div class="calendar-header">
                <h3>Study Calendar</h3>
                <button class="calendar-toggle" onclick="toggleCalendar()">
                    <i class="fas fa-chevron-up" id="calendar-toggle-icon"></i>
                </button>
            </div>
            <div id="calendar-content">
                <div class="calendar" id="calendar">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
                <div class="day-tip" id="day-tip"></div>
            </div>
        </div>
    </div>

    <!-- ===== NEW THEME MODAL ===== -->
    <div class="theme-modal-overlay" id="theme-modal-overlay">
        <div class="theme-modal-content">
            <button class="theme-modal-close-btn" id="theme-modal-close-btn">&times;</button>
            <h2>Choose a Theme</h2>
            <div class="theme-grid" id="theme-grid-container">
                <!-- Theme boxes will be dynamically generated here by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- ===== NEW CHONO COPILOT MODAL ===== -->
    <div class="chono-modal-overlay" id="chono-modal-overlay">
        <div class="chono-modal-content">
            <button class="chono-modal-close-btn" id="chono-modal-close-btn">&times;</button>
            <script async src="https://cse.google.com/cse.js?cx=200aa883980bb455a"></script>
            <div class="gcse-searchbox-only"></div>
        </div>
    </div>

    <!-- ===== NEW CHAT AI INTERFACE ===== -->
    <div class="chat-ai-toggle" id="chat-ai-toggle"><i class="fas fa-comment-dots"></i></div>
    <div class="chat-window" id="chat-window">
        <div class="chat-header">StudyVERSE AI</div>
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be injected by JavaScript -->
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Ask me something...">
            <button id="chat-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // --- DOM ELEMENT SELECTORS ---
        const tipElement = document.getElementById("tip");
        const caffeineCountEl = document.getElementById("caffeine-count");
        const caffeineWarningEl = document.getElementById("caffeine-warning");
        const dockElement = document.querySelector(".dock");
        const posButtons = document.querySelectorAll('.pos-btn');
        const sizeButtons = document.querySelectorAll('.size-btn');
        const calendarElement = document.getElementById("calendar");
        const dayTipElement = document.getElementById("day-tip");
        const calendarToggleIcon = document.getElementById("calendar-toggle-icon");
        const copyFeedbackEl = document.getElementById('copy-feedback');
        
        // THEME MODAL SELECTORS
        const themeControlIcon = document.getElementById('theme-control-icon');
        const themeModalOverlay = document.getElementById('theme-modal-overlay');
        const themeModalCloseBtn = document.getElementById('theme-modal-close-btn');
        const themeGridContainer = document.getElementById('theme-grid-container');
        
        // CHAT AI SELECTORS
        const chatAiToggle = document.getElementById('chat-ai-toggle');
        const chatWindow = document.getElementById('chat-window');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        
        // CHONO COPILOT MODAL SELECTORS
        const chonoCopilotIcon = document.getElementById('chono-copilot-icon');
        const chonoModalOverlay = document.getElementById('chono-modal-overlay');
        const chonoModalCloseBtn = document.getElementById('chono-modal-close-btn');

        // --- APP STATE ---
        let caffeineIntake = 0;
        let calendarVisible = true;
        
        const tips = [ 
            "Break your study time into 25-minute intervals with the Pomodoro Technique.", "Use active recall by testing yourself, not just rereading notes.", "Explain what you've learned to someone else to solidify your understanding.", "Create a dedicated, distraction-free study zone.", "Use flashcards for key terms and concepts.", "Review material consistently, a little bit each day.", "Prioritize sleep; it's crucial for memory consolidation.", "Stay hydrated and eat nutritious brain food.", "Use mind maps to visualize connections between ideas.", "Take short, regular breaks to avoid burnout.", "Teach concepts to an imaginary audience to identify knowledge gaps.", "Use the Feynman Technique: simplify complex topics as if explaining to a child.", "Change study locations occasionally to improve memory retention.", "Practice spaced repetition for long-term memorization.", "Start with the most challenging material when your mind is freshest.", "Use mnemonic devices to remember complex information.", "Set specific, achievable goals for each study session.", "Connect new information to what you already know.", "Take notes by hand to improve information processing.", "Use background music without lyrics to enhance focus.", "Schedule regular review sessions instead of cramming.", "Break large projects into smaller, manageable tasks.", "Use the 80/20 rule: focus on the 20% that gives 80% of results.", "Test yourself frequently to monitor your progress.", "Reward yourself after completing study milestones.", "Use different colored pens for different types of information.", "Create a study schedule and stick to it consistently.", "Find a study partner for accountability and discussion.", "Avoid multitasking—focus on one subject at a time.", "Use online resources and educational videos for difficult concepts.", "Practice problems actively instead of passively reading solutions."
        ];
        
        // --- THEME DEFINITIONS ---
        const themes = { 
            "cosmic-dark": { "--primary-glow": "#8A2BE2", "--secondary-glow": "#5D3FD3", "--tertiary-glow": "#9370DB", "--background": "#121212", "--text-primary": "#FFFFFF", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(30, 30, 46, 0.7)", "--accent": "#BB86FC" }, 
            "midnight-blue": { "--primary-glow": "#0f3460", "--secondary-glow": "#533483", "--tertiary-glow": "#1e90ff", "--background": "#1a1a2e", "--text-primary": "#e0e0e0", "--glass-bg": "rgba(0, 0, 0, 0.2)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(39, 39, 62, 0.7)", "--accent": "#4cc9f0" }, 
            "forest-deep": { "--primary-glow": "#0f3b2d", "--secondary-glow": "#1b5e45", "--tertiary-glow": "#2e8b56", "--background": "#0f3b2d", "--text-primary": "#e0f2e9", "--glass-bg": "rgba(0, 0, 0, 0.2)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(40, 80, 60, 0.7)", "--accent": "#42e695" }, 
            "synthwave": { "--primary-glow": "#f20089", "--secondary-glow": "#00f5d4", "--tertiary-glow": "#e500a4", "--background": "#2d00f7", "--text-primary": "#ffffff", "--glass-bg": "rgba(0, 0, 0, 0.2)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(80, 0, 200, 0.7)", "--accent": "#ff00ff" },
            "cozy-mocha": { "--primary-glow": "#c89f7f", "--secondary-glow": "#7c6a59", "--tertiary-glow": "#a5886e", "--background": "#4a3f35", "--text-primary": "#f5f5dc", "--glass-bg": "rgba(245, 245, 220, 0.1)", "--glass-border": "rgba(245, 245, 220, 0.2)", "--card-bg": "rgba(87, 72, 60, 0.7)", "--accent": "#e0cda9" },
            "sunset-peach": { "--primary-glow": "#ffc0cb", "--secondary-glow": "#ffa07a", "--tertiary-glow": "#ffdab9", "--background": "#ffeadb", "--text-primary": "#5c4033", "--glass-bg": "rgba(92, 64, 51, 0.08)", "--glass-border": "rgba(92, 64, 51, 0.15)", "--card-bg": "rgba(255, 237, 224, 0.7)", "--accent": "#ff6b6b" },
            "lavender-dream": { "--primary-glow": "#dda0dd", "--secondary-glow": "#d8bfd8", "--tertiary-glow": "#cbc3e3", "--background": "#e6e6fa", "--text-primary": "#483d8b", "--glass-bg": "rgba(72, 61, 139, 0.08)", "--glass-border": "rgba(72, 61, 139, 0.15)", "--card-bg": "rgba(238, 221, 255, 0.7)", "--accent": "#9370db" },
            "oceanic-abyss": { "--primary-glow": "#1f4287", "--secondary-glow": "#071e3d", "--tertiary-glow": "#278ea5", "--background": "#1d2b53", "--text-primary": "#f0f8ff", "--glass-bg": "rgba(31, 66, 135, 0.1)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(10, 25, 47, 0.7)", "--accent": "#21e6c1" },
            "crimson-study": { "--primary-glow": "#dc2626", "--secondary-glow": "#b91c1c", "--tertiary-glow": "#f87171", "--background": "#7f1d1d", "--text-primary": "#fecaca", "--glass-bg": "rgba(254, 202, 202, 0.08)", "--glass-border": "rgba(254, 202, 202, 0.2)", "--card-bg": "rgba(153, 27, 27, 0.7)", "--accent": "#ef4444" },
            "solarized-light": { "--primary-glow": "#eee8d5", "--secondary-glow": "#b58900", "--tertiary-glow": "#268bd2", "--background": "#fdf6e3", "--text-primary": "#657b83", "--glass-bg": "rgba(101, 123, 131, 0.08)", "--glass-border": "rgba(101, 123, 131, 0.15)", "--card-bg": "rgba(238, 232, 213, 0.7)", "--accent": "#d33682" },
            "liquid-gold": { "--primary-glow": "#FFD700", "--secondary-glow": "#FFA500", "--tertiary-glow": "#B8860B", "--background": "#000000", "--text-primary": "#FFFFFF", "--glass-bg": "rgba(255, 215, 0, 0.1)", "--glass-border": "rgba(255, 215, 0, 0.2)", "--card-bg": "rgba(20, 15, 0, 0.7)", "--accent": "#FFD700" },
            "starfall": { "--primary-glow": "#a2a8d3", "--secondary-glow": "#e7eaf6", "--tertiary-glow": "#38598b", "--background": "#0a043c", "--text-primary": "#ffffff", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(25, 20, 70, 0.7)", "--accent": "#e7eaf6" },
            "cyberpunk-neon": { "--primary-glow": "#701ebd", "--secondary-glow": "#f0f", "--tertiary-glow": "#0ff", "--background": "#1f1d36", "--text-primary": "#e9f5f9", "--glass-bg": "rgba(0, 255, 255, 0.1)", "--glass-border": "rgba(0, 255, 255, 0.2)", "--card-bg": "rgba(50, 48, 80, 0.7)", "--accent": "#00f0b5" },
            "enchanted-forest": { "--primary-glow": "#006400", "--secondary-glow": "#228b22", "--tertiary-glow": "#556b2f", "--background": "#102a24", "--text-primary": "#c4d8c6", "--glass-bg": "rgba(200, 220, 200, 0.1)", "--glass-border": "rgba(200, 220, 200, 0.2)", "--card-bg": "rgba(20, 50, 40, 0.7)", "--accent": "#98ff98" },
            "sakura-dream": { "--primary-glow": "#ffb7c5", "--secondary-glow": "#ffc0cb", "--tertiary-glow": "#ff69b4", "--background": "#f9e6e6", "--text-primary": "#613a3a", "--glass-bg": "rgba(97, 58, 58, 0.08)", "--glass-border": "rgba(97, 58, 58, 0.15)", "--card-bg": "rgba(255, 240, 240, 0.7)", "--accent": "#ff69b4" },
            "volcanic-ash": { "--primary-glow": "#ff4500", "--secondary-glow": "#ff8c00", "--tertiary-glow": "#ff6347", "--background": "#1e1e1e", "--text-primary": "#dcdcdc", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(40, 40, 40, 0.7)", "--accent": "#ff4500" },
            "arctic-dawn": { "--primary-glow": "#add8e6", "--secondary-glow": "#b0e0e6", "--tertiary-glow": "#87ceeb", "--background": "#f0f8ff", "--text-primary": "#003366", "--glass-bg": "rgba(0, 51, 102, 0.08)", "--glass-border": "rgba(0, 51, 102, 0.15)", "--card-bg": "rgba(225, 240, 255, 0.7)", "--accent": "#87cefa" },
            "nebula-haze": { "--primary-glow": "#da70d6", "--secondary-glow": "#ba55d3", "--tertiary-glow": "#9932cc", "--background": "#4c2a4c", "--text-primary": "#f5e6f5", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(90, 60, 90, 0.7)", "--accent": "#dda0dd" },
            "charcoal-slate": { "--primary-glow": "#708090", "--secondary-glow": "#778899", "--tertiary-glow": "#2f4f4f", "--background": "#36454f", "--text-primary": "#d3d3d3", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(60, 70, 80, 0.7)", "--accent": "#a9a9a9" },
            "nautical-depth": { "--primary-glow": "#008080", "--secondary-glow": "#20b2aa", "--tertiary-glow": "#5f9ea0", "--background": "#003153", "--text-primary": "#e0ffff", "--glass-bg": "rgba(224, 255, 255, 0.1)", "--glass-border": "rgba(224, 255, 255, 0.2)", "--card-bg": "rgba(0, 60, 90, 0.7)", "--accent": "#48d1cc" },
            "arcane-library": { "--primary-glow": "#483d8b", "--secondary-glow": "#8a2be2", "--tertiary-glow": "#9932cc", "--background": "#2e1a47", "--text-primary": "#e6e6fa", "--glass-bg": "rgba(230, 230, 250, 0.08)", "--glass-border": "rgba(230, 230, 250, 0.15)", "--card-bg": "rgba(50, 30, 70, 0.7)", "--accent": "#c792ea" },
            "rose-quartz": { "--primary-glow": "#e070a0", "--secondary-glow": "#f08080", "--tertiary-glow": "#db7093", "--background": "#3c1321", "--text-primary": "#f8dde9", "--glass-bg": "rgba(255, 255, 255, 0.1)", "--glass-border": "rgba(255, 255, 255, 0.2)", "--card-bg": "rgba(80, 30, 50, 0.7)", "--accent": "#ff9eb8" },
            "creamy-vanilla": { "--primary-glow": "#f3e5ab", "--secondary-glow": "#edeaaf", "--tertiary-glow": "#fafad2", "--background": "#fffdd0", "--text-primary": "#7a5c58", "--glass-bg": "rgba(122, 92, 88, 0.08)", "--glass-border": "rgba(122, 92, 88, 0.15)", "--card-bg": "rgba(255, 250, 230, 0.7)", "--accent": "#d4af37" },
            "olive-noir": { "--primary-glow": "#6b8e23", "--secondary-glow": "#556b2f", "--tertiary-glow": "#808000", "--background": "#232b2b", "--text-primary": "#e9f5e3", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(45, 55, 45, 0.7)", "--accent": "#bada55" },
            "emerald-path": { "--primary-glow": "#00a95c", "--secondary-glow": "#009b77", "--tertiary-glow": "#3cb371", "--background": "#013220", "--text-primary": "#d9eee1", "--glass-bg": "rgba(217, 238, 225, 0.1)", "--glass-border": "rgba(217, 238, 225, 0.2)", "--card-bg": "rgba(5, 60, 40, 0.7)", "--accent": "#50c878" },
            "graphite-gray": { "--primary-glow": "#8c92ac", "--secondary-glow": "#8d99ae", "--tertiary-glow": "#b3b3b3", "--background": "#353839", "--text-primary": "#edf2f4", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(60, 65, 70, 0.7)", "--accent": "#d8d8d8" },
            "bumblebee": { "--primary-glow": "#f4c430", "--secondary-glow": "#ffdb58", "--tertiary-glow": "#ffc300", "--background": "#202020", "--text-primary": "#ffffff", "--glass-bg": "rgba(255, 225, 0, 0.1)", "--glass-border": "rgba(255, 225, 0, 0.2)", "--card-bg": "rgba(40, 40, 40, 0.7)", "--accent": "#ffd700" },
            "cobalt-blue": { "--primary-glow": "#0047ab", "--secondary-glow": "#002366", "--tertiary-glow": "#1e90ff", "--background": "#00204a", "--text-primary": "#cce5ff", "--glass-bg": "rgba(204, 229, 255, 0.1)", "--glass-border": "rgba(204, 229, 255, 0.2)", "--card-bg": "rgba(0, 40, 80, 0.7)", "--accent": "#6699ff" },
            "mahogany": { "--primary-glow": "#c04000", "--secondary-glow": "#8b4513", "--tertiary-glow": "#a0522d", "--background": "#4a0404", "--text-primary": "#f8e8e8", "--glass-bg": "rgba(255, 255, 255, 0.08)", "--glass-border": "rgba(255, 255, 255, 0.15)", "--card-bg": "rgba(80, 20, 20, 0.7)", "--accent": "#e97451" },
            "minimalist-beige": { "--primary-glow": "#e3dac9", "--secondary-glow": "#dcd0c0", "--tertiary-glow": "#c1b5a9", "--background": "#f5f5dc", "--text-primary": "#5d564c", "--glass-bg": "rgba(93, 86, 76, 0.08)", "--glass-border": "rgba(93, 86, 76, 0.15)", "--card-bg": "rgba(240, 240, 220, 0.7)", "--accent": "#8a795d" },
            "oceanic-calm": { "--primary-glow": "#2c7a7b", "--secondary-glow": "#1f6f8b", "--tertiary-glow": "#89c9b8", "--background": "#d4f1f4", "--text-primary": "#1f6f8b", "--glass-bg": "rgba(31, 111, 139, 0.08)", "--glass-border": "rgba(31, 111, 139, 0.15)", "--card-bg": "rgba(220, 245, 245, 0.7)", "--accent": "#17a2b8" },
            "retro-groove": { "--primary-glow": "#f9a826", "--secondary-glow": "#e67e22", "--tertiary-glow": "#d35400", "--background": "#3d2c22", "--text-primary": "#f5deb3", "--glass-bg": "rgba(245, 222, 179, 0.08)", "--glass-border": "rgba(245, 222, 179, 0.15)", "--card-bg": "rgba(78, 56, 42, 0.7)", "--accent": "#f9a826" },
            "minty-fresh": { "--primary-glow": "#99f3bd", "--secondary-glow": "#7de8a8", "--tertiary-glow": "#5ce092", "--background": "#f0fff8", "--text-primary": "#005c3d", "--glass-bg": "rgba(0, 92, 61, 0.05)", "--glass-border": "rgba(0, 92, 61, 0.1)", "--card-bg": "rgba(230, 255, 245, 0.7)", "--accent": "#3ddc84" },
            "gothic-elegance": { "--primary-glow": "#c0392b", "--secondary-glow": "#8e44ad", "--tertiary-glow": "#2c3e50", "--background": "#121013", "--text-primary": "#ecf0f1", "--glass-bg": "rgba(236, 240, 241, 0.08)", "--glass-border": "rgba(236, 240, 241, 0.15)", "--card-bg": "rgba(25, 22, 28, 0.7)", "--accent": "#9b59b6" },
            "sunny-day": { "--primary-glow": "#f1c40f", "--secondary-glow": "#f39c12", "--tertiary-glow": "#3498db", "--background": "#eaf6ff", "--text-primary": "#2c3e50", "--glass-bg": "rgba(44, 62, 80, 0.08)", "--glass-border": "rgba(44, 62, 80, 0.15)", "--card-bg": "rgba(240, 248, 255, 0.7)", "--accent": "#3498db" },
            "autumn-leaves": { "--primary-glow": "#d35400", "--secondary-glow": "#c0392b", "--tertiary-glow": "#f39c12", "--background": "#4e342e", "--text-primary": "#ffccbc", "--glass-bg": "rgba(255, 204, 188, 0.08)", "--glass-border": "rgba(255, 204, 188, 0.15)", "--card-bg": "rgba(94, 65, 55, 0.7)", "--accent": "#e67e22" },
            "strawberry-cream": { "--primary-glow": "#ff8fab", "--secondary-glow": "#fb6f92", "--tertiary-glow": "#ffc2d1", "--background": "#fff0f3", "--text-primary": "#c9184a", "--glass-bg": "rgba(201, 24, 74, 0.08)", "--glass-border": "rgba(201, 24, 74, 0.15)", "--card-bg": "rgba(255, 230, 235, 0.7)", "--accent": "#ff6392" },
            "hacker-matrix": { "--primary-glow": "#00ff00", "--secondary-glow": "#00dd00", "--tertiary-glow": "#00aa00", "--background": "#000000", "--text-primary": "#00ff00", "--glass-bg": "rgba(0, 255, 0, 0.08)", "--glass-border": "rgba(0, 255, 0, 0.15)", "--card-bg": "rgba(5, 20, 5, 0.7)", "--accent": "#00ff00" },
            "sandstone-canyon": { "--primary-glow": "#e9a26e", "--secondary-glow": "#d88a53", "--tertiary-glow": "#c77238", "--background": "#fdf4e3", "--text-primary": "#6d4c41", "--glass-bg": "rgba(109, 76, 65, 0.08)", "--glass-border": "rgba(109, 76, 65, 0.15)", "--card-bg": "rgba(250, 235, 215, 0.7)", "--accent": "#bf6936" },
            "wild-berries": { "--primary-glow": "#7209b7", "--secondary-glow": "#560bad", "--tertiary-glow": "#f72585", "--background": "#1e0c38", "--text-primary": "#f1e3ff", "--glass-bg": "rgba(241, 227, 255, 0.08)", "--glass-border": "rgba(241, 227, 255, 0.15)", "--card-bg": "rgba(48, 25, 72, 0.7)", "--accent": "#b5179e" }
        };

        // --- CORE FUNCTIONS ---
        
        /**
         * Plays a sound from a given URL.
         * @param {string} url - The URL of the sound file.
         */
        function playSound(url) { 
            try {
                new Audio(url).play(); 
            } catch (e) {
                console.error("Audio playback error:", e);
            }
        }
        
        /**
         * Fetches and displays a new random study tip.
         */
        function newTip() {
            playSound('https://www.soundjay.com/buttons/sounds/button-16.mp3');
            tipElement.style.opacity = 0;
            setTimeout(() => {
                const randomIndex = Math.floor(Math.random() * tips.length);
                const newTip = tips[randomIndex];
                tipElement.textContent = newTip;
                localStorage.setItem('currentTip', newTip);
                tipElement.style.opacity = 1;
            }, 300);
        }
        
        /**
         * Copies the current tip to the clipboard and shows feedback.
         */
        function copyTip() { 
            navigator.clipboard.writeText(tipElement.textContent).then(() => { 
                playSound('https://www.soundjay.com/buttons/sounds/button-7.mp3');
                copyFeedbackEl.style.opacity = 1;
                copyFeedbackEl.style.transform = 'translate(-50%, -50%) scale(1)';
                setTimeout(() => {
                    copyFeedbackEl.style.opacity = 0;
                    copyFeedbackEl.style.transform = 'translate(-50%, -50%) scale(0.8)';
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
        
        /**
         * Opens the "Study With Me" page in a new tab.
         */
        function openStudyWithMe() { 
            window.open('page3.html', '_blank'); 
        }

        /**
         * Adds a random amount of caffeine and updates the display.
         * @param {HTMLElement} element - The button element that was clicked.
         */
        function addCaffeine(element) {
            caffeineIntake += Math.floor(Math.random() * 81) + 40; // Add 40-120mg
            localStorage.setItem('caffeineIntake', caffeineIntake);
            updateCaffeineDisplay();

            // Visual feedback
            element.style.transform = 'scale(1.2)';
            setTimeout(() => { element.style.transform = 'scale(1)'; }, 200);
        }
        
        /**
         * Resets the caffeine intake to zero.
         */
        function resetCaffeine() {
            caffeineIntake = 0;
            localStorage.setItem('caffeineIntake', caffeineIntake);
            updateCaffeineDisplay();
        }

        /**
         * Updates the caffeine counter and warning message on the UI.
         */
        function updateCaffeineDisplay() {
            caffeineCountEl.textContent = caffeineIntake;
            caffeineWarningEl.style.display = 'none';
            if (caffeineIntake >= 400) { 
                caffeineWarningEl.style.display = "block"; 
                caffeineWarningEl.textContent = "⚠️ Daily max exceeded!"; 
            } else if (caffeineIntake >= 300) { 
                caffeineWarningEl.style.display = "block"; 
                caffeineWarningEl.textContent = "Max recommended: 400mg"; 
            }
        }
        
        /**
         * Applies a selected theme to the entire page.
         * @param {string} themeName - The key of the theme in the `themes` object.
         */
        function setTheme(themeName) {
            const selectedTheme = themes[themeName]; 
            if (!selectedTheme) return false;
            
            for (const [key, value] of Object.entries(selectedTheme)) { 
                document.documentElement.style.setProperty(key, value); 
            }
            localStorage.setItem('studyVerseTheme', themeName);
            return true;
        }

        /**
         * Dynamically creates the theme selector boxes inside the theme modal.
         */
        function populateThemeSelector() {
            themeGridContainer.innerHTML = ''; // Clear existing options
            for (const themeName in themes) {
                const themeColors = themes[themeName];
                const displayName = themeName.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                const dot = document.createElement('div');
                dot.classList.add('theme-dot');
                dot.title = displayName;
                dot.dataset.theme = themeName;
                
                // Create the color swatches inside the box
                const swatch1 = document.createElement('span');
                swatch1.classList.add('theme-color-swatch');
                swatch1.style.backgroundColor = themeColors['--primary-glow'];

                const swatch2 = document.createElement('span');
                swatch2.classList.add('theme-color-swatch');
                swatch2.style.backgroundColor = themeColors['--accent'];
                
                const swatch3 = document.createElement('span');
                swatch3.classList.add('theme-color-swatch');
                swatch3.style.backgroundColor = themeColors['--background'];

                // Create a label
                const label = document.createElement('div');
                label.classList.add('theme-dot-label');
                label.textContent = displayName;

                dot.appendChild(swatch1);
                dot.appendChild(swatch2);
                dot.appendChild(swatch3);
                dot.appendChild(label);


                dot.addEventListener('click', () => {
                    setTheme(themeName);
                    closeThemeModal(); // Close modal after selection
                });
                themeGridContainer.appendChild(dot);
            }
        }
        
        // --- THEME MODAL FUNCTIONS ---
        function openThemeModal() {
            themeModalOverlay.classList.add('visible');
        }

        function closeThemeModal() {
            themeModalOverlay.classList.remove('visible');
        }
        
        // --- CHONO COPILOT MODAL FUNCTIONS ---
        function openChonoModal() {
            chonoModalOverlay.classList.add('visible');
        }

        function closeChonoModal() {
            chonoModalOverlay.classList.remove('visible');
        }

        /**
         * Sets the position of the dock.
         * @param {string} position - 'left', 'bottom', or 'right'.
         */
        function setDockPosition(position) {
            const validPositions = ['left', 'bottom', 'right'];
            if (!validPositions.includes(position)) position = 'bottom'; 

            dockElement.classList.remove('dock-left', 'dock-bottom', 'dock-right');
            dockElement.classList.add(`dock-${position}`);

            posButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.pos === position));
            localStorage.setItem('studyVerseDockPosition', position);
        }

        /**
         * Sets the size of the dock icons.
         * @param {string} size - 'small', 'medium', or 'large'.
         */
        function setDockSize(size) {
            const validSizes = ['small', 'medium', 'large'];
            if (!validSizes.includes(size)) size = 'medium'; 

            dockElement.classList.remove('size-small', 'size-medium', 'size-large');
            dockElement.classList.add(`size-${size}`);

            sizeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.size === size));
            localStorage.setItem('studyVerseDockSize', size);
        }
        
        /**
         * Generates and displays the calendar for the current month.
         */
        function generateCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let calendarHTML = '';
            dayNames.forEach(day => { calendarHTML += `<div class="calendar-day header">${day}</div>`; });
            for (let i = 0; i < firstDay; i++) { calendarHTML += `<div class="calendar-day empty"></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = now.getDate() === day;
                const hasTip = Math.random() > 0.7; 
                calendarHTML += `<div class="calendar-day ${isToday ? 'today' : 'normal'} ${hasTip ? 'has-tip' : ''}" data-day="${day}">${day}</div>`;
            }
            calendarElement.innerHTML = calendarHTML;
            document.querySelectorAll('.calendar-day.has-tip').forEach(day => {
                day.addEventListener('click', () => {
                    const dayNum = day.getAttribute('data-day');
                    showDayTip(dayNum);
                });
            });
        }
        
        /**
         * Shows a random tip associated with a specific day.
         * @param {string|number} day - The day number clicked.
         */
        function showDayTip(day) {
            const randomTipIndex = Math.floor(Math.random() * tips.length);
            dayTipElement.textContent = `Tip for day ${day}: ${tips[randomTipIndex]}`;
            dayTipElement.style.display = 'block';
        }
        
        /**
         * Toggles the visibility of the calendar content.
         */
        function toggleCalendar() {
            const calendarContent = document.getElementById('calendar-content');
            calendarVisible = !calendarVisible;
            if (calendarVisible) {
                calendarContent.style.display = 'block';
                calendarToggleIcon.className = 'fas fa-chevron-up';
            } else {
                calendarContent.style.display = 'none';
                calendarToggleIcon.className = 'fas fa-chevron-down';
            }
        }
        
        // --- CHAT AI LOGIC ---
        
        const pageNavigationMap = {
            'motivation': 'page12.html',
            'tasks': 'page1.html',
            'task': 'page1.html',
            'pomodoro': 'page13.html',
            'deep focus': 'page9.html',
            'measure': 'page10.html',
            'notes': 'page5.html',
            'note': 'page5.html',
            'cozynotes': 'page5.html',
            'typing test': 'page6.html',
            'typing': 'page6.html',
            'puzzle': 'page7.html',
            'puzzles': 'page7.html',
            'formulas': 'page4.html',
            'formula station': 'page4.html',
            'whiteboard': 'page8.html',
            'white board': 'page8.html',
            'mood': 'page11.html',
            'moodly': 'page11.html'
        };

        function setupChatAI() {
            chatAiToggle.addEventListener('click', () => chatWindow.classList.toggle('open'));
            chatSendBtn.addEventListener('click', handleUserMessage);
            chatInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleUserMessage();
            });

            // Add an initial welcome message
            appendAiMessage("Hello! I'm the StudyVERSE assistant. How can I help you? You can ask me to change the theme or take you to a page.");
        }

        function handleUserMessage() {
            const messageText = chatInput.value.trim();
            if (messageText === "") return;
            
            appendUserMessage(messageText);
            chatInput.value = "";

            setTimeout(() => {
                processAiCommand(messageText.toLowerCase());
            }, 500 + Math.random() * 500); // Simulate thinking
        }

        function appendUserMessage(text) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', 'user');
            messageEl.textContent = text;
            chatMessagesContainer.appendChild(messageEl);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function appendAiMessage(text) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', 'ai');
            messageEl.textContent = text;
            chatMessagesContainer.appendChild(messageEl);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function processAiCommand(command) {
            // Command: Change Theme
            const themeMatch = command.match(/(change|set) theme to (.+)/);
            if (themeMatch) {
                const requestedTheme = themeMatch[2].trim().replace(/\s+/g, '-');
                const themeDisplayName = requestedTheme.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                if (setTheme(requestedTheme)) {
                    appendAiMessage(`Of course! I've changed the theme to ${themeDisplayName}.`);
                } else {
                    appendAiMessage(`I'm sorry, I couldn't find a theme called "${themeDisplayName}". Try opening the theme palette to see available options.`);
                }
                return;
            }

            // Command: Navigation
            const navMatch = command.match(/(go to|take me to|open) (the )?(.+)/);
            if (navMatch) {
                const pageQuery = navMatch[3].trim().replace(/ page$/, ''); // "the puzzles page" -> "puzzles"
                if (pageNavigationMap[pageQuery]) {
                    const pageName = pageQuery.charAt(0).toUpperCase() + pageQuery.slice(1);
                    appendAiMessage(`Certainly, heading to the ${pageName} page now!`);
                    window.location.href = pageNavigationMap[pageQuery];
                } else {
                    appendAiMessage(`Sorry, I don't know where the "${pageQuery}" page is. My capabilities include: tasks, puzzles, notes, and more.`);
                }
                return;
            }
            
            // Basic conversation
            if (command.includes('hello') || command.includes('hi')) {
                appendAiMessage("Hi there! What can I assist you with today?");
                return;
            }

            if (command.includes('how are you')) {
                appendAiMessage("I'm just a set of instructions, but I'm operating perfectly! Ready to help you study.");
                return;
            }

            // Default fallback
            appendAiMessage("I'm not sure how to respond to that. You can ask me to 'change theme to...' or 'go to tasks'.");
        }
        
        /**
         * Loads the user's saved state from localStorage.
         */
        function loadState() {
            const savedCaffeine = localStorage.getItem('caffeineIntake');
            if (savedCaffeine !== null) { caffeineIntake = parseInt(savedCaffeine, 10); updateCaffeineDisplay(); }
            
            const savedTip = localStorage.getItem('currentTip');
            if (savedTip) { tipElement.textContent = savedTip; }

            populateThemeSelector(); // Generate themes inside the modal
            
            const savedTheme = localStorage.getItem('studyVerseTheme');
            setTheme(savedTheme && themes[savedTheme] ? savedTheme : 'cosmic-dark');
            
            const savedDockPos = localStorage.getItem('studyVerseDockPosition');
            setDockPosition(savedDockPos || 'bottom');
            
            const savedDockSize = localStorage.getItem('studyVerseDockSize');
            setDockSize(savedDockSize || 'medium');
            
            generateCalendar();
            setupChatAI(); // Initialize the new Chat AI
        }
        
        // --- INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", () => {
            // Setup Event Listeners for controls
            posButtons.forEach(btn => {
                btn.addEventListener('click', () => setDockPosition(btn.dataset.pos));
            });
            sizeButtons.forEach(btn => {
                btn.addEventListener('click', () => setDockSize(btn.dataset.size));
            });
            
            // Setup Theme Modal Listeners
            themeControlIcon.addEventListener('click', openThemeModal);
            themeModalCloseBtn.addEventListener('click', closeThemeModal);
            themeModalOverlay.addEventListener('click', (event) => {
                // Close only if the dark overlay itself is clicked
                if (event.target === themeModalOverlay) {
                    closeThemeModal();
                }
            });
            
            // Setup Chono Copilot Modal Listeners
            chonoCopilotIcon.addEventListener('click', openChonoModal);
            chonoModalCloseBtn.addEventListener('click', closeChonoModal);
            chonoModalOverlay.addEventListener('click', (event) => {
                if (event.target === chonoModalOverlay) {
                    closeChonoModal();
                }
            });


            // Load saved state
            loadState();
            
            // Initial animation for the main app
            const app = document.querySelector(".app");
            app.style.opacity = 0; app.style.transform = "translateY(20px)";
            setTimeout(() => {
                app.style.transition = "opacity 0.5s, transform 0.5s";
                app.style.opacity = 1; app.style.transform = "translateY(0)";
            }, 100);
        });
    </script>
</body>
</html>
